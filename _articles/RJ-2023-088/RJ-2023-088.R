# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2023-088.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
#knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(SSBtools)
library(Matrix)
library(kableExtra)


## ----include = FALSE----------------------------------------------------------
x <- SSBtoolsData("sprt_emp_withEU")[,c(1,2,5,3,4)] 
names(x)[5] <- "value"
x$age[x$age == "Y15-29"] <- "young"
x$age[x$age == "Y30-64"] <- "old"
d <- x[x$year=="2014",-4]
d 
setMethod("show", signature = "sparseMatrix", function(object) printSpMatrix(object)) 
setMethod("show", signature = "denseMatrix", function(object) print(as.matrix(object)))



## ----include = FALSE----------------------------------------------------------
milliseconds <- structure(list(f = c("FindHierarchies", "HierarchyCompute", "HierarchyCompute with colVar", 
"ModelMatrix from hierarchies", "ModelMatrix from formula", "sparse.model.matrix", 
"model.matrix", "FormulaSums", "median by model_aggregate"), `2` = c(10, 
17, 18, 14, 16, 26, 4, 21, 30), `3` = c(32, 27, 28, 26, 83, 173, 
24, 110, 208), `4` = c(392, 188, 86, 229, 1294, 11703, 3238, 
1417, 3353), `5` = c(7509, 4582, 863, 6557, 59640, 1596721, NA, 
42577, 74148), `6` = c(130730, 147113, 21773, 218071, 2921514, 
NA, NA, 1041023, 1403018)), startRow = c(f = 1L), row.names = c(NA, 
-9L), class = "data.frame")
k <- milliseconds
seconds <- k
for (i in 2:4) seconds[, i] <- sprintf("%0.3f", round(k[, i]/1000, 3))
for (i in 5:6) seconds[, i] <- sprintf("%0.0f", round(k[, i]/1000))
for (i in 2:6) seconds[!is.finite(milliseconds[[i]]), i] <- ""
colnames(seconds) <- c("function call", paste0("$i = ", 2:6, "$"))


## ----include = FALSE----------------------------------------------------------
peak_MiB <- structure(list(f = c("FindHierarchies", "HierarchyCompute", "HierarchyCompute with colVar", 
"ModelMatrix from hierarchies", "ModelMatrix from formula", "sparse.model.matrix", 
"model.matrix", "FormulaSums", "median by model_aggregate"), `2` = c(0.9, 
3, 1.2, 1, 0.7, 2.4, 0.6, 1, 0.9), `3` = c(1.9, 3.8, 2.1, 4.3, 
16.8, 40, 42.1, 18.2, 15.2), `4` = c(12, 69, 20, 71, 71, 536, 
5864, 431, 230), `5` = c(57, 1074, 201, 1079, 919, 61654, NA, 
6884, 2257), `6` = c(610, 30792, 1273, 32246, 27809, NA, NA, 
1252, 63435)), startRow = c(f = 1L), row.names = c(NA, -9L), class = "data.frame")
k <- peak_MiB
peakMiB <- k
for (i in 2:3) peakMiB[, i] <- sprintf("%0.1f", k[, i])
for (i in 4:6) peakMiB[, i] <- sprintf("%0.0f", k[, i])
for (i in 2:6) peakMiB[!is.finite(k[[i]]), i] <- " "
colnames(peakMiB) <- c("function call", paste0("$i = ", 2:6, "$"))


## ----include = FALSE----------------------------------------------------------
object_size <- structure(list(f = c("FindHierarchies", "HierarchyCompute", "HierarchyCompute with colVar", 
"ModelMatrix from hierarchies", "ModelMatrix from formula", "sparse.model.matrix", 
"model.matrix", "FormulaSums", "median by model_aggregate"), `2` = c(0.005, 
0.007, 0.007, 0.025, 0.026, 0.033, 0.171, 0.014, 0.007), `3` = c(0.008, 
0.087, 0.087, 0.51, 0.512, 0.581, 21.196, 0.21, 0.087), `4` = c(0.01, 
1.5, 1.5, 12.2, 12.2, 13.1, 2934.6, 3.1, 1.5), `5` = c(0.012, 
25, 25, 324, 324, 333, NA, 48, 25), `6` = c(0.015, 402, 402, 
9003, 9003, NA, NA, 689, 402)), startRow = c(f = 1L), row.names = c(NA, 
-9L), class = "data.frame")
k <- object_size
objectsize <- k
for (i in 2:3) objectsize[, i] <-  sprintf("(%0.3f)", k[, i])
for (i in 4  ) objectsize[, i] <-  sprintf("(%0.1f)", k[, i])
for (i in 4  ) objectsize[7, i] <- sprintf("(%0.0f)", k[7, i])
for (i in 5:6) objectsize[, i] <-  sprintf("(%0.0f)", k[, i])
for (i in 4:6) objectsize[1, i] <- sprintf("(%0.3f)", k[1, i])
for (i in 2:6) objectsize[!is.finite(k[[i]]), i] <- " "
colnames(objectsize) <- c("function call", paste("i =", 2:6))


## ----include = FALSE----------------------------------------------------------
code <- c(
  "`d <- SSBtoolsData(paste0(\"power10to\", i))`", 
  "`hi <- FindHierarchies(d)`", 
  "`d$y <- as.numeric(1:nrow(d))`", 
  "`HierarchyCompute(d, hi, \"y\", inputInOutput = TRUE)`", 
  "[[1`HierarchyCompute(d, hi, \"y\", inputInOutput = TRUE,` \\newline `colVar = letters[1:(floor(i/2))])`]]", 
  "`ModelMatrix(d, hierarchies = hi)`", 
  "[[2`f <- as.formula(strtrim(` \\newline `\"y ~ (a+A)*(b+B)*(c+C)*(d+D)*(e+E)*(f+F)\", 3 + 6*i))`]]", 
  "`ModelMatrix(d, formula = f)`", 
  "`ModelMatrix(d, formula = f, viaOrdinary = TRUE)`", 
  "[[1`ModelMatrix(d, formula = f, viaOrdinary = TRUE,` \\newline `sparse = FALSE)`]]b", 
  "`FormulaSums(d, formula = f)`",
  '[[2`model_aggregate(d, hierarchies = hi,` \\newline `fun_vars = c(median = "y"))`]]')

codetxt <- c("Input data", "FindHierarchies", "Adding numeric variable","HierarchyCompute", 
             "HierarchyCompute with colVar", 
"ModelMatrix from hierarchies", "Formula","ModelMatrix from formula", "sparse.model.matrix", 
"model.matrix", "FormulaSums", "median by model_aggregate")
codeframe <- data.frame(codetxt, code)
colnames(codeframe) <- c("function call, etc.", "source code") 


## ----comment=NA, prompt = TRUE------------------------------------------------
d


## ----comment=NA, prompt = TRUE------------------------------------------------
ModelMatrix(d, formula = ~age + geo)


## ----comment=NA, prompt = TRUE------------------------------------------------
t(ModelMatrix(d, formula = ~age + geo)) %*% d$value


## ----comment=NA, prompt = TRUE------------------------------------------------
ModelMatrix(d, formula = ~age*eu + geo, crossTable = TRUE)


## ----comment=NA, prompt = TRUE------------------------------------------------
dimLists <- FindDimLists(d[c("age", "geo", "eu")])
dimLists 


## ----fig1, fig.show="hold", out.width = "100%", fig.cap = "The hierarchies in the examples.", echo = FALSE----
knitr::include_graphics("figures/young_old_EU_nonEU_Total.png") 


## ----include = FALSE----------------------------------------------------------
options(sparse.colnames = FALSE)


## ----comment=NA, prompt = TRUE------------------------------------------------
ModelMatrix(d[-6, -3], hierarchies = dimLists, inputInOutput = c(TRUE, FALSE), 
            crossTable = TRUE)


## ----comment=NA, prompt = TRUE------------------------------------------------
hrc <- DimList2Hrc(dimLists)
hrc


## ----comment=NA, prompt = TRUE------------------------------------------------
hi <- AutoHierarchies(hrc, total = c("All", "Europe"))
hi


## ----comment=NA, prompt = TRUE------------------------------------------------
Hierarchies2Formulas(hi)


## ----include = FALSE----------------------------------------------------------
options(sparse.colnames = NULL)


## ----comment=NA, prompt = TRUE------------------------------------------------
ModelMatrix(d, hierarchies = hi, select = data.frame(
            age = c("young", "young", "All", "All"), 
            geo = c("EU", "nonEU", "nonEU", "Europe")))


## ----comment=NA, prompt = TRUE------------------------------------------------
ModelMatrix(d[c(1, 4), ], hierarchies = hi, removeEmpty = TRUE)


## ----comment=NA, prompt = TRUE------------------------------------------------
ModelMatrix(d[c(1,2,4), ], hierarchies = list(age = "", geo = "Europe"))


## ----comment=NA, prompt = TRUE------------------------------------------------
d$isSpain <- d$geo == "Spain"
fCorr <- FactorLevCorr(d[c("age", "geo", "eu", "isSpain")])
fCorr


## ----comment=NA, prompt = TRUE------------------------------------------------
HierarchicalGroups(fCorr = fCorr, eachName = TRUE)


## ----comment=NA, prompt = TRUE------------------------------------------------
FindDimLists(d[c("age", "geo", "eu", "isSpain")])[[3]]


## ----comment=NA, prompt = TRUE------------------------------------------------
SSBtools::SortRows(unique(d[c("isSpain", "geo")]))


## ----comment=NA, prompt = TRUE------------------------------------------------
FindHierarchies(d[c("age", "geo", "eu", "isSpain")])$geo


## ----comment=NA, prompt = TRUE------------------------------------------------
hiM <- DummyHierarchies(hi, inputInOutput = c(TRUE, FALSE))
hiM


## ----comment=NA, prompt = TRUE------------------------------------------------
geo2 <- Matrix(1, 1, 2, dimnames = list("Europe", c("EU", "nonEU")))
geo2


## ----comment=NA, prompt = TRUE------------------------------------------------
geo2 %*% hiM$geo[1:2, ]


## ----comment=NA, prompt = TRUE------------------------------------------------
hiD <- DataDummyHierarchies(d, hiM, colNamesFromData = TRUE)
hiD


## ----comment=NA, prompt = TRUE------------------------------------------------
Matrix::KhatriRao(hiD$geo, hiD$age, make.dimnames = TRUE)


## ----comment=NA, prompt = TRUE------------------------------------------------
hiD$age[c("young", "young", "All", "All"), ]
hiD$geo[c("EU", "nonEU", "nonEU", "Europe"), ]


## ----comment=NA, prompt = TRUE------------------------------------------------
HierarchyCompute(data = cbind(d, year = 2022), 
     hierarchies = list(age = "colFactor", geo = hi$geo, year = "rowFactor"), 
     valueVar = "value")


## ----comment=NA, prompt = TRUE------------------------------------------------
hc <- HierarchyCompute(data = cbind(d, year = 2022), 
           hierarchies = list(age = "colFactor", geo = hi$geo, year = "rowFactor"), 
           valueVar = "value", output = "matrixComponents")
hc


## ----comment=NA, prompt = TRUE------------------------------------------------
hc$dataDummyHierarchy %*% hc$valueMatrix


## ----comment=NA, prompt = TRUE------------------------------------------------
hc2 <- HierarchyCompute(data = cbind(d, year = 2022), 
            hierarchies = list(age = hi$age, geo = hi$geo, year = "rowFactor"), 
            colVar = "age", inputInOutput = c(TRUE, FALSE),
            valueVar = "value", output = "matrixComponents")


## ----comment=NA, prompt = TRUE------------------------------------------------
hc2$hcRow$dataDummyHierarchy %*% hc2$hcRow$valueMatrix


## ----comment=NA, prompt = TRUE------------------------------------------------
t(hc2$hcCol$dataDummyHierarchy)


## ----comment=NA, prompt = TRUE------------------------------------------------
hc2$hcRow$dataDummyHierarchy %*% hc2$hcRow$valueMatrix %*% t(hc2$hcCol$dataDummyHierarchy)


## ----comment=NA, prompt = TRUE------------------------------------------------
HierarchyCompute(data = cbind(d, year = 2022), 
     hierarchies = list(age = hi$age, geo = hi$geo, year = "rowFactor"), 
     colVar = "age", inputInOutput = c(TRUE, FALSE),
     valueVar = "value")


## ----include = FALSE----------------------------------------------------------
model_aggregate <- function(...) SSBtools::model_aggregate(..., verbose = FALSE)
magg <- model_aggregate(d, formula = ~age + eu, 
          fun_vars = c(max = "value", median = "value", length = "geo"), 
          pre_return = TRUE, list_return = TRUE)


## ----comment=NA, prompt = TRUE------------------------------------------------
model_aggregate(d, formula = ~age + eu, 
                fun_vars = c(max = "value", median = "value", length = "geo"))



## ----comment=NA, echo = FALSE-------------------------------------------------
magg$pre_data



## ----comment=NA, echo = FALSE-------------------------------------------------
magg$x



## ----comment=NA, prompt = TRUE------------------------------------------------
d <- SSBtoolsData("power10to4")
d[c(1:4, 3715:3716, 9999:10000), ]
hi <- FindHierarchies(d)
d$y <- 1:nrow(d)
output <- HierarchyCompute(d, hi, "y", inputInOutput = TRUE)
output[c(1, 5473:5475, 37852:37854, 38416), ]


## ----include = FALSE----------------------------------------------------------
blank <- " " 
blank9 <- "         "

nblank <- objectsize
nblank[2:6] <- 0
for (j in 1:nrow(peakMiB)) for (i in 4:6) {
    peakMiB[j, i] <- paste(strtrim(blank9, 1 + 2 * (5 - nchar(peakMiB[j, i]))), peakMiB[j, i], " ", objectsize[j, i])
}
names(peakMiB)[4:6] <- paste(strtrim(blank9, 4), names(peakMiB)[4:6])
align2 <- rep("r", 6)
align2[4:6] <- "l"



## ----include = FALSE----------------------------------------------------------
cap1 <- "User CPU time in seconds based on hierarchical input data with $10^i$ rows, resulting in $14^i$ output aggregates. Thus, the size of the model matrix is $10^i \\times 14^i$. The source code is given in Table 3."

cap2 <- "Peak RAM in MiB for the calculations described in Tables 1 and 3. For $i\\geq 4$, the size of the output object is provided within parentheses, denoted in MiB as well."

cap3 <- "The source code for the calculations underlying Tables 1 and 2. With $i$ defined, the code can be run directly from top to bottom. Be careful not to run `FindHierarchies(d)` with `y` included in `d`."



## ----tab1-html, eval = knitr::is_html_output(), echo = FALSE------------------
#> knitr::kable(seconds, format = "html", align = "r",   caption = cap1)


## ----tab1-pdf, eval = knitr::is_latex_output(), echo = FALSE------------------
q <- knitr::kable(seconds, format = "latex", align = "r",  caption = cap1)
q[1] <- gsub("\\begin{table}", "\\begin{table}[p]", q[1], fixed = TRUE)
q[1] <- gsub("\\end{table}", "\\vspace{20pt} \\end{table}", q[1], fixed = TRUE)
q[1] <- gsub("\\$i = 2\\$", "$i = 2$", q[1], fixed = TRUE) # escape = FALSE not working
q[1] <- gsub("\\$i = 3\\$", "$i = 3$", q[1], fixed = TRUE)
q[1] <- gsub("\\$i = 4\\$", "$i = 4$", q[1], fixed = TRUE)
q[1] <- gsub("\\$i = 5\\$", "$i = 5$", q[1], fixed = TRUE)
q[1] <- gsub("\\$i = 6\\$", "$i = 6$", q[1], fixed = TRUE)
q


## ----tab2-html, eval = knitr::is_html_output(), echo = FALSE------------------
#> knitr::kable(peakMiB, format = "html", align = align2,   caption = cap2)


## ----tab2-pdf, eval = knitr::is_latex_output(), echo = FALSE------------------
q <- knitr::kable(peakMiB, format = "latex", align = align2,  caption = cap2)
q[1] <- gsub("\\begin{table}", "\\begin{table}[p]", q[1], fixed = TRUE)
q[1] <- gsub("\\end{table}", "\\vspace{20pt} \\end{table}", q[1], fixed = TRUE)
q[1] <- gsub("\\$i = 2\\$", "$i = 2$", q[1], fixed = TRUE) # escape = FALSE not working
q[1] <- gsub("\\$i = 3\\$", "$i = 3$", q[1], fixed = TRUE)
q[1] <- gsub("\\$i = 4\\$", "$i = 4$", q[1], fixed = TRUE)
q[1] <- gsub("\\$i = 5\\$", "$i = 5$", q[1], fixed = TRUE)
q[1] <- gsub("\\$i = 6\\$", "$i = 6$", q[1], fixed = TRUE)
q


## ----tab3-html, eval = knitr::is_html_output(), echo = FALSE------------------
#> cf <- codeframe
#> cf[[2]] <- gsub("[[1", "", cf[[2]], fixed = TRUE)
#> cf[[2]] <- gsub("[[2", "", cf[[2]], fixed = TRUE)
#> cf[[2]] <- gsub("]]b", "", cf[[2]], fixed = TRUE)
#> cf[[2]] <- gsub("]]", "", cf[[2]], fixed = TRUE)
#> knitr::kable(cf, format = "pipe", align = c("r", "l"), caption = cap3)


## ----tab3-pdf, eval = knitr::is_latex_output(), echo = FALSE------------------
q <- knitr::kable(codeframe, format = "latex", align = c("r", "l"), caption = cap3)
q <- column_spec(q, 2, monospace = TRUE)
q <- kable_styling(q, full_width = FALSE)
q1 <- gsub("`FindHierarchies(d)`", "\\ttfamily{FindHierarchies(d)}", q[1], fixed = TRUE)
q1 <- gsub("`d`", "\\ttfamily{d}", q1, fixed = TRUE)
q1 <- gsub("`y`", "\\ttfamily{y}", q1, fixed = TRUE)
q1 <- gsub("`", "", q1, fixed = TRUE)
q1 <- gsub("\\textbackslash{}newline", "\\\\  \\phantom{AAA}", q1, fixed = TRUE)
q1 <- gsub("[[1", "\\shortstack[r]{", q1, fixed = TRUE)
q1 <- gsub("[[2", "\\shortstack[l]{", q1, fixed = TRUE)
q1 <- gsub("]]b", "\\phantom{AAAAAAAAAAAAAAAAAAAA} }", q1, fixed = TRUE)
q1 <- gsub("]]", "}", q1, fixed = TRUE)
q1 <- gsub("\\phantom{AAA} fun\\_vars", "\\phantom{AAAAAAAAAAAAAAA} fun\\_vars",  q1, fixed = TRUE)
#q1 <- gsub("HierarchyCompute with colVar", "\\shortstack[r]{HierarchyCompute \\\\ with colVar}", q1, fixed = TRUE)
q1 <- gsub("\\begin{table}", "\\begin{table}[p]", q1, fixed = TRUE)
q1 <- gsub("\\end{table}", "\\vspace{20pt} \\end{table}", q1, fixed = TRUE) 
q[1] <- q1
q


## ----fig2, fig.show="hold", out.width = "100%", fig.cap = "The function (left) and art (right) hierarchy involved in Statistics Norway’s municipal accounts calculations. Red arrow means negative sign.", echo = FALSE----
knitr::include_graphics("figures/Function_Art_hierarchy.png") 

