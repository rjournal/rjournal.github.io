---
title: 'exvatools: Value Added in Exports and Other Input-Output Table Analysis Tools'
abstract: |
  This article introduces an R package, \CRANpkg{exvatools}, that simplifies the analysis of trade in value added with  international input-output tables. It provides a full set of commands for data extraction, matrix creation and manipulation, decomposition  of value added in gross exports (using alternative methodologies)  and a straightforward calculation of many value added indicators.  It can handle both raw data from well-known public input-output databases and custom data. It has a wide sector and geographical flexibility and can be easily expanded and adapted to specific economic analysis needs, facilitating a better understanding and a wider use of the available statistical resources to study globalization.
author:
- name: Enrique Feás
  affiliation: Universidad de Alcalá and Elcano Royal Institute
  address:
  - Universidad de Alcalá, Pl. de San Diego, s/n, 28801 Alcalá de Henares, Madrid,
    Spain
  - Elcano Royal Institute, Calle del Príncipe de Vergara, 51. 28006 Madrid, Spain
  orcid: 0000-0002-9431-6051
  email: enrique.feas@edu.uah.es, efeas@rielcano.org
type: package
preamble: |
  \usepackage{amsmath} \usepackage{framed} \usepackage{mathtools} \usepackage{cancel} \usepackage{tikz} \usepackage{tikz-qtree} \usetikzlibrary{trees}
output:
  rjtools::rjournal_web_article:
    self_contained: yes
    toc: no
bibliography: exvatools.bib
always_allow_html: yes
date_received: '2023-04-20'
volume: 15
issue: 4
slug: RJ-2023-092
journal:
  lastpage: 235
  firstpage: 216
draft: no

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(exvatools)
library(kableExtra)
library(DiagrammeR)
```

# Introduction

The analysis of trade in value added involves the use of international
input-output tables and intensive matrix manipulation. Some trade databases,
such as the OECD Trade in Value Added Database (TiVA), offer a web interface,
but cannot be customized and lack some key indicators developed in recent
literature, especially indicators of bilateral trade in value added and
participation in global value chains. This makes recourse to raw data almost
inevitable and creates the need for software capable of performing complex
matrix analysis in a user-friendly environment.

This is the gap \CRANpkg{exvatools} pretends to fill. It has been designed as a
package for **R** with a triple purpose: as an international input-output table
general analysis tool (with commands to extract raw data and produce and
manipulate large matrices), as a way to decompose value added in exports using
alternative methodologies, and as a tool to easily produce complex tailor-made
value added indicators with flexible sector and geographical customization.

To our knowledge, there are no equivalent software tools available. There are
some input-out analysis tools, like \CRANpkg{ioanalysis}
[@wade_ioanalysis_2020], but they cannot properly handle OECD's ICIO-type data
(with some countries divided in industrial areas). The package \CRANpkg{decompr}
[@quast_decompr_2015] produces a decomposition of value added in exports, but
only according to the methodology of @wang_quantifying_2013.

Outside of the **R** ecosystem, the module `icio` [@belotti_icio_2021] for the
software **Stata** [@statacorp_stata_2021] provides the more modern (and
methodologically sounder) decomposition method of @borin_measuring_2023.
However, `icio` is a closed-source module, it does not allow complex sector
analysis and customization, direct handling of input-output tables nor detailed
decompositions (for instance, distinguishing between value added exported
induced by inputs and by final goods).

\CRANpkg{exvatools} can therefore be used as all-purpose tool, both to
facilitate the extraction and manipulation of input-output matrices and to
obtain detailed and customized indicators of trade in value added, facilitating
research on global value chains, globalization, and its economic effects. In the
following sections, we will describe the methodological background of
\CRANpkg{exvatools}, in particular the international input-output table
framework and its use to calculate value added induced by gross exports. Then we
will explain the creation of the three basic objects of \CRANpkg{exvatools}: a
list of basic input-output tables (the `wio` class), a list with the different
matrix components of a decomposition of value added in exports (the `exvadec`
class) and a list with a detailed origin and destination of value added (the
`exvadir` class). We will then explain the commands to fully exploit the
information included in the aforementioned classes. Along the way we will
produce examples of use.

\CRANpkg{exvatools} can be installed from the CRAN repository and made
available for the current session following the usual procedure:

```{r eval=FALSE, echo=TRUE}
install.packages("exvatools")
library(exvatools)
```

# Background methodology

## The international input-output framework

Analyzing the value added in exports requires the previous extraction of a
series of basic input-output matrices in a standardized format. We will consider
a typical international input-output framework with $G$ countries and $N$
sectors. Each country $s$ provides goods and services from each sector $i$ to
each sector $j$ in country $r$, and sources its goods and services from the
sectors of each country $t$.

```{=latex}
\begin{table}[h]
	\centering
	\caption{\label{tab:iot}Structure of an international Input-Output Table}
	\begin{tabular}{|lc|c|c|c|c|c|c|c|c|c|}
		\hline
		\multicolumn{2}{|r|}{Output}
		& \multicolumn{4}{|c|}{Intermediate uses}
		& \multicolumn{4}{|c|}{Final uses}
		& Output \\ \cline{3-10}
		\multicolumn{2}{|l|}{Input} & 1 & 2 & ... & $G$
		& 1 & 2 & ... & $G$ & ~ \\ \hline
		~ & 1 & $\mathbf{Z}_{11}$ & $\mathbf{Z}_{12}$ & ... & $\mathbf{Z}_{1G}$ &
		$\mathbf{Y}_{11}$ & $\mathbf{Y}_{12}$ & ... & $\mathbf{Y}_{1G}$
		& $\mathbf{X}_{1}$ \\
		Intermediate & 2 &
		$\mathbf{Z}_{21}$ & $\mathbf{Z}_{22}$ & ... & $\mathbf{Z}_{2G}$ &
		$\mathbf{Y}_{21}$ & $\mathbf{Y}_{22}$ & ... & $\mathbf{Y}_{2G}$ &
		$\mathbf{X}_{2}$ \\
		inputs & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
		~ & $G$ & $\mathbf{Z}_{G1}$ & $\mathbf{Z}_{G2}$ & ... & $\mathbf{Z}_{GG}$
		& $\mathbf{Y}_{G1}$ & $\mathbf{Y}_{G2}$ & ... & $\mathbf{Y}_{GG}$ &
		$\mathbf{X}_{G}$ \\ \hline
		Value added & ~ & $\mathbf{VA}_{1}$ & $\mathbf{VA}_{2}$ & ... &
		$\mathbf{VA}_{G}$ \\ \cline{1-6}
		Input & ~ & $\mathbf{X}_{1}$ & $\mathbf{X}_{2}$ & ...
		& $\mathbf{X}_{G}$  \\ \cline{1-6}
	\end{tabular}
\end{table}
```

```{r iotable, include=knitr::is_html_output(), eval=knitr::is_html_output()}
df <- data.frame(C1 = c("**Input**", " ", "**Intermediate**", "**inputs**",
                        " ", "**Value Added**", "**Input**"),
                 C2 = c(" ", "$1$", "$2$", "...", "$G$", " ", " "),
                 C3 = c("$1$", "$\\mathbf{Z}_{11}$", "$\\mathbf{Z}_{21}$",
                           "$\\dots$", "$\\mathbf{Z}_{G1}$",
                           "$\\mathbf{VA}_{1}$", "$\\mathbf{X}_{1}$"),
                 C4 = c("$2$", "$\\mathbf{Z}_{12}$", "$\\mathbf{Z}_{22}$",
                           "$\\dots$", "$\\mathbf{Z}_{G2}$",
                           "$\\mathbf{VA}_{2}$", "$\\mathbf{X}_{2}$"),
                 C5 = c("$\\dots$", "$\\dots$", "$\\dots$", "$\\dots$",
                            "$\\dots$", "$\\dots$", "$\\dots$"),
                 C6 = c("$G$", "$\\mathbf{Z}_{G1}$", "$\\mathbf{Z}_{G2}$",
                           "$\\dots$", "$\\mathbf{Z}_{GN}$",
                           "$\\mathbf{VA}_{G}$", "$\\mathbf{X}_{G}$"),
                 C7 = c("$1$", "$\\mathbf{Y}_{11}$", "$\\mathbf{Y}_{21}$",
                           "$\\dots$", "$\\mathbf{Y}_{G1}$", " ", " "),
                 C8 = c("$2$", "$\\mathbf{Y}_{12}$", "$\\mathbf{Y}_{22}$",
                           "$\\dots$", "$\\mathbf{Z}_{G2}$", " ", " "),
                 C9 = c("$\\dots$", "$\\dots$", "$\\dots$", "$\\dots$",
                            "$\\dots$", " ", " "),
                 C10 = c("$G$", "$\\mathbf{Y}_{G1}$", "$\\mathbf{Y}_{G2}$",
                           "$\\dots$", "$\\mathbf{Y}_{GN}$", " ", " "),
                 C11 = c(" ", "$\\mathbf{X}_{1}$", "$\\mathbf{X}_{2}$",
                           "$\\dots$", "$\\mathbf{X}_{G}$", " ", " ")
                 )
kableExtra::kbl(df, 
   format = "html",
   caption = "Input-Output Table",
   col.names = NULL, align = rep("c", 11)) %>%
  add_header_above(c(" ", "Output", "Intermediate uses" = 4,
                     "Final uses" = 4, "Output"), line = TRUE) %>%
  column_spec(3:11, border_left = TRUE)
```

In a typical international input-output table (which is a matrix composed of
block matrices) $\mathbf{Z}$ is the matrix of intermediate inputs (dimension $GN
\times GN$), with each sub-matrix $\mathbf{Z}_{sr}$ (dimension $N \times N$)
elements $z_{sr}^{ij}$ representing the deliveries of intermediate inputs from
sector $i$ in country $s$ to sector $j$ in country $r$. $\mathbf{Y}$ is the
matrix of final demand, of dimension $GN \times G$ (aggregated by country for
practical purposes from an original $\mathbf{Yfd}$ matrix with $FD$ demand
components). $\mathbf{X}$ is the production matrix, of dimension $GN \times 1$,
and $\mathbf{VA}$ the value added demand, of dimension $1 \times GN$.

## The demand model

The typical demand model, which dates back to
@leontief_quantitative_1936, assumes that the inputs from sector $i$ of country
$s$ to sector $j$ of country $r$ are a constant proportion of the output of
sector $j$ in country $r$. From there we obtain a matrix of coefficients
$\mathbf{A}$ whose elements are the proportion of intermediate inputs over total
production, $a_{sr}^{ij} = z_{sr}^{ij} / {x_{r}^{j}}$. Then the relations in the
international input-output table can be expressed as
$\mathbf{AX}+\mathbf{Y}=\mathbf{X}$, from where we deduct a relation between
production and final demand:

\begin{equation}
  \mathbf{X}=\left(\mathbf{I}-\mathbf{A}\right)^{-1}\mathbf{Y}=\mathbf{BY}
   (\#eq:XBY)
\end{equation}

Here the matrix $\mathbf{B}$ (inverse of $\mathbf{I} -\mathbf{A}$, where
$\mathbf{I}$ is the identity matrix) collects the backward linkages that the
final demand $\mathbf{Y}$ induces on production. Each element of $\mathbf{B}$,
$b_{sr}^{ij}$, can be expressed as the increase of production of sector $i$ in
country $s$, when the final demand of sector $j$ in country $r$ increases by one
unit.

## Value added in trade

If the ratio between inputs and production is constant, then the ratio between
value added (i.e., the value of production minus the value of inputs) and
production can also be considered constant, so we can define vector $\mathbf{V}$
as the value added by unit of output $\mathbf{X}$ and express the value added in
terms of global demand as $\mathbf{V} \mathbf{X} = \mathbf{V} \mathbf{BY}$. More
specifically, for a given country $s$:

\begin{equation}
  \mathbf{V}_s \mathbf{X}_s =
	\mathbf{V}_s \sum_{j}^{G}\sum_{r}^{G}{\mathbf{B}_{sj} \mathbf{Y}_{jr}}
	(\#eq:VBY)
\end{equation}

that we can break down into the value added produced and absorbed in $s$ and the
value added produced in $s$ and absorbed abroad:

\begin{equation}
  \mathbf{V}_s \sum_{j}^{G}{\mathbf{B}_{sj}\mathbf{Y}_{js}} +
	\mathbf{V}_s \sum_{j}^{G} \sum_{r\neq s}^{G} {\mathbf{B}_{sj}\mathbf{Y}_{jr}}
	(\#eq:VADVAX)
\end{equation}

The second term in \@ref(eq:VADVAX) is usually referred to as value added
exported ${\mathbf{VAX}}_s$ [@johnson_accounting_2012]. In aggregated terms,
value added absorbed abroad coincides with value added exported, but this is not
true in bilateral terms. In fact, ${\mathbf{VAX}}_{sr}$ is the value added
produced in $s$ and absorbed in $r$, but *regardless of the export destination*.
To obtain the value added exported to $r$ *regardless of the absorption country*
we need to calculate the value added induced not by final demand, but by the
demand of gross exports.

For that, knowing that each column of the matrix product 
$\mathbf{V} \mathbf{B}$ is a linear combination whose sum is a unit vector
$\boldsymbol{\iota}$, we can break down the linkage effects over the production
of any country $s$ into those derived of domestic inputs and those derived of
foreign components.

\begin{equation}
	\boldsymbol{\iota} = \sum_{t}^{G}{{\mathbf{V}}_t\mathbf{B}_{ts}} =
	{\mathbf{V}}_s \mathbf{B}_{ss} + \sum_{t\neq s}^{G}
	{{\mathbf{V}}_t\mathbf{B}_{ts}}
	 (\#eq:sumVB)
\end{equation}

If we multiply both terms of equation \@ref(eq:sumVB) by the demand of gross
exports of country $s$, $\mathbf{E}_s$, we obtain a basic decomposition of the
content of value added in exports into domestic and foreign content.

\begin{equation} 
	\boldsymbol{\iota} \mathbf{E}_{s}
	= \sum_{t}^{G} {{\mathbf{V}}_t\mathbf{B}_{ts}\mathbf{E}_{s}}
	= {\mathbf{V}}_s \mathbf{B}_{ss} \mathbf{E}_{s} +
	\sum_{t\neq s}^{G}{{\mathbf{V}}_t \mathbf{B}_{ts} \mathbf{E}_{s}}
	(\#eq:content)
\end{equation}

Expression \@ref(eq:content) reflects that the demand of gross exports of $s$
can only be satisfied with domestic value added or with foreign value added
(with inputs being value added of other sectors). This is also valid for the
bilateral exports of $s$, $\mathbf{E}_{sr}$ (the sum being in this case the
total gross bilateral exports).

We have so far overlooked the sector distribution of exports. It we wanted to
preserve the sector information, we should use a diagonalized version of matrix
$\mathbf{V}$, $\hat{\mathbf{V}}$, with the resulting product $\hat{\mathbf{V}}
\mathbf{B}$ reflecting the sector of origin of value added. If we opted instead
(as it normally the case) to reflect the value-added exporting sector, then the
products ${\hat{\mathbf{V}}}_s \mathbf{B}_{ss}$ and ${\hat{\mathbf{V}}}_t
\mathbf{B}_{ts}$ should be diagonalized as $\widehat{{\mathbf{V}}_s
\mathbf{B}_{ss}}$ and $\widehat{{\mathbf{V}}_t \mathbf{B}_{ts}}$, respectively.

The decomposition of value added in exports essentially consists in
analyzing the elements of Equation \@ref(eq:content), extracting the elements
that are not really value added (double counted) as well as those that are
not really exports (flows eventually re-imported and absorbed domestically).

# Creating and manipulating input-output matrices

## Usage

The basic matrices of a Leontief demand-induced model can be easily obtained
from raw data with the command `make_wio()`:

```{r echo=TRUE, eval=FALSE}
make_wio(wiotype = "icio2023", year = NULL, 
         src_dir = NULL, quiet = FALSE)
```

where:

* `wiotype` is a string specifying the type of international input-output table
  to be used (and therefore the source zip file to be looked for in the source
  directory `src_dir`).
* `year` is an integer specifying the reference year. If missing, `make_wio()`
  will use the last available year for that database (e.g., 2020 for 
  `"icio2023"` or 2014 for `"wiod2016"`).
* `src_dir` is the source directory where the raw data is located. If data is
  stored in the current working directory, this argument can be omitted.
* `quiet` is a boolean, with `TRUE` opting for a silent output.

## Source data

\CRANpkg{exvatools} produces basic input-output tables from three types 
of data: public international input-output databases, custom data and
sample data.

Public international input-output databases can be directly downloaded from the
web pages of their respective institutions. Three sources are currently 
supported:
  
  * OECD Inter-Country Input-Output (ICIO) tables [@oecd_oecd_2023], on which 
    the OECD's Trade in Value Added database (TiVA) is based,
  * World Input Output Database (WIOD) tables [@timmer_illustrated_2015].
  * FIGARO EU Input-Output Tables (EU IC-SUIOTs) [@remond-tierrez_eu_2019]
  
The default `wiotype` is `"icio2023"`, corresponding to the OECD ICIO Tables,
version 2023 (years 1995 to 2020), available as zip files that can be downloaded
from the [ICIO web
page](https://www.oecd.org/sti/ind/inter-country-input-output-tables.htm). Older
versions of OECD ICIO (`"icio2021"`, `"icio2018"` and `"icio2016"`) are provided
for backward compatibility (for example, to reproduce examples in literature
using those databases). For WIOD Tables, versions included are `"wiod2016"`
(version 2016, years 2000 to 2014), `"wiod2013"` and `"lrwiod2022"` (long-run
WIOD tables, version 2022, for years 1965 to 2000). All of them are available at
the University of Groningen's [Growth and Development Centre web
page](https://www.rug.nl/ggdc/valuechain/wiod/). FIGARO tables, whether
industry-by-industry (`"figaro2022i"`) or product-by-product (`"figaro2022p"`)
are available at the [Eurostat web
page](https://ec.europa.eu/eurostat/web/esa-supply-use-input-tables/database).

The advantage of these databases is threefold: they are widely used in the
economic literature, they are quite rich in terms of countries and sectors, and
they are directly downloadable from the web page of their supporting
institutions, typically as zipped files containing comma-delimited files
(`.csv`), Excel files (`.xlsx`) or R data files (`.RData`). In any case,
\CRANpkg{exvatools} can be easily extended to other available international
input-output databases like the Eora database [@lenzen_building_2013] or the ADB
Multi-Regional Input Output (ADB-MRIO) Database
[@asian_development_bank_multiregional_2023].

For instance, if we want to use \CRANpkg{exvatools} with the 2023 edition of the
OECD ICIO tables (with data up to 2020), we must first download the source file
"ICIO_2016-2020-extended.zip" (92 MB) from the [ICIO web
page](https://www.oecd.org/sti/ind/inter-country-input-output-tables.htm). Then
we will use the command `make_wio()`, specifying the edition, the year and the
folder where the source zip file is saved (just the directory). For instance, if
the file was located in `C:\Users\Username\Documents\R` and we wanted the year
2020:

```{r make_wio, eval=FALSE, echo=TRUE}
wio <- make_wio("icio2023", year = 2020, 
                src_dir = "C:/Users/Username/Documents/R")
```

and \CRANpkg{exvatools} will take care of the rest: it will extract the 
`.csv` files from the zip file and produce the basic input-output matrices.

Alternatively, \CRANpkg{exvatools} can use custom data to create basic
input-output matrices. In this case, we just need as input a numeric matrix or
data frame with the intermediate inputs $\mathbf{Z}$ and the final demand
$\mathbf{Yfd}$, plus a vector with the names of the countries. In this case, we
will use an alternative command, `make_custom_wio()`.

```{r make_custom_wio, echo=TRUE, eval=FALSE}
wio <- make_custom_wio(df, g_names = c("C01", "C02", "C03"))
```

If we just want to check the features of \CRANpkg{exvatools}, there is no need
to download any data. The package includes two sets of fictitious data, 
`wiotype = "iciotest"` (an ICIO-type data sample, with Mexico and China 
disaggregated) and `wiotype = "wiodtest"` (a WIOD-type data sample). Both can
be directly used in `make_wio()`, with no need to specify year or source 
directory.

As the dimension of publicly available input-output matrices is big, 
here  we will use here ICIO-type fictitious data made with
`make_wio("iciotest")`.

```{r make_wio_test, echo=TRUE, message=FALSE}
wio <- make_wio("iciotest")
```

The newly created `wio` class, which can be easily checked with `summary(wio)`,
includes the following elements:

  * $\mathbf{Z}$, the $GN \times GN$ matrix of intermediate inputs.
    $\mathbf{Zd}$ is the matrix of domestic intermediate inputs (diagonal block
    matrix of $\mathbf{Z}$) and $\mathbf{Zm}$ the matrix of international
    intermediate inputs, exported or imported (off-diagonal block matrix of
    $\mathbf{Z}$).
  * $\mathbf{A}$, the $GN \times GN$ coefficient matrix. $\mathbf{Ad}$ is
    the coefficient matrix of domestic inputs (diagonal block matrix of
    $\mathbf{A}$) and $\mathbf{Am}$ the matrix of exported or imported inputs
    (off-diagonal block matrix of $\mathbf{A}$).
  * $\mathbf{B}$, the $GN \times GN$ global inverse Leontief matrix.
    $\mathbf{Bd}$ is the global Leontief matrix for domestic linkage effects
    (diagonal block matrix) and $\mathbf{Bm}$ is the global Leontief matrix 
    for international linkage effects (off-diagonal block matrix), in both 
    cases using both domestic and international inputs.
  * $\mathbf{Ld}$, the $GN \times GN$ local inverse Leontief matrix
    reflecting domestic linkage effects using only domestic inputs.
  * $\mathbf{VA}$, the $GN \times 1$ value added vector matrix.
  * $\mathbf{X}$, the $GN \times 1$ production vector matrix.
  * $\mathbf{V}$, the $GN \times 1$ vector reflecting the value-added
    share of production ($\mathbf{VA}/\mathbf{X}$). $\mathbf{W}$ is the diagonal
    matrix of $\mathbf{V}$ (usually expressed as $\hat{\mathbf{V}}$).
  * $\mathbf{Yfd}$, the $GN \times GFD$ full demand matrix (with final
    demand components by country in columns); $\mathbf{Y}$, the $GN \times G$
    final demand matrix, with aggregated total demand by country in columns;
    $\mathbf{Yd}$ is the domestic final demand (diagonal block matrix of
    $\mathbf{Y}$) and $\mathbf{Ym}$ the foreign final demand (non-diagonal block
    matrix of $\mathbf{Y}$).
  * $\mathbf{EXGR}$, the $GN \times G$ total gross bilateral exports
    matrix. $\mathbf{E}$ is the $GN \times GN$ diagonal matrix of aggregated
    total exports (also shown sometimes as $\hat{\mathbf{E}}$).

Additionally, the main dimensions are provided in the list `dims`,
such as the number of countries $G$, the number of countries including
disaggregated countries $GX$, the number of sectors $N$, the number of final
demand components $FD$, or combinations thereof ($GN$, $GXN$, $GFD$). A list
`names` is also provided, including the names of countries (ISO codes of
3 characters), the names of sectors, (from D01 to D99 for tables based in ISIC
revision 4, and from C01 to C99 for tables based in ISIC revision 3), the
names of demand components, and two additional metadata: the type of source
database (`"icio2023"`, `"wiod2016"`, etc.) and the `year`.

## Commands for input-output matrix manipulation

Although \CRANpkg{exvatools} was initially conceived as a trade analysis
software, it also includes a series of commands that facilitate the manipulation
of international input-output tables for any other purposes. Thus, we can
multiply a diagonal matrix by an ordinary one with `dmult()`, an ordinary by a
diagonal with `multd()`, or make a block-by-block Hadamard product of matrices
with `hmult()`. We can also easily obtain a block diagonal matrix with `bkd()`,
a block off-diagonal matrix with `bkoffd()`, or a diagonal matrix with the sums
of all columns with `diagcs()`.

Additionally, as \CRANpkg{exvatools} always operates with named rows and columns
(names of countries and sectors), several commands are included to consolidate
matrices, preserving the matrix format and optionally providing names for the
resulting rows or columns: `rsums()` to sum rows, `csums()` to sum columns,
`sumnrow()` to sum every *nth* row of a matrix, `sumncol()` to sum every *nth*
column, `sumgrows()` to sum groups of rows of a particular size, `sumgcols()` to
do the same with columns, etc.

On the other hand, the OECD ICIO tables have a particular feature: two big
industrial countries, China and Mexico, are broken down into two regions each.
Calculations must initially be done with disaggregated data, but later 
consolidated under the name of the country. The command `meld()` takes 
care of that.

Let us, for instance, check that the production $\mathbf{X}$ is equivalent to
the product of the global Leontief inverse matrix $\mathbf{B}$ and the final
demand $\mathbf{Y}$:

```{r BY, echo=TRUE}
BY <- wio$B %*% wio$Y
```

We can sum the rows (with `rsums()`, naming the result as `"BY"`) and check that
it coincides with the production vector:

```{r check_BY, echo=TRUE}
BY <- rsums(BY, "BY")
print(cbind(head(BY, 10), head(wio$X, 10)))
```

Now let us calculate the value added absorbed abroad. For that we need to
multiply the value added coefficients matrix $\hat{\mathbf{V}}$ (represented
here as $\mathbf{W}$) by the global inverse matrix $\mathbf{B}$ by the final
demand matrix $\mathbf{Y}$, and then exclude the value added absorbed
domestically. This can be easily done with a few commands.

To calculate all value added induced by final demand:

```{r VBY, echo=TRUE}
VBY <- dmult(wio$W, wio$B) %*% wio$Y
VBY
```

The rows for Mexico and China are disaggregated. We can easily meld
them with `meld()`:

```{r meld_VBY, echo=TRUE}
VBY <- meld(VBY)
VBY
```

We just want the value added absorbed abroad. For that we need the block
off-diagonal matrix of $\mathbf{\hat{V}BY}$, that we can produce with
`bkoffd()`:

```{r bkoffd_VBY, echo=TRUE}
vax <- bkoffd(VBY)
head(vax, 10)
```

# Decomposition of value added in exports

## Methodology: extracting double counting and re-imports

Equation \@ref(eq:content) showed a basic decomposition of the value of gross
exports into its domestic and foreign content. However, matrix $\mathbf{B}$ in
that equation is the result of successive rounds of production induced by
demand, therefore incurring in double counting. To differentiate between true
value added and double counting we must specify a spatial perimeter and a
sequential perimeter. The spatial perimeter (or perspective) will delimit the
border that has to be crossed a specific number of times for a transaction to be
considered as value added, and the the sequential perimeter (or approach) will
delimit the number of border crossings for a transaction to be considered as
value added.

The most consistent decomposition methods employ for the spatial perimeter the
exporting country's border (country perspective) and for the sequential
perimeter the first border crossing (source-based approach). As a result,
export flows are considered as value added *the first time* they cross
*the exporting country's border*, with ulterior flows being considered as
double counting.

Once we have identified export flows that are double counted (and therefore do
not constitute real value added), we must also differentiate the export flows
that eventually return to be absorbed in the exporting country (and therefore do
not constitute true exports). The methodology to calculate value added in
exports is not univocal, and has led to a considerable amount of discussion in
the past few years, following @daudin_who_2011; @johnson_accounting_2012;
@foster-mcgregor_value_2013; @wang_quantifying_2013;
@koopman_tracing_2014; @los_tracing_2016 and
@los_measuring_2018; @nagengast_accounting_2016;
@johnson_measuring_2018; @arto_measuring_2019; @miroudot_decomposing_2021 and
@borin_measuring_2023.

The most recent decomposition methods, including those of @borin_measuring_2023
or @miroudot_decomposing_2021, involve the calculation of a coefficient matrix
$\mathbf{A}$ that excludes the linkage effects of exported inputs. Thus, for a
given country $s$ we will define an extraction matrix $\mathbf{A}^{xs}$ as a
global coefficient matrix whose coefficients corresponding to the exports of
inputs of $s$ are equal to zero.

\begin{equation}
	\mathbf{A}^{xs}
	=
	\left[
	\begin{matrix}
  	\mathbf{A}_{11} &
  	\mathbf{A}_{12} &
  	\cdots &
  	\mathbf{A}_{1s} &
  	\cdots &
  	\mathbf{A}_{1G} \\
  	\mathbf{A}_{21} &
  	\mathbf{A}_{22} &
  	\cdots &
  	\mathbf{A}_{2s} &
  	\cdots &
  	\mathbf{A}_{2G} \\
  	\vdots & \vdots & \ddots & \vdots & \vdots & \vdots \\
  	0 &
  	0 &
  	\cdots &
  	\mathbf{A}_{ss} &
  	\cdots &
  	0 \\
  	\vdots & \vdots & \vdots & \vdots & \ddots & \vdots \\
  	\mathbf{A}_{G1} &
  	\mathbf{A}_{G2} &
  	\cdots&
  	\mathbf{A}_{Gs}&
  	\cdots&
  	\mathbf{A}_{GG} \\
	\end{matrix}
	\right]
	(\#eq:Anots)
\end{equation}

The global inverse Leontief matrix $\mathbf{B}^{xs}$ derived of this
extraction matrix will collect the value added induced by exports excluding
intermediate goods. Therefore, the double counting will be the difference 
between the Leontief inverse global matrix $\mathbf{B}$ and the Leontief
inverse global extraction matrix $\mathbf{B}^{xs}$, from where we can break
down the components of equation \@ref(eq:content) into the domestic value added 
${\mathbf{V}}_s \mathbf{B}^{xs}_{ss} \mathbf{E}_{sr}$, the 
double counted domestic value added 
${\mathbf{V}}_s (\mathbf{B}_{ss} - \mathbf{B}^{xs}_{ss}) \mathbf{E}_{sr}$,
the foreign value added
$\sum_{t\neq s}^{G}{{\mathbf{V}}_t \mathbf{B}^{xs}_{ts} \mathbf{E}_{sr}}$,
and the foreign double counting 
$\sum_{t\neq s}^{G}{{\mathbf{V}}_t 
(\mathbf{B}_{ts} - \mathbf{B}^{xs}_{ts}) \mathbf{E}_{sr}}$

Then, after expressing exports in terms of final demand, we we will be able to
separate the exports that eventually return home to be absorbed, called
reflection. Figure \@ref(fig:decomposition) shows the process carried out by
`make_exvadec()`, first separating Domestic Content (DC) and Foreign Content
(FC), then identifying Domestic Value Added (DVA) and Foreign Value added (FVA),
separating them from Domestic Double Counting (DDC) and Foreign Double Counting
(FDC), and finally dividing Domestic Value Added between Value Added Exported
(VAX) and Reflection (REF).

<!-- For HTML -->
```{r decomposition, include=knitr::is_html_output(), fig.cap="Decomposition of value added in gross exports"}
grviz_code <- 
"
digraph boxes_and_circles {

  # a 'graph' statement
  graph [overlap = true, fontsize = 6, rankdir = LR]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  A [label = 'Gross\nExports\n(EXGR)'];
  B [label = 'Domestic\nContent\n(DC)']
  C [label = 'Foreign\nContent\n(FC)']
  D [label = 'Domestic\nValue Added\n(DVA)']
  E [label = 'Domestic\nDouble Counting\n(DDC)']
  F [label = 'Foreign\nValue Added\n(VA)']
  G [label = 'Foreign\nDoble Counting\n(FDC)']
  H [label = 'Value Added\nExported\n(VAX)']
  I [label = 'Reflection\n(REF)']
  B; C; D; E; F; G; H; I

  # several 'edge' statements
  A->B A->C B->D B->E C->F
  C->G D->H D->I
}
"
chart <- DiagrammeR::grViz(grviz_code)
chart
```

<!-- For LaTeX -->
```{=latex}
\begin{figure}
\centering
\caption{Decomposition of the value added embodied in exports}
\label{fig:decomposition}
  \begin{tikzpicture}
  %Source https://tikz.net/product-architecture/
  %Define the function structure
  \tikzset{
    grow'=right,level distance=25mm, sibling distance =3.5mm,
    execute at begin node=\strut,
    every tree node/.style={
  			draw,
  			rounded corners,
  			anchor = west,
  			minimum width=20mm,
  			text width=18mm,
  			align=center,
  			font = {\scriptsize}},
           edge from parent/.style={draw, edge from parent fork right}
  }
  %Draw the function structure (top to bottom)
  %distance from root: width of tree
  \begin{scope}[frontier/.style={distance from root=75mm}]
  \Tree
  [.{Gross \\ Exports \\ (EXGR)}
  		[.{Domestic \\ Content \\ (DC)}
  			[.{Domestic \\ Value Added \\ (DVA)}
  			\node(f1){Value Added \\ Exported \\ (VAX)};
  			\node(f2){Reflection \\ (REF)};
  			]
  			\node(f4){Domestic \\ Double Counting (DDC)};
  		]
  		[.{Foreign Content \\ (FC)}
  			[.{Foreign \\ Value Added \\ (FVA)}
  			]
  			[.{Foreign \\ Double Counting \\ (FDC)}
  			]
  		]
  ]
  \end{scope}
  \end{tikzpicture}
  (\#fig:decomposition)
\end{figure}
```

Using these indicators (or parts thereof) we can obtain additional indicators to
measure the participation of countries in global value chains, whether in the
form of foreign inputs used in the domestic production of exports (backward
vertical specialization) or in the form of domestic inputs exported to be used
in the production of foreign exports (forward vertical specialization). In case
these indicators are available, the denomination will be global value chain
participation (GVC), divided in global value chain participation backwards
(GVCB) and forward (GVCF).

## Usage

The command `make_exvadec()` (export value added decomposition) provides, from a
`wio` object, the full decomposition of the value added in exports for every
country or for a particular country or country group, according to different
methodologies. The command syntax is as follows:

```{r echo=TRUE, eval=FALSE}
make_exvadec(wio_object, exporter = "all", method = "bm_src",
             output = "standard", quiet = TRUE)
```

with the following arguments:

* `wio_object` is an object of class `wio` obtained through the
  command `make_wio`.
* `exporter` is a string with the code for the exporting country.
  Default is `"all"` (producing an output of dimension $GN \times G$), but
  can be the code of a country, e.g., `"ESP"`, or country group, e.g.,
  `"EU27"` (producing an output of dimension $N \times G$).
* `method` is a string specifying the decomposition method.
* `output` is a string specifying the desired output type.
* `quiet` is a boolean indicating whether to produce output silently (default is
  `FALSE`).

The available methods and outputs are summarized in Table
\@ref(tab:methodoutput). Selecting `"bm_src"` will produce a
@borin_measuring_2023 source-based decomposition (from our point of view, 
the most methodologically sound), `"bm_snk"` a @borin_measuring_2023 sink-based
decomposition, `"my"` a @miroudot_decomposing_2021 decomposition, `"wwz"` a 
@wang_quantifying_2013 decomposition, `"kww"` a @koopman_tracing_2014 
decomposition and `"oecd"` a basic OECD decomposition.

```{r methodoutput}
if (knitr::is_html_output()) {
  df <- data.frame(Method = c("`bm_src`", "`bm_snk`", "`my`", 
                            "`wwz`", "`kww`", "`oecd`"),
                 Description = c("Borin and Mancini (2019), source",
                                 "Borin and Mancini (2019), sink",
                                 "Miroudot and Ye (2021)",
                                 "Wang et al. (2013)",
                                 "Koopman et al. (2014)",
                                 "OECD (2021) (not a decomposition)"),
                 Perimeters = c("Source-based approach, various perspectives",
                              "Sink-based approach, country perspective",
                              "Source-based approach, various perspectives",
                              "Mix of both",
                              "Sink-based approach, mixed perspective",
                              "Not applicable"),
                 Outputs = c("`basic`, `standard`, `terms`",
                            "`standard`, `terms`",
                            "`standard`, `terms`, `terms2`",
                            "`standard`, `terms`, `terms2`",
                            "`standard`, `terms`",
                            "`standard`, `terms`, `tiva`"))
  knitr::kable(df,
               caption = "`make_exvadec()` output")
}

```


```{=latex}
 \begin{table}[h]
  \small
  \centering
  \caption{Output}
  \label{tab:methodoutput}
  \begin{tabular}{llll}
     \hline
     Decomposition & Description & Perimeters & \code{output} options \\
     \code{method} & ~ & (approach/perspective) & ~ \\ \hline
     \code{"bm\_src"} & Borin and Mancini & Source-based /
     & \code{"basic"}, \code{"standard"}, \\
     ~ & (2019) source-based  & various & \code{"terms"} \\ \hline
     \code{"bm\_snk"} & Borin and Mancini & Sink-based /
     & \code{"standard"}, \code{"terms"} \\
     ~ & (2019) sink-based & exporting country & ~ \\ \hline
     \code{"my"} & Miroudot and Ye & Source-based /
     & \code{"standard"}, \code{"terms"} \\
     ~ & (2021) source-based  & various & \code{"terms2"} \\ \hline
     \code{"wwz"} & Wang et al. (2013) & Mix of both
     & \code{"standard"}, \code{"terms"}, \\
     ~ & ~ & ~ & \code{"terms2"} \\ \hline
     \code{"kww"} & Koopman et al. & Sink-based /
     & \code{"standard"}, \code{"terms"}, \\
     ~ & (2014) & mixed & ~ \\ \hline
     \code{"oecd"} & OECD TiVA (not & Not applicable
     & \code{"standard"}, \code{"terms"}, \\
     ~ & a decomposition) & ~ & \code{"tiva"} \\ \hline
  \end{tabular}
\end{table}
```

The `"standard"` output of `make_exvadec()` will include a series of matrices of
dimension $GN \times G$ (when exporter is `"all"`) or of dimension $N \times G$
(when the exporting country is specified, e.g., `"USA"`), with breakdown by
exporting country and sector, and by importer (country of destination), plus
additional metadata:

  * $\mathbf{EXGR}$, total gross exports by country and exporting sector 
  and by country of destination.
  * $\mathbf{DC}$, total domestic content in exports by exporting sector 
  and country of destination.
  * $\mathbf{DVA}$, domestic value added (including value added that
  returns home).
  * $\mathbf{VAX}$, or value added effectively exported.
  * $\mathbf{REF}$, or reflection, value added that is eventually absorbed 
  in the exporting country and therefore does not constitute real exports.
  * $\mathbf{DDC}$, or domestic double counting, or flows of value added 
  that are reexported after passing a second time for the exporting country 
  and therefore nor constituting real value added.
  * $\mathbf{FC}$, total foreign value added content in exports
  (including double counting).
  * $\mathbf{FVA}$, foreign value added, excluding double counting.
  * $\mathbf{FDC}$, foreign double content, or flows of foreign value added 
  that have passed more than once by the exporting country, therefore already
  computed.

In some cases, indicators reflecting the participation in global value chains
(vertical specialization) will be provided, mainly foreign value added that
eventually takes part in the domestic production of exports ($\mathbf{GVCB}$ or
global value chain participation backwards) or domestic value added that
eventually takes part in the foreign production of exports ($\mathbf{GVCF}$ or
global value chain participation forward).

`exvadec` objects will inherit metadata of the `wio` object they come from, like
`dims`, `names`, or `source` (`type`), plus the indication of the decomposition
`method` used and, in case of individual decompositions, the `exporter`. The
`"standard"` output should be enough for most analyses, but alternative outputs
can be specified with the argument `output`. The option `"terms"` will show all
the elements of the decomposition (whose sum is the total value of gross
exports), which is useful if we need to distinguish the value added induced by
intermediate outputs. The @wang_quantifying_2013 decomposition corresponds with
the terminology of their Table A2 (pg. 35), but an additional `"terms2"` is
provided (with the terminology of their Table E1, pg. 61).

The `"kww"` and `"wwz"` methods are, in fact, a mix of perspectives and
approaches. The exporting country perspective and the source approach should
probably be considered as the standard, but some alternative approaches (like
the sink approach, considering value added all flows prior to the last border
crossing) and various tailored perspectives are provided. Thus, the sector,
bilateral or bilateral-sector perspectives consider double counting all flows
out of those perimeters, and can be calculated for the `"bm_src"` and the `"my"`
methods (by using the additional arguments `partner` and `sector`).
Additionally, the `"my"` method allows a world perspective (using `perim =
"WLD"`), consider as double counting the crossing of *any* border more than
once, not only that of the exporting country.

We have included an additional decomposition called `"oecd"`, which is not a
true full decomposition method, but represents nevertheless a calculation of
several elements of value added in exports. It includes a `"tiva"` output to
show the most typical indicators included in the OECD TiVA database. In this
decomposition (unlike in the the rest), the bilateral VAX is just VAX absorbed
in the partner country.

## Examples

To create create a full decomposition of the value added in the exports of Spain
using the method of @borin_measuring_2023, using a exporting country perspective
and a source-based approach, we would type:

```{r make_exvadec_bm, echo=TRUE}
exvadec <- make_exvadec(wio, exporter = "ESP", method = "bm_src")
```

If we want to go deeper into the components of this value added,
differentiating between final and intermediate exports, we can use:

```{r make_exvadec_bm_terms, echo=TRUE}
exvadec.terms <- make_exvadec(wio, exporter = "ESP", 
                              method = "bm_src", output = "terms")
```

If we want to get a list of common trade indicators (exports,
imports, value added, production) similar to those of the TiVA database, we
could just use `make_exvadec()` with the method `"oecd"` and
`output = "tiva"`.

```{r make_tiva, echo=TRUE}
tiva <- make_exvadec(wio, exporter = "ESP", 
                     method = "oecd", output = "tiva")
```

# Direction (origin and destination) of value added

The decomposition of `make_exvadec()` does not distinguish between the different
sources of foreign value added. This is where the command `make_exvadir()` might
be useful. It provides data on the direction of value added, i.e., details of
both the geographical and sectoral origin of the value added incorporated in
exports and of the final destination (in gross terms or in terms of final
demand). It allows therefore a thorough analysis of where the value added is
generated and where it ends up (for instance, how EU services are important for
UK's exports of goods, or the role of China as intermediate party in the exports
of Russia).

## Methodology

The command `make_exvadir()` produces an output which is the result of
multiplying the value added matrix $\hat{\mathbf{V}}$ by the global Leontief
inverse matrix $\mathbf{B}$ by a matrix of exports $\mathbf{EXGR}$, but with a
high level of specification of the three matrices. First, the matrix
$\hat{\mathbf{V}}$ ($\mathbf{V}$ diagonalized, to preserve the sector
information) will be multiplied by a specific form of $\mathbf{B}$: regular
$\mathbf{B}$ to obtain the total value added content, $\mathbf{B}_d$ to obtain
the domestic value added content and $\mathbf{B_m}$ to obtain the foreign value
added content; or its equivalents in the form of extraction matrices
$\mathbf{B}^{xs}$ to obtain the total, domestic or foreign value added excluding
double counting, according to the methodology of
@borin_measuring_2023.

Then, depending of the sectoral perspective, the product $\hat{\mathbf{V}}
\mathbf{B}$ will be left as it is (sector of origin) or will be summed up by
columns and diagonalized, i.e., as $\widehat{\mathbf{VB}}$ (default option,
exporting sector perspective). The specification of sectors or countries of
origin of value added will be done by setting the non-specified values to zero.
If the exporter is a group of countries, there is the possibility of considering
intra-regional flows as exports or not (by default, intra-regional flows will be
excluded).

Finally, the resulting adjusted product ${\mathbf{VB}}$ will be multiplied by a
form of export matrix $\mathbf{EXGR}$. By default, the ordinary gross export
matrix will be considered, but the option will be given to express exports in
terms of absorption (i.e., final demand), as $\mathbf{EXGRY}$, giving in this
case the possibility of distinguishing between destination of final goods
($\mathbf{Y_m}$) and destination of intermediate exports processed as final
goods ($\mathbf{A_m B Y}$: this is the only way of calculating the value added
induced by intermediate exports).

Additionally, the possibility will be given to consider exports that go via a
specific country, i.e., an intermediate importer (for example, Russian exports
to the EU that go via China). If this is the case, $\widehat{\mathbf{VB}}$ will
be multiplied by $\mathbf{Y}_{sr} + \mathbf{A}_{sr}[\mathbf{BY}]_r$, with $s$ 
being the exporter and $r$ the intermediate importer, and $[\mathbf{BY}]_r$ 
the rows of product $\mathbf{BY}$ for country $r$), i.e., the exports of $s$
used in the production of $r$, that ends up in $r$ or exported elsewhere.

## Usage

The syntax of `make_exvadir()` is:

```{r echo=TRUE, eval=FALSE}
make_exvadir(wio_object, va_type = "TC", flow_type = "EXGR", exporter,
             via = "any", sec_orig = "all", geo_orig = "all",
             intra = FALSE, perspective = "exporter")
```

The arguments are as follows:

* `wio_object` is an object of class `wio` (required).
* `va_type` is a string describing the type of value added: `"TC"`,
  the default, is the total content in value added (matrix $\mathbf{B}$), both
  foreign and domestic, but we can also select `"DC"` (the domestic value
  added content, using matrix $\mathbf{B_d}$) or `"FC"` (the foreign value
  added content, using matrix $\mathbf{B_m}$). `"TVA"` is the total pure
  value added, i.e., excluding double counting (matrix
  $\mathbf{B}^{xs}$), and we can also get the `"DVA"` (domestic
  value added, excluding double counting, matrix $\mathbf{B_d}^{xs}$) or
  the `"FVA"` (foreign value added, excluding double counting, matrix
  $\mathbf{B_m}^{xs}$).
* `flow_type` is a string specifying the type of export flow. Default is
  gross total exports (`"EXGR"`). Alternatives are exports expressed
  in terms of final demand: total exports (`"EXGRY"`), final exports 
  (`"EXGRY_FIN"`) or intermediate exports (`"EXGRY_INT"`). The latter 
  options will show where value added exported is eventually absorbed,
  regardless of where it was initially exported.
* `exporter` is a string reflecting the code of the exporting country or
  group of countries.
* `via` is a string with the code of the intermediate importing country or
  country group. Default is `"any"`. This option requires flows to be expressed
  necessarily in terms of final demand.
* `geo_orig` is a string with the code of the country or country group origin
   of value added. Default is `"all"`.
* `sec_orig` is string with the code of sector of origin of value added (e.g.,
  `"AGR"`, `"MANUF"`, `"SRVWC"`...). Default is `"all"`.
* `intra` is a boolean to specify whether to include or not intra-region
  exports (default is `FALSE`, i.e., EU27 exports will include only extra-EU
  exports).
* `perspective` shows the sectoral perspective of value added. Default is
  exporting sector (`"exporter"`) but sector of `"origin"` can also be 
  specified.

Please note that, compared to `make_exvadec()`, `make_exvadir()` is logically
more restricted at decomposing value added, so in principle calculations will
be shown in terms of domestic and foreign content (DC/FC) or, at most, domestic
and foreign value added (DVA/FVA, excluding double counting), but including
reflection (REF). Also note that the total content in value added from all
origins and all sectors is, precisely, the value of total gross exports. 

## Example

We have seen that the foreign content in Spanish exports amounts to USD 2501.78
million. Where does it come from? The specific geographical and sector origin of
the value added in exports can be obtained using the command `make_exvadir()`:

```{r make_exvadir, echo=TRUE}
exvadir <- make_exvadir(wio, exporter = "ESP", va_type = "FC", 
                        flow_type = "EXGR")
head(exvadir$FC, 10)
```

Note that the `exvadir` object that we have obtained is different from
the `exvadec` object, in the sense that 'exporters' in an `exvadir`
object are the different countries and sectors of origin of the value added
included in the exports of a specific country (in this case, Spain). We can
better understand this by typing `summary(exvadir)`:

```{r summary_exvadir, echo=TRUE}
summary(exvadir)
```

Now we will see how to maximize the information given by these objects.

# Sector and geographic analysis

The commands `make_wio()`, `make_exvadec()` and `make_exvadir()`
produce objects that are lists of matrices will a full breakdown by sector and
countries of destination. However, most analyses require grouping of those
variables. The advantage is that grouping by sector or by destination do not
require additional computing, just an aggregation of variables.

To check the information about sectors, it suffices to print `info_sec()`:

```{r info_sec_test, echo=TRUE}
info_sec("iciotest")
```

To check the information about available countries, the command is
`info_geo()`:

```{r info_geo_test, echo=TRUE}
info_geo("iciotest")
```

These commands do not require to have a `wio` in the environment, so we
can just check what countries are available in the OECD's ICIO tables, 2023
edition.

```{r info_geo_icio, echo=TRUE}
info_geo("icio2023")
```

Additionally, the commands `get_geo_codes()` and `get_sec_codes()`
provide details about the components of the different groups. These commands
are also directly applicable for any available input-output table. For
instance, for `"wiod2016"` we would have the following components of
NAFTA:

```{r get_geo_codes_NAFTA, echo=TRUE}
get_geo_codes("NAFTA", wiotype = "wiod2016")
```

And for `"icio2023"` we have the following components of the information
services sector (`INFO`):

```{r get_sec_codes_INFO, echo=TRUE}
get_sec_codes("INFO", wiotype = "icio2023")
```

Once we know the sector and geographical disaggregation, we can discuss
how to take advantage of the information contained in `exvatools` objects.

# Breaking down decompositions

Once we have obtained a decomposition, we can play with the results in terms of
sectors and countries of destination just using the command
`get_exvadec_bkdown()`. For instance, to select the value added in Spanish
exports of services (including construction) to the United States, we just have
to type:

```{r get_bkdown_bm, echo=TRUE}
get_exvadec_bkdown(exvadec, exporter = "ESP", 
                   sector = "SRVWC", importer = "USA")
```

Note that the bilateral `VAX` in this case shows the value added exported to
the United States, regardless of the final absorption country.

We can also  produce an `exvadec` object will all countries and then select any
exporting country and any partner or sector:

```{r makefullexvadec, echo=TRUE}
exvadec.all <- make_exvadec(wio, exporter = "all", quiet = TRUE)
```

and then:

```{r get_bkdown_specific, echo=TRUE}
get_exvadec_bkdown(exvadec.all, exporter = "USA", 
                   sector = "MANUF", importer = "CHN")
```

Apart from the console printout, `get_exvadec_bkdown()` will output a
matrix with the results.

# Extracting data from exvatools objects

The command `get_data()` takes an `exvatools` object (`wio` or
`exvadec`) and produces a value or a matrix of values. It allows a quick
extraction of data. The main advantage of `get_data()` is that it does not
only admit individual sectoral codes (`"MANUF"`) or destination country
codes (`"USA"`, `"NAFTA"`), but also lists of sectors and countries
in vector form. Therefore, we can easily produce a matrix of domestic value
added with breakdown by sector and by destination groups. The syntax of
`get_data()`is as follows:

```{r echo=TRUE, eval=FALSE}
get_data(exvatools_object, variable, exporter = NULL,
         sector = "TOTAL", importer = "WLD", custom = FALSE)
```

The arguments are as follows:

* `exvatools_object` (required) is an object of class `wio`, `exvadec` or
  `exvadir`, and `variable` is a string specifying one of the variables included
  in the `exvatools_object`, such as `"EXGR"`, `"VAX"`, `"FVA"`, etc.
* `exporter` is a string vector with one or more codes of exporters or groups of
  exporters, such as `"ESP"`, `"EU27"`, `c("WLD", "EU27", "NONEU27")`, etc. This
  will define the rows in the resulting matrix. Specific exclusions can be
  accepted through the excluding code `x` (lowercase x), so `"EU27xESP"` would
  be EU countries, excluding Spain, `"WLDxEU27"` would be total world except EU,
  and so on. More than one exception can be specified with the `"|"` element, 
  such as in `"WLDxESP|FRA|ITA"`. Available countries and country group id codes
  can be checked with the command `info_geo()`. The argument `exporter` is 
  required in all cases except two: in case of a country-specific `exvadec` 
  object, in which the exporter is previously defined, and in case of an 
  `exvadir` object, where, by definition, there is only one exporter. Note that,
  in the case of an `exvadir` object obtained for country $s$, the argument 
  `exporter` does not refer to country $s$ itself, but to the $t = 1 \dots G$ 
  exporters of value added that is used by country $s$ to produce its exports. 
  Therefore, if the `exporter` argument is missing, the default behavior of 
  `get_data()` will be different, depending on the case: for a country-specific
  `exvadec`, it will default to the exporting country, whereas for an `exvadir`
  object it will default to `"WLD"` (i.e., sum of all origins of value added).
* `sector` is a string vector with one or more codes of sectors or groups
  of sectors, such as `"MANUF"`, `"SERVS"`, `"TOTAL"`,
  `c("TOTAL", "GOODSWU", "SRVWC")`, etc. These will also show as rows in
  the result. Specific exclusions can be accepted through the excluding code
  `x`, so `"MANUFxPET"` would be manufactures, excluding oil products,
  `"SRVWCxBIZSV"` would be total services (with construction) except
  business services, and so on. Available sector id codes can be checked with
  the command `info_sec()`. Default option is `"TOTAL"` (sum of all
  sectors for the specific exporter). The option `"all"` can be used to
  specify all sectors.
* `importer` is a character string or vector with one or more codes of
  importing countries or groups of countries, such as `"ESP"`,
  `"EU27"`, `c("WLD", "EU27", "NONEU27")`, etc. This defines the
  columns of the result. Default option is `"WLD"`, i.e, the sum of all
  importers for the specific exporter (and sector) selection.
* `custom` is a boolean specifying whether custom-made groups of countries
  or sectors present in the environment should be looked up by `get_data()`.
  For instance, `HITECH` could be a specific variable including all
  high-tech sectors, or `LDC` could be a list of least-developed countries.
  Custom variables should be referred to as strings in `get_data()`, so, for
  instance, `get_data(exva, "VAX", exporter = "LDC", custom = TRUE)` would
  look for a variable called `LDC` in the environment and would use its
  codes to extract and group data.

We can use `get_data()` to summarize the foreign content of Spanish
exports, with a breakdown between EU and Non-EU origin (specifying a few
countries) and also distinguishing between goods (with utilities) and
services. We can also break down the destination of those exports between EU
and non-EU countries:

```{r get_data, echo=TRUE}
get_data(exvadir, exporter = c("WLD", "EU27", "FRA",
                               "NONEU27", "USA"),
         sector = c("TOTAL", "GOODSWU", "SRVWC"),
         importer = c("WLD", "EU27", "NONEU27"))
```

If there is not a specific group in the database of sectors or countries, 
the user has two options: to create a group and use `get_data()` with the
option `custom = TRUE`, or simply to use a combination of countries or
sectors with a vertical line `"|"`.

In the latter case, for instance, if we want to combine `ESP` and `MEX`
in a single group, we can just type:

```{r get_data_LATAM, echo=TRUE}
get_data(exvadec.all, "VAX", exporter = "ESP|MEX", 
         sector = c("TOTAL", "MANUF", "SRVWC"), 
         importer = "USA")
```

If the vertical line `"|"` is used to join, the exception marker is `"x"`. It
allows us, for instance, to calculate  NAFTA exports, both intra-regional and
extra-regional, employing services and non-services, using as extra-regional
`"WLDxNAFTA"` and as non-services `"TOTALxSRVWC"`

```{r get_data_exception, echo=TRUE}
get_data(exvadec.all, "EXGR", exporter = "NAFTA", 
         sector = c("TOTAL", "TOTALxSRVWC", "SRVWC"), 
         importer = c("WLD", "NAFTA", "WLDxNAFTA"))
```

Let us use `get_data()`to calculate the relative comparative advantage  (RCA) in
terms of gross exports and compare it with that in terms of VAX. The RCA is
the relation between the proportion of  exports of sector $i$ in country $s$ 
to total exports of $s$ ($E_{si}/E_s$) and the proportion of world exports of
sector $i$ to total world exports ($E_{wi}/E_w$). If RCA is more than 1, it
means that country $s$ has a relative specialization (and a comparative
advantage) in sector $i%$ compared to the world average.

We will create a function to calculate the RCA so it can be used with both
gross exports (`EXGR`) and value added exported (`VAX`). As we can see, 
`get_data()` considerably simplifies the calculation of country exports 
and sector exports.

```{r, rca, echo=TRUE}
RCA <- function(exva, exvar) {
  Esi <- get_data(exva, exvar, exporter = "all", sector = "all")
  Es <- get_data(exva, exvar, exporter = "all", sector = "TOTAL")
  Es <- rep(as.numeric(Es), each = exva$dims$N)
  Ewi <- get_data(exva, exvar, exporter = "WLD", sector = "all")
  Ewi <- rep(as.numeric(Ewi), exva$dims$G)
  Ew <- as.numeric(get_data(exva, exvar, exporter = "WLD", sector = "TOTAL"))
  rca <- (Esi/Es)/(Ewi/Ew)
  colnames(rca) <- paste0("RCA", ".", exvar)
  return(rca)
}
head(cbind(RCA(exvadec.all, "EXGR"),
           RCA(exvadec.all, "VAX")), 10)
```

We can see that some relative advantage (RCA > 1) in terms of gross exports
disappear when calculated in terms of VAX, while some other appear.

Another useful application is the calculation of bilateral balances. We can 
see that there are considerable difference in bilateral balances when 
calculated in terms of value added compared to the same balances using gross
exports.

```{r balva, echo=TRUE}
EXGR <- get_data(exvadec.all, "EXGR", "all", importer = "all")
IMGR <- bkt(EXGR)
VAX <- get_data(exvadec.all, "VAX", "all", importer = "all")
VAM <- bkt(VAX)
BALGR <- round(EXGR - IMGR, 0)
BALVA <- round(VAX - VAM, 0)
as.data.frame(cbind(BALGR, " "=" ", BALVA),
              row.names = exvadec.all$names$g_names)
```

# Other useful commands

\CRANpkg{exvatools} provides several additional commands, some of them 
resulting from the mere combination of `make_exvadir()` and `get_data()` with 
specific default arguments. Of course, it would be easy to create other custom combinations.

## Detailed origin of value added

The command `get_va_exgr()` provides a detailed sector and geographical origin
and destination of value added.

```{r echo=TRUE, eval=FALSE}
get_va_exgr(wio_object, va_type = "FC", 
            geo_orig = "all", sec_orig = "TOTAL",
            geo_export, sec_export = "TOTAL", as_numeric = TRUE)
```

It allows to analyze, for instance, the percentage of services (both domestic
and foreign) embedded in Spanish exports of manufactures, i.e. the so-called
'servicification' of Spanish exports:

```{r get_va_exgr1, echo=TRUE}
get_va_exgr(wio, va_type = "TC", 
            geo_orig = c("ESP", "WLDxESP"), sec_orig = "SRVWC",
            geo_export = "ESP", sec_export = "MANUF", 
            as_numeric = FALSE)
```

On the other hand, if we wanted the value added in services of the US
incorporated in the Spanish exports of manufactures, i.e., the Spanish
dependence of US services to produce exports of manufactures:

```{r get_va_exgr2, echo=TRUE}
get_va_exgr(wio, geo_orig = "USA", sec_orig = "SRVWC",
            geo_export = "ESP", sec_export = "MANUF")
```

## Detailed final absorption of value added

Sometimes we are not only interested in the origin, but also in the country of
final absorption. For that we have the command `get_va_exgry()`. This is
equivalent to the OECD's Gross Exports by Origin of Value Added and Final
destination (`FD_EXGR_VA`, `FD_EXGRFNL_VA` and `FD_EXGRINT_VA`), but with much
more flexible geographical and sector options. Since the OECD TiVA database no
longer provides this indicator in their online version, this command becomes
particularly useful.

```{r echo=TRUE, eval=FALSE}
get_va_exgry(wio_object, va_type = "TC", flow_type = "EXGRY",
             geo_orig = "WLD", geo_export, sec_export = "TOTAL",
             geo_fd = "WLD", as_numeric = TRUE)
```

Here `flow_type` are exports (expressed in terms of final demand), whether
total (`"EXGRY"`), final (`"EXGRY_FIN"`) or intermediate (`"EXGRY_INT"`), and
`geo_fd` is the country or region of final demand.

This allows, for instance, to calculate what part of US value added incorporated
in China's exports of manufactures ends up absorbed back in the US.

```{r get_va_exgry, echo=TRUE}
get_va_exgry(wio, geo_orig = "USA", geo_export = "CHN",
             sec_export = "MANUF", geo_fd = "USA")
```

## Value added induced by final demand

\CRANpkg{exvatools} also provides a simple command to obtain details of both the
geographical and sector origin of the value added incorporated in exports
induced by final demand.

```{r echo=TRUE, eval=FALSE}
get_va_fd(wio_object, va_type = "TOTAL",
          geo_orig = "WLD", sec_orig = "TOTAL",
          geo_fd = "WLD", sec_fd = "TOTAL", intra = FALSE)
```

This would allow, for instance, the calculation of the Chinese
total value added (or GDP) induced by US final demand for manufactures:

```{r get_va_fd, echo=TRUE}
get_va_fd(wio, geo_orig = "CHN", sec_orig = "TOTAL",
          geo_fd = "USA", sec_fd = "MANUF")
```

# Summary and conclusions

We have presented the package \CRANpkg{exvatools} for decomposition of value
added in exports using international-input out tables in **R**.
\CRANpkg{exvatools} provides a convenient tool for calculating and manipulating
international input-output matrices, and simplifies the decomposition of value
added in exports (using alternative methodologies). It also allows a
straightforward calculation of custom value added indicators.

The purpose of \CRANpkg{exvatools} is to provide the scientific community with
tools to take advantage of the valuable statistical resources that are the 
international input-output tables, facilitating the analysis of the complex
interaction between trade in goods and services and between economic sectors in
different countries.
