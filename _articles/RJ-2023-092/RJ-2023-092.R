# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2023-092.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(exvatools)
library(kableExtra)
library(DiagrammeR)


## ----eval=FALSE, echo=TRUE----------------------------------------------------
#> install.packages("exvatools")
#> library(exvatools)


## ----iotable, include=knitr::is_html_output(), eval=knitr::is_html_output()----
#> df <- data.frame(C1 = c("**Input**", " ", "**Intermediate**", "**inputs**",
#>                         " ", "**Value Added**", "**Input**"),
#>                  C2 = c(" ", "$1$", "$2$", "...", "$G$", " ", " "),
#>                  C3 = c("$1$", "$\\mathbf{Z}_{11}$", "$\\mathbf{Z}_{21}$",
#>                            "$\\dots$", "$\\mathbf{Z}_{G1}$",
#>                            "$\\mathbf{VA}_{1}$", "$\\mathbf{X}_{1}$"),
#>                  C4 = c("$2$", "$\\mathbf{Z}_{12}$", "$\\mathbf{Z}_{22}$",
#>                            "$\\dots$", "$\\mathbf{Z}_{G2}$",
#>                            "$\\mathbf{VA}_{2}$", "$\\mathbf{X}_{2}$"),
#>                  C5 = c("$\\dots$", "$\\dots$", "$\\dots$", "$\\dots$",
#>                             "$\\dots$", "$\\dots$", "$\\dots$"),
#>                  C6 = c("$G$", "$\\mathbf{Z}_{G1}$", "$\\mathbf{Z}_{G2}$",
#>                            "$\\dots$", "$\\mathbf{Z}_{GN}$",
#>                            "$\\mathbf{VA}_{G}$", "$\\mathbf{X}_{G}$"),
#>                  C7 = c("$1$", "$\\mathbf{Y}_{11}$", "$\\mathbf{Y}_{21}$",
#>                            "$\\dots$", "$\\mathbf{Y}_{G1}$", " ", " "),
#>                  C8 = c("$2$", "$\\mathbf{Y}_{12}$", "$\\mathbf{Y}_{22}$",
#>                            "$\\dots$", "$\\mathbf{Z}_{G2}$", " ", " "),
#>                  C9 = c("$\\dots$", "$\\dots$", "$\\dots$", "$\\dots$",
#>                             "$\\dots$", " ", " "),
#>                  C10 = c("$G$", "$\\mathbf{Y}_{G1}$", "$\\mathbf{Y}_{G2}$",
#>                            "$\\dots$", "$\\mathbf{Y}_{GN}$", " ", " "),
#>                  C11 = c(" ", "$\\mathbf{X}_{1}$", "$\\mathbf{X}_{2}$",
#>                            "$\\dots$", "$\\mathbf{X}_{G}$", " ", " ")
#>                  )
#> kableExtra::kbl(df,
#>    format = "html",
#>    caption = "Input-Output Table",
#>    col.names = NULL, align = rep("c", 11)) %>%
#>   add_header_above(c(" ", "Output", "Intermediate uses" = 4,
#>                      "Final uses" = 4, "Output"), line = TRUE) %>%
#>   column_spec(3:11, border_left = TRUE)


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> make_wio(wiotype = "icio2023", year = NULL,
#>          src_dir = NULL, quiet = FALSE)


## ----make_wio, eval=FALSE, echo=TRUE------------------------------------------
#> wio <- make_wio("icio2023", year = 2020,
#>                 src_dir = "C:/Users/Username/Documents/R")


## ----make_custom_wio, echo=TRUE, eval=FALSE-----------------------------------
#> wio <- make_custom_wio(df, g_names = c("C01", "C02", "C03"))


## ----make_wio_test, echo=TRUE, message=FALSE----------------------------------
wio <- make_wio("iciotest")


## ----BY, echo=TRUE------------------------------------------------------------
BY <- wio$B %*% wio$Y


## ----check_BY, echo=TRUE------------------------------------------------------
BY <- rsums(BY, "BY")
print(cbind(head(BY, 10), head(wio$X, 10)))


## ----VBY, echo=TRUE-----------------------------------------------------------
VBY <- dmult(wio$W, wio$B) %*% wio$Y
VBY


## ----meld_VBY, echo=TRUE------------------------------------------------------
VBY <- meld(VBY)
VBY


## ----bkoffd_VBY, echo=TRUE----------------------------------------------------
vax <- bkoffd(VBY)
head(vax, 10)


## ----decomposition, include=knitr::is_html_output(), fig.cap="Decomposition of value added in gross exports"----
grviz_code <- 
"
digraph boxes_and_circles {

  # a 'graph' statement
  graph [overlap = true, fontsize = 6, rankdir = LR]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  A [label = 'Gross\nExports\n(EXGR)'];
  B [label = 'Domestic\nContent\n(DC)']
  C [label = 'Foreign\nContent\n(FC)']
  D [label = 'Domestic\nValue Added\n(DVA)']
  E [label = 'Domestic\nDouble Counting\n(DDC)']
  F [label = 'Foreign\nValue Added\n(VA)']
  G [label = 'Foreign\nDoble Counting\n(FDC)']
  H [label = 'Value Added\nExported\n(VAX)']
  I [label = 'Reflection\n(REF)']
  B; C; D; E; F; G; H; I

  # several 'edge' statements
  A->B A->C B->D B->E C->F
  C->G D->H D->I
}
"
chart <- DiagrammeR::grViz(grviz_code)
chart


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> make_exvadec(wio_object, exporter = "all", method = "bm_src",
#>              output = "standard", quiet = TRUE)


## ----methodoutput-------------------------------------------------------------
if (knitr::is_html_output()) {
  df <- data.frame(Method = c("`bm_src`", "`bm_snk`", "`my`", 
                            "`wwz`", "`kww`", "`oecd`"),
                 Description = c("Borin and Mancini (2019), source",
                                 "Borin and Mancini (2019), sink",
                                 "Miroudot and Ye (2021)",
                                 "Wang et al. (2013)",
                                 "Koopman et al. (2014)",
                                 "OECD (2021) (not a decomposition)"),
                 Perimeters = c("Source-based approach, various perspectives",
                              "Sink-based approach, country perspective",
                              "Source-based approach, various perspectives",
                              "Mix of both",
                              "Sink-based approach, mixed perspective",
                              "Not applicable"),
                 Outputs = c("`basic`, `standard`, `terms`",
                            "`standard`, `terms`",
                            "`standard`, `terms`, `terms2`",
                            "`standard`, `terms`, `terms2`",
                            "`standard`, `terms`",
                            "`standard`, `terms`, `tiva`"))
  knitr::kable(df,
               caption = "`make_exvadec()` output")
}



## ----make_exvadec_bm, echo=TRUE-----------------------------------------------
exvadec <- make_exvadec(wio, exporter = "ESP", method = "bm_src")


## ----make_exvadec_bm_terms, echo=TRUE-----------------------------------------
exvadec.terms <- make_exvadec(wio, exporter = "ESP", 
                              method = "bm_src", output = "terms")


## ----make_tiva, echo=TRUE-----------------------------------------------------
tiva <- make_exvadec(wio, exporter = "ESP", 
                     method = "oecd", output = "tiva")


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> make_exvadir(wio_object, va_type = "TC", flow_type = "EXGR", exporter,
#>              via = "any", sec_orig = "all", geo_orig = "all",
#>              intra = FALSE, perspective = "exporter")


## ----make_exvadir, echo=TRUE--------------------------------------------------
exvadir <- make_exvadir(wio, exporter = "ESP", va_type = "FC", 
                        flow_type = "EXGR")
head(exvadir$FC, 10)


## ----summary_exvadir, echo=TRUE-----------------------------------------------
summary(exvadir)


## ----info_sec_test, echo=TRUE-------------------------------------------------
info_sec("iciotest")


## ----info_geo_test, echo=TRUE-------------------------------------------------
info_geo("iciotest")


## ----info_geo_icio, echo=TRUE-------------------------------------------------
info_geo("icio2023")


## ----get_geo_codes_NAFTA, echo=TRUE-------------------------------------------
get_geo_codes("NAFTA", wiotype = "wiod2016")


## ----get_sec_codes_INFO, echo=TRUE--------------------------------------------
get_sec_codes("INFO", wiotype = "icio2023")


## ----get_bkdown_bm, echo=TRUE-------------------------------------------------
get_exvadec_bkdown(exvadec, exporter = "ESP", 
                   sector = "SRVWC", importer = "USA")


## ----makefullexvadec, echo=TRUE-----------------------------------------------
exvadec.all <- make_exvadec(wio, exporter = "all", quiet = TRUE)


## ----get_bkdown_specific, echo=TRUE-------------------------------------------
get_exvadec_bkdown(exvadec.all, exporter = "USA", 
                   sector = "MANUF", importer = "CHN")


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> get_data(exvatools_object, variable, exporter = NULL,
#>          sector = "TOTAL", importer = "WLD", custom = FALSE)


## ----get_data, echo=TRUE------------------------------------------------------
get_data(exvadir, exporter = c("WLD", "EU27", "FRA",
                               "NONEU27", "USA"),
         sector = c("TOTAL", "GOODSWU", "SRVWC"),
         importer = c("WLD", "EU27", "NONEU27"))


## ----get_data_LATAM, echo=TRUE------------------------------------------------
get_data(exvadec.all, "VAX", exporter = "ESP|MEX", 
         sector = c("TOTAL", "MANUF", "SRVWC"), 
         importer = "USA")


## ----get_data_exception, echo=TRUE--------------------------------------------
get_data(exvadec.all, "EXGR", exporter = "NAFTA", 
         sector = c("TOTAL", "TOTALxSRVWC", "SRVWC"), 
         importer = c("WLD", "NAFTA", "WLDxNAFTA"))


## ----rca, echo=TRUE-----------------------------------------------------------
RCA <- function(exva, exvar) {
  Esi <- get_data(exva, exvar, exporter = "all", sector = "all")
  Es <- get_data(exva, exvar, exporter = "all", sector = "TOTAL")
  Es <- rep(as.numeric(Es), each = exva$dims$N)
  Ewi <- get_data(exva, exvar, exporter = "WLD", sector = "all")
  Ewi <- rep(as.numeric(Ewi), exva$dims$G)
  Ew <- as.numeric(get_data(exva, exvar, exporter = "WLD", sector = "TOTAL"))
  rca <- (Esi/Es)/(Ewi/Ew)
  colnames(rca) <- paste0("RCA", ".", exvar)
  return(rca)
}
head(cbind(RCA(exvadec.all, "EXGR"),
           RCA(exvadec.all, "VAX")), 10)


## ----balva, echo=TRUE---------------------------------------------------------
EXGR <- get_data(exvadec.all, "EXGR", "all", importer = "all")
IMGR <- bkt(EXGR)
VAX <- get_data(exvadec.all, "VAX", "all", importer = "all")
VAM <- bkt(VAX)
BALGR <- round(EXGR - IMGR, 0)
BALVA <- round(VAX - VAM, 0)
as.data.frame(cbind(BALGR, " "=" ", BALVA),
              row.names = exvadec.all$names$g_names)


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> get_va_exgr(wio_object, va_type = "FC",
#>             geo_orig = "all", sec_orig = "TOTAL",
#>             geo_export, sec_export = "TOTAL", as_numeric = TRUE)


## ----get_va_exgr1, echo=TRUE--------------------------------------------------
get_va_exgr(wio, va_type = "TC", 
            geo_orig = c("ESP", "WLDxESP"), sec_orig = "SRVWC",
            geo_export = "ESP", sec_export = "MANUF", 
            as_numeric = FALSE)


## ----get_va_exgr2, echo=TRUE--------------------------------------------------
get_va_exgr(wio, geo_orig = "USA", sec_orig = "SRVWC",
            geo_export = "ESP", sec_export = "MANUF")


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> get_va_exgry(wio_object, va_type = "TC", flow_type = "EXGRY",
#>              geo_orig = "WLD", geo_export, sec_export = "TOTAL",
#>              geo_fd = "WLD", as_numeric = TRUE)


## ----get_va_exgry, echo=TRUE--------------------------------------------------
get_va_exgry(wio, geo_orig = "USA", geo_export = "CHN",
             sec_export = "MANUF", geo_fd = "USA")


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> get_va_fd(wio_object, va_type = "TOTAL",
#>           geo_orig = "WLD", sec_orig = "TOTAL",
#>           geo_fd = "WLD", sec_fd = "TOTAL", intra = FALSE)


## ----get_va_fd, echo=TRUE-----------------------------------------------------
get_va_fd(wio, geo_orig = "CHN", sec_orig = "TOTAL",
          geo_fd = "USA", sec_fd = "MANUF")

