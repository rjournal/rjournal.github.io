# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit boiwsa-paper.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(boiwsa)
library(dplyr)
library(ggplot2)
library(kableExtra)


## ----global_options, include=FALSE--------------------------------------------
knitr::opts_chunk$set(fig.pos = 'H', out.extra = "")


## ----mov-window-problem, out.width = "100%", fig.asp=.7, fig.align = 'center', fig.pos="H", fig.cap = "Illustration of the moving window challenge."----
knitr::include_graphics("figures/mov-window-problem.png")


## ----gasoline, out.width = "70%", fig.pos="H", fig.asp=.7, fig.align = 'center', fig.cap = "Weekly gasoline production in the US, February 2, 1991 to January 20, 2017.", message=FALSE,eval=TRUE,echo=TRUE----
library(dplyr)
library(ggplot2)
library(boiwsa)

ggplot() +
  geom_line(
    aes(
      x = gasoline.data$date,
      y = gasoline.data$y
    ),
    color = "royalblue"
  ) +
  theme_bw() +
  ylab("Barrels per day (millions)") +
  xlab("Year")


## ----eval=TRUE, echo=TRUE-----------------------------------------------------
res <- boiwsa(
  x = gasoline.data$y,
  dates = gasoline.data$date
)


## ----inputs-tex, eval = knitr::is_latex_output(), layout = "l-body-outset", out.extra = ''----
input_args <- data.frame(
  Input_argument = c(
    "x",
    "dates",
    "r",
    "auto.ao.search",
    "out.threshold",
    "ao.list",
    "my.k_l",
    "H",
    "ic",
    "method"
  ),
  Description = c(
    "Numeric vector with series to be seasonally adjusted",
    "Vector of class \"Date\", containing the data dates",
    "Defines the rate of decay of the weights. Should be between zero and one. By default is set to 0.8",
    "Boolean. Search for additive outliers",
    "t-statistic threshold in outlier search. By default is set to 3.8 as suggested by Findley (1998)",
    "Vector with user-specified additive outliers in a date format",
    "Numeric vector defining the number of yearly and monthly trigonometric variables. If NULL, is found automatically using the information criteria (AICc)",
    "Matrix with holiday/working day factors or other user-defined preadjustments",
    "Information criterion used in the automatic search for the number of trigonometric regressors. There are three options: aic, aicc, and bic. aicc is set as default",
    "Decomposition type: additive or multiplicative (log transformation)"
  )
)

knitr::kable(input_args, format='latex', booktabs = T, caption = "Input arguments for boiwsa", col.names = c("Input argument", "Description"))%>%
  kableExtra::kable_styling(font_size = 7,latex_options=c("scale_down","HOLD_position"))


## ----inputs-html, eval = knitr::is_html_output(), layout = "l-body-outset", out.extra = ''----
# input_args <- data.frame(
#   Input_argument = c(
#     "x",
#     "dates",
#     "r",
#     "auto.ao.search",
#     "out.threshold",
#     "ao.list",
#     "my.k_l",
#     "H",
#     "ic",
#     "method"
#   ),
#   Description = c(
#     "Numeric vector with series to be seasonally adjusted",
#     "Vector of class \"Date\", containing the data dates",
#     "Defines the rate of decay of the weights. Should be between zero and one. By default is set to 0.8",
#     "Boolean. Search for additive outliers",
#     "t-statistic threshold in outlier search. By default is set to 3.8 as suggested by Findley (1998)",
#     "Vector with user-specified additive outliers in a date format",
#     "Numeric vector defining the number of yearly and monthly trigonometric variables. If NULL, is found automatically using the information criteria (AICc)",
#     "Matrix with holiday/working day factors or other user-defined preadjustments",
#     "Information criterion used in the automatic search for the number of trigonometric regressors. There are three options: aic, aicc, and bic. aicc is set as default",
#     "Decomposition type: additive or multiplicative (log transformation)"
#   )
# )
# 
# knitr::kable(input_args, format='html', booktabs = T, longtable = TRUE, caption = "Input arguments for boiwsa", col.names = c("Input argument", "Description"))%>%
#   kable_styling(latex_options=c("scale_down","HOLD_position"))


## ----values-html, eval = knitr::is_html_output(), layout = "l-body-outset"----
# 
# output_values <- data.frame(
#   Output_value = c(
#     "sa",
#     "x",
#     "my.k_l",
#     "sf",
#     "hol.factors",
#     "out.factors",
#     "beta",
#     "trend",
#     "ao.list",
#     "m"
#   ),
#   Description = c(
#     "Numeric vector with seasonally adjusted series",
#     "Numeric vector with series to be seasonally adjusted",
#     "Number of trigonometric variables used to model the seasonal pattern",
#     "Estimated seasonal effects. Note that these contain the seasonal effects represented by the trigonometric variables as well as the user-defined preadjustments in H",
#     "Estimated holiday effects or other user-defined variables supplied in H",
#     "Estimated outlier effects",
#     "DWR coefficients for the last year",
#     "Final trend estimate (T_t^(3))",
#     "Additive outlier dates",
#     "lm object. Unweighted OLS regression on the full sample"
#   )
# )
# 
# 
# knitr::kable(output_values, format='html', booktabs = T, longtable = TRUE, caption = "Output values for boiwsa", col.names = c("Value", "Description"))%>%
#   kable_styling(latex_options=c("scale_down","HOLD_position"))


## ----values-tex, eval = knitr::is_latex_output(), layout = "l-body-outset"----

output_values <- data.frame(
  Output_value = c(
    "sa",
    "x",
    "my.k_l",
    "sf",
    "hol.factors",
    "out.factors",
    "beta",
    "trend",
    "ao.list",
    "m"
  ),
  Description = c(
    "Numeric vector with seasonally adjusted series",
    "Numeric vector with series to be seasonally adjusted",
    "Number of trigonometric variables used to model the seasonal pattern",
    "Estimated seasonal effects. Note that these contain the seasonal effects represented by the trigonometric variables as well as the user-defined preadjustments in H",
    "Estimated holiday effects or other user-defined variables supplied in H",
    "Estimated outlier effects",
    "DWR coefficients for the last year",
    "Final trend estimate (T_t^(3))",
    "Additive outlier dates",
    "lm object. Unweighted OLS regression on the full sample"
  )
)

knitr::kable(output_values, format='latex', booktabs = T, caption = "Output values for boiwsa", col.names = c("Value", "Description"))%>%
   kableExtra::kable_styling(font_size = 7,latex_options=c("scale_down","HOLD_position"))


## ----gasoline-sa, out.width = "70%", fig.asp=.7, fig.pos="H", fig.align = 'center', fig.cap = "Weekly gasoline production in the US, February 2, 1991 to January 20, 2017.", eval=TRUE,echo=TRUE----
plot(res)


## ----gasoline-spec, out.width = "70%", fig.asp=.7, fig.pos="H", fig.align = 'center',  fig.cap = "Autoregressive spectrum of weekly gasoline production in the US.", eval=TRUE,echo=TRUE----

# spectrum of the original series (after detrending)
spec0 <- spec.ar((res$x - res$trend), order = 60, plot = F)
# spectrum of the seasonally adjusted series (after detrending)
spec1 <- spec.ar((res$sa - res$trend), order = 60, plot = F)

# plot
ggplot() +
  geom_line(aes(x = spec0$freq, y = spec0$spec, color = "orig")) +
  geom_line(aes(x = spec0$freq, y = spec1$spec, color = "sa")) +
  geom_vline(xintercept = 1:2 / 4.34, linetype = "dashed") +
  geom_text(aes(x = 1:2 / 4.34, label = "
 Intra-monthly cycle peaks", y = 0.5 * max(spec0$spec)), colour = "black", angle = 90) +
  geom_vline(xintercept = (1:3) / 52.1775, linetype = "dashed") +
  geom_text(aes(x = 3 / 52.1775, label = "
 First three intra-yearly cycle peaks", y = 0.5 * max(spec0$spec)), colour = "black", angle = 90) +
  scale_color_manual(
    name = "",
    values = c("orig" = "#31a354", "sa" = "#3182bd"),
    labels = c("Original", "Seasonally adjusted")
  ) +
  theme_bw() +
  theme(legend.position = "bottom") +
  theme(legend.text = element_text(size = 11)) +
  ylab(" ") +
  xlab("Frequency")



## ----eval=TRUE,echo=TRUE------------------------------------------------------
print(res)


## ----unemp, out.width = "70%", fig.asp=.7, fig.pos="H",fig.align = 'center', fig.cap = "Weekly number of initial unemployment claims in Israel, January 11, 2014 to January 4, 2020."----
ggplot() +
  geom_line(aes(
    x = lbm$date,
    y = lbm$IES_IN_W_ADJ
  ), color = "royalblue") +
  theme_bw() +
  ylab("Number of claims per week") +
  xlab("Year")


## ----eval=TRUE, echo=TRUE-----------------------------------------------------
# creating an input for simple_td 
dates_il %>%
  select(DATE_VALUE, ISR_WORKING_DAY_PART) %>%
  `colnames<-`(c("date", "WORKING_DAY_PART")) %>%
  mutate(date = as.Date(date)) -> df.td
# creating a matrix with a working day variable
td <- simple_td(dates = lbm$date, df.td = df.td)

# generating the Rosh Hashanah and Pesach moving holiday variables
rosh <- my_rosh(
  dates = lbm$date,
  holiday.dates = holiday_dates_il$rosh
)
# renaming (make sure that all the variables in H have distinct names)
colnames(rosh) <- paste0("rosh", colnames(rosh))

pesach <- my_rosh(
  dates = lbm$date,
  holiday.dates = holiday_dates_il$pesah,
  start = 3, end = -1
)
colnames(pesach) <- paste0("pesach", colnames(pesach))


# combining the prior adjustment variables in a single matrix
H <- as.matrix(cbind(rosh[, -1], pesach[, -1], td[, -1]))
# running seasonal adjustment routine
res <- boiwsa(
  x = lbm$IES_IN_W_ADJ,
  dates = lbm$date,
  H = H,
  out.threshold = 3.8
)


## ----unemp-sa-bad, out.width = "70%", fig.asp=.7, fig.pos="H", fig.align = 'center', fig.cap = "Weekly number of initial unemployment claims in Israel: Original, Seasonally adjusted, and the decomposition with `out.threshold=3.8`.",echo=TRUE,eval=TRUE----
plot(res)


## ----eval=TRUE, echo=TRUE-----------------------------------------------------
res <- boiwsa(
  x = lbm$IES_IN_W_ADJ,
  dates = lbm$date,
  H = H,
  out.threshold = 5
)


## ----unemp-sa-fixed, out.width = "70%", fig.asp=.7, fig.pos="H", fig.align = 'center', fig.cap = "Weekly number of initial unemployment claims in Israel: Original, Seasonally adjusted, and the decomposition with `out.threshold=5`.", echo=TRUE,eval=TRUE----
plot(res)


## ----unemp-spec, out.width = "70%", fig.asp=.7, fig.pos="H", fig.align = 'center', fig.cap = "Autoregressive spectrum of a weekly number of initial unemployment claims in Israel.", echo=TRUE,eval=TRUE----
plot_spec(res)

