# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2023-095.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(success)
library(ggpubr)
library(plotly)


## ----success, echo = TRUE, eval = FALSE---------------------------------------
#> library(success)
#> data("surgerydat", package = "success")
#> head(surgerydat, 5)


## ----surgerydat-interactive, eval = knitr::is_html_output()-------------------
#> knitr::kable(head(surgerydat, 5), format = "html", caption = "Overview of the enclosed `surgerydat` data set.")


## ----surgerydat-static, eval = knitr::is_latex_output()-----------------------
knitr::kable(head(surgerydat, 5), format = "latex", caption = "Overview of the enclosed `surgerydat` data set.")


## ----echo = TRUE, eval = TRUE-------------------------------------------------
assisted_parameters <- parameter_assist(
  baseline_data = subset(surgerydat, entrytime < 365), 
  data = subset(surgerydat, entrytime >= 365 & unit == 1), 
  formula = ~age + sex + BMI, 
  followup = 30,
  theta = log(2),
  time = 365,
  alpha = 0.05)


## ----echo = TRUE, eval = TRUE-------------------------------------------------
names(assisted_parameters)


## ----eval = TRUE, echo = TRUE, cache = TRUE-----------------------------------
bernoulli_control <- bernoulli_control_limit(assist = assisted_parameters)
bk_control <- bk_control_limit(assist = assisted_parameters)
cgr_control <- cgr_control_limit(assist = assisted_parameters)


## ----echo = TRUE, eval = TRUE-------------------------------------------------
bernoulli_assist <- bernoulli_cusum(assist = assisted_parameters, 
                                    h = bernoulli_control$h)
bk_assist <- bk_cusum(assist = assisted_parameters, h = bk_control$h)
cgr_assist <- cgr_cusum(assist = assisted_parameters, h = cgr_control$h)


## -----------------------------------------------------------------------------
a <- plot(bernoulli_assist) + ggtitle("Bernoulli CUSUM") +
  ylim(c(0, 7.45))
b <- plot(bk_assist) + ggtitle("BK-CUSUM") + ylim(c(0, 7.45))
c <- plot(cgr_assist) + ggtitle("CGR-CUSUM") + ylim(c(0, 7.45))


## ----assisted-plots-html, fig.cap="A), B), C) Bernoulli, BK- and CGR-CUSUM charts for hospital 1 in the surgery data set starting from 1 year after the start of the study. D) Funnel plot of all hospitals in the surgery data set.", eval = knitr::is_html_output()----
#> q <- ggarrange(a, b, c, ncol = 2, nrow = 2, labels = c("A", "B", "C"))
#> annotate_figure(q, top = text_grob("Hospital 1 control charts"))


## ----assisted-plots-pdf, fig.cap="Bernoulli, BK- and CGR-CUSUM charts for hospital 1 in the surgery data set starting from 1 year after the start of the study.", fig.width = 5, fig.height = 3, eval = knitr::is_latex_output()----
q <- ggarrange(a, b, c, ncol = 2, nrow = 2, labels = c("A", "B", "C"))
annotate_figure(q, top = text_grob("Hospital 1 control charts"))


## ----echo = TRUE, eval = TRUE-------------------------------------------------
runlength(bernoulli_assist, h = bernoulli_control$h)


## ----assisted-funnel, fig.cap="Funnel plot for hospitals over the first year of the surgery data set. Target performance determined as average over the considered data.", eval = TRUE, echo = TRUE, fig.width = 5, fig.height = 3.5----
funnel_assist <- funnel_plot(assist = assisted_parameters)
plot(funnel_assist, label_size = 2) + ggtitle("Funnel plot of surgerydat")


## ----echo = TRUE, eval = TRUE-------------------------------------------------
baseline_data <- subset(surgerydat, entrytime <= 365)
followup <- 30
glm_risk_model <- glm((survtime <= followup) & (censorid == 1) ~ age + sex + BMI,
                      data = baseline_data, family = binomial)


## ----echo = TRUE, eval = TRUE-------------------------------------------------
require(survival)
coxph_risk_model <- coxph(Surv(survtime, censorid) ~ age + sex + BMI,
                          data = baseline_data)


## ----echo = TRUE--------------------------------------------------------------
RA_manual <- list(formula = ~ age + sex + BMI, 
                  coefficients = c(age = 0.003, BMI = 0.02,  
                                         sexmale = 0.2)) 


## ----echo = TRUE, eval = TRUE-------------------------------------------------
funnel <- funnel_plot(data = surgerydat, ctime = 365, 
                      glmmod = glm_risk_model, followup = 30)


## ----funnel-p, fig.cap="Funnel plot of hospitals in the surgery data, using all information known after 1 year of the study.", fig.width = 5, fig.height = 3.5----
plot(funnel, label_size = 2) + ggtitle("Funnel plot of surgery data at 1 year")


## ----echo = TRUE, eval = FALSE------------------------------------------------
#> head(summary(funnel), 5)


## ----summaryfunnel-interactive, eval = knitr::is_html_output()----------------
#> knitr::kable(head(summary(funnel), 5), format = "html", caption = "Summary statistics for the funnel plot.")


## ----summaryfunnel-static, eval = knitr::is_latex_output()--------------------
knitr::kable(head(summary(funnel), 5), format = "latex", caption = "Summary statistics for the funnel plot.")


## ----eval = TRUE, echo = TRUE, cache = TRUE-----------------------------------
bern_control <- bernoulli_control_limit(
  time = 365, alpha = 0.05, followup = 30, psi = 1, 
  glmmod = glm_risk_model, baseline_data = surgerydat, theta = log(2))


## ----echo = TRUE, eval = TRUE-------------------------------------------------
bern_control$h


## ----Bernoulli2, echo = TRUE, eval = TRUE, fig.cap="Bernoulli CUSUM for hospital 9 over the study duration. Target performance estimated from the failure rate of patients treated in the first year of the study.", fig.width = 5, fig.height = 3----
Bernoulli <- bernoulli_cusum(
  data = subset(surgerydat, unit == 9),
  glmmod = glm_risk_model, followup = 30, theta = log(2))
plot(Bernoulli, h = bern_control$h) + 
  ggtitle("Bernoulli CUSUM of Hospital 9")


## ----eval = TRUE, echo = TRUE, cache = TRUE-----------------------------------
BK_control <- bk_control_limit(
  time = 365, alpha = 0.05, psi = 1, coxphmod = coxph_risk_model,
  baseline_data = surgerydat, theta = log(2))


## ----bkcusum9, echo = TRUE, eval = TRUE, fig.cap="BK-CUSUM for hospital 9 over the study duration. Target performance estimated from the failure rate of patients treated in the first year of the study.", fig.width = 5, fig.height = 3----
BK <- bk_cusum(data = subset(surgerydat, unit == 9), theta = log(2),
               coxphmod = coxph_risk_model)
plot(BK, h = BK_control$h) + ggtitle("BK-CUSUM of hospital 9")


## ----echo = TRUE, eval = TRUE, cache = TRUE-----------------------------------
BK_control_lower <- bk_control_limit(
  time = 365, alpha = 0.05, psi = 1, coxphmod = coxph_risk_model,
  baseline_data = surgerydat, theta = -log(2))


## ----echo = TRUE, eval = FALSE------------------------------------------------
#> BK_control_lower <- bk_control_limit(
#>   time = 365, alpha = 0.05, psi = 1, coxphmod = coxph_risk_model,
#>   baseline_data = surgerydat, theta = -log(2))
#> BKlower <- bk_cusum(data = subset(surgerydat, unit == 9),
#>               theta = -log(2), coxphmod = coxph_risk_model)
#> plot(BKlower, h = BK_control_lower$h) +
#>   ggtitle("BK-CUSUM of hospital 9 (lower sided)")


## ----echo = TRUE, eval = FALSE------------------------------------------------
#> BKtwosided <- bk_cusum(data = subset(surgerydat, unit == 9),
#>               theta = log(2), coxphmod = coxph_risk_model, twosided = TRUE)
#> plot(BKtwosided, h = c(BK_control_lower$h, BK_control$h))


## ----bkupperlower, echo = FALSE, fig.cap="Lower sided (left) and two-sided (right) Bernoulli CUSUM for hospital 9 over the study duration. Target performance estimated from the failure rate of patients treated in the first year of the study.", fig.width = 5, fig.height = 3----
BKlower <- bk_cusum(data = subset(surgerydat, unit == 9), 
              theta = -log(2), coxphmod = coxph_risk_model)
BKtwosided <- bk_cusum(data = subset(surgerydat, unit == 9), 
              theta = log(2), coxphmod = coxph_risk_model, twosided = TRUE)
e <- plot(BKlower, h = BK_control_lower$h) + 
  ggtitle("Lower sided")
f <- plot(BKtwosided, h = c(BK_control_lower$h, BK_control$h)) + 
  ggtitle("Two-sided")
g <- ggarrange(e, f, ncol = 2, nrow = 1, labels = c("A", "B"))
annotate_figure(g, top = text_grob("BK-CUSUM of hospital 9"))


## ----eval = TRUE, echo = TRUE, cache = TRUE-----------------------------------
CGR_control <- cgr_control_limit(
  time = 365, alpha = 0.05, psi = 1, coxphmod = coxph_risk_model,
  baseline_data = surgerydat)


## ----cgrcusumfig, echo = TRUE, eval = TRUE, fig.cap="CGR-CUSUM for hospital 9 over the study duration. Target performance estimated from the failure rate of patients treated in the first year of the study.", fig.width = 5, fig.height = 3----
CGR <- cgr_cusum(data = subset(surgerydat, unit == 9), 
               coxphmod = coxph_risk_model)
plot(CGR, h = CGR_control$h) + ggtitle("CGR-CUSUM of hospital 9")


## ----echo = TRUE, eval = FALSE------------------------------------------------
#> CGR_multicore <- cgr_cusum(data = subset(surgerydat, unit == 9),
#>                coxphmod = coxph_risk_model, ncores = 3, pb = TRUE)


## ----echo = TRUE, eval = FALSE------------------------------------------------
#> Bernoulli$h <- bernoulli_control$h
#> BK$h <- BK_control$h
#> CGR$h <- CGR_control$h
#> cusum_list <- list(Bernoulli, BK, CGR)
#> interactive_plot(cusum_list, unit_names = rep("Hosp 9", 3), scale = TRUE)


## ----echo = FALSE, eval = TRUE------------------------------------------------
Bernoulli$h <- bernoulli_control$h
BK$h <- BK_control$h
CGR$h <- CGR_control$h
cusum_list <- list(Bernoulli, BK, CGR)


## ----interplot-interactive, echo = FALSE, eval = knitr::is_html_output(), fig.cap="Interactive plot of CUSUM charts for hospital 9."----
#> interactive_plot(cusum_list, unit_names = rep("Hosp 9", 3), scale = TRUE)


## ----interplot-static, echo = FALSE, eval = knitr::is_latex_output(), fig.cap="Interactive plot of CUSUM charts for hospital 9.", fig.width = 5, fig.height = 3----
iplot <- interactive_plot(cusum_list, unit_names = rep("Hosp 9", 3), scale = TRUE)
ggplotly(iplot, width = 500, height = 300)


## ----echo = TRUE, eval = TRUE-------------------------------------------------
glmmodEORTC <- glm((survtime <= 36) & (censorid == 1) ~ var1 + var2 +
                      var3 + var4 + var5 + var6 + var7,
                   data = breast, family = binomial)
phmodEORTC <- coxph(Surv(survtime, censorid) ~ var1 + var2 +
                      var3 + var4 + var5 + var6 + var7, data = breast)


## ----eval = TRUE, cache = TRUE, warning = FALSE-------------------------------
EORTC_funnel <- funnel_plot(data = breast, glmmod = glmmodEORTC, 
                            followup = 36)
EORTC_charts <- vector("list", length = 15)
for(i in 1:15){
  max_time <- ceiling(max(subset(breast, unit == i)$entrytime + 
                            subset(breast, unit == i)$survtime))
  EORTC_charts[[i]]$ber <- bernoulli_cusum(data = subset(breast, unit == i),
                           followup = 36, glmmod = glmmodEORTC, 
                           theta = log(2))
  EORTC_charts[[i]]$bk <- bk_cusum(data = subset(breast, unit == i), 
                          coxphmod = phmodEORTC, 
                          ctimes = seq(0, max_time, 1), theta = log(2))
  EORTC_charts[[i]]$cgr <- cgr_cusum(data = subset(breast, unit == i),  
                           coxphmod = phmodEORTC, 
                           ctimes = seq(0, max_time, 1))
}


## ----echo = TRUE, eval = TRUE-------------------------------------------------
arrival_rate <- arrival_rate(breast)
arrival_rate


## ----eval = TRUE, cache = TRUE, echo = TRUE-----------------------------------
h <- matrix(0, nrow = 3, ncol = 3, 
            dimnames = list(c(0.9, 2.1, 11), c("Ber", "BK", "CGR")))
psi <- c(0.9, 2.1, 11)
for(i in 1:3){
  h[i,1] <- bernoulli_control_limit(time = 60, alpha = 0.05, followup = 36,
            psi = psi[i], n_sim = 300, theta = log(2), glmmod =  glmmodEORTC,
            baseline_data = breast)$h
  h[i,2] <- bk_control_limit(time = 60, alpha = 0.05, psi = psi[i], n_sim = 300,
            theta = log(2), coxphmod = phmodEORTC, baseline_data = breast)$h
  h[i,3] <- cgr_control_limit(time = 60, alpha = 0.05, psi = psi[i],
            n_sim = 300, coxphmod = phmodEORTC, baseline_data = breast)$h
}


## ----htable-interactive, eval = knitr::is_html_output()-----------------------
#> knitr::kable(h, format = "html", caption = "Control limits for the EORTC data. Estimated using a simulation procedure so that the probability of a type I error within 36 time units is approximately 0.05.")


## ----htable-static, eval = knitr::is_latex_output()---------------------------
knitr::kable(h, format = "latex", caption = "Control limits for the EORTC data. Estimated using a simulation procedure so that the probability of a type I error within 36 time units is approximately 0.05.")


## ----echo = TRUE, eval = TRUE-------------------------------------------------
times_detection <- matrix(0, nrow = 3, ncol = 15, 
                          dimnames = list(c("Ber", "BK", "CGR"), 1:15))
for(i in 1:5){
  times_detection[1,i] <- runlength(EORTC_charts[[i]]$ber, h = h[1,1])
  times_detection[2,i] <- runlength(EORTC_charts[[i]]$bk, h = h[1,2])
  times_detection[3,i] <- runlength(EORTC_charts[[i]]$cgr, h = h[1,3])
}
for(i in 6:11){
  times_detection[1,i] <- runlength(EORTC_charts[[i]]$ber, h = h[2,1])
  times_detection[2,i] <- runlength(EORTC_charts[[i]]$bk, h = h[2,2])
  times_detection[3,i] <- runlength(EORTC_charts[[i]]$cgr, h = h[2,3])
}
for(i in 12:15){
  times_detection[1,i] <- runlength(EORTC_charts[[i]]$ber, h = h[3,1])
  times_detection[2,i] <- runlength(EORTC_charts[[i]]$bk, h = h[3,2])
  times_detection[3,i] <- runlength(EORTC_charts[[i]]$cgr, h = h[3,3])
}


## ----echo = TRUE, eval = TRUE-------------------------------------------------
ceiling(times_detection[,colSums(is.infinite(times_detection)) != 3])


## ----echo = FALSE, eval = TRUE------------------------------------------------
annot = list(
    list(
      x = 0.225, 
      y = 0.95, 
      font = list(size = 16), 
      text = "Funnel plot", 
      xref = "paper", 
      yref = "paper", 
      xanchor = "center", 
      yanchor = "bottom", 
      showarrow = FALSE
    ), 
    list(
      x = 0.775, 
      y = 0.95, 
      font = list(size = 16), 
      text = "Bernoulli CUSUM", 
      xref = "paper", 
      yref = "paper", 
      xanchor = "center", 
      yanchor = "bottom", 
      showarrow = FALSE
    ), 
    list(
      x = 0.225, 
      y = 0, 
      font = list(size = 16), 
      text = "BK-CUSUM", 
      xref = "paper", 
      yref = "paper", 
      xanchor = "center", 
      yanchor = "bottom", 
      showarrow = FALSE
    ), 
    list(
      x = 0.775, 
      y = 0, 
      font = list(size = 16), 
      text = "CGR-CUSUM", 
      xref = "paper", 
      yref = "paper", 
      xanchor = "center", 
      yanchor = "bottom", 
      showarrow = FALSE
    )
  )


## ----echo = TRUE, eval = TRUE-------------------------------------------------
unnames <- paste(rep("Centre", 15), 1:15)
ber_EORTC <- lapply(EORTC_charts, FUN = function(x) x$ber)
bk_EORTC <- lapply(EORTC_charts, FUN = function(x) x$bk)
cgr_EORTC <- lapply(EORTC_charts, FUN = function(x) x$cgr)
for(i in 1:5){
  ber_EORTC[[i]]$h <- h[1,1] 
  bk_EORTC[[i]]$h <- h[1,2]
  cgr_EORTC[[i]]$h <- h[1,3]
}
for(i in 6:11){
  ber_EORTC[[i]]$h <- h[2,1] 
  bk_EORTC[[i]]$h <- h[2,2]
  cgr_EORTC[[i]]$h <- h[2,3]  
}
for(i in 12:15){
  ber_EORTC[[i]]$h <- h[3,1] 
  bk_EORTC[[i]]$h <- h[3,2]
  cgr_EORTC[[i]]$h <- h[3,3]  
}
cols <- palette.colors(6, "Set2")
col_manual <- rep("lightgrey", 15)
col_manual[c(3,5,9,10,11,14)] <- cols
t1 <- interactive_plot(ber_EORTC, unit_names = unnames, 
                       scale = TRUE, group_by = "type",
                       manual_colors = col_manual)
t2 <- interactive_plot(bk_EORTC, unit_names = unnames, 
                       scale = TRUE, group_by = "type",
                       manual_colors = col_manual)
t3 <- layout(interactive_plot(cgr_EORTC, unit_names = unnames, 
                       scale = TRUE, group_by = "type",
                       manual_colors = col_manual))
t0 <- ggplotly(plot(EORTC_funnel))


## ----funnelandcusums-interactive, echo = FALSE, fig.cap="(Top left) Funnel plot of breast data. (Top right) Bernoulli,  (Bottom left) BK- and (Bottom right) CGR-CUSUM charts of all 15 centres. Centres not detected by any of the charts are greyed out.", eval = knitr::is_html_output(), layout = "l-body-outset", fig.width = 5, fig.height = 5----
#> subplot(t0, t1,
#>             t2, t3, nrows = 2)


## ----funnelandcusums-static, echo = FALSE, fig.cap="(Top left) Funnel plot of breast data. (Top right) Bernoulli,  (Bottom left) BK- and (Bottom right) CGR-CUSUM charts of all 15 centres. Centres not detected by any of the charts are greyed out.", eval = knitr::is_latex_output(), layout = "l-body-outset", fig.width = 5, fig.height = 3----
layout(subplot(t0, style(t1, showlegend = FALSE),
               style(t2, showlegend = FALSE), t3, nrows = 2), 
       autosize = FALSE, width = 600, height = 500,
       annotations = annot)


## ----EORTC3-interactive, echo = FALSE, eval = knitr::is_html_output(), fig.cap="Bernoulli, BK- and CGR-CUSUM for centre 5 of the breast data."----
#> cusum_list <- EORTC_charts[[5]]
#> cusum_list$ber$h <- h[1,1]
#> cusum_list$bk$h <- h[1,2]
#> cusum_list$cgr$h <- h[1,3]
#> interactive_plot(cusum_list, unit_names = rep("Centre 5", 3),
#>                      scale = TRUE)


## ----EORTC3-static, echo = FALSE, eval = knitr::is_latex_output(), fig.cap="Bernoulli, BK- and CGR-CUSUM for centre 5 of the breast data.", fig.width = 5, fig.height = 3----
cusum_list <- EORTC_charts[[5]]
cusum_list$ber$h <- h[1,1]
cusum_list$bk$h <- h[1,2]
cusum_list$cgr$h <- h[1,3]
iplot2 <- interactive_plot(cusum_list, unit_names = rep("Centre 5", 3), 
                     scale = TRUE)
ggplotly(iplot2, width = 500, height = 300)

