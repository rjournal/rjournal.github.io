# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2024-033.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.pos = "H", cache=TRUE)
library(IRTest)
library(mirt)
library(ltm)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(plotly)


## ----validation, echo=FALSE, message=FALSE, results="hide"--------------------
Alldata <- IRTest::DataGeneration(N = 1000,
                                  nitem_D = 10,
                                  latent_dist = "2NM",
                                  d = 1.414,
                                  sd_ratio = 2,
                                  prob = .66)

simulated_data <- Alldata$data_D
colnames(simulated_data) <- paste0("Item",1:10)
true_item <- Alldata$item_D
true_theta <- Alldata$theta

model_IRTestd <- IRTest::IRTest_Dich(simulated_data, q = 61)$par_est
model_IRTestp <- IRTest::IRTest_Poly(simulated_data, q = 61)$par_est
model_mirt <- coef(mirt::mirt(simulated_data, model = 1, quadpts = 61), simplify = TRUE)$items
model_ltm <- coef(ltm::ltm(simulated_data~z1, control = list(GHk=61)))

result_a <- cbind(true_item[,1], model_IRTestd[,1], model_IRTestp[,1], model_mirt[,1], model_ltm[,2])
result_b <- cbind(true_item[,2], model_IRTestd[,2], model_IRTestp[,2], -model_mirt[,2]/model_mirt[,1], model_ltm[,1])

colnms <- c("parameter", "IRTest::IRTest_Dich()", "IRTest::IRTest_Poly()", "mirt::mirt()", "ltm::ltm()")
colnames(result_a) <- colnms
colnames(result_b) <- colnms


## ----parameter-static, eval = knitr::is_latex_output(), echo=FALSE------------
knitr::kable(rbind(result_a, result_b), format = "latex", caption = "Item parameters and their estimates", digits = 4, booktabs = T) %>% 
  kableExtra::kable_styling(font_size = 7, position = "center") %>%
  kableExtra::pack_rows("Item discrimination parameter (a)", 1, 10) %>%
  kableExtra::pack_rows("Item difficulty parameter (b)", 11, 20)


## ----parameter-interactive, eval = knitr::is_html_output(), layout = "l-body", echo=FALSE----
# knitr::kable(rbind(result_a, result_b), format = "html", caption = "Item parameters and their estimates", digits = 4, booktabs = T)%>%
#   kableExtra::kable_styling(position = "center") %>%
#   kableExtra::kable_styling(font_size = 7, position = "center") %>%
#   kableExtra::pack_rows("Item discrimination parameter (a)", 1, 10) %>%
#   kableExtra::pack_rows("Item difficulty parameter (b)", 11, 20)


## ----ise, echo=FALSE, message=FALSE, results="hide"---------------------------
n_quad <- 121
delta_theta <- seq(-6,6,length.out=n_quad)[2]-seq(-6,6,length.out=n_quad)[1]
LD_mirt_DCM <- mirt::extract.mirt(mirt::mirt(simulated_data, model = 1, quadpts = n_quad, dentype = "Davidian-3"), "Prior")[[1]]/delta_theta
LD_mirt_EHM <- as.vector(
  mirt::extract.mirt(mirt::mirt(simulated_data, model = 1, quadpts = n_quad, dentype = "EHW"), "Prior")[[1]]
  )/delta_theta
LD_IRTest_DCM <- IRTest::IRTest_Dich(simulated_data, q = n_quad, latent_dist = "DC", h=3)$Ak/delta_theta
LD_IRTest_EHM <- IRTest::IRTest_Dich(simulated_data, q = n_quad, latent_dist = "EHM")$Ak/delta_theta

# Collecting the estimates into a dataframe
LD_df <- data.frame(theta = rep(seq(-6,6,length.out=n_quad), 6),
                    density = c(LD_mirt_DCM, LD_mirt_EHM, LD_IRTest_DCM, LD_IRTest_EHM, 
                                IRTest::dist2(x = seq(-6,6,length.out=n_quad), d=1.414, sd_ratio = 2, prob = .66),
                                IRTest::dist2(x = seq(-6,6,length.out=n_quad), d=1.414, sd_ratio = 2, prob = .66)),
                    package = c(rep("mirt", n_quad*2), rep("IRTest", n_quad*2), rep("True", n_quad*2)),
                    LDE.method = rep(c("DCM","EHM","DCM","EHM","DCM","EHM"), each = n_quad)
                    )
LD_df$LDE.method <- factor(LD_df$LDE.method, levels = c("EHM", "DCM"))


## ----LDE-validation-html, echo=FALSE, fig=TRUE, fig.height=5, fig.width=7, fig.align='center', include=knitr::is_html_output(), eval=knitr::is_html_output(), fig.cap="Estimated latent distributions from IRTest and mirt"----
# LD_df %>%
#   ggplot2::ggplot(aes(x=theta, y=density, color = package)) +
#   ggplot2::geom_line(linewidth=1)+
#   ggplot2::facet_wrap(~ LDE.method,
#                       nrow = 2,
#                       scales = "fixed") +
#   ggplot2::scale_color_manual(values = c("#619CFF", "#F8766D", "#00BA38")) +
#   ggplot2::lims(x = c(-4, 4),
#                 y = c(0, .85)) +
#   ggplot2::labs(x=expression(theta),
#                 y='density') +
#   ggplot2::theme_bw()


## ----LDE-validation-latex, echo=FALSE, fig=TRUE, fig.height=5, fig.width=7.5, out.width="80%", fig.align='center', include=knitr::is_latex_output(), eval=knitr::is_latex_output(), fig.cap="Estimated latent distributions from IRTest and mirt"----
LD_df %>% 
  ggplot2::ggplot(aes(x=theta, y=density, color = package)) +
  ggplot2::geom_line(linewidth=1)+
  ggplot2::facet_wrap(~ LDE.method,
                      nrow = 2,
                      scales = "fixed") +
  ggplot2::scale_color_manual(values = c("#619CFF", "#F8766D", "#00BA38")) +
  ggplot2::lims(x = c(-4, 4),
                y = c(0, .85)) +
  ggplot2::labs(x=expression(theta),
                y='density') +
  ggplot2::theme_bw()


## ----data generation, echo=TRUE-----------------------------------------------
Alldata <- IRTest::DataGeneration(N = 2000,
                                  nitem_D = 40,
                                  latent_dist = "2NM",
                                  d = 1.414,
                                  sd_ratio = 2,
                                  prob = 2/3)
simulated_data <- Alldata$data_D
true_item <- Alldata$item_D
true_theta <- Alldata$theta


## ----model fitting1, message=FALSE, echo=TRUE---------------------------------
model_normal <- IRTest::IRTest_Dich(data = simulated_data,
                                    latent_dist = "Normal")
model_KDM <- IRTest::IRTest_Dich(data = simulated_data,
                                 latent_dist = "KDE")
theta_eap_normal <- IRTest::factor_score(model_normal)
theta_mle_normal <- IRTest::factor_score(model_normal, ability_method = "MLE")
theta_eap_KDM <- IRTest::factor_score(model_KDM)
theta_mle_KDM <- IRTest::factor_score(model_KDM, ability_method = "MLE")


## ----distribution example code, message=FALSE, echo=TRUE----------------------
density_plot <- ggplot2::ggplot() +
  ggplot2::stat_function(fun = IRTest::dist2,
                         args = list(d = 1.414, sd_ratio = 2, prob = 2/3),
                         linewidth = 1,
                         mapping = aes(color = "True")) +
  ggplot2::stat_function(fun = stats::dnorm,
                         linewidth = 1,
                         mapping = aes(color = "Normal")) +
  ggplot2::stat_function(fun = IRTest::latent_distribution,
                         args = list(model_KDM),
                         linewidth = 1,
                         mapping = aes(color = "KDM"))


## ----estimated-density-html, echo=FALSE, fig=TRUE, fig.height=3, fig.width=7, fig.align='center', include=knitr::is_html_output(), eval=knitr::is_html_output(), fig.cap="The true, normal, and estimated latent distributions"----
# density_plot +
#   ggplot2::lims(x = c(-6, 6),
#                 y = c(0, 0.7)) +
#   ggplot2::labs(x=expression(theta),
#                 y='density') +
#   ggplot2::scale_color_manual(values = c("#619CFF", "#F8766D", "#00BA38")) +
#   ggplot2::theme_bw()


## ----estimated-density-latex, echo=FALSE, fig=TRUE, fig.height=3, fig.width=7, out.width="80%", fig.align='center', include=knitr::is_latex_output(), eval=knitr::is_latex_output(), fig.cap="The true, normal, and estimated latent distributions"----
density_plot +
  ggplot2::lims(x = c(-6, 6),
                y = c(0, 0.7)) +
  ggplot2::labs(x=expression(theta),
                y='density') +
  ggplot2::scale_color_manual(values = c("#619CFF", "#F8766D", "#00BA38")) +
  ggplot2::theme_bw()


## ----estimated-item-plotly, echo=FALSE, fig=TRUE, fig.height=3.4, fig.width=7, fig.align='center', include=knitr::is_html_output(), eval=knitr::is_html_output(), fig.cap="Differences in the errors of the item parameter estimates caused by LDE"----
# true_values <-
#   as.data.frame(true_item[,1:2]) %>%
#   tidyr::pivot_longer(cols = everything(),
#                       names_to = "parameter",
#                       values_to = "True values")
# estimated_KDM <-
#   as.data.frame(model_KDM$par_est[,1:2]) %>%
#   tidyr::pivot_longer(cols = everything(),
#                       names_to = "parameter",
#                       values_to = "Estimated values") %>%
#   dplyr::mutate(true_values[,2],
#                 colour = "KDM")
# estimated_normal <-
#   as.data.frame(model_normal$par_est[,1:2]) %>%
#   tidyr::pivot_longer(cols = everything(),
#                       names_to = "parameter",
#                       values_to = "Estimated values") %>%
#   dplyr::mutate(true_values[,2],
#                 colour = "Normal")
# p <-
#   rbind(estimated_KDM, estimated_normal) %>%
#   dplyr::mutate(Errors = `Estimated values`-`True values`) %>%
#   ggplot2::ggplot(aes(x = `True values`,
#                       y = `Errors`,
#                       color = colour)) +
#   ggplot2::geom_point(size = 2,
#                       shape = 1) +
#   ggplot2::facet_wrap(~ parameter,
#                       ncol = 2,
#                       scales = "free_x") +
#   ggplot2::scale_color_manual(values = c("#619CFF", "#F8766D")) +
#   ggplot2::geom_hline(yintercept = 0) +
#   ggplot2::lims(y = c(-0.6, 0.6)) +
#   ggplot2::theme_bw()
# plotly::ggplotly(p)


## ----estimated-item-ggplot, echo=FALSE, fig=TRUE, fig.height=3.5, fig.width=7.5, out.width="108%", fig.align='center', include=knitr::is_latex_output(), eval=knitr::is_latex_output(), fig.cap="Differences in the errors of the item parameter estimates caused by LDE"----
true_values <-
  as.data.frame(true_item[,1:2]) %>%
  tidyr::pivot_longer(cols = everything(),
                      names_to = "parameter",
                      values_to = "True values")
estimated_KDM <-
  as.data.frame(model_KDM$par_est[,1:2]) %>%
  tidyr::pivot_longer(cols = everything(),
                      names_to = "parameter",
                      values_to = "Estimated values") %>%
  dplyr::mutate(true_values[,2],
                colour = "KDM")
estimated_normal <-
  as.data.frame(model_normal$par_est[,1:2]) %>%
  tidyr::pivot_longer(cols = everything(),
                      names_to = "parameter",
                      values_to = "Estimated values") %>%
  dplyr::mutate(true_values[,2],
                colour = "Normal")

rbind(estimated_KDM, estimated_normal) %>%
  dplyr::mutate(Errors = `Estimated values`-`True values`) %>% 
  ggplot2::ggplot(aes(x = `True values`,
                      y = `Errors`,
                      color = colour)) +
  ggplot2::geom_point(size = 2,
                      shape = 1) +
  ggplot2::facet_wrap(~ parameter,
                      ncol = 2,
                      scales = "free_x") +
  ggplot2::scale_color_manual(values = c("#619CFF", "#F8766D")) +
  ggplot2::geom_hline(yintercept = 0) +
  ggplot2::lims(y = c(-0.6, 0.6)) +
  ggplot2::theme_bw()


## ----rmse-table, echo=FALSE---------------------------------------------------
a_n <- sqrt(mean((model_normal$par_est[,1] - true_item[,1])^2))
a_k <- sqrt(mean((model_KDM$par_est[,1] - true_item[,1])^2))
b_n <- sqrt(mean((model_normal$par_est[,2] - true_item[,2])^2))
b_k <- sqrt(mean((model_KDM$par_est[,2] - true_item[,2])^2))
eap_n <- sqrt(mean((theta_eap_normal$theta - true_theta)^2))
eap_k <- sqrt(mean((theta_eap_KDM$theta - true_theta)^2))
mle_n <- sqrt(mean((theta_mle_normal$theta[is.finite(theta_mle_normal$theta)] - true_theta[is.finite(theta_mle_normal$theta)])^2))
mle_k <- sqrt(mean((theta_mle_KDM$theta[is.finite(theta_mle_KDM$theta)] - true_theta[is.finite(theta_mle_KDM$theta)])^2))


## ----rmse-static, eval = knitr::is_latex_output(), echo=FALSE-----------------
rmse_tab <- 
  matrix(c(a_n,a_k,b_n,b_k,eap_n,eap_k,mle_n,mle_k), ncol = 2, byrow = T) %>%
  data.frame(row.names = c("a", "b", "EAP", "MLE"))
colnames(rmse_tab) <- c("Normal", "KDM")

knitr::kable(rmse_tab, format = "latex", caption = "RMSEs from the normality assumption model and KDM", digits = 3, booktabs = T) %>% 
  kableExtra::kable_styling(font_size = 7, position = "center") %>%
  column_spec(1,width = "1in") %>%
  column_spec(2,width = "1in") %>%
  column_spec(3,width = "1in")


## ----rmse-interactive, eval = knitr::is_html_output(), layout = "l-body", echo=FALSE----
# rmse_tab <-
#   matrix(c(a_n,a_k,b_n,b_k,eap_n,eap_k,mle_n,mle_k), ncol = 2, byrow = T) %>%
#   data.frame(row.names = c("$a$", "$b$", "$\\theta_{EAP}$", "$\\theta_{MLE}$"))
# colnames(rmse_tab) <- c("Normal", "KDM")
# 
# knitr::kable(rmse_tab, format = "html", caption = "RMSEs from the normality assumption model and KDM", digits = 3, booktabs = T, table.attr = "style='width:40%;'") %>%
#  kableExtra::kable_styling(position = "center")


## ----data, echo=TRUE----------------------------------------------------------
data_GCBS <- read.csv("data/data_GCBS.csv")


## ----model fitting, message=FALSE, echo=TRUE----------------------------------
# Davidian-curve method
DCMs <- list()
for(i in 1:10){
    DCMs[[i]] <- IRTest::IRTest_Poly(data = data_GCBS, latent_dist = "DC", h = i)
}
names(DCMs) <- paste0("DC", 1:10)

# kernel density estimation method
KDM <- IRTest::IRTest_Poly(data = data_GCBS, latent_dist = "KDE")


## ----best DCM, echo=TRUE, results='markup'------------------------------------
do.call(what = IRTest::best_model, args = DCMs)


## ----KDM DCM, echo=TRUE, results='markup'-------------------------------------
IRTest::best_model(DCMs$DC8, KDM, criterion = "logLik")


## ----summary, echo=TRUE, results='markup'-------------------------------------
summary(KDM)


## ----realplot-html, echo=FALSE, fig=TRUE, fig.height=3, fig.width=7, fig.align='center', include=knitr::is_html_output(), eval=knitr::is_html_output(), fig.cap="Estimated latent distribution for the GCBS data"----
# plot(KDM, mapping = aes(color = "Estimated"), linewidth = 1) +
#   stat_function(fun = dnorm, linewidth = .8, mapping = aes(color = "Normal"))+
#   lims(x = c(-6, 6), y = c(0, 0.6)) +
#   scale_color_manual(values = c("#619CFF", "#F8766D")) +
#   theme_bw()


## ----realplot-latex, echo=FALSE, fig=TRUE, fig.height=3, fig.width=7, out.width="80%", fig.align='center', include=knitr::is_latex_output(), eval=knitr::is_latex_output(), fig.cap="Estimated latent distribution for the GCBS data"----
plot(KDM, mapping = aes(color = "Estimated"), linewidth = 1) +
  stat_function(fun = dnorm, linewidth = .8, mapping = aes(color = "Normal"))+
  lims(x = c(-6, 6), y = c(0, 0.6)) +
  scale_color_manual(values = c("#619CFF", "#F8766D")) +
  theme_bw()


## ----coef, echo=TRUE, results='markup'----------------------------------------
stats::coef(KDM)
IRTest::coef_se(KDM)


## ----ability example code, echo=TRUE, eval=FALSE, results='markup'------------
# IRTest::factor_score(KDM, ability_method = "EAP")


## ----plotitem-latex, echo=FALSE, fig.height=5, fig.width=8.5, out.width="100%", fig.align='center', include=knitr::is_latex_output(), eval=knitr::is_latex_output(), fig.cap="Item response functions of Item 4, 10, 12, and 15"----
plot1 <- IRTest::plot_item(KDM, 4)
plot2 <- IRTest::plot_item(KDM, 10)
plot3 <- IRTest::plot_item(KDM, 12)
plot4 <- IRTest::plot_item(KDM, 15)
grid.arrange(plot1, plot2, plot3, plot4, ncol=2)


## ----plotitem-html, echo=FALSE, fig=TRUE, fig.height=5, fig.width=8, fig.align='center', include=knitr::is_html_output(), eval=knitr::is_html_output(), fig.cap="Item response functions of Item 4, 10, 12, and 15"----
# plot1 <- IRTest::plot_item(KDM, 4)
# plot2 <- IRTest::plot_item(KDM, 10)
# plot3 <- IRTest::plot_item(KDM, 12)
# plot4 <- IRTest::plot_item(KDM, 15)
# grid.arrange(plot1, plot2, plot3, plot4, ncol=2)


## ----reliability, echo=TRUE, results='markup'---------------------------------
IRTest::reliability(KDM)


## ----inform-html, echo=FALSE, fig=TRUE, fig.height=5, fig.width=7, fig.align='center', include=knitr::is_html_output(), eval=knitr::is_html_output(), fig.cap="Item and test information functions"----
# xx <- seq(-6, 6, .1)
# iteminfo <- data.frame(theta=xx,
#                        Item01 = IRTest::inform_f_item(xx, KDM, 1),
#                        Item02 = IRTest::inform_f_item(xx, KDM, 2),
#                        Item03 = IRTest::inform_f_item(xx, KDM, 3),
#                        Item04 = IRTest::inform_f_item(xx, KDM, 4),
#                        Item05 = IRTest::inform_f_item(xx, KDM, 5),
#                        Item06 = IRTest::inform_f_item(xx, KDM, 6),
#                        Item07 = IRTest::inform_f_item(xx, KDM, 7),
#                        Item08 = IRTest::inform_f_item(xx, KDM, 8),
#                        Item09 = IRTest::inform_f_item(xx, KDM, 9),
#                        Item10 = IRTest::inform_f_item(xx, KDM, 10),
#                        Item11 = IRTest::inform_f_item(xx, KDM, 11),
#                        Item12 = IRTest::inform_f_item(xx, KDM, 12),
#                        Item13 = IRTest::inform_f_item(xx, KDM, 13),
#                        Item14 = IRTest::inform_f_item(xx, KDM, 14),
#                        Item15 = IRTest::inform_f_item(xx, KDM, 15)
#                        )
# iteminfo <- pivot_longer(iteminfo,
#                          cols = starts_with("Item"),
#                          names_to = "color",
#                          values_to = "information")
# ppp <-
#   ggplot(iteminfo,
#          aes(x=theta, y=information, color=color))+
#   geom_line(linewidth=.3) +
#   geom_line(data = data.frame(theta=xx, information=inform_f_test(xx, KDM)),
#             aes(x=theta, y=information),
#             color="black",
#             linewidth=.2) +
#   lims(x = c(-6, 6))+
#   theme_bw()
# ggplotly(ppp)


## ----inform-latex, echo=FALSE, fig=TRUE, fig.height=4.4, fig.width=7.5, out.width="110%", fig.align='center', include=knitr::is_latex_output(), eval=knitr::is_latex_output(), fig.cap="Item and test information functions"----
ggplot() +
  stat_function(
    fun = IRTest::inform_f_test,
    args = list(KDM)
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 1),
    mapping = aes(color = "Item 1")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 2),
    mapping = aes(color = "Item 2")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 3),
    mapping = aes(color = "Item 3")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 4),
    mapping = aes(color = "Item 4")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 5),
    mapping = aes(color = "Item 5")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 6),
    mapping = aes(color = "Item 6")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 7),
    mapping = aes(color = "Item 7")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 8),
    mapping = aes(color = "Item 8")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 9),
    mapping = aes(color = "Item 9")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 10),
    mapping = aes(color = "Item10")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 11),
    mapping = aes(color = "Item11")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 12),
    mapping = aes(color = "Item12")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 13),
    mapping = aes(color = "Item13")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 14),
    mapping = aes(color = "Item14")
  ) +
  stat_function(
    fun = IRTest::inform_f_item,
    args = list(KDM, 15),
    mapping = aes(color = "Item15")
  ) +
  lims(x = c(-6, 6))+
  labs(x = expression(theta), y = "information")+
  theme_bw()


## ----cont-IRT, eval=FALSE, echo=TRUE------------------------------------------
# # Generating a continuous item response data
# data <- IRTest::DataGeneration(N = 1000, nitem_C = 10)$data_C
# 
# # Analysis
# model_continuous <- IRTest::IRTest_Cont(data)


## ----mixed format, eval=FALSE, echo=TRUE--------------------------------------
# model_mixed.format <- IRTest::IRTest_Mix(data_D = dichotomous_data,
#                                          data_P = polytomous_data,
#                                          model_D = rep(c("2PL", "3PL"), each = 5),
#                                          model_P = "GPCM")

