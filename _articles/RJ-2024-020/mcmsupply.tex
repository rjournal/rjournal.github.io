% !TeX root = RJwrapper.tex
\title{mcmsupply: An R Package for Estimating Contraceptive Method Market Supply Shares}


\author{by Hannah Comiskey and Niamh Cahill}

\maketitle

\abstract{%
In this paper, we introduce the R package mcmsupply which implements Bayesian hierarchical models for estimating and projecting modern contraceptive market supply shares over time. The package implements four model types. These models vary by the administration level of their outcome estimates (national or subnational estimates) and dataset type utilised in the estimation (multi-country or single-country contraceptive market supply datasets). The mcmsupply package contains a compilation of national and subnational level contraceptive source datasets, generated by Integrated Public Use Microdata Series (IPUMS) and Demographic and Health Survey (DHS) microdata. We describe the functions that implement the models through practical examples. The annual estimates and projections with uncertainty of the contraceptive market supply, produced by mcmsupply at a national and subnational level, are the first of their kind. These estimates and projections have diverse applications, including acting as an indicator of family planning market stability over time and being utilised in the calculation of estimates of modern contraceptive use.
}

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

Family Planning 2030 (FP2030) is a `global movement dedicated to advancing the rights of people everywhere to access reproductive health services safely and on their own terms' (FP2030 2021). One step towards achieving this goal is to quantify \textit{how} people are accessing their modern contraceptive supplies. To date, obtaining estimates of modern contraceptive supply shares in low- and middle-income countries has relied on large-scale national surveys like the Demographic and Health Surveys (DHS). However, these DHS are not annually available and in practice, most countries carry out DHS every 3 to 5 years approximately, with some countries having fewer surveys than this ({``{The DHS Program - Demographic and Health Survey (DHS)}''} 2023). In previous work, we described a model that provides probabilistic estimates of the contraceptive supply share over time with uncertainty and examined the model performance at the national administration division for countries that are participating in FP2030 and have varying amounts of DHS data available (Comiskey, Alkema, and Cahill 2024). The original modern contraceptive supply share model (mcmsupply model) relies on splines, informed by cross-method correlations, to capture temporal variation combined with a hierarchical modelling approach to estimate country-level parameters. Using a multi-country dataset, the original mcmsupply model produces estimates of contraceptive supply market shares at the national level for all countries simultaneously. In this paper, we extend the model to estimate supply shares using input data from a single-country and to also include estimation at the subnational administrative division. At the time of writing, this package and models are the first of their kind to estimate and project modern contraceptive method supply shares at the national and subnational administration levels using Demographic and Health survey data.

For the remainder of the paper, we will refer to the original modern contraceptive supply share model as the multi-country national mcmsupply model. The single-country \CRANpkg{mcmsupply} model uses a scaled-down version of the multi-country approach. It borrows strength from the multi-country model using modular model runs with informative priors placed on key parameters to provide precise outcome estimation, even in the absence of data for a particular contraceptive method. Modularization in Bayesian analysis describes the process within a statistical model where information is restricted to flow only from the prior to the likelihood. Thus, preventing the `contamination' of key parameters from suspect data (Lunn et al. (2009) as cited in Plummer (2015)). In the context of our problem, parameters estimated within the multi-country model are used to inform the priors of the single-country (either national or subnational administrative division) models. This approach prevents spurious parameter estimates due to a lack of data for some locations. To summarise how the single-country and multi-country models are connected to each other, Figure \ref{fig:fig-1} depicts this modelling relationship at the national administration level. The main differences between the multi-country and single-country approaches is that for a single-country model, we only have data for one country (at the national or subnational administration division) and the country-level (in the national model) or subnational-level (in the subnational model) population parameters are informed by estimates from the corresponding multi-country model. In contrast to this, the multi-country model uses national or subnational level data (depending on your administrative level of interest) from many countries simultaneously to estimate model parameters and the country-level (in the national model) or subnational-level (in the subnational model) population parameters are estimated hierarchically. The \CRANpkg{mcmsupply} package contains vignettes that consider case studies of both single-country and multi-country model estimation approaches at the national and subnational administration levels.

\begin{figure}[H]
\includegraphics[width=1\linewidth,height=0.35\textheight]{figures/fig_1} \caption{A flow chart to illustrate the relationship between the multi-country and single-country national estimation approaches. The median estimates of the multi-country national model parameters are used as informative priors in the single-country national model. A legend describing each element of the schematic is located in the blue box.}\label{fig:fig-1}
\end{figure}

The need for a single-country version of the mcmsupply model arose for two primary reasons. Firstly, there was a demand for improved computational efficiency while ensuring that model accuracy remains uncompromised when generating projections of modern contraceptive method supply shares for a single-country. Secondly, the option to accommodate custom data, like incorporating a new survey dataset, was sought to be included in the estimation process for users who require a more tailored analysis.

The inclusion of the functionality to estimate supply shares at the subnational level in the mcmsupply package was spurred by the growing interest in subnational estimation among the family planning community (New et al. 2017; Mercer, Lu, and Proctor 2019; Li et al. 2019). The decentralization of family planning services produces a more equitable and efficient service; however, it also shifts the responsibility of service delivery to lower-level organisations that may not have the capacity to carry-out the role (Williamson et al. 2014). Providing subnational-level estimates can lead to a clearer understanding of localised user preferences, localised user access to family planning commodities and a measure of the true stability contraceptive supply market at a smaller geographic scale (Bossert and Beauvais 2002). These subnational estimates may also be used as part of a localised temperature check for progress towards the FP2030 goals, which include increasing access to contraceptive methods (Munoz and Ali 2022).

This paper introduces the R package \CRANpkg{mcmsupply} for estimating and projecting the contraceptive supply share at the national and subnational administration divisions using multi-country or single-country datasets. The package uses \CRANpkg{tidyverse} throughout to carry out data manipulation and visualisation tasks. The graphics are produced using \CRANpkg{ggplot2} and \CRANpkg{dplyr} is used for any data manipulation procedures. The workflow of the package aims to follow a Bayesian workflow (Gelman et al. 2020). The users are encouraged to explore the data, the model inputs, and the model outputs using diagnostics and visualisations. The individual elements of the workflow are made as accessible as possible through the built-in functions, such as the `get\_data' and `plot\_estimates' functions, and the code provided in the vignettes to test the convergence of the model parameters. To assess convergence, we consider the R-hat values of the model parameters using the plot function of \CRANpkg{rjags}, as well as the individual parameter trace plots (Vehtari, Gelman, Simpson, Carpenter, and Burkner 2021). Figure \ref{fig:fig-2} shows a summary of the different ways users can use the R functions and input data in \CRANpkg{mcmsupply} to carry out model fitting and estimation. The national data contained in the package is derived from the DHS microdata (ICF 2004) while the subnational data is derived from the IPUMS DHS datasets (Herger Boyle, King, and Sobek 2022). In the `Implementation and operation' section, we review the operation and implementation requirements of the \CRANpkg{mcmsupply} R package. In the `Data' section, a detailed description of the data used within the \CRANpkg{mcmsupply} R package is provided, as well as an explanation of the data pre-processing functions \texttt{get\_data} and \texttt{get\_modelinputs}. `The estimation process' section describes the model fitting and visualisation functions within the \CRANpkg{mcmsupply} R package. A basic overview of the process model is provided in `Overview of the mcmsupply process models' with an explanation of some key modelling parameters. The `Model fitting' section explains the \texttt{run\_jagsmodel} function. The \texttt{run\_jagsmodel} function fits models in a Bayesian framework using the JAGS (Just Another Gibbs Sampler) software and produces estimates with uncertainty for the administration level and dataset type of choice (Hornik et al. 2003). The `Model output' section describes the \texttt{plot\_estimates} function that takes the model estimates and visualises them using the R package ggplot2 (Wickham 2016). The `Use cases' section discusses five use cases for modelling modern contraceptive supply shares using the \CRANpkg{mcmsupply} R package. Finally, the conclusions are presented.

\hypertarget{implementation-and-operation}{%
\section{Implementation and operation}\label{implementation-and-operation}}

\CRANpkg{mcmsupply} contains pre-processing functions to clean and prepare raw input data for model fitting at the administrative level of choice (national or subnational) using the dataset type of choice (multi-country or single-country). This R package includes functions to fit Bayesian hierarchical models using the model inputs. Functionality for post-processing and visualisation of the model estimates are also included. The model fitting process described uses Just Another Gibbs Sampler (JAGS). JAGS uses Markov Chain Monte Carlo (MCMC) sampling to produce model estimates for Bayesian hierarchical models (Hornik et al. 2003). For installation, both R (\textgreater=3.5.0) and JAGS (\textgreater=4.0.0) are required. JAGS can be downloaded at \url{https://sourceforge.net/projects/mcmc-JAGS/files/JAGS/}. \CRANpkg{mcmsupply} interacts with JAGS using the wrapper functions supplied by the R package \CRANpkg{R2jags} (Su and Masanao Yajima 2021). The \CRANpkg{mcmsupply} package dependencies are listed in the package \texttt{DESCRIPTION} file and will be automatically installed upon installing the main package. There are no minimum RAM, CPU, or HARDDRIVE requirements apart from what is necessary to store model runs, which varies case-by-case. This software was run on a MacBook Air using macOS 13.1 with a 1.6 GHz Dual-Core Intel Core i5 processor and 8GB of memory.

\hypertarget{data}{%
\section{Data}\label{data}}

\hypertarget{input-data}{%
\subsection{Input data}\label{input-data}}

The \CRANpkg{mcmsupply} package contains the following input data sources:

\begin{itemize}
\tightlist
\item
  Survey data for the national and subnational modern contraceptive supply shares between 1990 and 2022 for a selection of countries participating in the FP2030 initiative.
\item
  Variance-covariance data on the logit scale corresponding to the observed public and commercial medical modern contraceptive supply shares at the national level between 1990 and 2022 for a selection of countries participating in the FP2030 initiative.
\item
  Estimated correlations between the rates of change in method supply shares in the public and private sectors at both the national and subnational administrative divisions. These are derived based on the method outlined in Comiskey et al.~(2023).
\item
  Global and subcontinental parameter estimates obtained from the multi-country model run at the national and subnational level.
\end{itemize}

The inst/data-raw folder of the \CRANpkg{mcmsupply} package contains sample R code that was used to create the model inputs in the case of the covariance arrays, correlations and parameters. This enables users to recalculate their own single-country model parameters and correlations should they wish to do so. The code for the creation of the main input contraceptive supply source data is provided on the \CRANpkg{mcmsupply} \href{https://github.com/hannahcomiskey/mcmsupply}{github} page but the raw data for these datasets cannot be provided. The raw data may be accessed by users through an application to the DHS program for national level data, or the IPUMS program, for subnational level data. Help files for the contraceptive supply source datasets can be accessed by using the command \texttt{?mcmsupply::national\_FPsource\_data} and \texttt{?mcmsupply::subnat\_FPsource\_data}. The national contraceptive supply source data has data for 33 countries (including participants and non-participants of FP2030) between 1990 and 2022. The subnational contraceptive supply source data has data for 256 provinces across 24 countries (all participating in FP2030) between 1990 and 2020. Table \ref{tab:tab-1} is a sample of 6 rows of the subnational contraceptive supply source data.



\begin{table}[H]

\caption{\label{tab:tab-1}The subnational contraceptive supply source data used in the subnational estimation models. Country and Region list the name of the country and province the observation relates to. The Method column lists the type of the contraceptive method supplied. The mid-year when the survey was collected is listed in average\_year. The supply sector is found in sector\_categories. The observed proportion and standard error are found in proportion and SE.proportion. The number of respondent making up each observation are listed in n.}
\centering
\resizebox{\linewidth}{!}{
\begin{tabular}[t]{llllrlrrr}
\toprule
  & Country & Region & Method & average\_year & sector\_categories & proportion & SE.proportion & n\\
\midrule
9512 & Zimbabwe & Midlands & OC Pills & 2010.5 & Commercial\_medical & 0.1601738 & 0.0355722 & 40\\
9513 & Zimbabwe & Midlands & OC Pills & 2010.5 & Other & 0.1018543 & 0.0259602 & 29\\
9514 & Zimbabwe & Midlands & OC Pills & 2010.5 & Public & 0.7379720 & 0.0449851 & 194\\
9515 & Zimbabwe & Midlands & OC Pills & 2015.5 & Commercial\_medical & 0.1929466 & 0.0395410 & 60\\
9516 & Zimbabwe & Midlands & OC Pills & 2015.5 & Other & 0.0428227 & 0.0166039 & 13\\
\addlinespace
9517 & Zimbabwe & Midlands & OC Pills & 2015.5 & Public & 0.7642307 & 0.0387566 & 209\\
\bottomrule
\end{tabular}}
\end{table}

Lastly, data on country classification, ISO codes and area groupings is provided in the dataset \texttt{Country\_and\_area\_classification} (Table \ref{tab:tab-2}). The help file for this dataset can be accessed via the R command \texttt{?mcmsupply::Country\_and\_area\_classification}.



\begin{table}[H]

\caption{\label{tab:tab-2}The Country\_and\_area\_classification dataset is the Track20 project country and area classification data according to the United Nations Statistical Division, standard country or area codes for statistical use (M49). This data set is how we classify each country in subcontinental regions. The name of the country, the International Organization for Standardization (ISO) code for each country, the continent, sub-continent are listed. Details on whether or not a country is defined as a developing, located in Sub-Saharan Africa and the status of its participation in FP2020 (now FP2030) are also provided.}
\centering
\resizebox{\linewidth}{!}{
\begin{tabular}[t]{lrllllll}
\toprule
Country or area & ISO Code & Major area & Region & Developed region & Least developed country & Sub-Saharan Africa & FP2020\\
\midrule
Afghanistan & 4 & Asia & Southern Asia & No & Yes & No & Yes\\
Albania & 8 & Europe & Southern Europe & Yes & No & No & No\\
Algeria & 12 & Africa & Northern Africa & No & No & No & No\\
American Samoa & 16 & Oceania & Polynesia & No & No & No & No\\
Andorra & 20 & Europe & Southern Europe & Yes & No & No & No\\
\addlinespace
Angola & 24 & Africa & Middle Africa & No & Yes & Yes & No\\
\bottomrule
\end{tabular}}
\end{table}

\hypertarget{data-pre-processing}{%
\subsection{Data pre-processing}\label{data-pre-processing}}

In \CRANpkg{mcmsupply}, the data processing occurs in two steps: First, the raw input data is retrieved and preliminary cleaning to the dataset is completed. Secondly, the cleaned data is processed to provide the model inputs for the Bayesian hierarchical model. This two-step process removes any black-box element to the model fitting process and allows the user to review the data at both stages and refer to it later when considering model outputs.
The first step involves the \texttt{get\_data} function. This function retrieves the raw data from the stored contraceptive supply source dataset, does data cleaning and processing to address any issues with missing data and regional naming inconsistencies. Its arguments are summarized in Table \ref{tab:tab1}. The \texttt{get\_data} function carries out several data pre-processing tasks. For example, it will remove observations where two or more sectors are missing. It also checks to see if observations across all three sectors sum to one and will replace missing observations with 0 when the total does sum to one. The function transforms the raw data away from the (0,1) boundary as parameter estimates that lie on the distribution limits cause issues with convergence during the model estimation process. Finally, the \texttt{get\_data} function imputes any missing standard errors using a binomial approximation. To use the the \texttt{get\_data} function, the user first defines whether they wish to use national or subnational level administrative data via the \texttt{national} argument. National level data is accessed when the \texttt{national} argument is set to \texttt{TRUE}. When subnational administrative data is required, the user sets national to \texttt{FALSE}. Similarly, the user defines whether they want to use multi-country estimation with data from multiple countries or single-country estimation with data from a single-country via the \texttt{local} argument. The default setting for the \texttt{local} argument is \texttt{FALSE}. This induces a multi-country estimation, where the outcomes for all the countries in the contraceptive supply source dataset will be estimated simultaneously. In the event of single-country estimation, the user sets \texttt{local} to TRUE and indicates their country of interest via the \texttt{mycountry} argument. The names of the countries listed in the package data can be found in the country\_names dataset. The help file for this dataset can be accessed via the R command \texttt{?mcmsupply::country\_names}. The \texttt{fp2030} argument controls whether to include countries that are participating in the FP2030 initiative or not. The default includes only the named FP2030 countries (see \texttt{country\_names}) in the dataset. There is the optional functionality to include a custom dataset. This allows the user to run the model on data outside of that stored within the package. The \texttt{surveydata\_filepath} is a character string that denotes the location of the custom dataset. The file must meet a series of internal checks on file type, column names, suitable data ranges and missing data. When a custom dataset is supplied to \texttt{get\_data}, the function carries out the checks and alerts the user to any differences between what is expected and what has been supplied. If \texttt{surveydata\_filepath} is left as \texttt{NULL}, by default the function uses the stored \texttt{national\_FPsource\_data} or \texttt{subnat\_FPsource\_data}, depending on what administrative level the user has specified via the \texttt{national} argument (Table \ref{tab:tab1}). The \texttt{get\_data} function returns a list containing the cleaned data and a list of arguments supplied to the function. Storing the arguments of the \texttt{get\_data} function allows the set-up information to flow without requiring the user to repeatedly supply the same arguments for each step of the modelling process.

\begin{table}[h]
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
\textbf{Argument} &
  \textbf{Data type} &
  \textbf{Description} \\ \hline
national &
  Character &
  \begin{tabular}[c]{@{}c@{}}It indicates whether the user is interested in using data at the\\ national or subnational administration level. \\ This is a binary TRUE or FALSE argument. \\ Default is TRUE which retrieves national level data, while \\ FALSE retrieves subnational data.\end{tabular} \\ \hline
local &
  Character &
  \begin{tabular}[c]{@{}c@{}}It indicates whether the user is interested in using data for a\\ single population or not. \\ This is a binary TRUE or FALSE argument. \\ Default is FALSE.\end{tabular} \\ \hline
mycountry &
  Character &
  \begin{tabular}[c]{@{}c@{}}This is the name of the country you wish to do single-country \\ estimation for. The data will only be returned for this country. \\ Default is NULL.\end{tabular} \\ \hline
fp2030 &
  Character &
  \begin{tabular}[c]{@{}c@{}}It indicates whether the user is interested in using only \\ countries participating in FP2030. \\ This is a binary TRUE or FALSE argument. \\ Default is TRUE.\end{tabular} \\ \hline
surveydata\_filepath &
  Character string &
  \begin{tabular}[c]{@{}c@{}}Pathway to the location of the custom dataset. \\ When left as NULL, the function \\ automatically uses the stored datasets. \\ Default is NULL.\end{tabular} \\ \hline
\end{tabular}%
}
\caption{The arguments of the get\_data function. The purpose of this function is to retrieve and clean the Demographic and Health Survey (DHS) data or custom user supplied data for use in supply share estimation. The ‘Argument’ column names the function component. Data type describes the argument. Description explains the purpose of the argument and any default entries. }
\label{tab:tab1}
\end{table}

Step two of the data pre-processing is the \texttt{get\_modelinputs} function. This function takes the cleaned data from the previous step and repackages it into suitable inputs for the model implementation. The arguments of the function are summarised in Table \ref{tab:tab2}. This function uses the arguments set in the \texttt{get\_data} function as well as additional parameters for the model. These parameters include the year the user wishes to begin their estimation at and the year they finish on. In the \CRANpkg{mcmsupply} package, the models use basis splines (B-splines), to capture the complexities in variation of the contraceptive supply source data over time. The use of splines for the estimation of demographic indicators is growing in popularity. Previous studies used small-area estimation models with splines to capture complex shapes of demographic spatio-temporal data (M. D. Ugarte, Goicoa, and Militino 2010; M. D. Ugarte et al. 2009). In recent years, many international health organisations have also used splines for the estimation of key demographic indicators. These include the estimation and projection of under-5 mortality for United Nations Children's Fund (UNICEF) (Sharrow et al. 2019) and the estimation of excess morality due to Covid-19 for the World Health Organisation (WHO) (Knutson et al. 2023). We build on these previous studies to use penalised regression splines in the mcmsupply R package. B-splines use basis-functions to create piecewise cubic polynomials. The number of basis functions that are fit to the data is determined by the number of knots. Knots are the locations along the x-axis where the piecewise polynomials of the B-splines join. As you increase the number of knots in the basis functions, the B-splines give a tighter fit to the data. Similarly, if you decrease the number of knots in the basis, you will get a smoother fit to your data. In the \CRANpkg{mcmsupply} package, the user may alter the number of knots (\texttt{nsegments}) used in the basis functions. The default number of knots is \texttt{12}, as was used in Comiskey et al.~(2023). This equates to a knot approximately every 3.5 years. Through validation, it was found that having fewer knots dis-improved model fit, while more knots did not significantly improve model fit. Like the \texttt{get\_data} function, this function returns a list containing the model inputs and the function arguments.

\begin{table}[h]
\caption{The arguments of the get\_modelinputs function. The purpose of this function is to get the model inputs for the JAGS model used for supply share estimation. In the table, the argument name and data type of the argument is stated, a description of the argument and any default values is then provided.}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
\textbf{Argument} & \textbf{Data type} & \textbf{Description}                            \\ \hline
startyear         & Numeric            & The year you wish to start your estimation at.  \\ \hline
endyear           & Numeric            & The year you wish to finish your estimation at. \\ \hline
nsegments &
  Numeric &
  \begin{tabular}[c]{@{}c@{}}The number of knots   you wish to include in your basis functions. \\ Default is 12.\end{tabular} \\ \hline
raw\_data &
  List &
  \begin{tabular}[c]{@{}c@{}}The output of the get\_data function, which includes a list \\ of the function arguments used and the \\ cleaned contraceptive supply source data.\end{tabular} \\ \hline
\end{tabular}%
}
\label{tab:tab2}
\end{table}

\hypertarget{the-estimation-process}{%
\section{The estimation process}\label{the-estimation-process}}

The \CRANpkg{mcmsupply} R package contains four Bayesian models, each of which aims to estimate and project contraceptive method supply shares over time with uncertainty. These models vary by the administration level of their outcome estimates (national or subnational estimates) and dataset type utilised in the estimation (multi-country or single-country contraceptive market supply datasets). A full mathematical description of all the models contained within \CRANpkg{mcmsupply} is described in the supplementary material. \footnote{At the time of publication it is expected that this material will be made available via another open access venue.}. A summary of each of the parameters and their role within each model can be found in Table \ref{tab:tab4} while a visual summary of the national model, using both multi-country and single-country inputs, can be found in Figure \ref{fig:fig-1}.

\hypertarget{brief-model-overview}{%
\subsection{Brief model overview}\label{brief-model-overview}}

The outcome of interest is the components of a compositional vector \(\boldsymbol{{\phi_{q,t,m}}}\), which captures the proportion of contraceptive method m, at time t, in population q supplied across the public and private sectors.

Let,
\begin{equation}
\boldsymbol{{\phi_{q,t,m}}} =(\phi_{q,t,m,1},\phi_{q,t,m,2},\phi_{q,t,m,3}),
   \label{eq:eq1}
\end{equation}

where, \newline
\(\phi_{q,t,m,s}\) is the proportion supplied by the public sector (s =1), the private commercial medical sector (s=2) and the other private sector (s=3) of modern contraceptive method m, at time t, in population q (national or subnational). \newline 

Figure \ref{tab:tab1} shows the model set up for the national level models. A similar approach is taken when estimating modern contraceptive method supply at the subnational administration level. For each model within the \CRANpkg{mcmsupply} package, the latent variable \(\psi_{q,m,t,s}\) relies on a spline to capture the underlying process that generates the data, on the logit scale, for sector s, in year t, for method m and population q (depending on the administration level of interest) .

\begin{equation}
   \psi_{q,t,m,1}=\sum_{k=1}^K \beta_{q,m,1,k} B_{q,k}(t),
   \label{eq:eq2}
\end{equation}

where, \newline
\(\beta_{q,m,1,k}\) is the \(k^{th}\) spline coefficient for sector s, method m in population q. \newline
\(B_{q,k}(t)\) is the \(k^{th}\) basis function fit to the data for population q. \newline

We assume that in population q, for method m and sector s, the value of spline coefficient at knot index \(k^*\), aligning with the year \(t^*\), the most recent survey available, is \(\alpha_{q, m, s}\). By doing this, we are assuming that the \(\alpha_{q,m,s}\) parameter will act as the spline coefficient for the reference spline at \(k^*\). We are then able to calculate the remaining spline coefficients using a random walk model of order 1 on spline coefficients from the reference index (\(k^*\)) using the penalised \(\boldsymbol{\delta_{q,m,s}}\).

Let,
\begin{equation}
    \beta_{q,m, s, k}=\left\{\begin{array}{c}
    \alpha_{q,m,s} \quad k=k^*, \\
    \beta_{q,m,s, k+1}-\delta_{q, m, s, k} \quad k<k^*, \\
    \beta_{q,m,s, k-1}+\delta_{q, m, s, k-1} \quad k>k^*,
\end{array}\right.
   \label{eq:eq3}
\end{equation}

where, \newline
\(\alpha_{q,m,s}\) is the most recently observed supply share, on the logit scale, for sector s , method m, in population q. This parameter is estimated hierarchically. The geographical set-up of this estimation process adapts to match the administrative level of interest. For example, the subnational multi-country models contain an additional layer of geography (world \textgreater{} subcontinent \textgreater{} country \textgreater{} province) in the hierarchical set-up that the national models don't have, which accounts for the subnational administration levels. \newline
k is the knot index along the set of basis splines \(B_{q,k}(t)\) \newline
\(k^*\) is the index of the knot that corresponds with \(t^*\), the year index where the most recent survey occurred in population q. \newline
\(\delta_{q,m,s,k-1}\) is the first order difference between spline coefficients \(\beta_{q,m, s, K}\) and \(\beta_{q,m, s,K-1}\). These reflect the changes in method supply shares over time. Within each sector, the first-order differences are assumed to be correlated between methods. These correlations were estimated using a maximum \textit{a posteriori} estimator for the correlation matrix first described in Azose and Raftery, (2018) and adapted for method supply shares in Comiskey et al.~(2023). These estimated correlations are available as data for both the national and subnational models. Please see the Data section of this paper for more details. \newline



\begin{table}[H]
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
\textbf{Model type} &
  \textbf{Parameter name} &
  \textbf{Parameter purpose} \\ \hline
\multirow{4}{*}{Multi-country national} &
  P &
  \begin{tabular}[c]{@{}c@{}} The method supply share proportions \\ across all countries, methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  beta.k &
  \begin{tabular}[c]{@{}c@{}}The set of spline coefficients for ($\beta_{c,m,s,k}$) \\ for all countries, methods and sectors at each knot.\end{tabular} \\ \cline{2-3} 
 &
  alpha\_cms &
  \begin{tabular}[c]{@{}c@{}}The intercept term ($\alpha_{c,m,s}$) \\ for all countries, methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  delta.k &
  \begin{tabular}[c]{@{}c@{}}The   first order differences between spline coefficients ($\delta_{c,m,s,k}$) \\ across all knots for all countries, methods and sectors\end{tabular} \\ \hline
\multirow{4}{*}{Single-country national} &
  P &
  \begin{tabular}[c]{@{}c@{}}The method supply share proportions \\ for a given country, across all methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  alpha\_cms &
  \begin{tabular}[c]{@{}c@{}}The intercept term ($\alpha_{c,m,s}$) for \\ the country of interest c, across all methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  inv.sigma\_delta &
  \begin{tabular}[c]{@{}c@{}}The precision matrix used in the \\ multivariate normal prior of $\delta_{c,1:M,s,k}$\end{tabular} \\ \cline{2-3} 
 &
  beta.k &
  \begin{tabular}[c]{@{}c@{}}The set of spline coefficients ($\beta_{c,m,s,k}$) for \\ the country of interest c, across all methods and sectors at each knot.\end{tabular} \\ \hline
\multirow{6}{*}{Multi-country subnational} &
  alpha\_pms &
  \begin{tabular}[c]{@{}c@{}}The intercept term ($\alpha_{p,m,s}$)  \\ for all subnational provinces, methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  alpha\_cms &
  \begin{tabular}[c]{@{}c@{}}The intercept term   ($\alpha_{c,m,s}$) \\ for all countries, methods and sectors.   \\ $\alpha_{c[p],m,s}$ is the expected value of $\alpha_{p,m,s}$.\end{tabular} \\ \cline{2-3} 
 &
  inv.sigma\_delta &
  \begin{tabular}[c]{@{}c@{}}The precision matrix used in the \\ multivariate normal prior of  $\delta_{p,1:M,s,k}$\end{tabular} \\ \cline{2-3} 
 &
  tau\_alpha\_pms &
  \begin{tabular}[c]{@{}c@{}}The sector-specific precision\\ associated with $\alpha_{p,m,s}$\end{tabular} \\ \cline{2-3} 
 &
  beta.k &
  \begin{tabular}[c]{@{}c@{}}The set of spline coefficients ($\beta_{p,m,s,k}$) \\ across all subnational provinces, methods and sectors at each knot.\end{tabular} \\ \cline{2-3} 
 &
  delta.k &
  \begin{tabular}[c]{@{}c@{}}The first order differences between spline coefficients \\ across all knots ($\delta_{p,m,s,k}$) for all provinces, methods and sectors.\end{tabular} \\ \hline
\multirow{3}{*}{Single-country subnational} &
  P &
  \begin{tabular}[c]{@{}c@{}}The method supply share proportions for the \\ subnational provinces in the country of interest, for all methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  alpha\_pms &
  \begin{tabular}[c]{@{}c@{}}The intercept term ($\alpha_{p,m,s}$) for the \\ subnational provinces in the country of interest, for all methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  beta.k &
  \begin{tabular}[c]{@{}c@{}}The set of spline coefficients ($\beta_{p,m,s,k}$) \\ for the subnational provinces in the country of interest, \\ across all methods and sectors at each knot\end{tabular} \\ \hline
\end{tabular}%
}
\caption{This table summarises the purpose of each parameter within each of the four models described in the \CRANpkg{mcmsupply} R package. The four types of models are listed in the `Model type' column. For each model, the parameters listed in the `Parameter name' column are the default parameters monitored when the argument \texttt{jagsparams=NULL} is used within the \texttt{run\_jags\_model} function. `Parameter purpose' explains the role each parameter plays within the estimation process and the notation can be linked directly to the `Model overview' section of this paper.}
\label{tab:tab4}
\end{table}

\hypertarget{model-fitting}{%
\subsection{Model fitting}\label{model-fitting}}

The \texttt{run\_jags\_model} function fits the selected JAGS model to the supplied data and returns a list of MCMC samples and point summaries for the time-period and locations of interest. Initial set-up arguments (\texttt{national}, \texttt{local}, \texttt{mycountry}) are inherited from the specification of the previous \texttt{get\_modelinputs} function. The additional inputs of this function are summarised in Table \ref{tab:tab3}. The \texttt{jagsdata} argument of this function is a list of initial set-up arguments and JAGS model inputs gathered from the \texttt{get\_modelinputs} function. \texttt{jagsparams} is a vector of strings that name the model parameters the user wishes to monitor within the JAGS model. The default is \texttt{NULL}. When \texttt{jagsparams\ =\ NULL}, the function will refer to a stored vector of parameters to monitor (Table \ref{tab:tab4}). The JAGS parameters of \texttt{n\_iter\ =\ 80000}, \texttt{n\_burnin\ =\ 10000} and \texttt{n\_thin\ =\ 35} ensure that the model has converged and that the final posterior sample size is 2000 samples. The function \texttt{get\_point\_estimates} takes the chains produced by the JAGS model and estimates the median, 95\% credible intervals and 80\% credible intervals. The \texttt{get\_point\_estimates} function runs automatically inside the \texttt{run\_jags\_model} function and returns the point summaries as part of the \texttt{run\_jags\_model} function output. The \texttt{run\_jags\_model} function returns a list containing the JAGS output of the model and the point summaries for the estimates.

\begin{table}[]
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
\textbf{Argument} & \textbf{Data type} & \textbf{Description} \\ \hline
jagsdata &
  List &
  \begin{tabular}[c]{@{}c@{}}The output of the get\_modelinputs function. \\ A list of the initial set-up arguments and the JAGS inputs \\ required using the data.\end{tabular} \\ \hline
jagsparams &
  Vector &
  \begin{tabular}[c]{@{}c@{}}A string vector of model parameters to be monitored. \\ NULL invokes a standard  vector to be used \\ Default is NULL.\end{tabular} \\ \hline
n\_iter           & Numeric            & \begin{tabular}[c]{@{}c@{}}Number of iterations you wish to run your JAGS model for. \\ Default is 80000.\end{tabular}       \\ \hline
n\_burnin         & Numeric            & \begin{tabular}[c]{@{}c@{}}Number of burn-in   samples you wish to run your JAGS model for. \\ Default is 10000\end{tabular} \\ \hline
n\_thin           & Numeric            & \begin{tabular}[c]{@{}c@{}}Number of samples you wish to thin your JAGS sample by. \\ Default is 35.\end{tabular}            \\ \hline
\end{tabular}%
}
\caption{The arguments of the run\_jags\_model function. The purpose of this function is to run the Bayesian hierarchical models stored within the \CRANpkg{mcmsupply}  package for either single- or multi-country datasets at the administration level of interest. The argument name and data type of the argument is stated, a description and any default values of the argument are then provided.}
\label{tab:tab3}
\end{table}

\hypertarget{model-output}{%
\subsection{Model output}\label{model-output}}

The user then runs the function \texttt{plot\_estimates}. This function visualises the point estimates with uncertainty alongside the data using the initial set up inputs of the \texttt{get\_modelinputs} function and the output of the \texttt{run\_jags\_model} function (Table \ref{tab:tab5}). The \texttt{plot\_estimates} function returns a list of \CRANpkg{ggplot2} objects, one for each country (when using the national model) or subnational region (when using the subnational model).

\begin{table}[]
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
\textbf{Argument} &
  \textbf{Data type} &
  \textbf{Description} \\ \hline
jagsdata &
  List &
  \begin{tabular}[c]{@{}c@{}}A list of the initial set-up arguments and the JAGS inputs required \\ using the data retrieved in the get\_modelinputs function.\end{tabular} \\ \hline
model\_output &
  List &
  \begin{tabular}[c]{@{}c@{}}The object assigned to store the list of  MCMC results and estimate \\ summary output from the run\_jags\_model function.\end{tabular} \\ \hline
\end{tabular}%
}
\caption{The arguments of the plot\_estimates function. The purpose of this function is to plot the data alongside the model estimates so that users can visualise their estimated method supply shares. The argument name and data type of the argument is stated, a description of the argument is then provided. }
\label{tab:tab5}
\end{table}

\begin{figure}[H]
\includegraphics[width=1\linewidth,height=0.35\textheight]{figures/fig_2} \caption{A flow chart to illustrate the decision processes that lead to the different estimation types within the mcmsupply package. The first decision is with respect to the administrative level of the estimates you wish to create – they may be either national level or subnational level. An explanation of each division is found on the first row of the figure. The second decision is with respect to the number of countries you wish to estimate – the user may estimate the proportions for all the countries at once or only one country. An explanation of each in the context of the specific administrative division is found on the second row of the figure. A set of sample functions used to estimate and plot the estimates for each modelling option are located on the third row of the figure}\label{fig:fig-2}
\end{figure}

\hypertarget{use-cases}{%
\section{Use cases}\label{use-cases}}

\hypertarget{case-1-estimating-contraceptive-method-supply-shares-at-the-national-administration-level-for-multiple-countries-simultaneously}{%
\subsection{Case 1: Estimating contraceptive method supply shares at the national administration level for multiple countries simultaneously}\label{case-1-estimating-contraceptive-method-supply-shares-at-the-national-administration-level-for-multiple-countries-simultaneously}}

The first use case describes how the user can estimate modern contraceptive method supply shares at the national administrative level over time for multiple countries at once (i.e., using the multi-country national model). This use case is described in \texttt{national\_multicountry\_mod} found in the \texttt{vignettes} folder. This vignette takes approximately 12 hours to run when using the recommended JAGS arguments, on a machine with 1.6 GHz Dual-Core Intel Core i5 processor and 8GB of RAM. The \texttt{national\_FPsource\_data} dataset contains observations for 30 countries. The user begins by accessing the \texttt{national\_FPsource\_data} dataset through the \texttt{get\_data} function with the argument \texttt{national=TRUE}, and the remaining arguments sets to their default values, to indicate that they are interested in national-level data for the FP2030 countries present in the data.

\begin{verbatim}
cleaned_natdata <- get_data(national = TRUE)

dplyr::glimpse(cleaned_natdata$mydata)
\end{verbatim}

Next, this data is supplied to the \texttt{get\_modelinputs} function. This function reshapes the data into a list of inputs for the JAGS model. At this point, the user must indicate the start and end years they wish to estimate between. The \texttt{n\_segments} argument controls how many knots will be used in the basis functions. The default number of segments is 12. Lastly, the cleaned national data from the \texttt{get\_data} function is provided to the \texttt{get\_modelinputs} function via the \texttt{raw\_data} argument.

\begin{verbatim}
pkg_data <- get_modelinputs(startyear = 1990, 
                            endyear = 2025.5, 
                            nsegments = 12, 
                            raw_data = cleaned_natdata)
\end{verbatim}

This list of data and model inputs is then fed into the JAGS model via the \texttt{run\_jags\_model} function. In this instance, the user wishes to monitor the default set of parameters within the JAGS model. Therefore, they set the \texttt{jagsparams} argument to \texttt{NULL}, which invokes the function to use the default list. The parameters for running the JAGS model are set via the \texttt{n\_iter}, \texttt{n\_burnin} and \texttt{n\_thin} arguments. For demonstration purposes in the code below, these arguments are set to low values. However, for optimal model convergence we recommend increasing the iterations to 80,0000, the burn-in period to 10,000, and the thinning to 35. Please note that for these increased values of arguments, the model run time is approximately 12 hours. As part of the \texttt{run\_jags\_model} function, the median and 80\% and 95\% credible intervals for the estimates are calculated. To assess convergence, we considered the convergence diagnostic \(\hat{R}\), as well as the individual parameter trace plots (Vehtari, Gelman, Simpson, Carpenter, and Bürkner 2021).

\begin{verbatim}
mod <- run_jags_model(jagsdata = pkg_data, 
                      jagsparams = NULL,
                      n_iter = 80, 
                      n_burnin = 10, 
                      n_thin = 2)
\end{verbatim}

\begin{verbatim}
plot(mod$JAGS)

sample_draws <- tidybayes::tidy_draws(mod$JAGS$BUGSoutput$sims.matrix)

var <- sample_draws %>% dplyr::select(.chain, .iteration, .draw,`P[1,2,1,1]`) %>%
  dplyr::mutate(chain = rep(1:2, each=mod$JAGS$BUGSoutput$n.keep)) %>%
  dplyr::mutate(iteration = rep(1:mod$JAGS$BUGSoutput$n.keep, 2))

ggplot2::ggplot(data=var) +
  ggplot2::geom_line(ggplot2::aes(x=iteration, y=`P[1,2,1,1]`, color=as.factor(chain)))
\end{verbatim}

The final JAGS model output and the summary estimates are returned as a list. Finally, these summary estimates are visualised via the \texttt{plot\_estimates} function using the R package \CRANpkg{ggplot2} (Figure \ref{fig:fig-3}).

\begin{verbatim}
plots <- plot_estimates(jagsdata = pkg_data, 
                        model_output = mod) 
\end{verbatim}



\begin{figure}[H]
\includegraphics[width=1\linewidth,height=0.4\textheight]{figures/fig_3} \caption{The plotted posterior point estimates for each of the three sectors (public in blue, private commercial medical in grey, and private other in gold) for Nepal at the national administrative level over time with the 80\% and 95\% uncertainty interval denoted as shaded regions. Time in years is on the x-axis and the proportion of each contraceptive method supply share is on the y-axis. The survey observations are plotted as points with their associated standard error, plotted as vertical lines. This plot was produced using a multi-country set up of the \CRANpkg{mcmsupply} functions.}\label{fig:fig-3}
\end{figure}

If the user wishes to pull out specific estimates for a given country and year, they may do so using the \texttt{pull\_estimates} function. The model object, country name and the year of interest are supplied, the function then returns a tibble of the corresponding estimates.

\begin{verbatim}
estimates_2018 <- pull_estimates(model_output = mod, country = 'Nepal', year=2018)
\end{verbatim}

\hypertarget{case-2-estimating-contraceptive-method-supply-shares-at-the-national-administration-level-for-a-single-country}{%
\subsection{Case 2: Estimating contraceptive method supply shares at the national administration level for a single-country}\label{case-2-estimating-contraceptive-method-supply-shares-at-the-national-administration-level-for-a-single-country}}

This case considers when the estimates at the national administration level are required for only one country. Rather than running a multi-country model, which takes several hours, a quicker alternative is the single-country approach, which takes only a few minutes. The main difference between the multi-country and single-country model outputs is that the model estimates of the single-country models have slightly larger uncertainty. This is especially evident where data is absent for a particular method. For example in Figure \ref{fig:fig-3}, the width of the 95\% credible intervals over time for implants estimated by the multi-country national model are smaller than those estimated in the single-country model (Figure \ref{fig:fig-4}). The arguments \texttt{local} and \texttt{mycountry} control the single-country estimation models in \CRANpkg{mcmsupply}. The user begins as by retrieving the data for Nepal only using the \texttt{get\_data} function. They set \texttt{local=TRUE} and specify which country they are interested in by setting \texttt{mycountry=Nepal}.

\begin{verbatim}
cleaned_natdata <- get_data(national = TRUE, 
                            local = TRUE,
                            mycountry = "Nepal")
\end{verbatim}

These arguments are the only discernible differences in the commands for users, the rest of the workflow is as described above in Case 1. A complete workflow for this use case can be found in \texttt{vignettes/national\_singlecountry\_mod}. The single-country model produces model estimates that align with those estimated by the multi-country estimation model.



\begin{figure}[H]
\includegraphics[width=1\linewidth,height=0.4\textheight]{figures/fig_4} \caption{The plotted posterior point estimates for each of the three sectors (public in blue, private commercial medical in grey, and private other in gold) for Nepal at the national administrative level over time with the 80\% and 95\% uncertainty interval denoted as shaded regions. Time in years is on the x-axis and the proportion of each contraceptive method supply share is on the y-axis. The survey observations are plotted as points with their associated standard error, plotted as vertical lines. This plot was produced using a single-country set up of the \CRANpkg{mcmsupply} functions.}\label{fig:fig-4}
\end{figure}

\hypertarget{case-3-estimating-contraceptive-method-supply-shares-at-the-subnational-administration-level-for-multiple-countries-simultaneously}{%
\subsection{Case 3: Estimating contraceptive method supply shares at the subnational administration level for multiple countries simultaneously}\label{case-3-estimating-contraceptive-method-supply-shares-at-the-subnational-administration-level-for-multiple-countries-simultaneously}}

The use case for estimating the contraceptive supply shares via a multi-country model for the subnational administration division is given by the vignette subnational\_multicountry\_models. This vignette takes approximately 24 hours to run on a machine with 1.6 GHz Dual-Core Intel Core i5 processor and 8GB of RAM. The dataset contains observations for 225 subnational divisions, across 23 countries. The user begins by calling the multi-country dataset at the subnational administration level via the \texttt{national} argument.

\begin{verbatim}
cleaned_subnatdata <- get_data(national = FALSE)
\end{verbatim}

\begin{verbatim}
#> Using preloaded dataset!
\end{verbatim}

\begin{verbatim}
#> Joining with `by = join_by(Country, average_year)`
#> Joining with `by = join_by(Country)`
\end{verbatim}

The remaining workflow is the same as described above in Case 1 and is not shown here. A complete workflow for this use case can be found in \texttt{vignettes/subnational\_multicountry\_models}.

\hypertarget{case-4-estimating-contraceptive-method-supply-shares-at-the-subnational-administration-level-for-a-single-country}{%
\subsection{Case 4: Estimating contraceptive method supply shares at the subnational administration level for a single-country}\label{case-4-estimating-contraceptive-method-supply-shares-at-the-subnational-administration-level-for-a-single-country}}

This use case is for considering use of the single-country model at the subnational administrative division. The user begins by retrieving the data for Nepal using the \texttt{get\_data} function by setting the arguments \texttt{national=FALSE}, \texttt{local=TRUE} and \texttt{mycountry=‘Nepal’}.

\begin{verbatim}
cleaned_data <- get_data(national = FALSE, 
                         local = TRUE,
                         mycountry = "Nepal")
\end{verbatim}

As in the previous use cases, the JAGS model is run and point summaries are calculated via the \texttt{run\_jags\_model} function. The visualisations for the subnational regions of Nepal are returns as a list via the \texttt{plot\_estimates} function. An example of these visualisations is given in Figure \ref{fig:fig-5}, where the estimated median method supply shares for Central region of Nepal are plotted with 80\% and 95\% credible intervals over time in each of the methods.



\begin{figure}[H]
\includegraphics[width=1\linewidth,height=0.4\textheight]{figures/fig_5} \caption{The plotted posterior point estimates for each of the three sectors (public in blue, private commercial medical in grey, and private other in gold) taken from the subnational single-country population for the Central subnational region of Nepal over time with both 80\% and 95\% uncertainty denoted as corresponding shaded regions. Time in years is on the x-axis and the proportion of each contraceptive method supply share is on the y-axis. The survey observations are plotted as points with their associated standard error, plotted as vertical lines.}\label{fig:fig-5}
\end{figure}

\hypertarget{case-5-estimating-contraceptive-method-supply-shares-at-the-nationalsubnational-administration-level-for-a-single-country-using-custom-data}{%
\subsection{Case 5: Estimating contraceptive method supply shares at the national/subnational administration level for a single-country using custom data}\label{case-5-estimating-contraceptive-method-supply-shares-at-the-nationalsubnational-administration-level-for-a-single-country-using-custom-data}}

It is possible to include custom datasets when estimating contraceptive method supply shares at either the national or subnational administration level. The set-up for using custom data is very similar to the above processes, with a small difference in the data retrieval step using the \texttt{get\_data} function. When using a custom dataset, the user defines the location of the \texttt{.xlsx} file containing the custom data.

\begin{verbatim}
cleaned_data <- get_data(national = FALSE, 
                         local = TRUE, 
                         surveydata_filepath = 
                           "inst/data-raw/my_custom_data_good.xlsx",
                         mycountry = "Ethiopia")
\end{verbatim}

The file must be in \texttt{.xlsx} format and match the layout of either the \texttt{national\_FPsource\_data} or \texttt{subnat\_FPsource\_data\ datasets}, depending on your desired administration level. The \texttt{get\_data} function will carry out a series of internal checks to ensure the custom data matches the stored data layout. If the custom data is not suitable, the \texttt{get\_data} function will return an error and a message to the user describing the issue with the custom data. A description of each column is given in Table \ref{tab:tab6}. Once the custom data checks are complete and passed, the regular workflow for fitting an \CRANpkg{mcmsupply} model continues. The JAGS model inputs are retrieved using the \texttt{get\_modelinputs} and the JAGS model is fit using \texttt{run\_jags\_model}. The summary estimates are plotted using the \texttt{plot\_estimates} function without any further changes to the workflow. A vignette of how to run the subnational model using a custom dataset can be found \texttt{vignettes/subnational\_singlecountry\_customdata\_models}.

\begin{table}[]
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|c|}
\hline
\textbf{Column name} &
  \textbf{Data type} &
  \textbf{Description} &
  \textbf{Required} \\ \hline
  Country &
  Character &
  \begin{tabular}[c]{@{}c@{}} The name of the country you have the custom data for.\end{tabular} &
  National and subnational \\ \hline
  Region &
  Character &
  \begin{tabular}[c]{@{}c@{}} The name of the subnational area you have the custom data for\end{tabular} &
  Subnational \\ \hline
  Method &
  Character &
  \begin{tabular}[c]{@{}c@{}} The name of the contraceptive method you have the custom data for\end{tabular} &
  National and subnational \\ \hline
  average\_year &
  Numeric &
  \begin{tabular}[c]{@{}c@{}} The year that the observation was collected in. \end{tabular} &
  National and subnational \\ \hline
  sector\_categories &
  Character &
  \begin{tabular}[c]{@{}c@{}} The supply sector of the contraceptive method you have the custom data for.\end{tabular} &
  Subnational \\ \hline
  sector\_category &
  Character &
  \begin{tabular}[c]{@{}c@{}} The supply sector of the contraceptive method you have the custom data for.\end{tabular} &
  National \\ \hline
  proportion &
  Numeric &
  \begin{tabular}[c]{@{}c@{}} The proportion of a given contraceptive method supplied by the observation. \end{tabular} &
  National and subnational \\ \hline
  SE.proportion &
  Numeric &
  \begin{tabular}[c]{@{}c@{}} The associated standard error of the proportion supplied by the observation. \end{tabular} &
  National and subnational \\ \hline
  n &
  Numeric &
  \begin{tabular}[c]{@{}c@{}} The sample size used to estimate the observation. \end{tabular} &
  National and subnational \\ \hline
\end{tabular}%
}
\caption{The required columns when supplying custom data to the get\_data . The column name is given, the type of data expected in each column along with a description of the column. The 'Required' column indicates whether the column belongs in national or subnational custom data files. The get\_data function will carry out a series of internal checks to ensure the custom data matches the stored data layout.}
\label{tab:tab6}
\end{table}

\hypertarget{discussion}{%
\section{Discussion}\label{discussion}}

In this paper we have introduced the package \CRANpkg{mcmsupply}. The primary purpose of this package is to estimate and project modern contraceptive method supply shares from the public, private commercial medical and private other sectors with uncertainty, for a selection of countries participating in the FP2030 initiative. The \CRANpkg{mcmsupply} package produces estimates within the period of available Demographic and Health Survey data for a given country, as well as projections beyond the most recent data point. The package uses either stored DHS survey data or custom user-supplied survey data as inputs to the modelling process. The package implements four model types. These models vary by the administration level of their outcome estimates (national or subnational administration level) and dataset type utilised in the estimation (multi-country or single-country contraceptive market supply datasets). The modelling framework uses penalised splines to capture temporal nature of the data. These splines utilise correlations between changes in method supply shares that exist within the data. Using splines informed by cross-method correlations allows us to capture the complex shape of the data without over-fitting. Bayesian hierarchical estimation is another key element of this model estimation process. We take advantage of the geographical nature of the data, such that the expected sector, province (subnational level) or country (national level), method-specific supply shares are informed based on the existing geographical structures in the data. This promotes information sharing across locations, and better inform estimates in areas where smaller amounts of data are present. Case studies illustrate how to use the \CRANpkg{mcmsupply} for each of the four potential modelling routes, as well as how to estimate contraceptive method supply shares using custom user-supplied data.

The \CRANpkg{mcmsupply} package has many benefits to users. Firstly, it is the first of its kind to produce annual estimates with uncertainty for monitoring contraceptive method supply shares over time at the national and subnational levels. On average, most countries carry out DHS surveys every 5-6 years, but in some instances the wait time between surveys may be even longer ({``{The DHS Program - Demographic and Health Survey (DHS)}''} 2023). The family planning community use contraceptive method supply shares to evaluate the stability and sustainability of a given country's contraceptive market (Bradley and Shiras 2022). Contraceptive method supply share estimates are also pivotal in effectively managing contraceptive commodity supply-chains through a `total market approach' (TMA). A TMA approach to the family planning supply market seeks to engage the public, private commercial, and other sectors in a country to increase family planning users access to vital information, products, and services (Moazzam 2015; Private Sector (SHOPS) Plus 2016). Prior to this package, individuals who required contraceptive method supply shares for a given country relied on estimates from the most recent DHS survey in the country, regardless of its age. The \CRANpkg{mcmsupply} package alleviates this issue and provides the family planning community annual estimates with uncertainty for these contraceptive method supply shares. Secondly, contraceptive method supply shares estimates are not only a stand -alone family planning indicator but are also used in the calculation of an another indicator, estimated modern use (EMU) (Track20 2020b). EMUs aim to measure the proportion of women, aged 15 to 49 years old , who are currently using any modern method of contraception, and are derived from routinely collected family planning service statistics (Track20 2020a). Currently, EMU calculations depend on an adjustment that relies on the most recent DHS survey to provide estimates of the contraceptive supply share market in a given country. Now this adjustment can instead rely on the annual estimates and projections with uncertainty produced by the \CRANpkg{mcmsupply} package. This can serve to improve the overall accuracy of EMUs with respect to their ability to accurately measure modern contraceptive use. In addition, given the probabilistic nature of the \CRANpkg{mcmsupply} estimates the associated uncertainty can be propagated into the EMU calculations.

The last key benefit of the \CRANpkg{mcmsupply} package is the speed at which the user is able to access individual countries supply share estimates. Using the single-country models, at either the national or subnational level, provides users with annual estimates of the method supply shares with uncertainty within minutes. This fast estimation approach is computationally efficient while still producing reliable estimates. Using priors informed by multi-country model subcontinental and country-level median parameter estimates, this modelling approach is robust to spurious parameter estimates even when estimating supply shares for countries with fewer surveys available. This computational efficiency without a loss of model accuracy makes the \CRANpkg{mcmsupply} package user-friendly and efficient for regular data analysis.

The \CRANpkg{mcmsupply} is not without its limitations. We remark that the implementation of these models in JAGS have not been optimised. The multi-country models at the national and subnational levels take hours to run and are intensive on computer memory and CPU. Hence, improvements such as matrix operations rather than for-loops would greatly improve the computation efficiency of this package. Another limitation of this package is that in methods without any survey information, the uncertainty intervals tend to be large. This is especially evident in the single-country models where in the absence of data for a given method, the uncertainty of the associated estimates is even larger than that of the corresponding multi-country model estimates. These limitations inspires our future work, where we seek to improve the computational efficiency of these models. We would also like to investigate the potential for incorporating additional covariates into the models, such as average method pricing for each sector, to improve the uncertainty of model estimates and projections where no DHS survey data is available. Lastly, we wish to design an R-shiny app that promotes the use of these model estimates among statistical non-experts within the family planning community.

\hypertarget{conclusions}{%
\section{Conclusions}\label{conclusions}}

\CRANpkg{mcmsupply} is an R package that estimates the modern contraceptive method supply shares at the national and subnational administrative divisions over time for countries participating in the Family Planning 2030 initiative. The package provides the user an easy and accessible way to produce annual estimates with uncertainty using Bayesian hierarchical penalised spline models with cross-method correlations at the national and subnational administration levels. These annual estimates with uncertainty may act as a stand-alone family planning indicator of the stability of the modern contraceptive supply market or be used to produce alternative family planning indicators, such as estimated modern use (EMUs) using service statistics (Track20 2020b). To the best of our knowledge, the package is the first of its kind to estimate these supply shares at both administrative levels. Using an R package to disseminate this work aligns with the findability, accessibility, interoperability, and reusability (FAIR) principles of scientific data (Wilkinson et al. 2016). The data used in the package is cited and explained thoroughly, the code is commented and easy to understand should a user wish to tweak or review any functionalities, and finally it is reusable by the very nature of the R package.

\hypertarget{references}{%
\section*{References}\label{references}}
\addcontentsline{toc}{section}{References}

\hypertarget{refs}{}
\begin{CSLReferences}{1}{0}
\leavevmode\vadjust pre{\hypertarget{ref-Bossert2002}{}}%
Bossert, Thomas J, and Joel C Beauvais. 2002. {``{Decentralization of health systems in Ghana, Zambia, Uganda and the Philippines: a comparative analysis of decision space}.''} \emph{Health Policy and Planning} 17 (1): 14--31. \url{https://doi.org/10.1093/heapol/17.1.14}.

\leavevmode\vadjust pre{\hypertarget{ref-Bradley2022}{}}%
Bradley, Sarah E K, and Tess Shiras. 2022. {``{Where Women Access Contraception in 36 Low- and Middle-Income Countries and Why It Matters}.''} \emph{Global Health: Science and Practice} 10 (3). \url{https://doi.org/10.9745/GHSP-D-21-00525}.

\leavevmode\vadjust pre{\hypertarget{ref-Comiskey2023}{}}%
Comiskey, Hannah, Leontine Alkema, and Niamh Cahill. 2024. {``{Estimating the proportion of modern contraceptives supplied by the public and private sectors using a Bayesian hierarchical penalized spline model}.''} \emph{Journal of the Royal Statistical Society Series A: Statistics in Society}, May. \url{https://doi.org/10.1093/jrsssa/qnae051}.

\leavevmode\vadjust pre{\hypertarget{ref-FP2030commitments}{}}%
FP2030. 2021. {``{Rights and Empowerment Principles for Family Planning}.''} FP2030 \textbar{} United Nations Foundation. \url{https://commitments.fp2030.org/principles}.

\leavevmode\vadjust pre{\hypertarget{ref-Gelman2020}{}}%
Gelman, Andrew, Aki Vehtari, Daniel Simpson, Charles C. Margossian, Bob Carpenter, Yuling Yao, Lauren Kennedy, Jonah Gabry, Paul-Christian Bürkner, and Martin Modrák. 2020. {``Bayesian Workflow,''} November. \url{http://arxiv.org/abs/2011.01808}.

\leavevmode\vadjust pre{\hypertarget{ref-Heger2022}{}}%
Herger Boyle, Elizabeth, Miriam King, and Matthew Sobek. 2022. {``{IPUMS-Demographic and Health Surveys: Version 9 {[}dataset{]}}.''} Minnesota Population Center; ICF International. \url{https://doi.org/10.18128/D080.V9}.

\leavevmode\vadjust pre{\hypertarget{ref-Hornik2003}{}}%
Hornik, Kurt, Friedrich Leisch, Achim Zeileis, and Martyn Plummer. 2003. {``{JAGS: A Program for Analysis of Bayesian Graphical Models Using Gibbs Sampling}.''} \url{http://www.ci.tuwien.ac.at/Conferences/DSC-2003/}.

\leavevmode\vadjust pre{\hypertarget{ref-ICF2004}{}}%
ICF. 2004. {``{Demographic and Health Surveys (various) {[}Datasets{]}}.''} USAID.

\leavevmode\vadjust pre{\hypertarget{ref-Knutson2023}{}}%
Knutson, Victoria, Serge Aleshin-Guendel, Ariel Karlinsky, William Msemburi, and Jon Wakefield. 2023. {``{Estimating global and country-specific excess mortality during the Covid-19 pandemic}.''} \emph{The Annals of Applied Statistics} 17 (2): 1353--74. \url{https://doi.org/10.1214/22-AOAS1673}.

\leavevmode\vadjust pre{\hypertarget{ref-Li2019}{}}%
Li, Qingfeng, Thomas A Louis, Li Liu, Chenguang Wang, and Amy O Tsui. 2019. {``{Subnational estimation of modern contraceptive prevalence in five sub-Saharan African countries: A Bayesian hierarchical approach}.''} \emph{BMC Public Health} 19 (1). \url{https://doi.org/10.1186/s12889-019-6545-3}.

\leavevmode\vadjust pre{\hypertarget{ref-Lunn2009}{}}%
Lunn, David, Nicky Best, David Spiegelhalter, Gordon Graham, and Beat Neuenschwander. 2009. {``{Combining MCMC with 'sequential' PKPD modelling}.''} \emph{Journal of Pharmacokinetics and Pharmacodynamics} 36 (1): 19--38. \url{https://doi.org/10.1007/S10928-008-9109-1}.

\leavevmode\vadjust pre{\hypertarget{ref-Mercer2019}{}}%
Mercer, Laina D, Fred Lu, and Joshua L Proctor. 2019. {``{Sub-national levels and trends in contraceptive prevalence, unmet need, and demand for family planning in Nigeria with survey uncertainty}.''} \emph{BMC Public Health} 19 (1). \url{https://doi.org/10.1186/s12889-019-8043-z}.

\leavevmode\vadjust pre{\hypertarget{ref-Moazzam2015}{}}%
Moazzam, Ali. 2015. {``{Ensuring contraceptive security through effective supply chains: WHO/RHR/17.09}.''} World Health Organization, United Nations Population Fund; \url{http://www.popcouncil.org/uploads/pdfs/FP\%7B_\%7DEvidence\%7B_\%7Dsupply\%7B_\%7Dchains\%7B_\%7DFINAL\%7B_\%7D07.10.17.pdf}.

\leavevmode\vadjust pre{\hypertarget{ref-Munoz2022}{}}%
Munoz, Maria-Fernanda, and Moazzam Ali. 2022. {``Commitment to FP2030.''} World Health Organisation. \url{https://cdn.who.int/media/docs/default-source/reproductive-health/who-srh-fp2030.pdf?sfvrsn=780d62cb_3}.

\leavevmode\vadjust pre{\hypertarget{ref-New2017}{}}%
New, Jin Rou, Niamh Cahill, John Stover, Yogender Pal Gupta, and Leontine Alkema. 2017. {``{Levels and trends in contraceptive prevalence, unmet need, and demand for family planning for 29 states and union territories in India: a modelling study using the Family Planning Estimation Tool}.''} \emph{The Lancet Global Health} 5 (3): e350--58. \url{https://doi.org/10.1016/S2214-109X(17)30033-5}.

\leavevmode\vadjust pre{\hypertarget{ref-Plummer2015}{}}%
Plummer, Martyn. 2015. {``{Cuts in Bayesian graphical models}.''} \emph{Statistics and Computing} 25 (1): 37--43. \url{https://doi.org/10.1007/S11222-014-9503-Z}.

\leavevmode\vadjust pre{\hypertarget{ref-SHOPSTMA2016}{}}%
Private Sector (SHOPS) Plus, Sustaining Health Outcomes through the. 2016. {``Total Market Approach Compendium.''} United States Agency for International Development (USAID). \url{https://shopsplusproject.org/tmacompendium}.

\leavevmode\vadjust pre{\hypertarget{ref-Sharrow2019}{}}%
Sharrow, David, Lucia Hug, PhD Danzhen You, PhD Leontine Alkema, Robert Black, Simon Cousens, Trevor Croft, et al. 2019. {``{National, regional, and global levels and trends in neonatal mortality between 1990 and 2017, with scenario-based projections to 2030: a systematic analysis}.''} \emph{The Lancet Global Health} 7 (6): e710--20. \url{https://doi.org/10.1016/S2214-109X(19)30163-9}.

\leavevmode\vadjust pre{\hypertarget{ref-Su2021}{}}%
Su, Yu-Sung, and Masanao Yajima. 2021. \emph{R2jags: Using r to Run {``{JAGS}''}}. \url{https://CRAN.R-project.org/package=R2jags}.

\leavevmode\vadjust pre{\hypertarget{ref-DHSTypes}{}}%
{``{The DHS Program - Demographic and Health Survey (DHS)}.''} 2023. \url{https://dhsprogram.com/methodology/survey-Types/dHs.cfm}.

\leavevmode\vadjust pre{\hypertarget{ref-Track20MonitoringEMUs}{}}%
Track20. 2020a. {``{Monitoring Progress in Family Planning Estimated Modern Use (EMU): A New Service Statistics-Based Family Planning Indicator}.''} Glastonbury, Conneticut: Avenir Health. \url{http://fpet.track20.org/fpet/.}

\leavevmode\vadjust pre{\hypertarget{ref-Track20}{}}%
Track20. 2020b. {``{SS to EMU Tool: Process Guide}.''} Avenir Health. \url{http://www.track20.org/pages/track20_tools/SS_to_EMU_tool.php}.

\leavevmode\vadjust pre{\hypertarget{ref-Ugarte2010}{}}%
Ugarte, M D, T Goicoa, and A F Militino. 2010. {``{Spatio-temporal modeling of mortality risks using penalized splines}.''} \emph{Environmetrics} 21 (3-4): 270--89. https://doi.org/\url{https://doi.org/10.1002/env.1011}.

\leavevmode\vadjust pre{\hypertarget{ref-Ugarte2009}{}}%
Ugarte, M. D., T. Goicoa, A. F. Militino, and M. Durbán. 2009. {``Spline Smoothing in Small Area Trend Estimation and Forecasting.''} \emph{Computational Statistics \& Data Analysis} 53 (10): 3616--29. \url{https://EconPapers.repec.org/RePEc:eee:csdana:v:53:y:2009:i:10:p:3616-3629}.

\leavevmode\vadjust pre{\hypertarget{ref-Vehtari2021}{}}%
Vehtari, Aki, Andrew Gelman, Daniel Simpson, Bob Carpenter, and Paul Christian Burkner. 2021. {``{Rank-Normalization, Folding, and Localization: An Improved (Formula presented) for Assessing Convergence of MCMC (with Discussion)*†}.''} \emph{Bayesian Analysis} 16 (2): 667--718. \url{https://doi.org/10.1214/20-BA1221}.

\leavevmode\vadjust pre{\hypertarget{ref-Vehtari_2021}{}}%
Vehtari, Aki, Andrew Gelman, Daniel Simpson, Bob Carpenter, and Paul-Christian Bürkner. 2021. {``Rank-Normalization, Folding, and Localization: An Improved Rˆ for Assessing Convergence of MCMC (with Discussion).''} \emph{Bayesian Analysis} 16 (2). \url{https://doi.org/10.1214/20-ba1221}.

\leavevmode\vadjust pre{\hypertarget{ref-Wickham2016}{}}%
Wickham, Hadley. 2016. \emph{Ggplot2: Elegant Graphics for Data Analysis}. Springer-Verlag New York. \url{https://ggplot2.tidyverse.org}.

\leavevmode\vadjust pre{\hypertarget{ref-Wilkinson2016}{}}%
Wilkinson, Mark D, Michel Dumontier, IJsbrand Jan Aalbersberg, Gabrielle Appleton, Myles Axton, Arie Baak, Niklas Blomberg, et al. 2016. {``{Comment: The FAIR Guiding Principles for scientific data management and stewardship}.''} \emph{Scientific Data} 3. \url{https://doi.org/10.1038/sdata.2016.18}.

\leavevmode\vadjust pre{\hypertarget{ref-Williamson2014}{}}%
Williamson, Taylor, Sandra Duvall, Arthur A Goldsmith, Karen Hardee, and Rebecca Mbuya-Brown. 2014. {``{The Effects of Dencentralization on Family Planning: A Framework for Analysis}.''} Futures Group, Health Policy Project. \url{https://www.healthpolicyproject.com/pubs/445_FPDecentralizationFINAL.pdf}.

\end{CSLReferences}

\bibliography{RJreferences.bib}

\address{%
Hannah Comiskey\\
Maynooth University\\%
Hamilton Institute\\ Maynooth, Co.Kildare, Ireland\\
%
%
\textit{ORCiD: \href{https://orcid.org/0000-0003-0034-6725}{0000-0003-0034-6725}}\\%
\href{mailto:hannah.comiskey.2015@mumail.ie}{\nolinkurl{hannah.comiskey.2015@mumail.ie}}%
}

\address{%
Niamh Cahill\\
Maynooth University\\%
\\
%
%
%
%
}
