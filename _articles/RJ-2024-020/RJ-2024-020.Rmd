---
title: 'mcmsupply: An R Package for Estimating Contraceptive Method Market Supply
  Shares'
abstract: "In this paper, we introduce the R package mcmsupply which implements Bayesian
  hierarchical models for estimating and projecting modern contraceptive market supply
  shares over time. The package implements four model types. These models vary by
  the administration level of their outcome estimates (national or subnational estimates)
  and dataset type utilised in the estimation (multi-country or single-country contraceptive
  market supply datasets). The mcmsupply package contains a compilation of national
  and subnational level contraceptive source datasets, generated by Integrated Public
  Use Microdata Series (IPUMS) and Demographic and Health Survey (DHS) microdata.
  We describe the functions that implement the models through practical examples.
  The annual estimates and projections with uncertainty of the contraceptive market
  supply, produced by mcmsupply at a national and subnational level, are the first
  of their kind. These estimates and projections have diverse applications, including
  acting as an indicator of family planning market stability over time and being utilised
  in the calculation of estimates of modern contraceptive use."
draft: no
author:
- name: Hannah Comiskey
  affiliation: Maynooth University
  address:
  - Hamilton Institute
  - Maynooth, Co.Kildare, Ireland
  orcid: 0000-0003-0034-6725
  email: hannah.comiskey.2015@mumail.ie
- name: Niamh Cahill
  affiliation: Maynooth University
type: package
output:
  rjtools::rjournal_article:
    self_contained: yes
    toc: no
bibliography: RJreferences.bib
header-includes:
- \usepackage{multirow}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage{fvextra}
- \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
- \usepackage{float}
- \floatstyle{plaintop}
- \restylefloat{table}
date: '2025-03-08'
date_received: '2023-09-24'
volume: 16
issue: 2
slug: RJ-2024-020
journal:
  lastpage: 115
  firstpage: 99

---


```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.pos = "H")
knitr::opts_chunk$set(fig.pos = "H")
library(plotly)
library(ggplot2)
library(mcmsupply)
library(knitr)
set.seed(1209)
#library(kableExtra)
```

# Introduction

Family Planning 2030 (FP2030) is a ‘global movement dedicated to advancing the rights of people everywhere to access reproductive health services safely and on their own terms’ [@FP2030commitments]. One step towards achieving this goal is to quantify \textit{how} people are accessing their modern contraceptive supplies.  To date, obtaining estimates of modern contraceptive supply shares in low- and middle-income countries has relied on large-scale national surveys like the Demographic and Health Surveys (DHS). However, these DHS are not annually available and in practice, most countries carry out DHS every 3 to 5 years approximately, with some countries having fewer surveys than this [@DHSTypes]. In previous work, we described a model that provides probabilistic estimates of the contraceptive supply share over time with uncertainty and examined the model performance at the national administration division for countries that are participating in FP2030 and have varying amounts of DHS data available [@Comiskey2023]. The original modern contraceptive supply share model (mcmsupply model) relies on splines, informed by cross-method correlations, to capture temporal variation combined with a hierarchical modelling approach to estimate country-level parameters. Using a multi-country dataset, the original mcmsupply model produces estimates of contraceptive supply market shares at the national level for all countries simultaneously. In this paper, we extend the model to estimate supply shares using input data from a single-country and to also include estimation at the subnational administrative division. At the time of writing, this package and models are the first of their kind to estimate and project modern contraceptive method supply shares at the national and subnational administration levels using Demographic and Health survey data.

For the remainder of the paper, we will refer to the original modern contraceptive supply share model as the multi-country national mcmsupply model. The single-country \CRANpkg{mcmsupply} model uses a scaled-down version of the multi-country approach. It borrows strength from the multi-country model using modular model runs with informative priors placed on key parameters to provide precise outcome estimation, even in the absence of data for a particular contraceptive method. Modularization in Bayesian analysis describes the process within a statistical model where information is restricted to flow only from the prior to the likelihood. Thus, preventing the ‘contamination’ of key parameters from suspect data (@Lunn2009 as cited in @Plummer2015). In the context of our problem, parameters estimated within the multi-country model are used to inform the priors of the single-country (either national or subnational administrative division) models. This approach prevents spurious parameter estimates due to a lack of data for some locations.  To summarise how the single-country and multi-country models are connected to each other, Figure \@ref(fig:fig-1) depicts this modelling relationship at the national administration level. The main differences between the multi-country and single-country approaches is that for a single-country model, we only have data for one country (at the national or subnational administration division) and the country-level (in the national model) or subnational-level (in the subnational model) population parameters are informed by estimates from the corresponding multi-country model. In contrast to this, the multi-country model uses national or subnational level data (depending on your administrative level of interest) from many countries simultaneously to estimate model parameters and the country-level (in the national model) or subnational-level (in the subnational model) population parameters are estimated hierarchically. The \CRANpkg{mcmsupply} package contains vignettes that consider case studies of both single-country and multi-country model estimation approaches at the national and subnational administration levels.

```{r fig-1, echo=FALSE, out.width = "100%", out.height = "35%", fig.cap = "A flow chart to illustrate the relationship between the multi-country and single-country national estimation approaches. The median estimates of the multi-country national model parameters are used as informative priors in the single-country national model. A legend describing each element of the schematic is located in the blue box."}
if(knitr::is_latex_output()) knitr::include_graphics("figures/fig_1.pdf") else knitr::include_graphics("figures/fig_1.svg")
```


The need for a single-country version of the mcmsupply model arose for two primary reasons. Firstly, there was a demand for improved computational efficiency while ensuring that model accuracy remains uncompromised when generating projections of modern contraceptive method supply shares for a single-country. Secondly, the option to accommodate custom data, like incorporating a new survey dataset, was sought to be included in the estimation process for users who require a more tailored analysis.

The inclusion of the functionality to estimate supply shares at the subnational level in the mcmsupply package was spurred by the growing interest in subnational estimation among the family planning community [@New2017; @Mercer2019; @Li2019]. The decentralization of family planning services produces a more equitable and efficient service; however, it also shifts the responsibility of service delivery to lower-level organisations that may not have the capacity to carry-out the role [@Williamson2014]. Providing subnational-level estimates can lead to a clearer understanding of localised user preferences, localised user access to family planning commodities and a measure of the true stability contraceptive supply market at a smaller geographic scale [@Bossert2002].  These subnational estimates may also be used as part of a localised temperature check for progress towards the FP2030 goals, which include increasing access to contraceptive methods [@Munoz2022]. 

This paper introduces the R package \CRANpkg{mcmsupply} for estimating and projecting the contraceptive supply share at the national and subnational administration divisions using multi-country or single-country datasets. The package uses \CRANpkg{tidyverse} throughout to carry out data manipulation and visualisation tasks. The graphics are produced using \CRANpkg{ggplot2} and \CRANpkg{dplyr} is used for any data manipulation procedures. The workflow of the package aims to follow a Bayesian workflow  [@Gelman2020]. The users are encouraged to explore the data, the model inputs, and the model outputs using diagnostics and visualisations. The individual elements of the workflow are made as accessible as possible through the built-in functions, such as the 'get_data' and 'plot_estimates' functions, and the code provided in the vignettes to test the convergence of the model parameters. To assess convergence, we consider the R-hat values of the model parameters using the plot function of \CRANpkg{rjags}, as well as the individual parameter trace plots [@Vehtari2021]. Figure \@ref(fig:fig-2) shows a summary of the different ways users can use the R functions and input data in \CRANpkg{mcmsupply} to carry out model fitting and estimation. The national data contained in the package is derived from the DHS microdata [@ICF2004]  while the subnational data is derived from the IPUMS DHS datasets [@Heger2022]. In the 'Implementation and operation' section, we review the operation and implementation requirements of the \CRANpkg{mcmsupply} R package. In the 'Data' section, a detailed description of the data used within the \CRANpkg{mcmsupply} R package is provided, as well as an explanation of the data pre-processing functions `get_data` and `get_modelinputs`. 'The estimation process' section describes the model fitting and visualisation functions within the \CRANpkg{mcmsupply} R package. A basic overview of the process model is provided in 'Overview of the mcmsupply process models' with an explanation of some key modelling parameters. The 'Model fitting' section  explains the `run_jagsmodel` function. The  `run_jagsmodel` function fits models in a Bayesian framework using the JAGS (Just Another Gibbs Sampler) software and produces estimates with uncertainty for the administration level and dataset type of choice [@Hornik2003]. The 'Model output' section describes the `plot_estimates` function that takes the model estimates and visualises them using the R package ggplot2 [@Wickham2016]. The 'Use cases' section discusses five use cases for modelling modern contraceptive supply shares using the \CRANpkg{mcmsupply} R package. Finally, the conclusions are presented.


# Implementation and operation

\CRANpkg{mcmsupply} contains pre-processing functions to clean and prepare raw input data for model fitting at the administrative level of choice (national or subnational) using the dataset type of choice (multi-country or single-country).  This R package includes functions to fit Bayesian hierarchical models using the model inputs. Functionality for post-processing and visualisation of the model estimates are also included. The model fitting process described uses Just Another Gibbs Sampler (JAGS). JAGS uses Markov Chain Monte Carlo (MCMC) sampling to produce model estimates for Bayesian hierarchical models [@Hornik2003]. For installation, both R (>=3.5.0) and JAGS (>=4.0.0) are required. JAGS can be downloaded at https://sourceforge.net/projects/mcmc-JAGS/files/JAGS/. \CRANpkg{mcmsupply} interacts with JAGS using the wrapper functions supplied by the R package \CRANpkg{R2jags} [@Su2021]. The \CRANpkg{mcmsupply} package dependencies are listed in the package `DESCRIPTION` file and will be automatically installed upon installing the main package. There are no minimum RAM, CPU, or HARDDRIVE requirements apart from what is necessary to store model runs, which varies case-by-case. This software was run on a MacBook Air using macOS 13.1 with a 1.6 GHz Dual-Core Intel Core i5 processor and 8GB of memory.

# Data

## Input data

The \CRANpkg{mcmsupply}  package contains the following input data sources: 

- Survey data for the national and subnational modern contraceptive supply shares between 1990 and 2022 for a selection of countries participating in the FP2030 initiative. 
- Variance-covariance data on the logit scale corresponding to the observed public and commercial medical modern contraceptive supply shares at the national level between 1990 and 2022 for a selection of countries participating in the FP2030 initiative. 
- Estimated correlations between the rates of change in method supply shares in the public and private sectors at both the national and subnational administrative divisions. These are derived based on the method outlined in Comiskey et al. (2023). 
- Global and subcontinental parameter estimates obtained from the multi-country model run at the national and subnational level.


The inst/data-raw folder of the \CRANpkg{mcmsupply} package contains sample R code that was used to create the model inputs in the case of the covariance arrays, correlations and parameters. This enables users to recalculate their own single-country model parameters and correlations should they wish to do so. The code for the creation of the main input contraceptive supply source data is provided on the \CRANpkg{mcmsupply} [github](https://github.com/hannahcomiskey/mcmsupply) page but the raw data for these datasets cannot be provided. The raw data may be accessed by users through an application to the DHS program for national level data, or the IPUMS program, for subnational level data. Help files for the contraceptive supply source datasets can be accessed by using the command `?mcmsupply::national_FPsource_data` and `?mcmsupply::subnat_FPsource_data`. The national contraceptive supply source data has data for 33 countries (including participants and non-participants of FP2030) between 1990 and 2022. The subnational contraceptive supply source data has data for 256 provinces across 24 countries (all participating in FP2030) between 1990 and 2020. Table \@ref(tab:tab-1) is a sample of 6 rows of the subnational contraceptive supply source data.

(ref:tab1Cap) The subnational contraceptive supply source data used in the subnational estimation models. Country and Region list the name of the country and province the observation relates to. The Method column lists the type of the contraceptive method supplied. The mid-year when the survey was collected is listed in average_year. The supply sector is found in sector_categories. The observed proportion and standard error are found in proportion and SE.proportion. The number of respondent making up each observation are listed in n.


```{r tab-1, echo=FALSE}
if(knitr::is_latex_output()) {
  knitr::kable(tail(mcmsupply::subnat_FPsource_data), format="latex", booktabs=TRUE,
      caption = '(ref:tab1Cap)' ) %>% 
  kableExtra::kable_styling(latex_options="scale_down") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
} else{
  knitr::kable(tail(mcmsupply::subnat_FPsource_data), caption = '(ref:tab1Cap)' )
}
```


Lastly, data on country classification, ISO codes and area groupings is provided in the dataset `Country_and_area_classification` (Table \@ref(tab:tab-2)). The help file for this dataset can be accessed via the R command `?mcmsupply::Country_and_area_classification`. 

(ref:tab2Cap) The Country_and_area_classification dataset is the Track20 project country and area classification data according to the United Nations Statistical Division, standard country or area codes for statistical use (M49). This data set is how we classify each country in subcontinental regions. The name of the country, the International Organization for Standardization (ISO) code for each country, the continent, sub-continent are listed. Details on whether or not a country is defined as a developing, located in Sub-Saharan Africa and the status of its participation in FP2020 (now FP2030) are also provided.


```{r tab-2, echo=FALSE}
if(knitr::is_latex_output()) {
  knitr::kable(head(mcmsupply::Country_and_area_classification), format="latex",
      booktabs=TRUE, caption = '(ref:tab2Cap)' ) %>% 
  kableExtra::kable_styling(latex_options="scale_down") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
} else{
  knitr::kable(tail(mcmsupply::Country_and_area_classification), caption = '(ref:tab2Cap)' )
}
```



## Data pre-processing

In \CRANpkg{mcmsupply}, the data processing occurs in two steps: First, the raw input data is retrieved and preliminary cleaning to the dataset is completed. Secondly, the cleaned data is processed to provide the model inputs for the Bayesian hierarchical model. This two-step process removes any black-box element to the model fitting process and allows the user to review the data at both stages and refer to it later when considering model outputs.
The first step involves the `get_data` function. This function retrieves the raw data from the stored contraceptive supply source dataset, does data cleaning and processing to address any issues with missing data and regional naming inconsistencies. Its arguments are summarized in Table \@ref(tab:tab1). The `get_data` function carries out several data pre-processing tasks. For example, it will remove observations where two or more sectors are missing. It also checks to see if observations across all three sectors sum to one and will replace missing observations with 0 when the total does sum to one. The function transforms the raw data away from the (0,1) boundary as parameter estimates that lie on the distribution limits cause issues with convergence during the model estimation process. Finally, the `get_data` function imputes any missing standard errors using a binomial approximation. To use the the `get_data` function, the user first defines whether they wish to use national or subnational level administrative data via the `national` argument. National level data is accessed when the `national` argument is set to `TRUE`. When subnational administrative data is required, the user sets national to `FALSE`. Similarly, the user defines whether they want to use multi-country estimation with data from multiple countries or single-country estimation with data from a single-country via the `local` argument. The default setting for the `local` argument is `FALSE`. This induces a multi-country estimation, where the outcomes for all the countries in the contraceptive supply source dataset will be estimated simultaneously. In the event of single-country estimation, the user sets `local` to TRUE and indicates their country of interest via the `mycountry` argument. The names of the countries listed in the package data can be found in the country_names dataset. The help file for this dataset can be accessed via the R command `?mcmsupply::country_names`. The `fp2030` argument controls whether to include countries that are participating in the FP2030 initiative or not. The default includes only the named FP2030 countries (see `country_names`) in the dataset. There is the optional functionality to include a custom dataset. This allows the user to run the model on data outside of that stored within the package. The `surveydata_filepath` is a character string that denotes the location of the custom dataset. The file must meet a series of internal checks on file type, column names, suitable data ranges and missing data. When a custom dataset is supplied to `get_data`, the function carries out the checks and alerts the user to any differences between what is expected and what has been supplied. If `surveydata_filepath` is left as `NULL`, by default the function uses the stored `national_FPsource_data` or `subnat_FPsource_data`, depending on what administrative level the user has specified via the `national` argument (Table \@ref(tab:tab1)). The `get_data` function returns a list containing the cleaned data and a list of arguments supplied to the function. Storing the arguments of the `get_data` function allows the set-up information to flow without requiring the user to repeatedly supply the same arguments for each step of the modelling process.

```{r te-tab1, echo = FALSE, results = "asis"}
latex_tab1 <- r"(
\begin{table}[h]
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
\textbf{Argument} &
  \textbf{Data type} &
  \textbf{Description} \\ \hline
national &
  Character &
  \begin{tabular}[c]{@{}c@{}}It indicates whether the user is interested in using data at the\\ national or subnational administration level. \\ This is a binary TRUE or FALSE argument. \\ Default is TRUE which retrieves national level data, while \\ FALSE retrieves subnational data.\end{tabular} \\ \hline
local &
  Character &
  \begin{tabular}[c]{@{}c@{}}It indicates whether the user is interested in using data for a\\ single population or not. \\ This is a binary TRUE or FALSE argument. \\ Default is FALSE.\end{tabular} \\ \hline
mycountry &
  Character &
  \begin{tabular}[c]{@{}c@{}}This is the name of the country you wish to do single-country \\ estimation for. The data will only be returned for this country. \\ Default is NULL.\end{tabular} \\ \hline
fp2030 &
  Character &
  \begin{tabular}[c]{@{}c@{}}It indicates whether the user is interested in using only \\ countries participating in FP2030. \\ This is a binary TRUE or FALSE argument. \\ Default is TRUE.\end{tabular} \\ \hline
surveydata\_filepath &
  Character string &
  \begin{tabular}[c]{@{}c@{}}Pathway to the location of the custom dataset. \\ When left as NULL, the function \\ automatically uses the stored datasets. \\ Default is NULL.\end{tabular} \\ \hline
\end{tabular}%
}
\caption{The arguments of the get\_data function. The purpose of this function is to retrieve and clean the Demographic and Health Survey (DHS) data or custom user supplied data for use in supply share estimation. The ‘Argument’ column names the function component. Data type describes the argument. Description explains the purpose of the argument and any default entries. }
\label{tab:tab1}
\end{table}
)"

md_tab1 <- r"(
| **Argument**          | **Data type**      | **Description**                                                                                                                                                                                                                                                             |
|-----------------------|--------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| national              | Character          | It indicates whether the user is interested in using data at the national or subnational administration level. This is a binary TRUE or FALSE argument. Default is TRUE which retrieves national level data, while FALSE retrieves subnational data.                            |
| local                 | Character          | It indicates whether the user is interested in using data for a single population or not. This is a binary TRUE or FALSE argument. Default is FALSE.                                                                                                                         |
| mycountry             | Character          | This is the name of the country you wish to do single-country estimation for. The data will only be returned for this country. Default is NULL.                                                                                                                              |
| fp2030                | Character          | It indicates whether the user is interested in using only countries participating in FP2030. This is a binary TRUE or FALSE argument. Default is TRUE.                                                                                                                      |
| surveydata_filepath   | Character string   | Pathway to the location of the custom dataset. When left as NULL, the function automatically uses the stored datasets. Default is NULL.                                                                                                                                     |

Table: (\#tab:tab1) The arguments of the `get_data` function. The purpose of this function is to retrieve and clean the Demographic and Health Survey (DHS) data or custom user supplied data for use in supply share estimation. The ‘Argument’ column names the function component. Data type describes the argument. Description explains the purpose of the argument and any default entries.
)"

if(knitr::is_latex_output()) cat(latex_tab1) else cat(md_tab1)
```

Step two of the data pre-processing is the `get_modelinputs` function. This function takes the cleaned data from the previous step and repackages it into suitable inputs for the model implementation. The arguments of the function are summarised in Table \@ref(tab:tab2). This function uses the arguments set in the `get_data` function as well as additional parameters for the model. These parameters include the year the user wishes to begin their estimation at and the year they finish on.  In the \CRANpkg{mcmsupply} package, the models use basis splines (B-splines), to capture the complexities in variation of the contraceptive supply source data over time. The use of splines for the estimation of demographic indicators is growing in popularity. Previous studies used small-area estimation models with splines to capture complex shapes of demographic spatio-temporal data [@Ugarte2010; @Ugarte2009]. In recent years, many international health organisations have also used splines for the estimation of key demographic indicators. These include the estimation and projection of under-5 mortality for United Nations Children's Fund (UNICEF) [@Sharrow2019] and the estimation of excess morality due to Covid-19 for the World Health Organisation (WHO) [@Knutson2023]. We build on these previous studies to use penalised regression splines in the mcmsupply R package. B-splines use basis-functions to create piecewise cubic polynomials. The number of basis functions that are fit to the data is determined by the number of knots. Knots are the locations along the x-axis where the piecewise polynomials of the B-splines join. As you increase the number of knots in the basis functions, the B-splines give a tighter fit to the data. Similarly, if you decrease the number of knots in the basis, you will get a smoother fit to your data.   In the \CRANpkg{mcmsupply} package, the user may alter the number of knots (`nsegments`) used in the basis functions. The default number of knots is `12`, as was used in Comiskey et al. (2023). This equates to a knot approximately every 3.5 years. Through validation, it was found that having fewer knots dis-improved model fit, while more knots did not significantly improve model fit. Like the `get_data` function, this function returns a list containing the model inputs and the function arguments.

```{r te-tab2, echo = FALSE, results = "asis"}
latex_tab2 <- r"(
\begin{table}[h]
\caption{The arguments of the get\_modelinputs function. The purpose of this function is to get the model inputs for the JAGS model used for supply share estimation. In the table, the argument name and data type of the argument is stated, a description of the argument and any default values is then provided.}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
\textbf{Argument} & \textbf{Data type} & \textbf{Description}                            \\ \hline
startyear         & Numeric            & The year you wish to start your estimation at.  \\ \hline
endyear           & Numeric            & The year you wish to finish your estimation at. \\ \hline
nsegments &
  Numeric &
  \begin{tabular}[c]{@{}c@{}}The number of knots   you wish to include in your basis functions. \\ Default is 12.\end{tabular} \\ \hline
raw\_data &
  List &
  \begin{tabular}[c]{@{}c@{}}The output of the get\_data function, which includes a list \\ of the function arguments used and the \\ cleaned contraceptive supply source data.\end{tabular} \\ \hline
\end{tabular}%
}
\label{tab:tab2}
\end{table}
)"

md_tab2 <- r"(
| **Argument** | **Data type** | **Description**                                                                                                                                                                                          |
|--------------|---------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| startyear    | Numeric       | The year you wish to start your estimation at.                                                                                                                                                            |
| endyear      | Numeric       | The year you wish to finish your estimation at.                                                                                                                                                           |
| nsegments    | Numeric       | The number of knots you wish to include in your basis functions. Default is 12.                                                                                                                           |
| raw_data     | List          | The output of the get_data function, which includes a list of the function arguments used and the cleaned contraceptive supply source data.                                                                |

Table: (\#tab:tab2) The arguments of the `get_modelinputs` function. The purpose of this function is to get the model inputs for the JAGS model used for supply share estimation. In the table, the argument name and data type of the argument is stated, a description of the argument and any default values is then provided.
)"


if(knitr::is_latex_output()) cat(latex_tab2) else cat(md_tab2)
```


# The estimation process

The \CRANpkg{mcmsupply} R package contains four Bayesian models, each of which aims to estimate and project contraceptive method supply shares over time with uncertainty. These models vary by the administration level of their outcome estimates (national or subnational estimates) and dataset type utilised in the estimation (multi-country or single-country contraceptive market supply datasets). A full mathematical description of all the models contained within \CRANpkg{mcmsupply} is described in the supplementary material. ^[At the time of publication it is expected that this material will be made available via another open access venue.]. A summary of each of the parameters and their role within each model can be found in Table \@ref(tab:tab4) while a visual summary of the national model, using both multi-country and single-country inputs, can be found in Figure \@ref(fig:fig-1).

## Brief model overview
The outcome of interest is the components of a compositional vector $\boldsymbol{{\phi_{q,t,m}}}$, which captures the proportion of contraceptive method m, at time t, in population q supplied across the public and private sectors.

Let,
\begin{equation}
\boldsymbol{{\phi_{q,t,m}}} =(\phi_{q,t,m,1},\phi_{q,t,m,2},\phi_{q,t,m,3}),
   (\#eq:eq1)
\end{equation} 

where, \newline
$\phi_{q,t,m,s}$ is the proportion supplied by the public sector (s =1), the private commercial medical sector (s=2) and the other private sector (s=3) of modern contraceptive method m, at time t, in population q (national or subnational). \newline 

Figure \@ref(tab:tab1) shows the model set up for the national level models. A similar approach is taken when estimating modern contraceptive method supply at the subnational administration level. For each model within the \CRANpkg{mcmsupply} package, the latent variable $\psi_{q,m,t,s}$ relies on a spline to capture the underlying process that generates the data, on the logit scale, for sector s, in year t, for method m and population q (depending on the administration level of interest) . 


\begin{equation}
   \psi_{q,t,m,1}=\sum_{k=1}^K \beta_{q,m,1,k} B_{q,k}(t),
   (\#eq:eq2)
\end{equation}

where, \newline
$\beta_{q,m,1,k}$ is the $k^{th}$ spline coefficient for sector s, method m in population q. \newline
$B_{q,k}(t)$ is the $k^{th}$ basis function fit to the data for population q. \newline

We assume that in population q, for method m and sector s, the value of spline coefficient at knot index $k^*$, aligning with the year $t^*$, the most recent survey available, is $\alpha_{q, m, s}$. By doing this, we are assuming that the $\alpha_{q,m,s}$ parameter will act as the spline coefficient for the reference spline at $k^*$. We are then able to calculate the remaining spline coefficients using a random walk model of order 1 on spline coefficients from the reference index ($k^*$) using the penalised $\boldsymbol{\delta_{q,m,s}}$.

Let,
\begin{equation}
    \beta_{q,m, s, k}=\left\{\begin{array}{c}
    \alpha_{q,m,s} \quad k=k^*, \\
    \beta_{q,m,s, k+1}-\delta_{q, m, s, k} \quad k<k^*, \\
    \beta_{q,m,s, k-1}+\delta_{q, m, s, k-1} \quad k>k^*,
\end{array}\right.
   (\#eq:eq3)
\end{equation} 

where, \newline
$\alpha_{q,m,s}$ is the most recently observed supply share, on the logit scale, for sector s , method m, in population q. This parameter is estimated hierarchically. The geographical set-up of this estimation process adapts to match the administrative level of interest. For example, the subnational multi-country models contain an additional layer of geography (world > subcontinent > country > province) in the hierarchical set-up that the national models don't have, which accounts for the subnational administration levels. \newline
k is the knot index along the set of basis splines $B_{q,k}(t)$ \newline
$k^*$ is the index of the knot that corresponds with $t^*$, the year index where the most recent survey occurred in population q. \newline
$\delta_{q,m,s,k-1}$ is the first order difference between spline coefficients $\beta_{q,m, s, K}$ and $\beta_{q,m, s,K-1}$. These reflect the changes in method supply shares over time. Within each sector, the first-order differences are assumed to be correlated  between methods. These correlations were estimated using a maximum \textit{a posteriori} estimator for the correlation matrix first described in Azose and Raftery, (2018) and adapted for method supply shares in Comiskey et al. (2023). These estimated correlations are available as data for both the national and subnational models. Please see the Data section of this paper for more details. \newline


(ref:tab4) This table summarises the purpose of each parameter within each of the four models described in the \CRANpkg{mcmsupply} R package. The four types of models are listed in the 'Model type' column. For each model, the parameters listed in the 'Parameter name' column are the default parameters monitored when the argument `jagsparams=NULL` is used within the `run_jags_model` function. 'Parameter purpose' explains the role each parameter plays within the estimation process and the notation can be linked directly to the 'Model overview' section of this paper. 

```{r te-tab4, echo = FALSE, results = "asis"}
latex_tab4 <- r"(
\begin{table}[H]
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
\textbf{Model type} &
  \textbf{Parameter name} &
  \textbf{Parameter purpose} \\ \hline
\multirow{4}{*}{Multi-country national} &
  P &
  \begin{tabular}[c]{@{}c@{}} The method supply share proportions \\ across all countries, methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  beta.k &
  \begin{tabular}[c]{@{}c@{}}The set of spline coefficients for ($\beta_{c,m,s,k}$) \\ for all countries, methods and sectors at each knot.\end{tabular} \\ \cline{2-3} 
 &
  alpha\_cms &
  \begin{tabular}[c]{@{}c@{}}The intercept term ($\alpha_{c,m,s}$) \\ for all countries, methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  delta.k &
  \begin{tabular}[c]{@{}c@{}}The   first order differences between spline coefficients ($\delta_{c,m,s,k}$) \\ across all knots for all countries, methods and sectors\end{tabular} \\ \hline
\multirow{4}{*}{Single-country national} &
  P &
  \begin{tabular}[c]{@{}c@{}}The method supply share proportions \\ for a given country, across all methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  alpha\_cms &
  \begin{tabular}[c]{@{}c@{}}The intercept term ($\alpha_{c,m,s}$) for \\ the country of interest c, across all methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  inv.sigma\_delta &
  \begin{tabular}[c]{@{}c@{}}The precision matrix used in the \\ multivariate normal prior of $\delta_{c,1:M,s,k}$\end{tabular} \\ \cline{2-3} 
 &
  beta.k &
  \begin{tabular}[c]{@{}c@{}}The set of spline coefficients ($\beta_{c,m,s,k}$) for \\ the country of interest c, across all methods and sectors at each knot.\end{tabular} \\ \hline
\multirow{6}{*}{Multi-country subnational} &
  alpha\_pms &
  \begin{tabular}[c]{@{}c@{}}The intercept term ($\alpha_{p,m,s}$)  \\ for all subnational provinces, methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  alpha\_cms &
  \begin{tabular}[c]{@{}c@{}}The intercept term   ($\alpha_{c,m,s}$) \\ for all countries, methods and sectors.   \\ $\alpha_{c[p],m,s}$ is the expected value of $\alpha_{p,m,s}$.\end{tabular} \\ \cline{2-3} 
 &
  inv.sigma\_delta &
  \begin{tabular}[c]{@{}c@{}}The precision matrix used in the \\ multivariate normal prior of  $\delta_{p,1:M,s,k}$\end{tabular} \\ \cline{2-3} 
 &
  tau\_alpha\_pms &
  \begin{tabular}[c]{@{}c@{}}The sector-specific precision\\ associated with $\alpha_{p,m,s}$\end{tabular} \\ \cline{2-3} 
 &
  beta.k &
  \begin{tabular}[c]{@{}c@{}}The set of spline coefficients ($\beta_{p,m,s,k}$) \\ across all subnational provinces, methods and sectors at each knot.\end{tabular} \\ \cline{2-3} 
 &
  delta.k &
  \begin{tabular}[c]{@{}c@{}}The first order differences between spline coefficients \\ across all knots ($\delta_{p,m,s,k}$) for all provinces, methods and sectors.\end{tabular} \\ \hline
\multirow{3}{*}{Single-country subnational} &
  P &
  \begin{tabular}[c]{@{}c@{}}The method supply share proportions for the \\ subnational provinces in the country of interest, for all methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  alpha\_pms &
  \begin{tabular}[c]{@{}c@{}}The intercept term ($\alpha_{p,m,s}$) for the \\ subnational provinces in the country of interest, for all methods and sectors.\end{tabular} \\ \cline{2-3} 
 &
  beta.k &
  \begin{tabular}[c]{@{}c@{}}The set of spline coefficients ($\beta_{p,m,s,k}$) \\ for the subnational provinces in the country of interest, \\ across all methods and sectors at each knot\end{tabular} \\ \hline
\end{tabular}%
}
\caption{(ref:tab4)}
\label{tab:tab4}
\end{table}
)"

md_tab4 <- r"(
| **Model type**              | **Parameter name** | **Parameter purpose**                                                                                                                                                             |
|-----------------------------|--------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Multi-country national      | P                  | The method supply share proportions across all countries, methods and sectors.                                                                                                    |
|                             | beta.k             | The set of spline coefficients for ($\beta_{c,m,s,k}$) for all countries, methods and sectors at each knot.                                                                       |
|                             | alpha\_cms         | The intercept term ($\alpha_{c,m,s}$) for all countries, methods and sectors.                                                                                                     |
|                             | delta.k            | The first order differences between spline coefficients ($\delta_{c,m,s,k}$) across all knots for all countries, methods and sectors.                                             |
| Single-country national     | P                  | The method supply share proportions for a given country, across all methods and sectors.                                                                                          |
|                             | alpha\_cms         | The intercept term ($\alpha_{c,m,s}$) for the country of interest c, across all methods and sectors.                                                                              |
|                             | inv.sigma\_delta   | The precision matrix used in the multivariate normal prior of $\delta_{c,1:M,s,k}$.                                                                                               |
|                             | beta.k             | The set of spline coefficients ($\beta_{c,m,s,k}$) for the country of interest c, across all methods and sectors at each knot.                                                    |
| Multi-country subnational   | alpha\_pms         | The intercept term ($\alpha_{p,m,s}$) for all subnational provinces, methods and sectors.                                                                                         |
|                             | alpha\_cms         | The intercept term ($\alpha_{c,m,s}$) for all countries, methods and sectors. $\alpha_{c[p],m,s}$ is the expected value of $\alpha_{p,m,s}$.                                       |
|                             | inv.sigma\_delta   | The precision matrix used in the multivariate normal prior of $\delta_{p,1:M,s,k}$.                                                                                               |
|                             | tau\_alpha\_pms    | The sector-specific precision associated with $\alpha_{p,m,s}$.                                                                                                                   |
|                             | beta.k             | The set of spline coefficients ($\beta_{p,m,s,k}$) across all subnational provinces, methods and sectors at each knot.                                                            |
|                             | delta.k            | The first order differences between spline coefficients across all knots ($\delta_{p,m,s,k}$) for all provinces, methods and sectors.                                             |
| Single-country subnational  | P                  | The method supply share proportions for the subnational provinces in the country of interest, for all methods and sectors.                                                        |
|                             | alpha\_pms         | The intercept term ($\alpha_{p,m,s}$) for the subnational provinces in the country of interest, for all methods and sectors.                                                      |
|                             | beta.k             | The set of spline coefficients ($\beta_{p,m,s,k}$) for the subnational provinces in the country of interest, across all methods and sectors at each knot.                         |

Table: (\#tab:tab4) The parameters for different model types. Each parameter is described by its use in modeling supply share proportions, the intercept term, spline coefficients, and the precision matrix.
)"


if(knitr::is_latex_output()) cat(latex_tab4) else cat(md_tab4)
```


## Model fitting

The `run_jags_model` function fits the selected JAGS model to the supplied data and returns a list of MCMC samples and point summaries for the time-period and locations of interest. Initial set-up arguments (`national`, `local`, `mycountry`) are inherited from the specification of the previous `get_modelinputs` function. The additional inputs of this function are summarised in Table \@ref(tab:tab3). The `jagsdata` argument of this function is a list of initial set-up arguments and JAGS model inputs gathered from the `get_modelinputs` function. `jagsparams` is a vector of strings that name the model parameters the user wishes to monitor within the JAGS model. The default is `NULL`. When `jagsparams = NULL`, the function will refer to a stored vector of parameters to monitor (Table \@ref(tab:tab4)). The JAGS parameters of `n_iter = 80000`, `n_burnin = 10000` and `n_thin = 35` ensure that the model has converged and that the final posterior sample size is 2000 samples. The function `get_point_estimates` takes the chains produced by the JAGS model and estimates the median, 95% credible intervals and 80% credible intervals. The `get_point_estimates` function runs automatically inside the `run_jags_model` function and returns the point summaries as part of the `run_jags_model` function output. The `run_jags_model` function returns a list containing the JAGS output of the model and the point summaries for the estimates.

```{r te-tab3, echo = FALSE, results = "asis"}
latex_tab3 <- r"(
\begin{table}[]
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
\textbf{Argument} & \textbf{Data type} & \textbf{Description} \\ \hline
jagsdata &
  List &
  \begin{tabular}[c]{@{}c@{}}The output of the get\_modelinputs function. \\ A list of the initial set-up arguments and the JAGS inputs \\ required using the data.\end{tabular} \\ \hline
jagsparams &
  Vector &
  \begin{tabular}[c]{@{}c@{}}A string vector of model parameters to be monitored. \\ NULL invokes a standard  vector to be used \\ Default is NULL.\end{tabular} \\ \hline
n\_iter           & Numeric            & \begin{tabular}[c]{@{}c@{}}Number of iterations you wish to run your JAGS model for. \\ Default is 80000.\end{tabular}       \\ \hline
n\_burnin         & Numeric            & \begin{tabular}[c]{@{}c@{}}Number of burn-in   samples you wish to run your JAGS model for. \\ Default is 10000\end{tabular} \\ \hline
n\_thin           & Numeric            & \begin{tabular}[c]{@{}c@{}}Number of samples you wish to thin your JAGS sample by. \\ Default is 35.\end{tabular}            \\ \hline
\end{tabular}%
}
\caption{The arguments of the run\_jags\_model function. The purpose of this function is to run the Bayesian hierarchical models stored within the \CRANpkg{mcmsupply}  package for either single- or multi-country datasets at the administration level of interest. The argument name and data type of the argument is stated, a description and any default values of the argument are then provided.}
\label{tab:tab3}
\end{table}
)"

md_tab3 <- r"(
| **Argument** | **Data type** | **Description** |
|--------------|---------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| jagsdata     | List          | The output of the `get_modelinputs` function. A list of the initial set-up arguments and the JAGS inputs required using the data.                                                     |
| jagsparams   | Vector        | A string vector of model parameters to be monitored. NULL invokes a standard vector to be used. Default is NULL.                                                                     |
| n_iter       | Numeric       | Number of iterations you wish to run your JAGS model for. Default is 80000.                                                                                                          |
| n_burnin     | Numeric       | Number of burn-in samples you wish to run your JAGS model for. Default is 10000.                                                                                                     |
| n_thin       | Numeric       | Number of samples you wish to thin your JAGS sample by. Default is 35.                                                                                                               |

Table: (\#tab:tab3) The arguments of the `run_jags_model` function. The purpose of this function is to run the Bayesian hierarchical models stored within the mcmsupply package for either single- or multi-country datasets at the administration level of interest. The argument name and data type of the argument is stated, a description and any default values of the argument are then provided.
)"


if(knitr::is_latex_output()) cat(latex_tab3) else cat(md_tab3)
```




## Model output


The user then runs the function `plot_estimates`. This function visualises the point estimates with uncertainty alongside the data using the initial set up inputs of the `get_modelinputs` function and the output of the `run_jags_model` function (Table \@ref(tab:tab5)). The `plot_estimates` function returns a list of \CRANpkg{ggplot2} objects, one for each country (when using the national model) or subnational region (when using the subnational model).

```{r te-tab5, echo = FALSE, results = "asis"}
latex_tab5 <- r"(
\begin{table}[]
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
\textbf{Argument} &
  \textbf{Data type} &
  \textbf{Description} \\ \hline
jagsdata &
  List &
  \begin{tabular}[c]{@{}c@{}}A list of the initial set-up arguments and the JAGS inputs required \\ using the data retrieved in the get\_modelinputs function.\end{tabular} \\ \hline
model\_output &
  List &
  \begin{tabular}[c]{@{}c@{}}The object assigned to store the list of  MCMC results and estimate \\ summary output from the run\_jags\_model function.\end{tabular} \\ \hline
\end{tabular}%
}
\caption{The arguments of the plot\_estimates function. The purpose of this function is to plot the data alongside the model estimates so that users can visualise their estimated method supply shares. The argument name and data type of the argument is stated, a description of the argument is then provided. }
\label{tab:tab5}
\end{table}
)"

md_tab5 <- r"(
| **Argument**   | **Data type** | **Description**                                                                                                                                                        |
|----------------|---------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| jagsdata       | List          | A list of the initial set-up arguments and the JAGS inputs required using the data retrieved in the get_modelinputs function.                                             |
| model_output   | List          | The object assigned to store the list of MCMC results and estimate summary output from the run_jags_model function.                                                      |

Table:  (\#tab:tab5) The arguments of the `plot_estimates` function. The purpose of this function is to plot the data alongside the model estimates so that users can visualize their estimated method supply shares. The argument name and data type are stated, followed by a description of the argument.
)"


if(knitr::is_latex_output()) cat(latex_tab5) else cat(md_tab5)
```

```{r fig-2, echo=FALSE, out.width = "100%", out.height = "35%", fig.cap = "A flow chart to illustrate the decision processes that lead to the different estimation types within the mcmsupply package. The first decision is with respect to the administrative level of the estimates you wish to create – they may be either national level or subnational level. An explanation of each division is found on the first row of the figure. The second decision is with respect to the number of countries you wish to estimate – the user may estimate the proportions for all the countries at once or only one country. An explanation of each in the context of the specific administrative division is found on the second row of the figure. A set of sample functions used to estimate and plot the estimates for each modelling option are located on the third row of the figure"}

if(knitr::is_latex_output()) knitr::include_graphics("figures/fig_2.pdf") else knitr::include_graphics("figures/fig_2.svg")
```


# Use cases

## Case 1: Estimating contraceptive method supply shares at the national administration level for multiple countries simultaneously

The first use case describes how the user can estimate modern contraceptive method supply shares at the national administrative level over time for multiple countries at once (i.e., using the multi-country national model). This use case is described in `national_multicountry_mod` found in the `vignettes` folder. This vignette takes approximately 12 hours to run when using the recommended JAGS arguments, on a machine with 1.6 GHz Dual-Core Intel Core i5 processor and 8GB of RAM. The `national_FPsource_data` dataset contains observations for 30 countries. The user begins by accessing the `national_FPsource_data` dataset through the `get_data` function with the argument `national=TRUE`, and the remaining arguments sets to their default values, to indicate that they are interested in national-level data for the FP2030 countries present in the data. 


```{r eval=FALSE}
cleaned_natdata <- get_data(national = TRUE)

dplyr::glimpse(cleaned_natdata$mydata)
```

Next, this data is supplied to the `get_modelinputs` function. This function reshapes the data into a list of inputs for the JAGS model. At this point, the user must indicate the start and end years they wish to estimate between. The `n_segments` argument controls how many knots will be used in the basis functions. The default number of segments is 12. Lastly, the cleaned national data from the `get_data` function is provided to the `get_modelinputs` function via the `raw_data` argument.


```{r eval=FALSE}
pkg_data <- get_modelinputs(startyear = 1990, 
                            endyear = 2025.5, 
                            nsegments = 12, 
                            raw_data = cleaned_natdata)

```

This list of data and model inputs is then fed into the JAGS model via the `run_jags_model` function. In this instance, the user wishes to monitor the default set of parameters within the JAGS model. Therefore, they set the `jagsparams` argument to `NULL`, which invokes the function to use the default list. The parameters for running the JAGS model are set via the `n_iter`, `n_burnin` and `n_thin` arguments. For demonstration purposes in the code below, these arguments are set to low values. However, for optimal model convergence we recommend increasing the iterations to 80,0000, the burn-in period to 10,000, and the thinning to 35. Please note that for these increased values of arguments, the model run time is approximately 12 hours. As part of the `run_jags_model` function, the median and 80% and 95% credible intervals for the estimates are calculated. To assess convergence, we considered the convergence diagnostic $\hat{R}$, as well as the individual parameter trace plots [@Vehtari_2021].

```{r eval=FALSE}
mod <- run_jags_model(jagsdata = pkg_data, 
                      jagsparams = NULL,
                      n_iter = 80, 
                      n_burnin = 10, 
                      n_thin = 2)

```


```{r, include=TRUE, message=FALSE, eval=FALSE}

plot(mod$JAGS)

sample_draws <- tidybayes::tidy_draws(mod$JAGS$BUGSoutput$sims.matrix)

var <- sample_draws %>% dplyr::select(.chain, .iteration, .draw,`P[1,2,1,1]`) %>%
  dplyr::mutate(chain = rep(1:2, each=mod$JAGS$BUGSoutput$n.keep)) %>%
  dplyr::mutate(iteration = rep(1:mod$JAGS$BUGSoutput$n.keep, 2))

ggplot2::ggplot(data=var) +
  ggplot2::geom_line(ggplot2::aes(x=iteration, y=`P[1,2,1,1]`, color=as.factor(chain)))
```


The final JAGS model output and the summary estimates are returned as a list. Finally, these summary estimates are visualised via the `plot_estimates` function using the R package \CRANpkg{ggplot2} (Figure \@ref(fig:fig-3)).

```{r eval=FALSE, message=FALSE}
plots <- plot_estimates(jagsdata = pkg_data, 
                        model_output = mod) 
```


(ref:fig3Cap) The plotted posterior point estimates for each of the three sectors (public in blue, private commercial medical in grey, and private other in gold) for Nepal at the national administrative level over time with the 80% and 95% uncertainty interval denoted as shaded regions. Time in years is on the x-axis and the proportion of each contraceptive method supply share is on the y-axis. The survey observations are plotted as points with their associated standard error, plotted as vertical lines. This plot was produced using a multi-country set up of the mcmsupply functions.


```{r fig-3, echo=FALSE, out.width = "100%", out.height = "40%", fig.cap = '(ref:fig3Cap)'}
if(knitr::is_latex_output()) knitr::include_graphics("figures/fig_3.pdf") else knitr::include_graphics("figures/fig_3.svg")
```


If the user wishes to pull out specific estimates for a given country and year, they may do so using the `pull_estimates` function. The model object, country name and the year of interest are supplied, the function then returns a tibble of the corresponding estimates.

```{r, include=TRUE, message=FALSE, eval=FALSE}
estimates_2018 <- pull_estimates(model_output = mod, country = 'Nepal', year=2018)
```

## Case 2: Estimating contraceptive method supply shares at the national administration level for a single-country

This case considers when the estimates at the national administration level are required for only one country. Rather than running a multi-country model, which takes several hours, a quicker alternative is the single-country approach, which takes only a few minutes. The main difference between the multi-country and single-country model outputs is that the model estimates of the single-country models have slightly larger uncertainty. This is especially evident where data is absent for a particular method. For example in Figure \@ref(fig:fig-3), the width of the 95\% credible intervals over time for implants estimated by the multi-country national model are smaller than those estimated in the single-country model (Figure \@ref(fig:fig-4)). The arguments `local` and `mycountry` control the single-country estimation models in \CRANpkg{mcmsupply}. The user begins as by retrieving the data for Nepal only using the `get_data` function. They set `local=TRUE` and specify which country they are interested in by setting `mycountry=Nepal`.

```{r eval=FALSE}
cleaned_natdata <- get_data(national = TRUE, 
                            local = TRUE,
                            mycountry = "Nepal")
```


These arguments are the only discernible differences in the commands for users, the rest of the workflow is as described above in Case 1. A complete workflow for this use case can be found in `vignettes/national_singlecountry_mod`. The single-country model produces model estimates that align with those estimated by the multi-country estimation model.


(ref:fig4Cap) The plotted posterior point estimates for each of the three sectors (public in blue, private commercial medical in grey, and private other in gold) for Nepal at the national administrative level over time with the 80% and 95% uncertainty interval denoted as shaded regions. Time in years is on the x-axis and the proportion of each contraceptive method supply share is on the y-axis. The survey observations are plotted as points with their associated standard error, plotted as vertical lines. This plot was produced using a single-country set up of the mcmsupply functions.


```{r fig-4, echo=FALSE, out.width = "100%", out.height = "40%", fig.cap = '(ref:fig4Cap)'}
if(knitr::is_latex_output()) knitr::include_graphics("figures/fig_4.pdf") else knitr::include_graphics("figures/fig_4.svg")
```



## Case 3: Estimating contraceptive method supply shares at the subnational administration level for multiple countries simultaneously

The use case for estimating the contraceptive supply shares via a multi-country model for the subnational administration division is given by the vignette subnational_multicountry_models. This vignette takes approximately 24 hours to run on a machine with 1.6 GHz Dual-Core Intel Core i5 processor and 8GB of RAM. The dataset contains observations for 225 subnational divisions, across 23 countries. The user begins by calling the multi-country dataset at the subnational administration level via the `national` argument. 

```{r}
cleaned_subnatdata <- get_data(national = FALSE)
```


The remaining workflow is the same as described above in Case 1 and is not shown here. A complete workflow for this use case can be found in `vignettes/subnational_multicountry_models`.


## Case 4: Estimating contraceptive method supply shares at the subnational administration level for a single-country

This use case is for considering use of the single-country model at the subnational administrative division. The user begins by retrieving the data for Nepal using the `get_data` function by setting the arguments `national=FALSE`, `local=TRUE` and `mycountry=‘Nepal’`.  

```{r eval=FALSE}
cleaned_data <- get_data(national = FALSE, 
                         local = TRUE,
                         mycountry = "Nepal")
```

As in the previous use cases, the JAGS model is run and point summaries are calculated via the `run_jags_model` function. The visualisations for the subnational regions of Nepal are returns as a list via the `plot_estimates` function. An example of these visualisations is given in Figure \@ref(fig:fig-5), where the estimated median method supply shares for Central region of Nepal are plotted with 80% and 95% credible intervals over time in each of the methods.


(ref:fig5Cap) The plotted posterior point estimates for each of the three sectors (public in blue, private commercial medical in grey, and private other in gold) taken from the subnational single-country population for the Central subnational region of Nepal over time with both 80% and 95% uncertainty denoted as corresponding shaded regions. Time in years is on the x-axis and the proportion of each contraceptive method supply share is on the y-axis. The survey observations are plotted as points with their associated standard error, plotted as vertical lines.


```{r fig-5, echo=FALSE, out.width = "100%", out.height = "40%", fig.cap = '(ref:fig5Cap)'}
if(knitr::is_latex_output()) knitr::include_graphics("figures/fig_5.pdf") else knitr::include_graphics("figures/fig_5.svg")
```



## Case 5: Estimating contraceptive method supply shares at the national/subnational administration level for a single-country using custom data

It is possible to include custom datasets when estimating contraceptive method supply shares at either the national or subnational administration level. The set-up for using custom data is very similar to the above processes, with a small difference in the data retrieval step using the `get_data` function. When using a custom dataset, the user defines the location of the `.xlsx` file containing the custom data.

```{r eval=FALSE}
cleaned_data <- get_data(national = FALSE, 
                         local = TRUE, 
                         surveydata_filepath = 
                           "inst/data-raw/my_custom_data_good.xlsx",
                         mycountry = "Ethiopia")
```

The file must be in `.xlsx` format and match the layout of either the `national_FPsource_data` or `subnat_FPsource_data datasets`, depending on your desired administration level.  The `get_data` function will carry out a series of internal checks to ensure the custom data matches the stored data layout. If the custom data is not suitable, the `get_data` function will return an error and a message to the user describing the issue with the custom data. A description of each column is given in Table \@ref(tab:tab6). Once the custom data checks are complete and passed, the regular workflow for fitting an \CRANpkg{mcmsupply} model continues. The JAGS model inputs are retrieved using the `get_modelinputs` and the JAGS model is fit using `run_jags_model`. The summary estimates are plotted using the `plot_estimates` function without any further changes to the workflow. A vignette of how to run the subnational model using a custom dataset can be found `vignettes/subnational_singlecountry_customdata_models`.


```{r te-tab6, echo = FALSE, results = "asis"}
latex_tab6 <- r"(
\begin{table}[]
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|c|}
\hline
\textbf{Column name} &
  \textbf{Data type} &
  \textbf{Description} &
  \textbf{Required} \\ \hline
  Country &
  Character &
  \begin{tabular}[c]{@{}c@{}} The name of the country you have the custom data for.\end{tabular} &
  National and subnational \\ \hline
  Region &
  Character &
  \begin{tabular}[c]{@{}c@{}} The name of the subnational area you have the custom data for\end{tabular} &
  Subnational \\ \hline
  Method &
  Character &
  \begin{tabular}[c]{@{}c@{}} The name of the contraceptive method you have the custom data for\end{tabular} &
  National and subnational \\ \hline
  average\_year &
  Numeric &
  \begin{tabular}[c]{@{}c@{}} The year that the observation was collected in. \end{tabular} &
  National and subnational \\ \hline
  sector\_categories &
  Character &
  \begin{tabular}[c]{@{}c@{}} The supply sector of the contraceptive method you have the custom data for.\end{tabular} &
  Subnational \\ \hline
  sector\_category &
  Character &
  \begin{tabular}[c]{@{}c@{}} The supply sector of the contraceptive method you have the custom data for.\end{tabular} &
  National \\ \hline
  proportion &
  Numeric &
  \begin{tabular}[c]{@{}c@{}} The proportion of a given contraceptive method supplied by the observation. \end{tabular} &
  National and subnational \\ \hline
  SE.proportion &
  Numeric &
  \begin{tabular}[c]{@{}c@{}} The associated standard error of the proportion supplied by the observation. \end{tabular} &
  National and subnational \\ \hline
  n &
  Numeric &
  \begin{tabular}[c]{@{}c@{}} The sample size used to estimate the observation. \end{tabular} &
  National and subnational \\ \hline
\end{tabular}%
}
\caption{The required columns when supplying custom data to the get\_data . The column name is given, the type of data expected in each column along with a description of the column. The 'Required' column indicates whether the column belongs in national or subnational custom data files. The get\_data function will carry out a series of internal checks to ensure the custom data matches the stored data layout.}
\label{tab:tab6}
\end{table}
)"

md_tab6 <- r"(
| **Column name**     | **Data type** | **Description**                                                                                                                                             | **Required**          |
|---------------------|---------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------|
| Country             | Character     | The name of the country you have the custom data for.                                                                                                                                              | National and subnational |
| Region              | Character     | The name of the subnational area you have the custom data for.                                                                                                                                     | Subnational           |
| Method              | Character     | The name of the contraceptive method you have the custom data for.                                                                                                                                 | National and subnational |
| average\_year       | Numeric       | The year that the observation was collected in.                                                                                                                                                    | National and subnational |
| sector\_categories  | Character     | The supply sector of the contraceptive method you have the custom data for.                                                                                                                       | Subnational           |
| sector\_category    | Character     | The supply sector of the contraceptive method you have the custom data for.                                                                                                                       | National              |
| proportion          | Numeric       | The proportion of a given contraceptive method supplied by the observation.                                                                                                                        | National and subnational |
| SE.proportion       | Numeric       | The associated standard error of the proportion supplied by the observation.                                                                                                                       | National and subnational |
| n                   | Numeric       | The sample size used to estimate the observation.                                                                                                                                                   | National and subnational |

Table: (\#tab:tab6) The required columns when supplying custom data to the `get_data`. The column name is given, the type of data expected in each column along with a description of the column. The 'Required' column indicates whether the column belongs in national or subnational custom data files. The `get_data` function will carry out a series of internal checks to ensure the custom data matches the stored data layout.
)"


if(knitr::is_latex_output()) cat(latex_tab6) else cat(md_tab6)
```

# Discussion 

In this paper we have introduced the package \CRANpkg{mcmsupply}. The primary purpose of this package is to estimate and project modern contraceptive method supply shares from the public, private commercial medical and private other sectors with uncertainty, for a selection of countries participating in the FP2030 initiative. The \CRANpkg{mcmsupply} package produces estimates within the period of available Demographic and Health Survey data for a given country, as well as projections beyond the most recent data point. The package uses either stored DHS survey data or custom user-supplied survey data as inputs to the modelling process. The package implements four model types. These models vary by the administration level of their outcome estimates (national or subnational administration level) and dataset type utilised in the estimation (multi-country or single-country contraceptive market supply datasets). The modelling framework uses penalised splines to capture temporal nature of the data. These splines utilise correlations between changes in method supply shares that exist within the data. Using splines informed by cross-method correlations allows us to capture the complex shape of the data without over-fitting. Bayesian hierarchical estimation is another key element of this model estimation process. We take advantage of the geographical nature of the data, such that the expected sector, province (subnational level) or country (national level), method-specific supply shares are informed based on the existing geographical structures in the data. This promotes information sharing across locations, and better inform estimates in areas where smaller amounts of data are present. Case studies illustrate how to use the \CRANpkg{mcmsupply} for each of the four potential modelling routes, as well as how to estimate contraceptive method supply shares using custom user-supplied data. 

The \CRANpkg{mcmsupply} package has many benefits to users. Firstly, it is the first of its kind to produce annual estimates with uncertainty for monitoring contraceptive method supply shares over time at the national and subnational levels. On average, most countries carry out DHS surveys every 5-6 years, but in some instances the wait time between surveys may be even longer [@DHSTypes]. The family planning community use contraceptive method supply shares to evaluate the stability and sustainability of a given country's contraceptive market [@Bradley2022]. Contraceptive method supply share estimates are also pivotal in effectively managing contraceptive commodity supply-chains through a 'total market approach' (TMA). A TMA approach to the family planning supply market seeks to engage the public, private commercial, and other sectors in a country to increase family planning users access to vital information, products, and services [@Moazzam2015; @SHOPSTMA2016]. Prior to this package, individuals who required contraceptive method supply shares for a given country relied on estimates from the most recent DHS survey in the country, regardless of its age. The \CRANpkg{mcmsupply} package alleviates this issue and provides the family planning community annual estimates with uncertainty for these contraceptive method supply shares. Secondly, contraceptive method supply shares estimates are not only a stand -alone family planning indicator but are also used in the calculation of an another indicator, estimated modern use (EMU) [@Track20]. EMUs aim to measure the proportion of women, aged 15 to 49 years old , who are currently using any modern method of contraception, and are derived from routinely collected family planning service statistics [@Track20MonitoringEMUs]. Currently, EMU calculations depend on an adjustment that relies on the most recent DHS survey to provide estimates of the contraceptive supply share market in a given country. Now this adjustment can instead rely on the annual estimates and projections with uncertainty produced by the \CRANpkg{mcmsupply} package. This can serve to improve the overall accuracy of EMUs with respect to their ability to accurately measure modern contraceptive use. In addition, given the probabilistic nature of the \CRANpkg{mcmsupply} estimates the associated uncertainty can be propagated into the EMU calculations.

The last key benefit of the \CRANpkg{mcmsupply} package is the speed at which the user is able to access individual countries supply share estimates. Using the single-country models, at either the national or subnational level, provides users with annual estimates of the method supply shares with uncertainty within minutes. This fast estimation approach is computationally efficient while still producing reliable estimates. Using priors informed by multi-country model subcontinental and country-level median parameter estimates, this modelling approach is robust to spurious parameter estimates even when estimating supply shares for countries with fewer surveys available. This computational efficiency without a loss of model accuracy makes the \CRANpkg{mcmsupply} package user-friendly and efficient for regular data analysis.

The \CRANpkg{mcmsupply} is not without its limitations. We remark that the implementation of these models in JAGS have not been optimised. The multi-country models at the national and subnational levels take hours to run and are intensive on computer memory and CPU. Hence, improvements such as matrix operations rather than for-loops would greatly improve the computation efficiency of this package. Another limitation of this package is that in methods without any survey information, the uncertainty intervals tend to be large. This is especially evident in the single-country models where in the absence of data for a given method, the uncertainty of the associated estimates is even larger than that of the corresponding multi-country model estimates. These limitations inspires our future work, where we seek to improve the computational efficiency of these models. We would also like to investigate the potential for incorporating additional covariates into the models, such as average method pricing for each sector, to improve the uncertainty of model estimates and projections where no DHS survey data is available. Lastly, we wish to design an R-shiny app that promotes the use of these model estimates among statistical non-experts within the family planning community.


# Conclusions

\CRANpkg{mcmsupply} is an R package that estimates the modern contraceptive method supply shares at the national and subnational administrative divisions over time for countries participating in the Family Planning 2030 initiative. The package provides the user an easy and accessible way to produce annual estimates with uncertainty using Bayesian hierarchical penalised spline models with cross-method correlations at the national and subnational administration levels. These annual estimates with uncertainty may act as a stand-alone family planning indicator of the stability of the modern contraceptive supply market or be used to produce alternative family planning indicators, such as estimated modern use (EMUs) using service statistics [@Track20]. To the best of our knowledge, the package is the first of its kind to estimate these supply shares at both administrative levels. Using an R package to disseminate this work aligns with the findability, accessibility, interoperability, and reusability (FAIR) principles of scientific data [@Wilkinson2016]. The data used in the package is cited and explained thoroughly, the code is commented and easy to understand should a user wish to tweak or review any functionalities, and finally it is reusable by the very nature of the R package.


