# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2025-002.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center")
library(ggplot2)
library(cowplot)
library(kableExtra)


## ----dynforestRgraph, out.width = "100%", out.height = "30%", fig.cap = "Overall scheme of the tree building in DynForest with (A) the tree structure, (B) the node-specific treatment of time-dependent predictors to obtain time-fixed features, (C) the dichotomization of the time-fixed features, (D) the splitting rule."----
knitr::include_graphics("figures/dynforestR_graph.png")


## ----eval = FALSE, echo = TRUE------------------------------------------------
# dynforest(
#   timeData = NULL, fixedData = NULL, idVar = NULL,
#   timeVar = NULL, timeVarModel = NULL, Y = NULL,
#   ntree = 200, mtry = NULL, nodesize = 1, minsplit = 2, cause = 1,
#   nsplit_option = "quantile", ncores = NULL,
#   seed = 1234, verbose = TRUE
# )


## ----eval = FALSE, echo = TRUE------------------------------------------------
# predict(object, timeData = NULL, fixedData = NULL, idVar, timeVar, t0 = NULL)


## ----include = FALSE----------------------------------------------------------
load("data/DynForest_fit_surv_all.RData")


## ----echo = TRUE, message = FALSE---------------------------------------------
library("DynForest")
data(pbc2)
pbc2[1:5, c(
  "id", "time", "serBilir", "SGOT", "albumin", "alkaline",
  "age", "drug", "sex", "years", "event"
)]


## ----eval = FALSE, echo = TRUE------------------------------------------------
# set.seed(1234)
# id <- unique(pbc2$id)
# id_sample <- sample(id, length(id) * 2 / 3)
# id_row <- which(pbc2$id %in% id_sample)
# pbc2_train <- pbc2[id_row, ]
# pbc2_pred <- pbc2[-id_row, ]


## ----eval = FALSE, echo = TRUE------------------------------------------------
# timeData_train <- pbc2_train[,
#   c("id", "time", "serBilir", "SGOT", "albumin", "alkaline")
# ]
# fixedData_train <- unique(pbc2_train[, c("id", "age", "drug", "sex")])


## ----eval = FALSE, echo = TRUE------------------------------------------------
# timeVarModel <- list(
#   serBilir = list(fixed = serBilir ~ time, random = ~time),
#   SGOT = list(fixed = SGOT ~ time + I(time^2), random = ~ time + I(time^2)),
#   albumin = list(fixed = albumin ~ time, random = ~time),
#   alkaline = list(fixed = alkaline ~ time, random = ~time)
# )


## ----eval = FALSE, echo = TRUE------------------------------------------------
# Y <- list(type = "surv", Y = unique(pbc2_train[, c("id", "years", "event")]))


## ----eval = FALSE, echo = TRUE------------------------------------------------
# res_dyn <- dynforest(
#   timeData = timeData_train,
#   fixedData = fixedData_train,
#   timeVar = "time", idVar = "id",
#   timeVarModel = timeVarModel, Y = Y,
#   ntree = 200, mtry = 3, nodesize = 2, minsplit = 3,
#   cause = 2, ncores = 7, seed = 1234
# )


## ----echo = TRUE--------------------------------------------------------------
summary(res_dyn)


## ----echo = TRUE--------------------------------------------------------------
head(get_tree(dynforest_obj = res_dyn, tree = 1))


## ----echo = TRUE--------------------------------------------------------------
tail(get_tree(dynforest_obj = res_dyn, tree = 1))


## ----eval = FALSE-------------------------------------------------------------
# plot(res_dyn, tree = 1, nodes = 251)


## ----DynForestRCIF, echo = TRUE, out.width = "80%", out.height = "30%", fig.cap = "Estimated cumulative incidence functions for subject 104 over 9 trees."----
plot(res_dyn, id = 104, max_tree = 9)


## ----eval = FALSE, echo = TRUE------------------------------------------------
# res_dyn_OOB <- compute_ooberror(dynforest_obj = res_dyn)


## ----echo = TRUE--------------------------------------------------------------
res_dyn_OOB


## ----eval = FALSE, echo = TRUE------------------------------------------------
# id_pred <- unique(pbc2_pred$id[which(pbc2_pred$years > 4)])
# pbc2_pred_tLM <- pbc2_pred[which(pbc2_pred$id %in% id_pred), ]
# timeData_pred <- pbc2_pred_tLM[,
#   c("id", "time", "serBilir", "SGOT", "albumin", "alkaline")
# ]
# fixedData_pred <- unique(pbc2_pred_tLM[, c("id", "age", "drug", "sex")])
# pred_dyn <- predict(
#   object = res_dyn,
#   timeData = timeData_pred,
#   fixedData = fixedData_pred,
#   idVar = "id",
#   timeVar = "time",
#   t0 = 4
# )


## ----DynForestRpredCIF, eval = TRUE, out.width = "80%", out.height = "30%", fig.cap = "Predicted cumulative incidence function for subjects 102 and 260 from landmark time of 4 years (represented by the dashed vertical line)"----
plot(pred_dyn, id = c(102, 260))


## ----eval = FALSE, echo = TRUE------------------------------------------------
# res_dyn_VIMP <- compute_vimp(dynforest_obj = res_dyn, seed = 123)


## ----echo = TRUE, fig.show='hide'---------------------------------------------
p1 <- plot(res_dyn_VIMP, PCT = TRUE)


## ----eval = FALSE, echo = TRUE------------------------------------------------
# group <- list(
#   group1 = c("serBilir", "SGOT"),
#   group2 = c("albumin", "alkaline")
# )
# res_dyn_gVIMP <- compute_gvimp(dynforest_obj = res_dyn, group = group, seed = 123)


## ----echo = TRUE, fig.show='hide'---------------------------------------------
p2 <- plot(res_dyn_gVIMP, PCT = TRUE)


## ----DynForestRVIMPgVIMP, echo = TRUE, out.width = "80%", out.height = "30%", fig.cap = "(A) VIMP statistic and (B) grouped-VIMP statistic displayed as a percentage of loss in OOB error of prediction. group1 includes serBilir and SGOT; group2 includes albumin and alkaline."----
plot_grid(p1, p2, labels = c("A", "B"))


## ----eval = FALSE, echo = TRUE------------------------------------------------
# res_dyn_max <- dynforest(
#   timeData = timeData_train,
#   fixedData = fixedData_train,
#   timeVar = "time", idVar = "id",
#   timeVarModel = timeVarModel, Y = Y,
#   ntree = 200, mtry = 7, nodesize = 2, minsplit = 3,
#   cause = 2, ncores = 7, seed = 1234
# )


## ----echo = TRUE, eval = TRUE, fig.show='hide'--------------------------------
depth_dyn <- compute_vardepth(dynforest_obj = res_dyn_max)
p1 <- plot(depth_dyn, plot_level = "predictor")
p2 <- plot(depth_dyn, plot_level = "feature")


## ----DynForestRmindepth, echo = TRUE, eval = TRUE, out.width = "80%", out.height = "30%", fig.cap = "Average minimal depth level by predictor (A) and feature (B)."----
plot_grid(p1, p2, labels = c("A", "B"))


## ----DynForestRmtrytuned, echo = FALSE, include = TRUE, out.width = "80%", out.height = "30%", fig.cap = "OOB error according to mtry hyperparameter. The optimal value was found for the maximum value mtry = 7."----
ggplot(data.frame(mtry = seq(7), OOB.error = err.OOB), aes(x = mtry, y = OOB.error)) +
  geom_line(color = "red") +
  geom_point(color = "red", size = 1) +
  ylab("OOB error") +
  theme_bw() +
  theme(
    axis.title.x = element_text(face = "bold"),
    axis.title.y = element_text(face = "bold")
  )


## -----------------------------------------------------------------------------
load("data/DynForest_fit_factor_all.RData")


## ----echo = TRUE, message = FALSE---------------------------------------------
pbc2 <- pbc2[which(pbc2$years > 4 & pbc2$time <= 4), ]
pbc2$event <- ifelse(pbc2$event == 2, 1, 0)
pbc2$event[which(pbc2$years > 10)] <- 0
set.seed(1234)
id <- unique(pbc2$id)
id_sample <- sample(id, length(id) * 2 / 3)
id_row <- which(pbc2$id %in% id_sample)
pbc2_train <- pbc2[id_row, ]
pbc2_pred <- pbc2[-id_row, ]


## ----eval = FALSE, echo = TRUE------------------------------------------------
# timeData_train <- pbc2_train[,
#   c("id", "time", "serBilir", "SGOT", "albumin", "alkaline")
# ]
# timeVarModel <- list(
#   serBilir = list(fixed = serBilir ~ time, random = ~time),
#   SGOT = list(fixed = SGOT ~ time + I(time^2), random = ~ time + I(time^2)),
#   albumin = list(fixed = albumin ~ time, random = ~time),
#   alkaline = list(fixed = alkaline ~ time, random = ~time)
# )
# fixedData_train <- unique(pbc2_train[, c("id", "age", "drug", "sex")])


## ----eval = FALSE, echo = TRUE------------------------------------------------
# Y <- list(
#   type = "factor",
#   Y = unique(pbc2_train[, c("id", "event")])
# )


## ----eval = FALSE, echo = TRUE------------------------------------------------
# res_dyn <- dynforest(
#   timeData = timeData_train,
#   fixedData = fixedData_train,
#   timeVar = "time", idVar = "id",
#   timeVarModel = timeVarModel,
#   mtry = 7, nodesize = 2,
#   Y = Y, ncores = 7, seed = 1234
# )


## ----eval = FALSE, echo = TRUE------------------------------------------------
# res_dyn_OOB <- compute_ooberror(dynforest_obj = res_dyn)


## ----eval = TRUE, echo = TRUE-------------------------------------------------
summary(res_dyn_OOB)


## ----eval = FALSE, echo = TRUE------------------------------------------------
# timeData_pred <- pbc2_pred[,
#   c("id", "time", "serBilir", "SGOT", "albumin", "alkaline")
# ]
# fixedData_pred <- unique(pbc2_pred[, c("id", "age", "drug", "sex")])
# pred_dyn <- predict(
#   object = res_dyn,
#   timeData = timeData_pred,
#   fixedData = fixedData_pred,
#   idVar = "id", timeVar = "time",
#   t0 = 4
# )


## ----eval = TRUE, echo = TRUE-------------------------------------------------
head(data.frame(
  pred = pred_dyn$pred_indiv,
  proba = pred_dyn$pred_indiv_proba
))


## ----eval = FALSE, echo = TRUE------------------------------------------------
# res_dyn_VIMP <- compute_vimp(dynforest_obj = res_dyn_OOB, seed = 123)
# plot(res_dyn_VIMP, PCT = TRUE)


## ----eval = TRUE, echo = TRUE, fig.show='hide'--------------------------------
depth_dyn <- compute_vardepth(dynforest_obj = res_dyn_OOB)
p1 <- plot(depth_dyn, plot_level = "predictor")
p2 <- plot(depth_dyn, plot_level = "feature")


## ----DynForestRfactormindepth, eval = TRUE, echo = TRUE, out.width = "80%", out.height = "30%", fig.cap = "Average minimal depth by predictor (A) and feature (B)."----
plot_grid(p1, p2, labels = c("A", "B"))

