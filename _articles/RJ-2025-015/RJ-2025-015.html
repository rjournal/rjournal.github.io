<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

<style>
  div.csl-bib-body { }
  div.csl-entry {
    clear: both;
      margin-bottom: 0em;
    }
  .hanging div.csl-entry {
    margin-left:2em;
    text-indent:-2em;
  }
  div.csl-left-margin {
    min-width:2em;
    float:left;
  }
  div.csl-right-inline {
    margin-left:2em;
    padding-left:1em;
  }
  div.csl-indent {
    margin-left: 2em;
  }
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Sfislands: An R Package for Accommodating Islands and Disjoint Zones in Areal Spatial Modelling</title>

  <meta property="description" itemprop="description" content="Fitting areal models which use a spatial weights matrix to represent relationships between geographical units can be a cumbersome task, particularly when these units are not well-behaved. The two chief aims of sfislands are to simplify the process of creating an appropriate neighbourhood matrix, and to quickly visualise the predictions of subsequent models. The package uses visual aids in the form of easily-generated maps to help this process. This paper demonstrates how sfislands could be useful to researchers. It begins by describing the package&#39;s functions in the context of a proposed workflow. It then presents two worked examples showing a selection of potential use-cases. These range from earthquakes in Indonesia, to river crossings in London. We aim to show how the sfislands package streamlines much of the human workflow involved in creating and examining such models."/>

  <link rel="license" href="https://creativecommons.org/licenses/by/4.0/"/>

  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2025-09-24"/>
  <meta property="article:created" itemprop="dateCreated" content="2025-09-24"/>
  <meta name="article:author" content="Kevin Horan"/>
  <meta name="article:author" content="Katarina Domijan"/>
  <meta name="article:author" content="Chris Brunsdon"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Sfislands: An R Package for Accommodating Islands and Disjoint Zones in Areal Spatial Modelling"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Fitting areal models which use a spatial weights matrix to represent relationships between geographical units can be a cumbersome task, particularly when these units are not well-behaved. The two chief aims of sfislands are to simplify the process of creating an appropriate neighbourhood matrix, and to quickly visualise the predictions of subsequent models. The package uses visual aids in the form of easily-generated maps to help this process. This paper demonstrates how sfislands could be useful to researchers. It begins by describing the package&#39;s functions in the context of a proposed workflow. It then presents two worked examples showing a selection of potential use-cases. These range from earthquakes in Indonesia, to river crossings in London. We aim to show how the sfislands package streamlines much of the human workflow involved in creating and examining such models."/>
  <meta property="og:locale" content="en_US"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Sfislands: An R Package for Accommodating Islands and Disjoint Zones in Areal Spatial Modelling"/>
  <meta property="twitter:description" content="Fitting areal models which use a spatial weights matrix to represent relationships between geographical units can be a cumbersome task, particularly when these units are not well-behaved. The two chief aims of sfislands are to simplify the process of creating an appropriate neighbourhood matrix, and to quickly visualise the predictions of subsequent models. The package uses visual aids in the form of easily-generated maps to help this process. This paper demonstrates how sfislands could be useful to researchers. It begins by describing the package&#39;s functions in the context of a proposed workflow. It then presents two worked examples showing a selection of potential use-cases. These range from earthquakes in Indonesia, to river crossings in London. We aim to show how the sfislands package streamlines much of the human workflow involved in creating and examining such models."/>

  <!--  https://scholar.google.com/intl/en/scholar/inclusion.html#indexing -->
  <meta name="citation_title" content="Sfislands: An R Package for Accommodating Islands and Disjoint Zones in Areal Spatial Modelling"/>
  <meta name="citation_fulltext_html_url" content="https://doi.org/10.32614/RJ-2025-015"/>
  <meta name="citation_pdf_url" content="RJ-2025-015.pdf"/>
  <meta name="citation_volume" content="17"/>
  <meta name="citation_issue" content="2"/>
  <meta name="citation_doi" content="10.32614/RJ-2025-015"/>
  <meta name="citation_journal_title" content="The R Journal"/>
  <meta name="citation_issn" content="2073-4859"/>
  <meta name="citation_firstpage" content="1"/>
  <meta name="citation_fulltext_world_readable" content=""/>
  <meta name="citation_online_date" content="2025/09/24"/>
  <meta name="citation_publication_date" content="2025/09/24"/>
  <meta name="citation_author" content="Kevin Horan"/>
  <meta name="citation_author_institution" content="Hamilton Institute, Maynooth University"/>
  <meta name="citation_author" content="Katarina Domijan"/>
  <meta name="citation_author_institution" content="Department of Mathematics and Statistics, Maynooth University"/>
  <meta name="citation_author" content="Chris Brunsdon"/>
  <meta name="citation_author_institution" content="National Centre for Geocomputation, Maynooth University"/>
  <!--/radix_placeholder_meta_tags-->
  
  <meta name="citation_reference" content="citation_title=sfdep: Spatial dependence for simple features;citation_author=Josiah Parry;citation_author=Dexter H Locke"/>
  <meta name="citation_reference" content="citation_title=sfislands: Streamlines the process of fitting areal spatial models;citation_author=Kevin Horan;citation_author=Katarina Domijan;citation_author=Chris Brunsdon"/>
  <meta name="citation_reference" content="citation_title=Simple features for R: Standardized support for spatial vector data;citation_volume=10;citation_author=Edzer Pebesma"/>
  <meta name="citation_reference" content="citation_title=ggpubr: “ggplot2”-based publication ready plots;citation_author=Alboukadel Kassambara"/>
  <meta name="citation_reference" content="citation_title=Fitting linear mixed-effects models using lme4;citation_volume=67;citation_author=Douglas Bates;citation_author=Martin Mächler;citation_author=Ben Bolker;citation_author=Steve Walker"/>
  <meta name="citation_reference" content="citation_title=nlme: Linear and nonlinear mixed effects models;citation_author=José Pinheiro;citation_author=Douglas Bates;citation_author=nlme: Linear and nonlinear mixed effects models"/>
  <meta name="citation_reference" content="citation_title=Fast stable restricted maximum likelihood and marginal likelihood estimation of semiparametric generalized linear models;citation_volume=73;citation_author=S. N. Wood"/>
  <meta name="citation_reference" content="citation_title=broom: Convert statistical objects into tidy tibbles;citation_author=David Robinson;citation_author=Alex Hayes;citation_author=Simon Couch"/>
  <meta name="citation_reference" content="citation_title=R packages for analyzing spatial data: A comparative case study with areal data;citation_volume=54;citation_author=Roger S. Bivand"/>
  <meta name="citation_reference" content="citation_title=brms: An R package for Bayesian multilevel models using Stan;citation_volume=80;citation_author=Paul-Christian Bürkner"/>
  <meta name="citation_reference" content="citation_title=ggplot2: Elegant graphics for data analysis;citation_publisher=Springer-Verlag New York;citation_author=Hadley Wickham"/>
  <meta name="citation_reference" content="citation_title=Spatial modelling with R-INLA: A review;citation_publisher=arXiv;citation_doi=10.48550/ARXIV.1802.06350;citation_author=Haakon Bakka;citation_author=Håvard Rue;citation_author=Geir-Arne Fuglstad;citation_author=Andrea Riebler;citation_author=David Bolin;citation_author=Elias Krainski;citation_author=Daniel Simpson;citation_author=Finn Lindgren"/>
  <meta name="citation_reference" content="citation_title=RStan: the R interface to Stan;citation_author=RStan: the R interface to Stan"/>
  <meta name="citation_reference" content="citation_title=Evaluating the effect of neighbourhood weight matrices on smoothing properties of conditional autoregressive (CAR) models;citation_publisher=Springer Science; Business Media LLC;citation_volume=6;citation_author=Arul Earnest;citation_author=Geoff Morgan;citation_author=Kerrie Mengersen;citation_author=Louise Ryan;citation_author=Richard Summerhayes;citation_author=John Beard"/>
  <meta name="citation_reference" content="citation_title=Spatial smoothing in Bayesian models: A comparison of weights matrix specifications and their impact on inference;citation_publisher=Springer Science; Business Media LLC;citation_volume=16;citation_author=Earl W. Duncan;citation_author=Nicole M. White;citation_author=Kerrie Mengersen"/>
  <meta name="citation_reference" content="citation_title=A comparison of multiple neighborhood matrix specifications for spatio-temporal model fitting: A case study on COVID-19 data;citation_publisher=Springer Science; Business Media LLC;citation_volume=36;citation_author=Álvaro Briz-Redón;citation_author=Adina Iftimi;citation_author=Juan Francisco Correcher;citation_author=Jose De Andrés;citation_author=Manuel Lozano;citation_author=Carolina Romero-García"/>
  <meta name="citation_reference" content="citation_title=A computer movie simulating urban growth in the Detroit region;citation_volume=46;citation_author=W. R. Tobler"/>
  <meta name="citation_reference" content="citation_title=List of crossings of the River Thames — Wikipedia, the free encyclopedia;citation_author= Wikipedia"/>
  <meta name="citation_reference" content="citation_title=Exploring spatial data analysis techniques using R: The case of observations with no neighbors;citation_publisher=Springer;citation_author=Roger S. Bivand;citation_author=Boris A. Portnov"/>
  <meta name="citation_reference" content="citation_title=A note on intrinsic conditional autoregressive models for disconnected graphs;citation_publisher=Elsevier BV;citation_volume=26;citation_author=Anna Freni-Sterrantino;citation_author=Massimo Ventrucci;citation_author=Håvard Rue"/>
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","date","description","draft","author","type","output","bibliography","date_received","volume","issue","slug","journal","pdf_url","citation_url","doi","creative_commons","packages","CTV","csl"]}},"value":[{"type":"character","attributes":{},"value":["Sfislands: An R Package for Accommodating Islands and Disjoint Zones in Areal Spatial Modelling"]},{"type":"character","attributes":{},"value":["2025-09-24"]},{"type":"character","attributes":{},"value":["Fitting areal models which use a spatial weights matrix to represent relationships between geographical units can be a cumbersome task, particularly when these units are not well-behaved. The two chief aims of sfislands are to simplify the process of creating an appropriate neighbourhood matrix, and to quickly visualise the predictions of subsequent models. The package uses visual aids in the form of easily-generated maps to help this process. This paper demonstrates how sfislands could be useful to researchers. It begins by describing the package's functions in the context of a proposed workflow. It then presents two worked examples showing a selection of potential use-cases. These range from earthquakes in Indonesia, to river crossings in London. We aim to show how the sfislands package streamlines much of the human workflow involved in creating and examining such models.\n"]},{"type":"logical","attributes":{},"value":[false]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation","address","url","orcid_id","email"]}},"value":[{"type":"character","attributes":{},"value":["Kevin Horan"]},{"type":"character","attributes":{},"value":["Hamilton Institute, Maynooth University"]},{"type":"character","attributes":{},"value":["Maynooth","Co. Kildare, Ireland"]},{"type":"character","attributes":{},"value":["https://github.com/horankev"]},{"type":"character","attributes":{},"value":["0009-0003-9378-0084"]},{"type":"character","attributes":{},"value":["kevin.horan.2021@mumail.ie"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation","address","email","orcid_id"]}},"value":[{"type":"character","attributes":{},"value":["Katarina Domijan"]},{"type":"character","attributes":{},"value":["Department of Mathematics and Statistics, Maynooth University"]},{"type":"character","attributes":{},"value":["Maynooth","Co. Kildare, Ireland"]},{"type":"character","attributes":{},"value":["katarina.domijan@mu.ie"]},{"type":"character","attributes":{},"value":["0000-0002-4268-2236"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation","address","email","orcid_id"]}},"value":[{"type":"character","attributes":{},"value":["Chris Brunsdon"]},{"type":"character","attributes":{},"value":["National Centre for Geocomputation, Maynooth University"]},{"type":"character","attributes":{},"value":["Maynooth","Co. Kildare, Ireland"]},{"type":"character","attributes":{},"value":["Christopher.Brunsdon@mu.ie"]},{"type":"character","attributes":{},"value":["0000-0003-4254-1780"]}]}]},{"type":"character","attributes":{},"value":["package"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["rjtools::rjournal_pdf_article","distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["toc"]}},"value":[{"type":"logical","attributes":{},"value":[false]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc"]}},"value":[{"type":"logical","attributes":{},"value":[true]},{"type":"logical","attributes":{},"value":[false]}]}]},{"type":"character","attributes":{},"value":["RJreferences.bib"]},{"type":"character","attributes":{},"value":["2024-04-05"]},{"type":"integer","attributes":{},"value":[17]},{"type":"integer","attributes":{},"value":[2]},{"type":"character","attributes":{},"value":["RJ-2025-015"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","issn","firstpage","lastpage"]}},"value":[{"type":"character","attributes":{},"value":["The R Journal"]},{"type":"character","attributes":{},"value":["2073-4859"]},{"type":"double","attributes":{},"value":[1]},{"type":"NULL"}]},{"type":"character","attributes":{},"value":["RJ-2025-015.pdf"]},{"type":"character","attributes":{},"value":["https://doi.org/10.32614/RJ-2025-015"]},{"type":"character","attributes":{},"value":["10.32614/RJ-2025-015"]},{"type":"character","attributes":{},"value":["CC BY"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["cran","bioc"]}},"value":[{"type":"character","attributes":{},"value":["spdep","sf","sfdep","sfislands","mgcv","ggplot2","brms","rstan","broom","lme4","nlme","ggpubr","tidyverse"]},{"type":"list","attributes":{},"value":[]}]},{"type":"character","attributes":{},"value":["Bayesian","ChemPhys","ClinicalTrials","Econometrics","Environmetrics","Finance","MetaAnalysis","MixedModels","NetworkAnalysis","OfficialStatistics","Phylogenetics","Psychometrics","Spatial","SpatioTemporal","TeachingStatistics"]},{"type":"character","attributes":{},"value":["/home/hyndman/R/x86_64-pc-linux-gnu-library/4.5/rjtools/rjournal.csl"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["article.log","article.tex","RJ-2025-015_files/anchor-4.2.2/anchor.min.js","RJ-2025-015_files/bowser-1.9.3/bowser.min.js","RJ-2025-015_files/distill-2.2.21/template.v2.js","RJ-2025-015_files/figure-html5/fault-buffers-1.png","RJ-2025-015_files/figure-html5/fault-conc-1.png","RJ-2025-015_files/figure-html5/ind-contig1html-1.png","RJ-2025-015_files/figure-html5/ind-contig2html-1.png","RJ-2025-015_files/figure-html5/ind-contig3html-1.png","RJ-2025-015_files/figure-html5/ind-mrf1html-1.png","RJ-2025-015_files/figure-html5/ind-mrf2html-1.png","RJ-2025-015_files/figure-html5/lon-contig1-1.png","RJ-2025-015_files/figure-html5/lon-contig2-1.png","RJ-2025-015_files/figure-html5/lon-contig3-1.png","RJ-2025-015_files/figure-html5/lon-contig4-1.png","RJ-2025-015_files/figure-html5/lon-crossings-1.png","RJ-2025-015_files/figure-html5/quake-conc-1.png","RJ-2025-015_files/figure-html5/quake-occur-1.png","RJ-2025-015_files/figure-html5/quake-totals-1.png","RJ-2025-015_files/figure-html5/rects1-1.png","RJ-2025-015_files/figure-html5/rects2-1.png","RJ-2025-015_files/figure-html5/rects3-1.png","RJ-2025-015_files/figure-html5/rects4-1.png","RJ-2025-015_files/figure-html5/rects5-1.png","RJ-2025-015_files/header-attrs-2.29/header-attrs.js","RJ-2025-015_files/jquery-3.6.0/jquery-3.6.0.js","RJ-2025-015_files/jquery-3.6.0/jquery-3.6.0.min.js","RJ-2025-015_files/jquery-3.6.0/jquery-3.6.0.min.map","RJ-2025-015_files/kePrint-0.0.1/kePrint.js","RJ-2025-015_files/lightable-0.0.1/lightable.css","RJ-2025-015_files/popper-2.6.0/popper.min.js","RJ-2025-015_files/tippy-6.2.7/tippy-bundle.umd.min.js","RJ-2025-015_files/tippy-6.2.7/tippy-light-border.css","RJ-2025-015_files/tippy-6.2.7/tippy.css","RJ-2025-015_files/tippy-6.2.7/tippy.umd.min.js","RJ-2025-015_files/webcomponents-2.0.0/webcomponents.js","RJ-2025-015.log","RJ-2025-015.pdf","RJ-2025-015.tex","RJournal.sty","RJreferences.bib","RJwrapper.log","RJwrapper.tex"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
    font-size: 100%;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  hr.section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    margin: 0px;
  }


  d-byline {
    border-top: none;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
    border-top: none;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  /* tweak for Pandoc numbered line within distill */
  d-article pre.numberSource code > span {
      left: -2em;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // separator
    var separator = '<hr class="section-separator" style="clear: both"/>';
    // prepend separator above appendix
    $('.d-byline').before(separator);
    $('.d-article').before(separator);

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme, except when numbering line
    // in code chunk
    $('pre:not(.numberLines) code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        var author_name = front_matter.authors[i].author
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', author_name ? 'ORCID ID for ' + author_name : 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        const citeChild = $(this).children()[0]
        // Do not process if @xyz has been used without escaping and without bibliography activated
        // https://github.com/rstudio/distill/issues/466
        if (citeChild === undefined) return true

        if (citeChild.nodeName == "D-FOOTNOTE") {
          var fn = citeChild
          $(this).html(fn.shadowRoot.querySelector("sup"))
          $(this).id = fn.id
          fn.remove()
        }
        var refs = $(this).attr('data-cites').split(" ");
        var refHtml = refs.map(function(ref) {
          // Could use CSS.escape too here, we insure backward compatibility in navigator
          return "<p>" + $('div[id="ref-' + ref + '"]').html() + "</p>";
        }).join("\n");
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // fix footnotes in tables (#411)
      // replacing broken distill.pub feature
      $('table d-footnote').each(function() {
        // we replace internal showAtNode methode which is triggered when hovering a footnote
        this.hoverBox.showAtNode = function(node) {
          // ported from https://github.com/distillpub/template/pull/105/files
          calcOffset = function(elem) {
              let x = elem.offsetLeft;
              let y = elem.offsetTop;
              // Traverse upwards until an `absolute` element is found or `elem`
              // becomes null.
              while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                  x += elem.offsetLeft;
                  y += elem.offsetTop;
              }

              return { left: x, top: y };
          }
          // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
          const bbox = node.getBoundingClientRect();
          const offset = calcOffset(node);
          this.show([offset.left + bbox.width, offset.top + bbox.height]);
        }
      })

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      // ignore leaflet img layers (#106)
      figures = figures.filter(':not(img[class*="leaflet"])')
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="RJ-2025-015_files/header-attrs-2.29/header-attrs.js"></script>
  <script src="RJ-2025-015_files/kePrint-0.0.1/kePrint.js"></script>
  <link href="RJ-2025-015_files/lightable-0.0.1/lightable.css" rel="stylesheet" />
  <script src="RJ-2025-015_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="RJ-2025-015_files/popper-2.6.0/popper.min.js"></script>
  <link href="RJ-2025-015_files/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="RJ-2025-015_files/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="RJ-2025-015_files/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="RJ-2025-015_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="RJ-2025-015_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="RJ-2025-015_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="RJ-2025-015_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->
  <script>
    $(function() {
      console.log("Starting...")

      // Mathjax config (add automatic linebreaks when supported)
      // MathJax = {
      //    tex: {
      //        inlineMath: [['$', '$'], ['\\(', '\\)']],
      //        displayMath: [['$$', '$$'], ['\\[', '\\]']],
      //        tags: 'ams',
      //        multline: true,
      //    },
      //    options: {
      //        linebreaks: { automatic: true },
      //    },
      // };

      // Always show Published - distill hides it if not set
      function show_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'visible');
      }

      show_byline_column('Published')

      // tweak function
      var rmd_meta = JSON.parse($("#radix-rmarkdown-metadata").html());
      function get_meta(name, meta) {
        var ind = meta.attributes.names.value.findIndex((e) => e == name)
        var val = meta.value[ind]
        if (val.type != 'list') {
          return val.value.toString()
        }
        return val
      }

      // tweak description
      // Add clickable tags
      const slug = get_meta('slug', rmd_meta)
      const cite_url = get_meta('citation_url', rmd_meta)

      var title = $("d-title").text

      const buttons = $('<div class="dt-tags" style="grid-column: page;">')
      buttons.append('<a href="#citation" class="dt-tag"><i class="fas fa-quote-left"></i> Cite</a>')
      buttons.append('<a href="' + slug + '.pdf" class="dt-tag"><i class="fas fa-file-pdf"></i> PDF</a>')
      buttons.append('<a href="' + slug + '.zip" class="dt-tag"><i class="fas fa-file-zipper"></i> Supplement</a>')

      // adds Abstract: in front of the first <p> in the title section --
      // unless it happens to be the subtitle (FIXME: this is a bad hack - can't distill do this?)
      var tpar = $("d-title p:not(:empty)").filter(function() {
        return !$(this).hasClass("subtitle");
      }).first();
      if (tpar) {
        const abstract = $('<d-abstract>')
        abstract.append('<b>Abstract:</b><br>')
        abstract.append(tpar) // Move description to d-abstract
        $("d-title p:empty").remove() // Remove empty paragraphs after title
        abstract.append(buttons)
        abstract.insertAfter($('d-title')) // Add abstract section after title */
      }

      // tweak by-line
      var byline = $("d-byline div.byline")
      ind = rmd_meta.attributes.names.value.findIndex((e) => e == "journal")
      const journal = get_meta('journal', rmd_meta)
      const volume = get_meta('volume', rmd_meta)
      const issue = get_meta('issue', rmd_meta)
      const jrtitle = get_meta('title', journal)
      const year = ((jrtitle == "R News") ? 2000 : 2008) + parseInt(volume)
      const firstpage = get_meta('firstpage', journal)
      const lastpage = get_meta('lastpage', journal)
      byline.append('<div class="rjournal grid">')
      $('div.rjournal').append('<h3>Volume</h3>')
      $('div.rjournal').append('<h3>Pages</h3>')
      $('div.rjournal').append('<a class="volume" href="../../issues/'+year+'-'+issue+'">'+volume+'/'+issue+'</a>')
      $('div.rjournal').append('<p class="pages">'+firstpage+' - '+lastpage+'</p>')

      const received_date = new Date(get_meta('date_received', rmd_meta))
      byline.find('h3:contains("Published")').parent().append('<h3>Received</h3><p>'+received_date.toLocaleDateString('en-US', {month: 'short'})+' '+received_date.getDate()+', '+received_date.getFullYear()+'</p>')

    })
  </script>

  <style>
      /*
    .nav-dropdown-content .nav-dropdown-header {
      text-transform: lowercase;
    }
    */

    d-byline .byline {
      grid-template-columns: 2fr 2fr 2fr 2fr;
    }

    d-byline .rjournal {
      grid-column-end: span 2;
      grid-template-columns: 1fr 1fr;
      margin-bottom: 0;
    }

    d-title h1, d-title p, d-title figure,
    d-abstract p, d-abstract b {
      grid-column: page;
    }

    d-title .dt-tags {
      grid-column: page;
    }

    .dt-tags .dt-tag {
      text-transform: lowercase;
    }

    d-article h1 {
      line-height: 1.1em;
    }

    d-abstract p, d-article p {
      text-align: justify;
    }

    @media(min-width: 1000px) {
      .d-contents.d-contents-float {
        justify-self: end;
      }

      nav.toc {
        border-right: 1px solid rgba(0, 0, 0, 0.1);
        border-right-width: 1px;
        border-right-style: solid;
        border-right-color: rgba(0, 0, 0, 0.1);
      }
    }

    .posts-list .dt-tags .dt-tag {
      text-transform: lowercase;
    }

    @keyframes highlight-target {
      0% {
        background-color: #ffa;
      }
      66% {
        background-color: #ffa;
      }
      100% {
        background-color: none;
      }
    }

    d-article :target, d-appendix :target {
       animation: highlight-target 3s;
    }

    .header-section-number {
      margin-right: 0.5em;
    }
    
    d-appendix .citation-appendix,
    .d-appendix .citation-appendix {
      color: rgb(60, 60, 60);
    }

    d-article h2 {
      border-bottom: 0px solid rgba(0, 0, 0, 0.1);
      padding-bottom: 0rem;
    }
    d-article h3 {
      font-size: 20px;
    }
    d-article h4 {
      font-size: 18px;
      text-transform: none;
    }

    @media (min-width: 1024px) {
      d-article h2 {
        font-size: 32px;
      }
      d-article h3 {
        font-size: 24px;
      }
      d-article h4 {
        font-size: 20px;
      }
    }
  </style>


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Sfislands: An R Package for Accommodating Islands and Disjoint Zones in Areal Spatial Modelling","description":"Fitting areal models which use a spatial weights matrix to represent relationships between geographical units can be a cumbersome task, particularly when these units are not well-behaved. The two chief aims of sfislands are to simplify the process of creating an appropriate neighbourhood matrix, and to quickly visualise the predictions of subsequent models. The package uses visual aids in the form of easily-generated maps to help this process. This paper demonstrates how sfislands could be useful to researchers. It begins by describing the package's functions in the context of a proposed workflow. It then presents two worked examples showing a selection of potential use-cases. These range from earthquakes in Indonesia, to river crossings in London. We aim to show how the sfislands package streamlines much of the human workflow involved in creating and examining such models.","doi":"10.32614/RJ-2025-015","authors":[{"author":"Kevin Horan","authorURL":"https://github.com/horankev","affiliation":"Hamilton Institute, Maynooth University","affiliationURL":"#","orcidID":"0009-0003-9378-0084"},{"author":"Katarina Domijan","authorURL":"#","affiliation":"Department of Mathematics and Statistics, Maynooth University","affiliationURL":"#","orcidID":"0000-0002-4268-2236"},{"author":"Chris Brunsdon","authorURL":"#","affiliation":"National Centre for Geocomputation, Maynooth University","affiliationURL":"#","orcidID":"0000-0003-4254-1780"}],"publishedDate":"2025-09-24T00:00:00.000+10:00","citationText":"Horan, et al., 2025"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Sfislands: An R Package for Accommodating Islands and Disjoint Zones in Areal Spatial Modelling</h1>

<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p><p>Fitting areal models which use a spatial weights matrix to represent relationships between geographical units can be a cumbersome task, particularly when these units are not well-behaved. The two chief aims of sfislands are to simplify the process of creating an appropriate neighbourhood matrix, and to quickly visualise the predictions of subsequent models. The package uses visual aids in the form of easily-generated maps to help this process. This paper demonstrates how sfislands could be useful to researchers. It begins by describing the package’s functions in the context of a proposed workflow. It then presents two worked examples showing a selection of potential use-cases. These range from earthquakes in Indonesia, to river crossings in London. We aim to show how the sfislands package streamlines much of the human workflow involved in creating and examining such models.</p></p>
</div>

<div class="d-byline">
  Kevin Horan <a href="https://github.com/horankev" class="uri">https://github.com/horankev</a> (Hamilton Institute, Maynooth University)
  
,   Katarina Domijan  (Department of Mathematics and Statistics, Maynooth University)
  
,   Chris Brunsdon  (National Centre for Geocomputation, Maynooth University)
  
<br/>2025-09-24
</div>

<div class="d-article">
<div class="layout-chunk" data-layout="l-body">

</div>
<h2 data-number="1" id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>A key feature which differentiates spatial statistics is the
non-independence of observations and the expectation that neighbouring
units will be more similar than non-neighbouring ones <span class="citation" data-cites="tobler">(<a href="#ref-tobler" role="doc-biblioref">Tobler 1970</a>)</span>. If this
is not accounted for, the assumptions of many types of models will be
violated. The relationships between all spatial units in a study can be
represented numerically in a spatial weights matrix. In order to build
this, we must first decide on what constitutes being a neighbour. We might
see this as a continuous relationship where degree of neighbourliness is
a function of connectivity, which could be represented as some measure
of distance. Alternatively it could be a binary situation where each
pair of units either are (1) or are not (0) neighbours. This can be
based on a condition such as contiguity of some sort, or a distance
constraint. It is the job of the modeller to formulate a hypothesis
which justifies their choice of neighbourhood structure.</p>
<p>For R users, the <a href="https://cran.r-project.org/package=spdep">spdep</a> package <span class="citation" data-cites="spdep">(<a href="#ref-spdep" role="doc-biblioref">Bivand 2022</a>)</span> has long been popular for the
creation of these matrices. More recently, in reference to the increasing use of <a href="https://cran.r-project.org/package=sf">sf</a> structures <span class="citation" data-cites="sf">(<a href="#ref-sf" role="doc-biblioref">Pebesma 2018</a>)</span>, the <a href="https://cran.r-project.org/package=sfdep">sfdep</a> package <span class="citation" data-cites="sfdep">(<a href="#ref-sfdep" role="doc-biblioref">Parry and Locke 2024</a>)</span> has presented generally similar functionality by wrapping <a href="https://cran.r-project.org/package=spdep">spdep</a> functions with functions that follow the <a href="https://cran.r-project.org/package=sf">sf</a> naming convention (function names starting with <code>st_</code>), as well as a “use a data.frame for everything” attitude.</p>
<p>The most appropriate form of neighbourhood structure will depend on the specific context. <span class="citation" data-cites="BrizRedn2021">Briz-Redón et al. (<a href="#ref-BrizRedn2021" role="doc-biblioref">2021</a>)</span> compared different structures in the context of COVID-19 data. They note that <span class="citation" data-cites="Earnest2007">Earnest et al. (<a href="#ref-Earnest2007" role="doc-biblioref">2007</a>)</span> found that distance-based matrices were more appropriate when examining birth defects in Australia, whereas <span class="citation" data-cites="Duncan2017">Duncan et al. (<a href="#ref-Duncan2017" role="doc-biblioref">2017</a>)</span> found that a first-order contiguity structure produced a better fit than others in the context of lip cancer incidence in Scotland.</p>
<p>The most commonly used neighbourhood structure is one based on first-order queen contiguity, where units are considered neighbours if they
share at least a vertex or boundary. However, as the name suggests, this
will lead to problems when non-contiguous units such as islands or
exclaves are present. Less obviously, depending on how the geographic
units are described, areas on either side of rivers may be
inappropriately classified as neighbours or not neighbours. Furthermore,
the presence of infrastructure such as tunnels, bridges or ferry
services might be satisfactory to meet our hypothesis of the required
degree of connectivity to be considered neighbours. Again, such information may not be apparent from a basic set of polygons. In order to create what a researcher considers to be an appropriate neighbourhood structure, incorporating all of the domain knowledge that they might have about the system, it should be simple and intuitive to add and remove connections between spatial units. This might mean adding links to account for man-made infrastructure, or cutting links to incorporate natural barriers such as rivers or mountains.</p>
<p>The aim of <a href="https://cran.r-project.org/package=sfislands">sfislands</a> <span class="citation" data-cites="sfislands">(<a href="#ref-sfislands" role="doc-biblioref">Horan et al. 2024</a>)</span> is to deal with the situations described above in a
convenient and open manner. It allows us to set up a structure, quickly
map it, and then examine whether or not we are happy with how it represents our hypothesis of relationships between units. The structure can then be edited and the process re-iterated until we have described a
spatial relationship structure with which we are satisfied.</p>
<p>It should be noted that while this package offers convenient tools for the examination, visualisation, addition and removal of neighbourhood linkages between units, such an approach to dealing with disconnected units is not always appropriate and other methodologies are available. These issues are discussed in more depth by <span class="citation" data-cites="bivandportnov">Bivand and Portnov (<a href="#ref-bivandportnov" role="doc-biblioref">2004</a>)</span> and <span class="citation" data-cites="freni">Freni-Sterrantino et al. (<a href="#ref-freni" role="doc-biblioref">2018</a>)</span>.</p>
<p>The above can be considered as the <em>pre-functions</em> of the package. A
second category of features, which we refer to as <em>post-functions</em>,
are for use after the creation of a model. Having fit a model with <a href="https://cran.r-project.org/package=mgcv">mgcv</a> <span class="citation" data-cites="mgcv">(<a href="#ref-mgcv" role="doc-biblioref">Wood 2011</a>)</span> in particular, the process of extracting estimates for certain types of effects can be somewhat awkward. These <em>post-functions</em> augment the original dataframe with these estimates and their standard errors in tidy format. They also allow for quick visualisation of the output in map form.</p>
<h3 data-number="1.1" id="typical-use-cases"><span class="header-section-number">1.1</span> Typical use-cases</h3>
<p>In this paper, we will look at two examples to show different use-cases for
<a href="https://cran.r-project.org/package=sfislands">sfislands</a>. The first example focuses on earthquakes in
Indonesia. It shows a scenario where all of the functions are used, from
setting up contiguities, to modelling and examining the predictions of the
model. The second example looks at London and how, despite an absence of islands,
the presence of a river means that some of the pre-functions of
<a href="https://cran.r-project.org/package=sfislands">sfislands</a> can be useful.</p>
<h2 data-number="2" id="why-use"><span class="header-section-number">2</span> Why use <a href="https://cran.r-project.org/package=sfislands">sfislands</a>?</h2>
<p>Below, we outline some of the benefits of the package in the context of a proposed workflow for fitting areal spatial models.</p>
<h4 class="unnumbered" data-number="2.0.1" id="step-1-pre-functions-for-setting-up-neighbourhood-structure">Step 1: <em>Pre-functions</em> for setting up neighbourhood structure</h4>
<ol type="1">
<li><p>It addresses an issue commonly seen in online help forums where an inexperienced user wishes to get started with a model but fails at the first hurdle because their neighbourhood structure contains empty records. <a href="https://cran.r-project.org/package=sfislands">sfislands</a> will include a contiguity for all units.</p></li>
<li><p>It gives tools to immediately visualise this structure as a map.</p></li>
<li><p>These maps are created using <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> <span class="citation" data-cites="ggplot2">(<a href="#ref-ggplot2" role="doc-biblioref">Wickham 2016</a>)</span>, which allows users to apply additional styling and themes using <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> syntax.</p></li>
<li><p>As the nodes can be labelled by index, it makes it very easy to add and remove connections as appropriate with confidence and without reference to the names of these areas.</p></li>
<li><p>Connections which have been induced by a function from the package but which are not based on geographical contiguity can be accessed to ensure openness in the process.</p></li>
</ol>
<h4 class="unnumbered" data-number="2.0.2" id="step-2-modelling">Step 2: Modelling</h4>
<p>These neighbourhood structures can be used in modelling packages such as <a href="https://cran.r-project.org/package=mgcv">mgcv</a>, <a href="https://cran.r-project.org/package=brms">brms</a> <span class="citation" data-cites="brms">(<a href="#ref-brms" role="doc-biblioref">Bürkner 2017</a>)</span>, <a href="#">r-inla</a> <span class="citation" data-cites="r-inla">(<a href="#ref-r-inla" role="doc-biblioref">Bakka et al. 2018</a>)</span> and more.</p>
<h4 class="unnumbered" data-number="2.0.3" id="step-3-post-functions-for-models">Step 3: <em>Post-functions</em> for models</h4>
<ol type="1">
<li><p>It simplifies the process of extracting estimates from models, such as those with random effects and Markov random field structures created using <a href="https://cran.r-project.org/package=mgcv">mgcv</a>. Compatibility with more packages can be added at a future date.</p></li>
<li><p>These effects can be quickly visualised as <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> maps.</p></li>
</ol>
<h2 data-number="3" id="pre-functions"><span class="header-section-number">3</span> Pre-functions</h2>
<p>The first group of functions, shown in Table <a href="#tab:prefunc-html">1</a>, deals with the creation
of a neighbourhood structure in the presence of discontiguities. The
resultant structure can be quickly mapped to check if it is
satisfactory. Connections can be forcibly added or removed by name or
index number. By an iterative process of changes and examination of a
quickly-generated guide map, a satisfactory structure can be decided upon.</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="center">
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:prefunc-html">Table 1: </span>Pre-functions: setting up a neighbourhood structure.
</caption>
<thead>
<tr>
<th style="text-align:left;">
function
</th>
<th style="text-align:left;">
purpose
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
st_bridges()
</td>
<td style="text-align:left;">
create a neighbourhood contiguity structure, with a k-nearest neighbours condition for islands
</td>
</tr>
<tr>
<td style="text-align:left;">
st_quickmap_nb()
</td>
<td style="text-align:left;">
check structure visually on map
</td>
</tr>
<tr>
<td style="text-align:left;">
st_check_islands()
</td>
<td style="text-align:left;">
check the contiguities which have been assigned to islands
</td>
</tr>
<tr>
<td style="text-align:left;">
st_force_join_nb()
</td>
<td style="text-align:left;">
enforce changes by adding connections
</td>
</tr>
<tr>
<td style="text-align:left;">
st_force_cut_nb()
</td>
<td style="text-align:left;">
enforce changes by removing connections
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>We will now go through each function in more detail using the set of rectangles shown in Figure <a href="#fig:rects1">1</a> for demonstration purposes. Rectangles 1, 2 and 3 are contiguous while 4 and 5 can be viewed as “islands”.</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:rects1"></span>
<img src="RJ-2025-015_files/figure-html5/rects1-1.png" alt="Simplified scenario with five rectangles. " width="384" />
<p class="caption">
Figure 1: Simplified scenario with five rectangles.
</p>
</div>
</div>
<h3 data-number="3.1" id="st_bridges"><span class="header-section-number">3.1</span> st_bridges()</h3>
<p>This function requires at least two arguments: an <a href="https://cran.r-project.org/package=sf">sf</a> dataframe and, from that, the name of one column of unique row identifiers, ideally names, of each spatial unit. It creates a neighbourhood structure where non-island units are joined by first-order queen contiguity, while island units are joined to their k-nearest neighbours. The output is a <em>named</em> neighbourhood structure in either list or matrix form as desired, which can be either a standalone object or included as an additional column in the original <a href="https://cran.r-project.org/package=sf">sf</a> dataframe. While we have chosen to append the neighbourhood structure to the original data frame in this way by default, the user should be warned that any subsequent row sub-setting (filter) operation on this object will invalidate the list column involved. While it is not necessary in all modelling packages for the neighbourhood list or matrix to be <em>named</em>, it is good practice to do so and is mandatory when using, for example, <a href="https://cran.r-project.org/package=mgcv">mgcv</a>.</p>
<p>One solution when confronted with islands in a dataset is to simply exclude them from the analysis. In the first two examples of using <code>st_bridges()</code>, we have chosen to ignore islands with the argument <code>remove_islands = TRUE</code> and to return a list and matrix structure respectively by specifying this in the <code>nb_structure</code> argument and choosing <code>add_to_dataframe = FALSE</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># output a named list</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>rectangles</span>,</span>
<span>           <span class='st'>"name"</span>,</span>
<span>           remove_islands <span class='op'>=</span> <span class='cn'>TRUE</span>,</span>
<span>           nb_structure <span class='op'>=</span> <span class='st'>"list"</span>,</span>
<span>           add_to_dataframe <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>$Rect1
[1] 2 3

$Rect2
[1] 1 3

$Rect3
[1] 1 2</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># output a named matrix</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>rectangles</span>,</span>
<span>           <span class='st'>"name"</span>,</span>
<span>           remove_islands <span class='op'>=</span> <span class='cn'>TRUE</span>,</span>
<span>           nb_structure <span class='op'>=</span> <span class='st'>"matrix"</span>,</span>
<span>           add_to_dataframe <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>      [,1] [,2] [,3]
Rect1    0    1    1
Rect2    1    0    1
Rect3    1    1    0</code></pre>
</div>
<p>Alternatively, in the following examples, we choose to join islands to their 1 nearest
neighbour, which is the default setting, and to return the output as a column called “nb” in the original
<a href="https://cran.r-project.org/package=sf">sf</a> dataframe (<code>add_to_dataframe = "TRUE"</code> is the default setting):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># output a named list as a column "nb" in original dataframe</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>rectangles</span>,</span>
<span>           <span class='st'>"name"</span>,</span>
<span>           link_islands_k <span class='op'>=</span> <span class='fl'>1</span>,</span>
<span>           nb_structure <span class='op'>=</span> <span class='st'>"list"</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>Simple feature collection with 5 features and 2 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 0 ymin: 0 xmax: 6 ymax: 4
CRS:           NA
   name      nb                       geometry
1 Rect1    2, 3 POLYGON ((0 0, 0 2, 2 2, 2 ...
2 Rect2 1, 3, 4 POLYGON ((2 0, 2 2, 4 2, 4 ...
3 Rect3 1, 2, 5 POLYGON ((2 2, 2 4, 4 4, 4 ...
4 Rect4       2 POLYGON ((5 0, 5 1, 6 1, 6 ...
5 Rect5       3 POLYGON ((0.8 3, 0.8 4, 1.8...</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># output a named matrix as a column "nb" in original dataframe</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>rectangles</span>,</span>
<span>           <span class='st'>"name"</span>,</span>
<span>           link_islands_k <span class='op'>=</span> <span class='fl'>1</span>,</span>
<span>           nb_structure <span class='op'>=</span> <span class='st'>"matrix"</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>Simple feature collection with 5 features and 2 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 0 ymin: 0 xmax: 6 ymax: 4
CRS:           NA
   name nb.1 nb.2 nb.3 nb.4 nb.5                       geometry
1 Rect1    0    1    1    0    0 POLYGON ((0 0, 0 2, 2 2, 2 ...
2 Rect2    1    0    1    1    0 POLYGON ((2 0, 2 2, 4 2, 4 ...
3 Rect3    1    1    0    0    1 POLYGON ((2 2, 2 4, 4 4, 4 ...
4 Rect4    0    1    0    0    0 POLYGON ((5 0, 5 1, 6 1, 6 ...
5 Rect5    0    0    1    0    0 POLYGON ((0.8 3, 0.8 4, 1.8...</code></pre>
</div>
<p>These structures can serve as the input to models in <a href="https://cran.r-project.org/package=brms">brms</a>,
<a href="#">r-inla</a>, <a href="https://cran.r-project.org/package=rstan">rstan</a> <span class="citation" data-cites="rstan">(<a href="#ref-rstan" role="doc-biblioref">Stan Development Team 2020</a>)</span> or <a href="https://cran.r-project.org/package=mgcv">mgcv</a>. <a href="https://cran.r-project.org/package=brms">brms</a> requires a matrix structure while <a href="https://cran.r-project.org/package=mgcv">mgcv</a> models use a list. Rather than having a separate neighbours
object, it is included in the original <a href="https://cran.r-project.org/package=sf">sf</a> dataframe as a named list or matrix, in the spirit of the <a href="https://cran.r-project.org/package=sfdep">sfdep</a> package.</p>
<h3 data-number="3.2" id="st_quickmap_nb"><span class="header-section-number">3.2</span> st_quickmap_nb()</h3>
<p>It is much more intuitive to examine these structures visually than in
matrix or list format. This can be done with the <code>st_quickmap_nb()</code>
function as shown in Figure <a href="#fig:rects2">2</a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># default is 'nodes = "point"'</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>rectangles</span>,</span>
<span>           <span class='st'>"name"</span>,</span>
<span>           link_islands_k <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:rects2"></span>
<img src="RJ-2025-015_files/figure-html5/rects2-1.png" alt="Queen contiguity and islands connected to nearest neighbour. " width="192" />
<p class="caption">
Figure 2: Queen contiguity and islands connected to nearest neighbour.
</p>
</div>
</div>
<p>If we wish to make edits, it might be more useful to represent the nodes
numerically rather than as points (Figure <a href="#fig:rects3">3</a>).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># with 'nodes = "numeric"'</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>rectangles</span>,</span>
<span>           <span class='st'>"name"</span>,</span>
<span>           link_islands_k <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span>nodes <span class='op'>=</span> <span class='st'>"numeric"</span><span class='op'>)</span></span></code></pre>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:rects3"></span>
<img src="RJ-2025-015_files/figure-html5/rects3-1.png" alt="Queen contiguity and islands connected to nearest neighbour. Nodes are shown as numeric indices. " width="192" />
<p class="caption">
Figure 3: Queen contiguity and islands connected to nearest neighbour. Nodes are shown as numeric indices.
</p>
</div>
</div>
<h3 data-number="3.3" id="st_check_islands"><span class="header-section-number">3.3</span> st_check_islands()</h3>
<p>This function will show us transparently what connections have been made which
are not based on contiguity. It gives both the name and index number of each pair of added connections. In this example, two pairs have been added.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># show summary of non-contiguous connections in a dataframe</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>rectangles</span>,</span>
<span>           <span class='st'>"name"</span>,</span>
<span>           link_islands_k <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_check_islands.html'>st_check_islands</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  island_names island_num nb_num nb_names
1        Rect4          4      2    Rect2
2        Rect5          5      3    Rect3</code></pre>
</div>
<h3 data-number="3.4" id="st_force_join_nb"><span class="header-section-number">3.4</span> st_force_join_nb()</h3>
<p>If we feel that 4 should also be connected to 3, this can be done
by forcing a join (Figure <a href="#fig:rects4">4</a>).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># add an extra connection using numeric index</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>rectangles</span>, <span class='st'>"name"</span>,</span>
<span>           link_islands_k <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_force_join_nb.html'>st_force_join_nb</a></span><span class='op'>(</span><span class='fl'>3</span>,<span class='fl'>4</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span>nodes <span class='op'>=</span> <span class='st'>"numeric"</span><span class='op'>)</span></span></code></pre>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:rects4"></span>
<img src="RJ-2025-015_files/figure-html5/rects4-1.png" alt="With an additional connection between 3 and 4. " width="192" />
<p class="caption">
Figure 4: With an additional connection between 3 and 4.
</p>
</div>
</div>
<h3 data-number="3.5" id="st_force_cut_nb"><span class="header-section-number">3.5</span> st_force_cut_nb()</h3>
<p>And perhaps there is a wide river between rectangles 1 and 2 which
justifies removing the connection. We will edit it this time using
names (Figure <a href="#fig:rects5">5</a>).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># remove an existing connection using unit name, not index</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>rectangles</span>, <span class='st'>"name"</span>,</span>
<span>           link_islands_k <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_force_join_nb.html'>st_force_join_nb</a></span><span class='op'>(</span><span class='fl'>3</span>,<span class='fl'>4</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_force_cut_nb.html'>st_force_cut_nb</a></span><span class='op'>(</span><span class='st'>"Rect1"</span>,<span class='st'>"Rect2"</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span>nodes <span class='op'>=</span> <span class='st'>"numeric"</span><span class='op'>)</span></span></code></pre>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:rects5"></span>
<img src="RJ-2025-015_files/figure-html5/rects5-1.png" alt="With the removal of connection between 1 and 2. " width="192" />
<p class="caption">
Figure 5: With the removal of connection between 1 and 2.
</p>
</div>
</div>
<p>Having decided upon an appropriate neighbourhood structure, the next step is to use this in the context of a model. The use of such structures is particularly associated with CAR (conditional autoregressive) or ICAR-type (intrinsic conditional autoregressive) models <span class="citation" data-cites="besag">(<a href="#ref-besag" role="doc-biblioref">Besag 1974</a>)</span>.
These are often implemented in a Bayesian framework using
<a href="https://cran.r-project.org/package=brms">brms</a>, <a href="#">r-inla</a> or <a href="https://cran.r-project.org/package=rstan">rstan</a>. For example, the <a href="https://cran.r-project.org/package=brms">brms</a> ICAR structure requires the neighbourhood relationships to be in matrix form. The pre-functions will output the
neighbourhood structure in the desired format for use in any of these
frameworks. A convenient frequentist alternative is to use the
<a href="https://cran.r-project.org/package=mgcv">mgcv</a> package which requires a named list of neighbours. It has the functionality to create such models
using <code>bs="mrf"</code>. It also has the ability to combine these with a
hierarchical structure using <code>bs="re"</code>. While the outputs from the
Bayesian structures mentioned above can be extracted in the same way as
any other component of the model, it can be somewhat awkward to get the
estimates from <a href="https://cran.r-project.org/package=mgcv">mgcv</a> models. <a href="https://cran.r-project.org/package=sfislands">sfislands</a> has two post-functions to conveniently extract and visualise these.</p>
<h2 data-number="4" id="post-functions"><span class="header-section-number">4</span> Post-functions</h2>
<p>Table <a href="#tab:postfunc-html">2</a> shows the second set of functions in the package and their purpose.</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="center">
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:postfunc-html">Table 2: </span>Post-functions: tidy estimates from <code>mgcv</code>.
</caption>
<thead>
<tr>
<th style="text-align:left;">
function
</th>
<th style="text-align:left;">
purpose
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
st_augment()
</td>
<td style="text-align:left;">
augment the original dataframe with model predictions
</td>
</tr>
<tr>
<td style="text-align:left;">
st_quickmap_preds()
</td>
<td style="text-align:left;">
generate quick maps of these predictions
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<h3 data-number="4.1" id="st_augment"><span class="header-section-number">4.1</span> st_augment()</h3>
<p>This function augments the original dataframe with the estimated means
and standard errors of the spatially varying predictions from a fitted <a href="https://cran.r-project.org/package=mgcv">mgcv</a> model in a similar manner to
how the <a href="https://cran.r-project.org/package=broom">broom</a> package <span class="citation" data-cites="broom">(<a href="#ref-broom" role="doc-biblioref">Robinson et al. 2023</a>)</span> operates. The <code>geometry</code> column, as per convention, remains as the last column of the augmented dataframe, while the predictions are positioned immediately before it. <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> The spatially varying predictions which <code>st_augment()</code> extracts from an <a href="https://cran.r-project.org/package=mgcv">mgcv</a> model are</p>
<ul>
<li>random effects (which are called in <a href="https://cran.r-project.org/package=mgcv">mgcv</a> with <code>bs='re'</code>), and</li>
<li>ICAR components (<code>bs='mrf'</code>).</li>
</ul>
<p>Consider the model structure described in the code below using <a href="https://cran.r-project.org/package=mgcv">mgcv</a> syntax. In this model <span class="math inline">\(y\)</span> is the dependent variable which is being estimated with a fixed intercept, a fixed slope for some covariate, a set of random intercepts and slopes for the covariate at a <em>region</em> level, and a set of ICAR varying intercepts and slopes at a lower <em>sub-region</em> level.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># creating an mgcv model</span></span>
<span></span>
<span><span class='fu'>mgcv</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/gam.html'>gam</a></span><span class='op'>(</span></span>
<span>  <span class='va'>y</span> <span class='op'>~</span> <span class='va'>covariate</span> <span class='op'>+</span>                   <span class='co'># fixed intercept and effect for covariate</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>region</span>, bs <span class='op'>=</span> <span class='st'>"re"</span><span class='op'>)</span> <span class='op'>+</span>                  <span class='co'># random intercept at level region</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>region</span>, <span class='va'>covariate</span>, bs <span class='op'>=</span> <span class='st'>"re"</span><span class='op'>)</span> <span class='op'>+</span>          <span class='co'># random slopes at level region</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>sub</span><span class='op'>-</span><span class='va'>region</span>,</span>
<span>      bs <span class='op'>=</span> <span class='st'>'mrf'</span>,</span>
<span>      xt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>nb <span class='op'>=</span> <span class='va'>data</span><span class='op'>$</span><span class='va'>nb</span><span class='op'>)</span>,</span>
<span>      k <span class='op'>=</span> <span class='va'>k</span><span class='op'>)</span> <span class='op'>+</span>                    <span class='co'># ICAR varying intercept at level sub-region</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>sub</span><span class='op'>-</span><span class='va'>region</span>, by <span class='op'>=</span> <span class='va'>covariate</span>,</span>
<span>      bs <span class='op'>=</span> <span class='st'>'mrf'</span>,</span>
<span>      xt <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>nb <span class='op'>=</span> <span class='va'>data</span><span class='op'>$</span><span class='va'>nb</span><span class='op'>)</span>,</span>
<span>      k <span class='op'>=</span> <span class='va'>k</span><span class='op'>)</span>,           <span class='co'># ICAR varying slope for covariate at level sub-region</span></span>
<span>  data <span class='op'>=</span> <span class='va'>data</span>,</span>
<span>  method <span class='op'>=</span> <span class='st'>"REML"</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>When labelling the new prediction columns which are augmented to the original dataframe from such a model, <code>st_augment()</code> follows the formula syntax of the <a href="https://cran.r-project.org/package=lme4">lme4</a> package <span class="citation" data-cites="lme4">(<a href="#ref-lme4" role="doc-biblioref">Bates et al. 2015</a>)</span>, where the pipe symbol (<code>|</code>) indicates “<em>grouped by</em>”. Table <a href="#tab:staugtab-html">3</a> shows how the augmented columns in this scenario would be named. Each column name begins with either <code>random.effect.</code> or <code>mrf.smooth.</code> as appropriate. An additional column is also added for the standard error of each prediction, as calculated by <a href="https://cran.r-project.org/package=mgcv">mgcv</a>. These columns are named as above but with <code>se.</code> prepended (e.g. <code>se.random.effect.region</code>).</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="center">
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:staugtab-html">Table 3: </span>The naming procedure for augmented columns from different <code>mgcv</code> structures.
</caption>
<thead>
<tr>
<th style="text-align:left;">
mgcv syntax
</th>
<th style="text-align:left;">
column name
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
s(region, bs = ‘re’)
</td>
<td style="text-align:left;">
random.effect.region
</td>
</tr>
<tr>
<td style="text-align:left;">
s(region, covariate, bs = ‘re’)
</td>
<td style="text-align:left;">
random.effect.covariate|region
</td>
</tr>
<tr>
<td style="text-align:left;">
s(sub-region, bs = ‘mrf’, xt = list(nb = data$nb))
</td>
<td style="text-align:left;">
mrf.smooth.sub-region
</td>
</tr>
<tr>
<td style="text-align:left;">
s(sub-region, by = covariate, bs = ‘mrf’, xt = list(nb = data$nb))
</td>
<td style="text-align:left;">
mrf.smooth.covariate|sub-region
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<h3 data-number="4.2" id="st_quickmap_preds"><span class="header-section-number">4.2</span> st_quickmap_preds()</h3>
<p>These estimates can then be quickly mapped. As it is possible to include more than 1 spatially varying component, the output of this function is a list of plots. They can be viewed individually by indexing, or all at once using, for example, the <code>plotlist</code> argument from the <code>ggarrange()</code> function which is part of the <a href="https://cran.r-project.org/package=ggpubr">ggpubr</a> <span class="citation" data-cites="ggpubr">(<a href="#ref-ggpubr" role="doc-biblioref">Kassambara 2023</a>)</span> package. We will see this function in practice in the following example. The maps which it generates are automatically titled and subtitled according to the type of effect. For example, the map showing predictions for <code>random.effect.region</code> will have “<em>region</em>” as its title and “<em>random.effect</em>” as its subtitle.</p>
<h2 data-number="5" id="indonesia-example-1"><span class="header-section-number">5</span> Indonesia (example 1)</h2>
<p>Modelling earthquakes in Indonesia serves as a good example to
demonstrate this package. Firstly, Indonesia is composed of many
islands. Secondly, earthquake activity is known to be associated with
the presence of faults which exist below sea level and thus do not
respect land boundaries. Therefore it is reasonable to expect similar
behaviour in nearby provinces regardless of whether or not they are
contiguous. We aim to model the incidence, or count per unit area, of earthquake activity by
province across Indonesia, controlling for proximity to faults.</p>
<h3 data-number="5.1" id="data"><span class="header-section-number">5.1</span> Data</h3>
<p>The data for this section have been downloaded from the National Earthquake Information Center, <a href="https://earthquake.usgs.gov/earthquakes/search/">USGS earthquake
catalogue</a>. The
datasets with accompanying explanations are available at
<a href="https://github.com/horankev/quake_data" class="uri">https://github.com/horankev/quake_data</a>. They capture all recorded earthquakes in
and close to Indonesia from the beginning of January 1985 to the end of December 2023. Figure <a href="#fig:fault-buffers">6</a> shows a map of Indonesia, divided into 33 provinces, with other neighbouring or bordering countries filled in grey. The many local
faults which lie within 300km of the shore are shown in yellow with green outlines.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:fault-buffers"></span>
<img src="RJ-2025-015_files/figure-html5/fault-buffers-1.png" alt="Indonesia faults. Surrounded by a 10 kilometre buffer. " width="100%" />
<p class="caption">
Figure 6: Indonesia faults. Surrounded by a 10 kilometre buffer.
</p>
</div>
</div>
<p>To get an interpretable measure of the concentration of faults in any area,
these faults are transformed from linestrings to polygons by setting a buffer of
10km around them, which explains their green outline. Now both our faults and the sizes of provinces are in units of kilometres
squared. This means we can generate a unitless metric of what proportion of any administrative unit
is covered by these buffered faults. This measure across provinces is shown in Figure
<a href="#fig:fault-conc">7</a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:fault-conc"></span>
<img src="RJ-2025-015_files/figure-html5/fault-conc-1.png" alt="Indonesia fault concentration. Square kilometre of buffered fault per square kilometre of province area. " width="100%" />
<p class="caption">
Figure 7: Indonesia fault concentration. Square kilometre of buffered fault per square kilometre of province area.
</p>
</div>
</div>
<p>Earthquake incidence per province has been calculated as the total number of earthquakes with
an epicentre within that province per unit area. We have
restricted counts to earthquakes &gt;5.5 on the moment magnitude scale, which is the point
at which they are often labelled as potentially damaging.</p>
<p>The occurrences of these earthquakes are shown in Figure <a href="#fig:quake-occur">8</a>, their total per province in Figure <a href="#fig:quake-totals">9</a>, and finally, their incidence or count per square kilometre can be seen in Figure <a href="#fig:quake-conc">10</a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:quake-occur"></span>
<img src="RJ-2025-015_files/figure-html5/quake-occur-1.png" alt="Earthquakes in Indonesia of magnitude &gt; 5.5, 1985-2023. Categorised by magnitude as medium, large or extra-large. " width="100%" />
<p class="caption">
Figure 8: Earthquakes in Indonesia of magnitude &gt; 5.5, 1985-2023. Categorised by magnitude as medium, large or extra-large.
</p>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:quake-totals"></span>
<img src="RJ-2025-015_files/figure-html5/quake-totals-1.png" alt="Earthquake count in Indonesia, 1985-2023, mag &gt; 5.5: count by province. " width="100%" />
<p class="caption">
Figure 9: Earthquake count in Indonesia, 1985-2023, mag &gt; 5.5: count by province.
</p>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:quake-conc"></span>
<img src="RJ-2025-015_files/figure-html5/quake-conc-1.png" alt="Earthquake incidence in Indonesia, 1985-2023, mag &gt; 5.5: count per square kilometre by province. " width="100%" />
<p class="caption">
Figure 10: Earthquake incidence in Indonesia, 1985-2023, mag &gt; 5.5: count per square kilometre by province.
</p>
</div>
</div>
<h3 data-number="5.2" id="model"><span class="header-section-number">5.2</span> Model</h3>
<p>As this is count data, we will model it as a Poisson distribution with
<span class="math inline">\(\lambda\)</span> as the mean count per province. For <span class="math inline">\(i = 1,...,n\)</span> provinces,
the dependent variable in this model is
<span class="math display" id="eq:eq1">\[\begin{equation}
y_i = \text{earthquake count}_i
\tag{1}
\end{equation}\]</span>
while the explanatory variable is
<span class="math display" id="eq:eq2">\[\begin{equation}
x_i = \text{fault concentration}_i = \frac{\text{area of buffered faults in province}_i} {\text{province area}_i}.
\tag{2}
\end{equation}\]</span>
Firstly, when excluding the incidence and just modelling counts, where
<span class="math inline">\(y_i = \text{earthquake count in province}_i\)</span>, the Poisson model is of
the following form:
<span class="math display" id="eq:eq3">\[\begin{equation}
y_i | \lambda_i \sim \text{Pois}(\lambda_i)
\tag{3}
\end{equation}\]</span>
with
<span class="math display" id="eq:eq4">\[\begin{equation}
E(y_i | \lambda_i) = \lambda_i.
\tag{4}
\end{equation}\]</span>
We model
<span class="math display" id="eq:eq5">\[\begin{equation}
log(\lambda_i) = \beta_0 + \beta_1x_i + \gamma_i.
\tag{5}
\end{equation}\]</span>
where <span class="math inline">\(\gamma_i\)</span>
is a term with a correlation structure reflecting a province’s location
relative to other provinces.</p>
<p>We can describe these relationships by setting up a neighbourhood
structure based on queen contiguity where a pair of provinces are
considered neighbours if they share at least one point of boundary. This can be modelled as a Markov random field to generate an ICAR model with a spatially varying term. Each of these terms will be correlated with the others according to the neighbourhood structure we have defined.</p>
<p>The Markov random field here follows a multivariate Gaussian
distribution. <span class="math inline">\(\gamma_i\)</span> is a vector of province effects having a
distribution with mean <strong>0</strong> and precision <strong>P</strong> where</p>
<p><span class="math inline">\([\textbf{p}]_{ij} = v_i\)</span> if <span class="math inline">\(i=j\)</span> and <span class="math inline">\(v_i\)</span> is the number of adjacent provinces
to province <span class="math inline">\(i\)</span>,</p>
<p><span class="math inline">\([\textbf{p}]_{ij} = -1\)</span> if provinces <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are adjacent, and</p>
<p><span class="math inline">\([\textbf{p}]_{ij} = 0\)</span> otherwise.</p>
<p>A further constraint that <span class="math inline">\(\Sigma_j \gamma_j = 0\)</span> is applied so that the
distribution is identifiable.</p>
<p>We now include an offset term (here, area) because we are more interested
in modelling the incidence than in the actual count, such that
<span class="math display" id="eq:eq6">\[\begin{equation}
log(\frac{\lambda_i} {\text{area}_i}) = \beta_0 + \beta_1x_i + \gamma_i
\tag{6}
\end{equation}\]</span>
which is equivalent to
<span class="math display" id="eq:eq7">\[\begin{equation}
log(\lambda_i) = \beta_0 + \beta_1x_i + \gamma_i + log(\text{area}_i).
\tag{7}
\end{equation}\]</span>
We are still modelling <span class="math inline">\(log(\lambda)\)</span> rather than the incidence, but we
are adding an offset to adjust for differing areas. Modelling <span class="math inline">\(log(\lambda)\)</span> and adding an offset is equivalent to
modelling incidence, and coefficients can be interpreted that way.</p>
<p>When interpreting the estimated coefficients of the model, it can be
useful to look at it in the following form:
<span class="math display" id="eq:eq8">\[\begin{equation}
\lambda_i = e^{\beta_0 + \beta_1 x_i + \gamma_i} \text{area}_i.
\tag{8}
\end{equation}\]</span></p>
<p>Having described the type of model we wish to implement, we now show how <a href="https://cran.r-project.org/package=sfislands">sfislands</a> can be used to streamline the process.</p>
<h3 data-number="5.3" id="pre-functions-1"><span class="header-section-number">5.3</span> Pre-functions</h3>
<p>Such models, however, cannot incorporate locations which have no
neighbours. In the case of Indonesia, this is quite problematic. It is
composed of many islands. The estimated count of
islands according to <span class="citation" data-cites="Andrfout2022">Andréfouët et al. (<a href="#ref-Andrfout2022" role="doc-biblioref">2022</a>)</span> is 13,558.
While it is not unusual for a country to have a number of often small
offshore islands, Indonesia is entirely composed of (at least portions
of) an archipelago of islands, so many of these islands or groups of
islands are individual provinces in their own right. We might like to hypothesise that just because a province is a disconnected island, this should not mean that it is independent of other nearby provinces in terms of earthquake incidence. A standard first-order queen contiguity structure would mean the exclusion of disconnected units entirely from the model. An alternative strategy of assigning neighbour status based on a distance metric would overcome this, but the threshold size of distance necessary for such a structure might be inappropriately large for the non-islands provinces. Many extra unwanted contiguities could be added when only those related to disconnected units were desired. We would like to use a compromise between these two strategies.</p>
<p>In this case, we use <code>st_bridges()</code> for setting up the queen contiguity
structure as usual, but with the additional stipulation that unconnected
units (provinces which are islands or collections of islands) are
considered neighbours to their <em>k</em> nearest provinces. For this example,
we have set the value of k to 2. The resulting neighbourhood structure
is shown in Figure <a href="#fig:ind-contig1html">11</a>. Note how it can be styled with a combination of internal arguments (size, colour, fill etc.) and additional <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> layers.</p>

<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># join islands to k=2 nearest neighbours</span></span>
<span><span class='co'># various arguments exist for altering colours and sizes</span></span>
<span><span class='co'># additional ggplot themes and layers can be added</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>provinces_df</span>, <span class='st'>"province"</span>, link_islands_k <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span>fillcol <span class='op'>=</span> <span class='st'>"antiquewhite1"</span>,</span>
<span>                 bordercol <span class='op'>=</span> <span class='st'>"black"</span>, bordersize <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>                 linkcol <span class='op'>=</span> <span class='st'>"darkblue"</span>, linksize <span class='op'>=</span> <span class='fl'>0.8</span>,</span>
<span>                 pointcol <span class='op'>=</span> <span class='st'>"red"</span>, pointsize <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>panel.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"#ECF6F7"</span>, colour <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>                                        linewidth<span class='op'>=</span><span class='fl'>1.5</span><span class='op'>)</span>,</span>
<span>        axis.text <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>nearby_countries_df</span>,</span>
<span>          fill<span class='op'>=</span><span class='st'>"gray50"</span>, linewidth<span class='op'>=</span><span class='fl'>0.5</span>, colour<span class='op'>=</span><span class='st'>"black"</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ind-contig1html"></span>
<img src="RJ-2025-015_files/figure-html5/ind-contig1html-1.png" alt="Neighbourhood structure for Indonesian provinces created by st_bridges() with k=2. " width="100%" />
<p class="caption">
Figure 11: Neighbourhood structure for Indonesian provinces created by st_bridges() with k=2.
</p>
</div>
</div>
<p>This neighbourhood structure now has no unconnected provinces so it is
suitable for use in an ICAR model. However, if we are not entirely happy with this structure because of some domain knowledge about the inter-relationships between certain island provinces, we might wish to</p>
<ul>
<li><p>add some additional contiguities using <code>st_force_join_nb()</code></p></li>
<li><p>and remove one using <code>st_force_cut_nb()</code>.</p></li>
</ul>
<p>To cater for the possibility that a modeller might not be familiar with the names of the various geographic units but still wishes to enforce alterations to their relationships, we can look at a map (Figure <a href="#fig:ind-contig2html">12</a>) where the nodes are shown by
index number instead of as points (using the argument <code>nodes='numeric'</code>). This makes it easy to cut and join neighbour connectivities as desired. Furthermore, there is an option to
show concave hulls drawn around each unit (using <code>concavehull = TRUE</code>). This is also shown in Figure <a href="#fig:ind-contig2html">12</a>. These shapes are not used in the assignment of contiguities but it can be useful to see them in a situation such as Indonesia where many individual provinces are actually multipolygons of more than one island. Without them, it is not clear whether an island is a province in its own right, or which group of islands together form one province.</p>

<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># with 'concavehull = TRUE' and 'nodes = "numeric"'</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>provinces_df</span>, <span class='st'>"province"</span>, link_islands_k <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span>fillcol <span class='op'>=</span> <span class='st'>"antiquewhite1"</span>,</span>
<span>                 bordercol <span class='op'>=</span> <span class='st'>"black"</span>, bordersize <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>                 linkcol <span class='op'>=</span> <span class='st'>"tomato"</span>, linksize <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>                 nodes <span class='op'>=</span> <span class='st'>"numeric"</span>,</span>
<span>                 numericcol <span class='op'>=</span> <span class='st'>"black"</span>, numericsize <span class='op'>=</span> <span class='fl'>6</span>,</span>
<span>                 concavehull <span class='op'>=</span> <span class='cn'>TRUE</span>,</span>
<span>                 hullcol <span class='op'>=</span> <span class='st'>"darkgreen"</span>, hullsize <span class='op'>=</span> <span class='fl'>0.2</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>panel.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"#ECF6F7"</span>, colour <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>                                        linewidth<span class='op'>=</span><span class='fl'>1.5</span><span class='op'>)</span>,</span>
<span>        axis.text <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ind-contig2html"></span>
<img src="RJ-2025-015_files/figure-html5/ind-contig2html-1.png" alt="Neighbourhood structure for Indonesian provinces. Viewed with st\_quickmap_nb(), using the arguments nodes = 'numeric' and concavehull = TRUE. " width="100%" />
<p class="caption">
Figure 12: Neighbourhood structure for Indonesian provinces. Viewed with st_quickmap_nb(), using the arguments nodes = ‘numeric’ and concavehull = TRUE.
</p>
</div>
</div>
<p>Having enforced some adjustments to the neighbourhood structure, outlined in the code below, the
new structure can be seen in Figure <a href="#fig:ind-contig3html">13</a>. Edge effects
have also been mitigated by imposing additional connections on the two extreme
provinces (1 and 23), which would otherwise have only one neighbour, so that they now also include
their two next closest neighbours.</p>

<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># a series of forced joins and cuts by index number</span></span>
<span></span>
<span><span class='va'>joins_df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tribble.html'>tribble</a></span><span class='op'>(</span></span>
<span>  <span class='op'>~</span><span class='va'>x</span>, <span class='op'>~</span><span class='va'>y</span>,</span>
<span>  <span class='fl'>1</span>, <span class='fl'>24</span>,</span>
<span>  <span class='fl'>1</span>, <span class='fl'>30</span>,</span>
<span>  <span class='fl'>3</span>, <span class='fl'>13</span>,</span>
<span>  <span class='fl'>13</span>, <span class='fl'>17</span>,</span>
<span>  <span class='fl'>14</span>, <span class='fl'>25</span>,</span>
<span>  <span class='fl'>20</span>, <span class='fl'>29</span>,</span>
<span>  <span class='fl'>19</span>, <span class='fl'>23</span>,</span>
<span>  <span class='fl'>16</span>, <span class='fl'>27</span>,</span>
<span>  <span class='fl'>22</span>, <span class='fl'>23</span>,</span>
<span>  <span class='fl'>7</span>, <span class='fl'>19</span>,</span>
<span>  <span class='fl'>7</span>, <span class='fl'>20</span>,</span>
<span>  <span class='fl'>19</span>, <span class='fl'>28</span>,</span>
<span>  <span class='fl'>4</span>, <span class='fl'>18</span>,</span>
<span>  <span class='fl'>21</span>, <span class='fl'>26</span>,</span>
<span>  <span class='fl'>22</span>, <span class='fl'>28</span></span>
<span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>provinces_df</span>, <span class='st'>"province"</span>, link_islands_k <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_force_join_nb.html'>st_force_join_nb</a></span><span class='op'>(</span>xy_df <span class='op'>=</span> <span class='va'>joins_df</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_force_cut_nb.html'>st_force_cut_nb</a></span><span class='op'>(</span><span class='fl'>19</span>,<span class='fl'>22</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span>fillcol <span class='op'>=</span> <span class='st'>"antiquewhite1"</span>,</span>
<span>                 bordercol <span class='op'>=</span> <span class='st'>"black"</span>, bordersize <span class='op'>=</span> <span class='fl'>0.5</span>,</span>
<span>                 linkcol <span class='op'>=</span> <span class='st'>"darkblue"</span>, linksize <span class='op'>=</span> <span class='fl'>0.8</span>,</span>
<span>                 pointcol <span class='op'>=</span> <span class='st'>"red"</span>, pointsize <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>panel.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"#ECF6F7"</span>, colour <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>                                        linewidth<span class='op'>=</span><span class='fl'>1.5</span><span class='op'>)</span>,</span>
<span>        axis.text <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>nearby_countries_df</span>,</span>
<span>          fill<span class='op'>=</span><span class='st'>"gray50"</span>, linewidth<span class='op'>=</span><span class='fl'>0.5</span>, colour<span class='op'>=</span><span class='st'>"black"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html'>annotation_scale</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ind-contig3html"></span>
<img src="RJ-2025-015_files/figure-html5/ind-contig3html-1.png" alt="Neighbourhood structure for Indonesian provinces, after alterations using st\_force_join() and st\_force_cut().  As many connections are being enforced at once, we can feed these to the function as a data frame rather than using consecutive function calls as before. " width="100%" />
<p class="caption">
Figure 13: Neighbourhood structure for Indonesian provinces, after alterations using st_force_join() and st_force_cut(). As many connections are being enforced at once, we can feed these to the function as a data frame rather than using consecutive function calls as before.
</p>
</div>
</div>
<h3 data-number="5.4" id="mgcv-model"><span class="header-section-number">5.4</span> <code>mgcv</code> model</h3>
<p>We now create the ICAR model using, in this case, the <a href="https://cran.r-project.org/package=mgcv">mgcv</a> package. We will be able to use the output of <code>st_bridges</code>, which we have named <code>prep_data</code>, as both the data source for the model and the neighbourhood structure (by specifying the column <code>nb</code> which contains the neighbourhood list).</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>mod_pois_mrf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/gam.html'>gam</a></span><span class='op'>(</span><span class='va'>damaging_quakes_total</span> <span class='op'>~</span></span>
<span>                      <span class='va'>fault_concentration</span> <span class='op'>+</span></span>
<span>                      <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>province</span>, bs<span class='op'>=</span><span class='st'>'mrf'</span>, xt<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>nb<span class='op'>=</span><span class='va'>prep_data</span><span class='op'>$</span><span class='va'>nb</span><span class='op'>)</span>, k<span class='op'>=</span><span class='fl'>24</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>                      <span class='fu'><a href='https://rdrr.io/r/stats/offset.html'>offset</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>area_province</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>                    data<span class='op'>=</span><span class='va'>prep_data</span>, method<span class='op'>=</span><span class='st'>"REML"</span>,family <span class='op'>=</span> <span class='st'>"poisson"</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>We can see from the summary below that the adjusted R-squared is <strong>0.983</strong> and deviance explained is <strong>93.3%</strong>. The coefficient for <code>fault_concentration</code> confirms an expected positive mean global association between earthquake and fault incidence.</p>
<div class="layout-chunk" data-layout="l-body">
<pre><code>
Family: poisson 
Link function: log 

Formula:
damaging_quakes_total ~ fault_concentration + s(province, bs = &quot;mrf&quot;, 
    xt = list(nb = prep_data$nb), k = 24) + offset(log(area_province))

Parametric coefficients:
                    Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          -9.5648     0.1744 -54.845  &lt; 2e-16 ***
fault_concentration   5.9971     1.9245   3.116  0.00183 ** 
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Approximate significance of smooth terms:
              edf Ref.df Chi.sq p-value    
s(province) 19.19     23  166.6  &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

R-sq.(adj) =  0.983   Deviance explained = 93.3%
-REML = 104.81  Scale est. = 1         n = 33</code></pre>
</div>
<p>Returning to the initial question, what is the additional risk level of earthquakes in a province, having controlled for the concentration of faults? This can be seen as a measure of the activity level of faults locally and it is spatially smoothed by the autoregressive process. It is represented in the model summary by the component <code>s(province)</code>. However, the extraction of individual predictions for this component for each province from the <code>mgcv</code> model requires a number of steps. We now demonstrate how these are streamlined into a single function by the <a href="https://cran.r-project.org/package=sfislands">sfislands</a> package.</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<h3 data-number="5.5" id="post-functions-1"><span class="header-section-number">5.5</span> Post-functions</h3>
<p>The function <code>st_augment()</code> allows us to add the spatially varying predictions from the model as new columns to the original dataframe in a process
similar to that of the <a href="https://cran.r-project.org/package=broom">broom</a> package. For instance, we see from the output of the following code chunk that the original dataframe is now augmented with columns called <code>mrf.smooth.province</code> and <code>se.mrf.smooth.province</code> which show the predictions for the <span class="math inline">\(\gamma_i\)</span> component and their standard errors. Note that this is how we would expect them to be named, based on the previous discussion surrounding Table <a href="#tab:staugtab-html">3</a>. They are positioned immediately before the final <code>geometry</code> column of the <code>sf</code> dataframe, and after the neighbours list column, <code>nb</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># column names of augmented dataframe</span></span>
<span></span>
<span><span class='va'>mod_pois_mrf</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_augment.html'>st_augment</a></span><span class='op'>(</span><span class='va'>prep_data</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code> [1] &quot;province&quot;                &quot;province_id&quot;            
 [3] &quot;S&quot;                       &quot;M&quot;                      
 [5] &quot;L&quot;                       &quot;XL&quot;                     
 [7] &quot;quake_total&quot;             &quot;quake_density&quot;          
 [9] &quot;damaging_quakes_total&quot;   &quot;damaging_quakes_density&quot;
[11] &quot;area_fault_within&quot;       &quot;area_province&quot;          
[13] &quot;fault_concentration&quot;     &quot;nb&quot;                     
[15] &quot;mrf.smooth.province&quot;     &quot;se.mrf.smooth.province&quot; 
[17] &quot;geometry&quot;               </code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>This output can now be piped into the <code>st_quickmap_preds()</code> function to get a quick visualisation of
these estimates for <span class="math inline">\(\gamma_i\)</span> on a map, as shown in Figure <a href="#fig:ind-mrf1html">14</a>. Again, note that the title and subtitle of the image are as previously discussed.</p>

<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># st_quickmap_preds() outputs a list of ggplots</span></span>
<span></span>
<span><span class='va'>plot_mrf</span> <span class='op'>&lt;-</span> <span class='va'>mod_pois_mrf</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_augment.html'>st_augment</a></span><span class='op'>(</span><span class='va'>prep_data</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_preds.html'>st_quickmap_preds</a></span><span class='op'>(</span>scale_low <span class='op'>=</span> <span class='st'>"darkgreen"</span>,</span>
<span>                    scale_mid <span class='op'>=</span> <span class='st'>"ivory"</span>,</span>
<span>                    scale_high <span class='op'>=</span> <span class='st'>"darkred"</span>,</span>
<span>                    scale_midpoint <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># in this case, there is only one plot in the list</span></span>
<span><span class='co'># so we call it by index</span></span>
<span><span class='co'># it is then supplemented with additional ggplot functions</span></span>
<span></span>
<span><span class='va'>plot_mrf</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>coord_sf</a></span><span class='op'>(</span>datum<span class='op'>=</span><span class='cn'>NA</span>, default <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>panel.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"#ECF6F7"</span>, colour <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>                                        linewidth<span class='op'>=</span><span class='fl'>1.5</span><span class='op'>)</span>,</span>
<span>        axis.text <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>provinces_df</span>, fill<span class='op'>=</span><span class='cn'>NA</span>, colour<span class='op'>=</span><span class='st'>"black"</span>, linewidth<span class='op'>=</span><span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>nearby_countries_df</span>, fill<span class='op'>=</span><span class='st'>"gray50"</span>, colour<span class='op'>=</span><span class='st'>"black"</span>,</span>
<span>          linewidth<span class='op'>=</span><span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>fill<span class='op'>=</span><span class='st'>"relative\nincidence"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html'>annotation_scale</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>coord_sf</a></span><span class='op'>(</span>datum<span class='op'>=</span><span class='cn'>NA</span>, default <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"inside"</span>,</span>
<span>        legend.position.inside <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.92</span>,<span class='fl'>0.77</span><span class='op'>)</span>,</span>
<span>        legend.box.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>colour <span class='op'>=</span> <span class='st'>"black"</span>, linewidth <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>,</span>
<span>        legend.title <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_text</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ind-mrf1html"></span>
<img src="RJ-2025-015_files/figure-html5/ind-mrf1html-1.png" alt="Estimates of $\gamma_i$ using st_quickmap_preds(). " width="100%" />
<p class="caption">
Figure 14: Estimates of <span class="math inline">\(\gamma_i\)</span> using st_quickmap_preds().
</p>
</div>
</div>
<p>If we wish to apply the inverse link function (the exponential function in the case of this Poisson model) to map these values to a more interpretable scale, this will not be generated by the function <code>st_quickmap_preds()</code>. Instead, we must use the augmented dataframe which is produced by <code>st_augment()</code> and create the appropriate extra column with the usual <a href="https://cran.r-project.org/package=tidyverse">tidyverse</a> <code>mutate()</code> function. This allows us to produce the map in Figure
<a href="#fig:ind-mrf2html">15</a>. As these coefficients are multiplicatively related to the earthquake incidence, values below 1 imply an earthquake incidence which is lower than expected.</p>
<p>The provinces with the 3 most elevated incidences are labelled in red. We can see that, controlling for the effects of proximity to faults, the province of Nusa Tenggara Barat has 8.7 times the expected incidence, or number of major earthquakes per square kilometre. The two lowest-scoring provinces, labelled in green, have essentially no incidence of earthquake epicentres within their boundaries, controlling for what their proximity to faults alone would suggest.</p>

<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ind-mrf2html"></span>
<img src="RJ-2025-015_files/figure-html5/ind-mrf2html-1.png" alt="Map showing estimates of exp($\gamma_i$). This is produced by adding an additional column to the dataframe produced by st_augment()." width="100%" />
<p class="caption">
Figure 15: Map showing estimates of exp(<span class="math inline">\(\gamma_i\)</span>). This is produced by adding an additional column to the dataframe produced by st_augment().
</p>
</div>
</div>
<h3 data-number="5.6" id="workflow-summary"><span class="header-section-number">5.6</span> Workflow summary</h3>
<p>In this example, we have gone through a number of stages carefully, making changes to contiguities that we deemed appropriate as we went. However, in practice, at least in a first iteration, it might not be necessary to go through all of these steps. A rough and ready model, complete with spatially varying coefficients and visual output, can be generated with <a href="https://cran.r-project.org/package=sfislands">sfislands</a> using nothing more than three or four lines of code, such as the following:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># workflow:</span></span>
<span></span>
<span><span class='co'># 1. set up neighbourhood structure</span></span>
<span></span>
<span><span class='va'>prep_data</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>provinces_df</span>, <span class='st'>"province"</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># 2. define model</span></span>
<span></span>
<span><span class='va'>mod</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/gam.html'>gam</a></span><span class='op'>(</span><span class='va'>quake_mlxl_total</span> <span class='op'>~</span></span>
<span>                  <span class='va'>fault_concentration</span> <span class='op'>+</span></span>
<span>                  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>province</span>, bs<span class='op'>=</span><span class='st'>'mrf'</span>, xt<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>nb<span class='op'>=</span><span class='va'>prep_data</span><span class='op'>$</span><span class='va'>nb</span><span class='op'>)</span>, k<span class='op'>=</span><span class='fl'>22</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>                  <span class='fu'><a href='https://rdrr.io/r/stats/offset.html'>offset</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>area_province</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>        data<span class='op'>=</span><span class='va'>prep_data</span>, method<span class='op'>=</span><span class='st'>"REML"</span>,family <span class='op'>=</span> <span class='st'>"poisson"</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># 3. augment tidy estimates</span></span>
<span></span>
<span><span class='va'>tidy_ests</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_augment.html'>st_augment</a></span><span class='op'>(</span><span class='va'>mod</span>, <span class='va'>prep_data</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># 4. visualise them</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_preds.html'>st_quickmap_preds</a></span><span class='op'>(</span><span class='va'>tidy_ests</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<h2 data-number="6" id="london-example-2"><span class="header-section-number">6</span> London (example 2)</h2>
<p>The next example looks only at using the <em>pre-functions</em> of <a href="https://cran.r-project.org/package=sfislands">sfislands</a>, but in a situation where the presence of actual <em>islands</em> is not the problem we seek to deal with. Consider the wards of London (sourced from the Greater London Authority’s <a href="https://data.london.gov.uk/">London Datastore</a>) and available at
<a href="https://github.com/horankev/london_liverpool_data" class="uri">https://github.com/horankev/london_liverpool_data</a>. In Figure <a href="#fig:lon-contig1">16</a> the <code>st_bridges()</code>
function is applied to them to construct a queen contiguity
neighbourhood structure. As can be seen from the <code>st_check_islands()</code> function, this collection of London wards contains no isolated units.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>london</span>, <span class='st'>"GSS_CODE"</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_check_islands.html'>st_check_islands</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>No disconnected units were found in original data</code></pre>
<pre><code>[1] 0</code></pre>
</div>
<p>The <code>st_quickmap_nb()</code> function gives an immediate visual representation of the structure. <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Because this map is created using <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a>, it can be easily supplemented by adding a layer showing the course of the river Thames which is also visible in Figure <a href="#fig:lon-contig1">16</a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># same as sfdep:st_contiguity() as there are no islands</span></span>
<span><span class='co'># an extra layer for the river Thames</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>london</span>, <span class='st'>"GSS_CODE"</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>thames</span>, colour<span class='op'>=</span><span class='st'>"blue"</span>, linewidth<span class='op'>=</span><span class='fl'>1.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>panel.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"#F6F3E9"</span>, colour <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>                                        linewidth<span class='op'>=</span><span class='fl'>1.5</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:lon-contig1"></span>
<img src="RJ-2025-015_files/figure-html5/lon-contig1-1.png" alt="Wards of Greater London. Queen contiguity. " width="100%" />
<p class="caption">
Figure 16: Wards of Greater London. Queen contiguity.
</p>
</div>
</div>
<p>When a study area has a river running through it, problems can arise with constructing appropriate neighbourhood structures. Depending on how the
geometries are defined, the presence of a river can cause problems in two ways. In one situation, the river could be expressed as a polygon in its own right meaning that, using the condition of queen contiguity, it severs any potential contiguity between units on either side of its banks. In this situation, no spatial units will be neighbours with the units directly across the river from them. At the other extreme, if the river is not included as a geometry (as is the case here) all units on opposing banks are automatically considered neighbours.</p>
<p>Depending on the presence of river crossings, two areas which are physically quite close but on opposing banks might be very distinct. If there is no means of crossing the river within a reasonable distance, somebody living on the banks of a river might be more likely to go about their life primarily on their side of the river, despite the short distance as the crow flies of facilities on the other side. This could be relevant in terms of, say, modelling of house prices where we might want to incorporate issues such as local amenities into a neighbourhood structure.</p>
<p><a href="https://cran.r-project.org/package=sfislands">sfislands</a> provides convenient functions for this sort of situation. Let us start by restricting our wards of interest to just those which are on either side of the river Thames. Figure <a href="#fig:lon-contig2">17</a> shows the resultant contiguities when the river is ignored.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># which wards are alongside the river</span></span>
<span></span>
<span><span class='va'>riverside</span> <span class='op'>&lt;-</span> <span class='va'>thames</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/geos_binary_pred.html'>st_intersects</a></span><span class='op'>(</span><span class='va'>london</span><span class='op'>)</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://rdrr.io/r/base/unlist.html'>unlist</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># only map these wards</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>london</span><span class='op'>[</span><span class='va'>riverside</span>,<span class='op'>]</span>,<span class='st'>"NAME"</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span>linksize <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>thames</span>, colour<span class='op'>=</span><span class='st'>"blue"</span>, linewidth<span class='op'>=</span><span class='fl'>1.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html'>annotation_scale</a></span><span class='op'>(</span>location<span class='op'>=</span><span class='st'>"br"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>coord_sf</a></span><span class='op'>(</span>datum<span class='op'>=</span><span class='cn'>NA</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>panel.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"#F6F3E9"</span>, colour <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>                                        linewidth<span class='op'>=</span><span class='fl'>1.5</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:lon-contig2"></span>
<img src="RJ-2025-015_files/figure-html5/lon-contig2-1.png" alt="Riverside wards of Greater London. Queen contiguity disregarding river. " width="100%" />
<p class="caption">
Figure 17: Riverside wards of Greater London. Queen contiguity disregarding river.
</p>
</div>
</div>
<p>In order to take account of actual connectivity, we can add a layer showing the road and pedestrian bridges or tunnels. Details of these were sourced from the <span class="citation" data-cites="wikicrossings">Wikipedia (<a href="#ref-wikicrossings" role="doc-biblioref">2024</a>)</span> article titled “<em>List of crossings of the River Thames</em>”. In Figure <a href="#fig:lon-crossings">18</a>, we have also drawn a 1 kilometre buffer around each crossing. This was chosen as an arbitrary measure of what might be considered a “reasonable” distance within which to consider opposing banks as being connected. The vast majority of units on opposing banks have access to a river crossing within this threshold and thus should be considered as neighbours. Only the extreme eastern units and one to the south west should not have a connection across the river according to this criterion.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:lon-crossings"></span>
<img src="RJ-2025-015_files/figure-html5/lon-crossings-1.png" alt="Riverside wards of Greater London. Road and pedestrian crossing and tunnels surrounded by 1 kilometre buffer shaded green. " width="100%" />
<p class="caption">
Figure 18: Riverside wards of Greater London. Road and pedestrian crossing and tunnels surrounded by 1 kilometre buffer shaded green.
</p>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>In order to identify the changes we wish to make, we use the
<code>nodes = "numeric"</code> argument in <code>st_quickmap_nb()</code>. Now we can identify
each unit by its position in the contiguity structure. Here we have
shaded in pink the units which are not within 1 kilometre of a river
crossing (see Figure <a href="#fig:lon-contig3">19</a>).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># with 'nodes = "numeric"'</span></span>
<span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>london</span><span class='op'>[</span><span class='va'>riverside</span>,<span class='op'>]</span>,<span class='st'>"NAME"</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span>nodes <span class='op'>=</span> <span class='st'>"numeric"</span>, numericsize <span class='op'>=</span> <span class='fl'>4</span>, linksize <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>no_touch_buffer</span>, fill<span class='op'>=</span><span class='st'>"pink"</span>, alpha<span class='op'>=</span><span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>crossings_roadped</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/geos_unary.html'>st_buffer</a></span><span class='op'>(</span><span class='fl'>1000</span><span class='op'>)</span>,</span>
<span>          fill<span class='op'>=</span><span class='st'>"darkgreen"</span>, alpha<span class='op'>=</span><span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>thames</span>, colour<span class='op'>=</span><span class='st'>"blue"</span>, linewidth<span class='op'>=</span><span class='fl'>1.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>crossings_roadped</span>, size<span class='op'>=</span><span class='fl'>1</span>, colour<span class='op'>=</span><span class='st'>"yellow"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html'>annotation_scale</a></span><span class='op'>(</span>location<span class='op'>=</span><span class='st'>"br"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>coord_sf</a></span><span class='op'>(</span>datum<span class='op'>=</span><span class='cn'>NA</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>panel.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"#F6F3E9"</span>, colour <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>                                        linewidth<span class='op'>=</span><span class='fl'>1.5</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:lon-contig3"></span>
<img src="RJ-2025-015_files/figure-html5/lon-contig3-1.png" alt="Riverside wards of Greater London. Index number for each ward shown at centroid. Wards which are not within 1 kilometre of a crossing are shaded pink. " width="100%" />
<p class="caption">
Figure 19: Riverside wards of Greater London. Index number for each ward shown at centroid. Wards which are not within 1 kilometre of a crossing are shaded pink.
</p>
</div>
</div>
<p>This allows us to easily cut the ties across the river for these units by using the function <code>st_force_cut_nb()</code>. <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> Having made these adjustments,
<code>st_quickmap_nb()</code> now shows a connectivity structure (Figure <a href="#fig:lon-contig4">20</a>) which reflects our hypothesis of how influence should extend across the river in the presence or absence of crossings.</p>
<p>This example shows that the pre-functions of <a href="https://cran.r-project.org/package=sfislands">sfislands</a> have uses for situations which do not involve islands. They can be used to apply domain knowledge to easily design the most appropriate neighbourhood structure.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># enforce cuts for the links where there is no crossing</span></span>
<span></span>
<span><span class='va'>cut_df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tribble.html'>tribble</a></span><span class='op'>(</span></span>
<span>  <span class='op'>~</span><span class='va'>x</span>, <span class='op'>~</span><span class='va'>y</span>,</span>
<span>  <span class='fl'>18</span>, <span class='fl'>17</span>,</span>
<span>  <span class='fl'>19</span>, <span class='fl'>17</span>,</span>
<span>  <span class='fl'>19</span>, <span class='fl'>20</span>,</span>
<span>  <span class='fl'>20</span>, <span class='fl'>21</span>,</span>
<span>  <span class='fl'>21</span>, <span class='fl'>22</span>,</span>
<span>  <span class='fl'>47</span>, <span class='fl'>48</span>,</span>
<span>  <span class='fl'>45</span>, <span class='fl'>46</span>,</span>
<span>  <span class='fl'>45</span>, <span class='fl'>47</span>,</span>
<span>  <span class='fl'>39</span>, <span class='fl'>65</span>,</span>
<span>  <span class='fl'>1</span>, <span class='fl'>2</span></span>
<span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_bridges.html'>st_bridges</a></span><span class='op'>(</span><span class='va'>london</span><span class='op'>[</span><span class='va'>riverside</span>,<span class='op'>]</span>, <span class='st'>"NAME"</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_force_cut_nb.html'>st_force_cut_nb</a></span><span class='op'>(</span>xy_df <span class='op'>=</span> <span class='va'>cut_df</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='fu'><a href='https://horankev.github.io/sfislands/reference/st_quickmap_nb.html'>st_quickmap_nb</a></span><span class='op'>(</span>bordercol <span class='op'>=</span> <span class='st'>"black"</span>, bordersize <span class='op'>=</span> <span class='fl'>0.5</span>, linksize <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>no_touch_buffer</span>, fill <span class='op'>=</span> <span class='st'>"pink"</span>, alpha <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>crossings_roadped</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/geos_unary.html'>st_buffer</a></span><span class='op'>(</span><span class='fl'>1000</span><span class='op'>)</span>,</span>
<span>          fill<span class='op'>=</span> <span class='st'>"darkgreen"</span>, alpha <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data<span class='op'>=</span><span class='va'>thames</span>, colour <span class='op'>=</span> <span class='st'>"blue"</span>, linewidth <span class='op'>=</span> <span class='fl'>1.5</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html'>annotation_scale</a></span><span class='op'>(</span>location <span class='op'>=</span> <span class='st'>"br"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>coord_sf</a></span><span class='op'>(</span>datum<span class='op'>=</span><span class='cn'>NA</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>panel.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"#F6F3E9"</span>, colour <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>                                        linewidth <span class='op'>=</span> <span class='fl'>1.5</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:lon-contig4"></span>
<img src="RJ-2025-015_files/figure-html5/lon-contig4-1.png" alt="Riverside wards of Greater London. Contiguities across the river have been cut for the pink wards. " width="100%" />
<p class="caption">
Figure 20: Riverside wards of Greater London. Contiguities across the river have been cut for the pink wards.
</p>
</div>
</div>
<h2 data-number="7" id="summary"><span class="header-section-number">7</span> Summary</h2>
<p>These examples have shown the varying scenarios in which <a href="https://cran.r-project.org/package=sfislands">sfislands</a> can be useful. It aims to contribute to spatial modelling by making an awkward area less awkward. Rather than having a default attitude of ignoring islands when building neighbourhood structures based on contiguity, it offers a convenient system for enforcing linkages if that is deemed to be the most appropriate course of action. Even when no islands are present, it provides a simple procedure for tailoring a neighbourhood structure with bespoke contiguities to match a given hypothesis. It also provides helper functions to use these structures in spatial regression models, notably those built with <a href="https://cran.r-project.org/package=mgcv">mgcv</a>, which streamline the human effort necessary to examine the estimates. In future, compatibility with other modelling packages can be added to broaden the package’s capabilities.</p>
<h2 data-number="8" id="acknowledgements"><span class="header-section-number">8</span> Acknowledgements</h2>
<p>This publication has emanated from research conducted with the financial support of Taighde Éireann – Research Ireland under Grant number 18/CRT/6049. For the purpose of Open Access, the author has applied a CC BY public copyright licence to any Author Accepted Manuscript version arising from this submission.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<h3 class="appendix" data-number="8.1" id="cran-packages-used"><span class="header-section-number">8.1</span> CRAN packages used</h3>
<p><a href="https://cran.r-project.org/package=spdep">spdep</a>, <a href="https://cran.r-project.org/package=sf">sf</a>, <a href="https://cran.r-project.org/package=sfdep">sfdep</a>, <a href="https://cran.r-project.org/package=sfislands">sfislands</a>, <a href="https://cran.r-project.org/package=mgcv">mgcv</a>, <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a>, <a href="https://cran.r-project.org/package=brms">brms</a>, <a href="https://cran.r-project.org/package=rstan">rstan</a>, <a href="https://cran.r-project.org/package=broom">broom</a>, <a href="https://cran.r-project.org/package=lme4">lme4</a>, <a href="https://cran.r-project.org/package=nlme">nlme</a>, <a href="https://cran.r-project.org/package=ggpubr">ggpubr</a>, <a href="https://cran.r-project.org/package=tidyverse">tidyverse</a></p>
<h3 class="appendix" data-number="8.2" id="cran-task-views-implied-by-cited-packages"><span class="header-section-number">8.2</span> CRAN Task Views implied by cited packages</h3>
<p><a href="https://cran.r-project.org/view=Bayesian">Bayesian</a>, <a href="https://cran.r-project.org/view=ChemPhys">ChemPhys</a>, <a href="https://cran.r-project.org/view=ClinicalTrials">ClinicalTrials</a>, <a href="https://cran.r-project.org/view=Econometrics">Econometrics</a>, <a href="https://cran.r-project.org/view=Environmetrics">Environmetrics</a>, <a href="https://cran.r-project.org/view=Finance">Finance</a>, <a href="https://cran.r-project.org/view=MetaAnalysis">MetaAnalysis</a>, <a href="https://cran.r-project.org/view=MixedModels">MixedModels</a>, <a href="https://cran.r-project.org/view=NetworkAnalysis">NetworkAnalysis</a>, <a href="https://cran.r-project.org/view=OfficialStatistics">OfficialStatistics</a>, <a href="https://cran.r-project.org/view=Phylogenetics">Phylogenetics</a>, <a href="https://cran.r-project.org/view=Psychometrics">Psychometrics</a>, <a href="https://cran.r-project.org/view=Spatial">Spatial</a>, <a href="https://cran.r-project.org/view=SpatioTemporal">SpatioTemporal</a>, <a href="https://cran.r-project.org/view=TeachingStatistics">TeachingStatistics</a></p>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Andrfout2022" class="csl-entry" role="listitem">
S. Andréfouët, M. Paul and A. R. Farhan. <span>Indonesia</span>’s 13558 islands: <span>A</span> new census from space and a first step towards a <span class="nocase">One Map for Small Islands Policy</span>. <em>Marine Policy</em>, 135: 104848, 2022. URL <a href="http://dx.doi.org/10.1016/j.marpol.2021.104848">http://dx.doi.org/10.1016/j.marpol.2021.104848</a>.
</div>
<div id="ref-r-inla" class="csl-entry" role="listitem">
H. Bakka, H. Rue, G.-A. Fuglstad, A. Riebler, D. Bolin, E. Krainski, D. Simpson and F. Lindgren. Spatial modelling with <span>R-INLA</span>: A review. 2018. URL <a href="https://arxiv.org/abs/1802.06350">https://arxiv.org/abs/1802.06350</a>.
</div>
<div id="ref-lme4" class="csl-entry" role="listitem">
D. Bates, M. Mächler, B. Bolker and S. Walker. Fitting linear mixed-effects models using <span class="nocase">lme4</span>. <em>Journal of Statistical Software</em>, 67(1): 1–48, 2015. URL <a href="https://doi.org/10.18637/jss.v067.i01">https://doi.org/10.18637/jss.v067.i01</a>.
</div>
<div id="ref-besag" class="csl-entry" role="listitem">
J. Besag. Spatial interaction and the statistical analysis of lattice systems. <em>Journal of the Royal Statistical Society: Series B (Methodological)</em>, 36(2): 192–225, 1974. URL <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.2517-6161.1974.tb00999.x">https://onlinelibrary.wiley.com/doi/abs/10.1111/j.2517-6161.1974.tb00999.x</a>.
</div>
<div id="ref-spdep" class="csl-entry" role="listitem">
R. S. Bivand. <span>R</span> packages for analyzing spatial data: A comparative case study with areal data. <em>Geographical Analysis</em>, 54(3): 488–518, 2022. URL <a href="https://doi.org/10.1111/gean.12319">https://doi.org/10.1111/gean.12319</a>.
</div>
<div id="ref-bivandportnov" class="csl-entry" role="listitem">
R. S. Bivand and B. A. Portnov. <span class="nocase">Exploring spatial data analysis techniques using <span>R</span>: The case of observations with no neighbors</span>. In <em><span class="nocase">Advances in Spatial Econometrics</span></em>, Eds L. Anselin, R. J. G. M. Florax and S. J. Rey pages. 121–142 2004. Springer. URL <a href="https://ideas.repec.org/h/spr/adspcp/978-3-662-05617-2_6.html">https://ideas.repec.org/h/spr/adspcp/978-3-662-05617-2_6.html</a>.
</div>
<div id="ref-BrizRedn2021" class="csl-entry" role="listitem">
Á. Briz-Redón, A. Iftimi, J. F. Correcher, J. De Andrés, M. Lozano and C. Romero-García. A comparison of multiple neighborhood matrix specifications for spatio-temporal model fitting: <span>A</span> case study on <span>COVID-19</span> data. <em>Stochastic Environmental Research and Risk Assessment</em>, 36(1): 271–282, 2021. URL <a href="http://dx.doi.org/10.1007/s00477-021-02077-y">http://dx.doi.org/10.1007/s00477-021-02077-y</a>.
</div>
<div id="ref-brms" class="csl-entry" role="listitem">
P.-C. Bürkner. <span class="nocase">brms</span>: An <span>R</span> package for <span>Bayesian</span> multilevel models using <span>Stan</span>. <em>Journal of Statistical Software</em>, 80(1): 1–28, 2017. URL <a href="https://doi.org/10.18637/jss.v080.i01">https://doi.org/10.18637/jss.v080.i01</a>.
</div>
<div id="ref-Duncan2017" class="csl-entry" role="listitem">
E. W. Duncan, N. M. White and K. Mengersen. Spatial smoothing in <span>Bayesian</span> models: <span>A</span> comparison of weights matrix specifications and their impact on inference. <em>International Journal of Health Geographics</em>, 16(1): 2017. URL <a href="http://dx.doi.org/10.1186/s12942-017-0120-x">http://dx.doi.org/10.1186/s12942-017-0120-x</a>.
</div>
<div id="ref-Earnest2007" class="csl-entry" role="listitem">
A. Earnest, G. Morgan, K. Mengersen, L. Ryan, R. Summerhayes and J. Beard. Evaluating the effect of neighbourhood weight matrices on smoothing properties of conditional autoregressive (<span>CAR</span>) models. <em>International Journal of Health Geographics</em>, 6(1): 54, 2007. URL <a href="http://dx.doi.org/10.1186/1476-072X-6-54">http://dx.doi.org/10.1186/1476-072X-6-54</a>.
</div>
<div id="ref-freni" class="csl-entry" role="listitem">
A. Freni-Sterrantino, M. Ventrucci and H. Rue. A note on intrinsic conditional autoregressive models for disconnected graphs. <em>Spatial and Spatio-temporal Epidemiology</em>, 26: 25–34, 2018. URL <a href="http://dx.doi.org/10.1016/j.sste.2018.04.002">http://dx.doi.org/10.1016/j.sste.2018.04.002</a>.
</div>
<div id="ref-sfislands" class="csl-entry" role="listitem">
K. Horan, K. Domijan and C. Brunsdon. <em><span class="nocase">sfislands</span>: Streamlines the process of fitting areal spatial models.</em> 2024. URL <a href="https://horankev.github.io/sfislands/">https://horankev.github.io/sfislands/</a>. R package version 1.1.2.
</div>
<div id="ref-ggpubr" class="csl-entry" role="listitem">
A. Kassambara. <em><span class="nocase">ggpubr</span>: <span>“<span class="nocase">ggplot2</span>”</span>-based publication ready plots.</em> 2023. URL <a href="https://CRAN.R-project.org/package=ggpubr">https://CRAN.R-project.org/package=ggpubr</a>. R package version 0.6.0.
</div>
<div id="ref-sfdep" class="csl-entry" role="listitem">
J. Parry and D. H. Locke. <em><span class="nocase">sfdep</span>: Spatial dependence for simple features.</em> 2024. URL <a href="https://sfdep.josiahparry.com">https://sfdep.josiahparry.com</a>. R package version 0.2.4.
</div>
<div id="ref-sf" class="csl-entry" role="listitem">
E. Pebesma. <span class="nocase">Simple features for <span>R</span>: Standardized support for spatial vector data</span>. <em><span>The R Journal</span></em>, 10(1): 439–446, 2018. URL <a href="https://doi.org/10.32614/RJ-2018-009">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
<div id="ref-nlme" class="csl-entry" role="listitem">
J. Pinheiro, D. Bates and R Core Team. <em><span class="nocase">nlme</span>: Linear and nonlinear mixed effects models.</em> 2023. URL <a href="https://CRAN.R-project.org/package=nlme">https://CRAN.R-project.org/package=nlme</a>. R package version 3.1-164.
</div>
<div id="ref-broom" class="csl-entry" role="listitem">
D. Robinson, A. Hayes and S. Couch. <span class="nocase">broom</span>: Convert statistical objects into tidy tibbles. 2023. URL <a href="https://CRAN.R-project.org/package=broom">https://CRAN.R-project.org/package=broom</a>.
</div>
<div id="ref-rstan" class="csl-entry" role="listitem">
Stan Development Team. <span class="nocase"><span>RStan</span>: the <span>R</span> interface to <span>Stan</span></span>. 2020. URL <a href="http://mc-stan.org/">http://mc-stan.org/</a>.
</div>
<div id="ref-tobler" class="csl-entry" role="listitem">
W. R. Tobler. A computer movie simulating urban growth in the <span>Detroit</span> region. <em>Economic Geography</em>, 46(sup1): 234–240, 1970. URL <a href="https://www.tandfonline.com/doi/abs/10.2307/143141">https://www.tandfonline.com/doi/abs/10.2307/143141</a>. Publisher: Routledge.
</div>
<div id="ref-ggplot2" class="csl-entry" role="listitem">
H. Wickham. <em><span class="nocase">ggplot2</span>: Elegant graphics for data analysis.</em> Springer-Verlag New York, 2016. URL <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-wikicrossings" class="csl-entry" role="listitem">
Wikipedia. <span class="nocase">List of crossings of the <span>River Thames</span></span> — <span>W</span>ikipedia<span>,</span> the free encyclopedia. 2024. URL <a href="http://en.wikipedia.org/w/index.php?title=List\%20of\%20crossings\%20of\%20the\%20River\%20Thames&amp;oldid=1184426738">http://en.wikipedia.org/w/index.php?title=List\%20of\%20crossings\%20of\%20the\%20River\%20Thames&amp;oldid=1184426738</a>. <span>A</span>ccessed 2024-03-15.
</div>
<div id="ref-mgcv" class="csl-entry" role="listitem">
S. N. Wood. Fast stable restricted maximum likelihood and marginal likelihood estimation of semiparametric generalized linear models. 73: 3–36, 2011. URL <a href="https://CRAN.R-project.org/web/packages/mgcv/index.html">https://CRAN.R-project.org/web/packages/mgcv/index.html</a>.
</div>
</div>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>In a similar way, <code>st_augment()</code> can also be used to append the random effects from <a href="https://cran.r-project.org/package=lme4">lme4</a> <span class="citation" data-cites="lme4">(<a href="#ref-lme4" role="doc-biblioref">Bates et al. 2015</a>)</span> and <a href="https://cran.r-project.org/package=nlme">nlme</a> <span class="citation" data-cites="nlme">(<a href="#ref-nlme" role="doc-biblioref">Pinheiro et al. 2023</a>)</span> models to an <a href="https://cran.r-project.org/package=sf">sf</a> dataframe, which can then be easily mapped using <code>st_quickmap_preds()</code>. Compatibility with models created using different packages can be introduced in the future.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><code>st_quickmap_nb()</code> can also be used to visualise any contiguity structure created by <code>spdep</code> or <code>sfdep</code> as long as that structure is included in an <code>sf</code> dataframe as a column named <code>nb</code>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>While we are using the index of the units in this example, the function also
accepts names as arguments which may be more convenient in some circumstances.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
<h3 id="references">References</h3>
<div id="references-listing"></div>
<h3 id="reuse">Reuse</h3>
<p>Text and figures are licensed under Creative Commons Attribution <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. The figures that have been reused from other sources don't fall under this license and can be recognized by a note in their caption: "Figure from ...".</p>
<h3 id="citation">Citation</h3>
<p>For attribution, please cite this work as</p>
<pre class="citation-appendix short">Horan, et al., "Sfislands: An R Package for Accommodating Islands and Disjoint Zones in Areal Spatial Modelling", The R Journal, 2025</pre>
<p>BibTeX citation</p>
<pre class="citation-appendix long">@article{RJ-2025-015,
  author = {Horan, Kevin and Domijan, Katarina and Brunsdon, Chris},
  title = {Sfislands: An R Package for Accommodating Islands and Disjoint Zones in Areal Spatial Modelling},
  journal = {The R Journal},
  year = {2025},
  note = {https://doi.org/10.32614/RJ-2025-015},
  doi = {10.32614/RJ-2025-015},
  volume = {17},
  issue = {2},
  issn = {2073-4859},
  pages = {1}
}</pre>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
