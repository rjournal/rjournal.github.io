# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2025-015.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center")

# required libraries
library(tidyverse)
library(kableExtra)
library(sf)
library(sfdep)
library(sfislands)
library(mgcv)
library(here)
library(ggspatial)
library(ggpubr)
library(ggrepel)
library(AER) # to test for overdispersion

# To scrape data
library(rvest)
library(httr)
library(polite)
library(janitor)

# for geom_label_repel consistency
set.seed(123)

# set consistent theme
theme_set(
  theme_bw() +
    theme(panel.background = element_rect(fill = "#F6F3E9", colour = "black", linewidth=1.5), 
          axis.title = element_blank(),
          axis.ticks = element_blank())
)



## -----------------------------------------------------------------------------
# load data

# datasets are all available at https://github.com/horankev/quake_data 
# or https://github.com/horankev/london_liverpool_data
# alongside details on precisely how they were sourced etc

# indonesia
quakes_df <- readRDS(gzcon(url("https://github.com/horankev/quake_data/raw/main/datasets/quakes_df.rds")))
provinces_df <- readRDS(gzcon(url("https://github.com/horankev/quake_data/raw/main/datasets/provinces_df.rds"))) |> 
  rename(damaging_quakes_total = quake_mlxl_total,
         damaging_quakes_density = quake_mlxl_density)
counties_df <- readRDS(gzcon(url("https://github.com/horankev/quake_data/raw/main/datasets/counties_df.rds")))
faults_df <- readRDS(gzcon(url("https://github.com/horankev/quake_data/raw/main/datasets/faults_df.rds")))
nearby_countries_df <- readRDS(gzcon(url("https://github.com/horankev/quake_data/raw/main/datasets/nearby_countries_df.rds")))
indonesia_outline <- provinces_df |> summarise()

# london
london <- readRDS(gzcon(url("https://github.com/horankev/london_liverpool_data/raw/main/data/london.rds")))
thames <- readRDS(gzcon(url("https://github.com/horankev/london_liverpool_data/raw/main/data/thames.rds")))
crossings_roadped <- readRDS(gzcon(url("https://github.com/horankev/london_liverpool_data/raw/main/data/crossings_roadped.rds")))



## -----------------------------------------------------------------------------
prefunc <- tribble(
  ~`function`, ~purpose,
  "st_bridges()", "create a neighbourhood contiguity structure, with a k-nearest neighbours condition for islands",
  "st_quickmap_nb()", "check structure visually on map",
  "st_check_islands()", "check the contiguities which have been assigned to islands",
  "st_force_join_nb()", "enforce changes by adding connections",
  "st_force_cut_nb()", "enforce changes by removing connections"
)



## ----prefunc-html, eval = knitr::is_html_output(), layout = "center"----------
# knitr::kable(prefunc, format = "html", caption = "Pre-functions: setting up a neighbourhood structure.") |>
#   kable_styling(full_width = TRUE)


## ----prefunc-latex, eval = knitr::is_latex_output()---------------------------
knitr::kable(prefunc, format = "latex", caption = "Pre-functions: setting up a neighbourhood structure.") |>
  row_spec(0, bold = TRUE) |> 
  kableExtra::kable_styling(font_size = 9) |> 
  column_spec(2, width = "7cm")


## -----------------------------------------------------------------------------
rect1 <- st_polygon(list(rbind(c(0, 0), c(0, 2), c(2, 2), c(2, 0), c(0, 0))))
rect2 <- st_polygon(list(rbind(c(2, 0), c(2, 2), c(4, 2), c(4, 0), c(2, 0))))
rect3 <- st_polygon(list(rbind(c(2, 2), c(2, 4), c(4, 4), c(4, 2), c(2, 2))))
rect4 <- st_polygon(list(rbind(c(5, 0), c(5, 1), c(6, 1), c(6, 0), c(5, 0))))
rect5 <- st_polygon(list(rbind(c(0.8, 3), c(0.8, 4), c(1.8, 4), c(1.8, 3), c(0.8, 3))))

# Create sf objects for each rectangle
rect1_sf <- st_sf(geometry = st_sfc(rect1))
rect2_sf <- st_sf(geometry = st_sfc(rect2))
rect3_sf <- st_sf(geometry = st_sfc(rect3))
rect4_sf <- st_sf(geometry = st_sfc(rect4))
rect5_sf <- st_sf(geometry = st_sfc(rect5))

# Combine the rectangles into one sf object
rectangles <- rbind(rect1_sf, rect2_sf, rect3_sf, rect4_sf, rect5_sf) |> 
  mutate(name = c("Rect1","Rect2","Rect3","Rect4","Rect5"))


## ----rects1, fig.width=4, fig.height=2, fig.cap = "Simplified scenario with five rectangles. "----
ggplot(rectangles) + geom_sf(colour="black", linewidth=1) + geom_sf_label(aes(label=name),size=2.5) + 
  coord_sf(datum=NA) + 
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "#ECF6F7", colour = "black", linewidth=1.5))



## ----echo=TRUE----------------------------------------------------------------
# output a named list

st_bridges(rectangles, 
           "name", 
           remove_islands = TRUE, 
           nb_structure = "list", 
           add_to_dataframe = FALSE) |>
  head()



## ----echo=TRUE----------------------------------------------------------------
# output a named matrix

st_bridges(rectangles, 
           "name", 
           remove_islands = TRUE, 
           nb_structure = "matrix", 
           add_to_dataframe = FALSE) |> 
  head()



## ----echo=TRUE----------------------------------------------------------------
# output a named list as a column "nb" in original dataframe

st_bridges(rectangles, 
           "name", 
           link_islands_k = 1, 
           nb_structure = "list") |> 
  head()



## ----echo=TRUE----------------------------------------------------------------
# output a named matrix as a column "nb" in original dataframe

st_bridges(rectangles, 
           "name", 
           link_islands_k = 1, 
           nb_structure = "matrix") |> 
  head()



## ----rects2, fig.width=2, fig.height=1, echo=TRUE, fig.cap = "Queen contiguity and islands connected to nearest neighbour. "----
# default is 'nodes = "point"'

st_bridges(rectangles, 
           "name", 
           link_islands_k = 1) |> 
  st_quickmap_nb()



## ----rects3, fig.width=2, fig.height=1, echo=TRUE, fig.cap = "Queen contiguity and islands connected to nearest neighbour. Nodes are shown as numeric indices. "----
# with 'nodes = "numeric"'

st_bridges(rectangles, 
           "name", 
           link_islands_k = 1) |> 
  st_quickmap_nb(nodes = "numeric")



## ----echo=TRUE----------------------------------------------------------------
# show summary of non-contiguous connections in a dataframe

st_bridges(rectangles, 
           "name", 
           link_islands_k = 1) |> 
  st_check_islands()



## ----rects4, fig.width=2, fig.height=1, echo=TRUE, fig.cap = "With an additional connection between 3 and 4. "----
# add an extra connection using numeric index

st_bridges(rectangles, "name", 
           link_islands_k = 1) |> 
  st_force_join_nb(3,4) |> 
  st_quickmap_nb(nodes = "numeric")


## ----rects5, fig.width=2, fig.height=1, echo=TRUE, fig.cap = "With the removal of connection between 1 and 2. "----
# remove an existing connection using unit name, not index

st_bridges(rectangles, "name", 
           link_islands_k = 1) |> 
  st_force_join_nb(3,4) |> 
  st_force_cut_nb("Rect1","Rect2") |> 
  st_quickmap_nb(nodes = "numeric")


## -----------------------------------------------------------------------------
postfunc <- tribble(
  ~`function`, ~purpose,
  "st_augment()", "augment the original dataframe with model predictions",
  "st_quickmap_preds()", "generate quick maps of these predictions"
)



## ----postfunc-html, eval = knitr::is_html_output(), layout = "center"---------
# knitr::kable(postfunc, format = "html", caption = "Post-functions: tidy estimates from `mgcv`.") |>
#   kable_styling(full_width = TRUE)


## ----postfunc-latex, eval = knitr::is_latex_output()--------------------------
knitr::kable(postfunc, format = "latex", caption = "Post-functions: tidy estimates from mgcv.") |> 
  row_spec(0, bold = TRUE) |> 
  kableExtra::kable_styling(font_size = 9, full_width = FALSE)


## ----eval=FALSE, echo=TRUE----------------------------------------------------
# # creating an mgcv model
# 
# mgcv::gam(
#   y ~ covariate +                   # fixed intercept and effect for covariate
#     s(region, bs = "re") +                  # random intercept at level region
#     s(region, covariate, bs = "re") +          # random slopes at level region
#     s(sub-region,
#       bs = 'mrf',
#       xt = list(nb = data$nb),
#       k = k) +                    # ICAR varying intercept at level sub-region
#     s(sub-region, by = covariate,
#       bs = 'mrf',
#       xt = list(nb = data$nb),
#       k = k),           # ICAR varying slope for covariate at level sub-region
#   data = data,
#   method = "REML")


## -----------------------------------------------------------------------------
st_aug_tab_html <- tribble(
  ~`mgcv syntax`, ~`column name`,
  "s(region, bs = 're')", "random.effect.region",
  "s(region, covariate, bs = 're')", "random.effect.covariate|region",
  "s(sub-region, bs = 'mrf', xt = list(nb = data\\$nb))", "mrf.smooth.sub-region",
  "s(sub-region, by = covariate, bs = 'mrf', xt = list(nb = data\\$nb))", "mrf.smooth.covariate|sub-region"
)


## -----------------------------------------------------------------------------
st_aug_tab_latex <- tribble(
  ~`mgcv syntax`, ~`column name`,
  "s(region, bs = 're')", "random.effect.region",
  "s(region, covariate, bs = 're')", "random.effect.covariate|region",
  "s(sub-region, bs = 'mrf', xt = list(nb = data$nb))", "mrf.smooth.sub-region",
  "s(sub-region, by = covariate, bs = 'mrf', xt = list(nb = data$nb))", "mrf.smooth.covariate|sub-region"
)


## ----staugtab-html, eval = knitr::is_html_output(), layout = "center"---------
# knitr::kable(st_aug_tab_html, format = "html", caption = "The naming procedure for augmented columns from different `mgcv` structures.") |>
#   kable_styling(full_width = TRUE)


## ----staugtab-latex, eval = knitr::is_latex_output()--------------------------
knitr::kable(st_aug_tab_latex, format = "latex", caption = "The naming procedure for augmented columns from different mgcv structures.") |> 
  row_spec(0, bold = TRUE) |> 
  kableExtra::kable_styling(font_size = 9, full_width = FALSE)


## ----fault-buffers, fig.width=12, fig.height=6, out.width="100%", fig.cap = "Indonesia faults. Surrounded by a 10 kilometre buffer. "----

faults_buf <- faults_df |> 
  st_buffer(dist = 10000)

ggplot() + 
  geom_sf(data=nearby_countries_df, fill="gray50", linewidth=0.5, colour="black") +
  geom_sf(data = provinces_df, fill="antiquewhite", colour="black",linewidth=0.5) +
  geom_sf(data = faults_buf, fill="darkgreen", colour="gray50",linewidth=0.9) +
  geom_sf(data=faults_df, colour="yellow", linewidth=0.4) +
  annotation_scale() +
  coord_sf(datum=NA) + 
  theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", linewidth=1.5),
        axis.title = element_blank(),
        axis.ticks = element_blank())



## ----fault-conc, fig.width=12, fig.height=6, out.width="100%", fig.cap = "Indonesia fault concentration. Square kilometre of buffered fault per square kilometre of province area. "----

ggplot() + 
  geom_sf(data=nearby_countries_df, fill="gray50", colour="black", linewidth=0.5) +
  geom_sf(data=provinces_df, aes(fill=fault_concentration), colour="black", linewidth=0.5) +
  geom_sf(data=faults_df, colour="gray10", linetype="dashed", linewidth=0.5) +
  scale_fill_distiller(palette = "YlGn", direction = 1) + 
  labs(fill="fault\nconcentration") + 
  annotation_scale() +
  coord_sf(datum=NA) + 
  theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", linewidth=1.5),
        legend.position = "inside",
        legend.position.inside = c(0.92,0.8), 
        legend.box.background = element_rect(colour = "black", linewidth = 1))



## ----quake-occur, fig.width=12, fig.height=6, out.width="100%", fig.cap = "Earthquakes in Indonesia of magnitude > 5.5, 1985-2023. Categorised by magnitude as medium, large or extra-large. "----

quakes_df_temp <- quakes_df |> 
  mutate(magfact = case_when(magfact == "M" ~ "M: 5.5 - 6",
                             magfact == "L" ~ "L: 6.1 - 6.9",
                             magfact == "XL" ~ "XL: 7+")) |> 
  mutate(magfact = factor(magfact,
                          levels = c("M: 5.5 - 6",
                                     "L: 6.1 - 6.9",
                                     "XL: 7+")))
ggplot() + 
  geom_sf(data=nearby_countries_df, fill="gray50", linewidth=0.5, colour="black") +
  geom_sf(data=provinces_df, fill="antiquewhite", colour="black", linewidth=0.5) + 
  geom_sf(data=quakes_df_temp |> filter(magfact != "S") |> filter(province != "undersea"), 
          aes(fill=magfact, size=magfact), shape=21, colour="black") +
  scale_fill_manual(values = c("white","khaki","tomato4")) +
  scale_size_manual(values = c(3.5,5.5,7.5)) + 
  labs(fill="magnitude",
       size="magnitude") + 
  annotation_scale() +
  coord_sf(datum=NA) + 
  theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", linewidth=1.5),
        legend.position = "inside",
        legend.position.inside = c(0.92,0.8),
        legend.key = element_blank(),
        legend.box.background = element_rect(colour = "black", linewidth = 1))



## ----quake-totals, fig.width=12, fig.height=6, out.width="100%", fig.cap = "Earthquake count in Indonesia, 1985-2023, mag > 5.5: count by province. "----

ggplot() +
  geom_sf(data=nearby_countries_df, fill="gray50", colour="black", linewidth=0.5) +
  geom_sf(data=provinces_df, aes(fill=damaging_quakes_total), colour="black", linewidth=0.5) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill="count") + 
  annotation_scale() +
  coord_sf(datum=NA) + 
  theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", linewidth=1.5),
        legend.position = "inside",
        legend.position.inside = c(0.92,0.78),
        legend.box.background = element_rect(colour = "black", linewidth = 1))



## ----quake-conc, fig.width=12, fig.height=6, out.width="100%", fig.cap = "Earthquake incidence in Indonesia, 1985-2023, mag > 5.5: count per square kilometre by province. "----

  ggplot() +
  geom_sf(data=nearby_countries_df, fill="gray50", colour="black", linewidth=0.5) +
  geom_sf(data=provinces_df, aes(fill=damaging_quakes_density), colour="black", linewidth=0.5) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill="incidence") + 
  annotation_scale() +
  coord_sf(datum=NA) + 
  theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", linewidth=1.5),
  axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "inside",
        legend.position.inside = c(0.92,0.78),
        legend.box.background = element_rect(colour = "black", linewidth = 1))



## ----ind-contig1, fig.width=12, fig.height=6, echo=TRUE, out.width="100%", eval=knitr::is_latex_output(), fig.cap = "(ref:my-caption1)"----
# join islands to k=2 nearest neighbours
# various arguments exist for altering colours and sizes
# additional ggplot themes and layers can be added

st_bridges(provinces_df, "province", link_islands_k = 2) |> 
  st_quickmap_nb(fillcol = "antiquewhite1", 
                 bordercol = "black", bordersize = 0.5, 
                 linkcol = "darkblue", linksize = 0.8, 
                 pointcol = "red", pointsize = 2) + 
  theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", 
                                        linewidth=1.5),
        axis.text = element_blank()) +
  geom_sf(data=nearby_countries_df, 
          fill="gray50", linewidth=0.5, colour="black")



## ----ind-contig1html, fig.width=12, fig.height=6, echo=FALSE, out.width="100%", eval=knitr::is_html_output(), fig.cap = "Neighbourhood structure for Indonesian provinces created by st_bridges() with k=2. "----
# # join islands to k=2 nearest neighbours
# # various arguments exist for altering colours and sizes
# # additional ggplot themes and layers can be added
# 
# st_bridges(provinces_df, "province", link_islands_k = 2) |>
#   st_quickmap_nb(fillcol = "antiquewhite1",
#                  bordercol = "black", bordersize = 0.5,
#                  linkcol = "darkblue", linksize = 0.8,
#                  pointcol = "red", pointsize = 2) +
#   theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black",
#                                         linewidth=1.5),
#         axis.text = element_blank()) +
#   geom_sf(data=nearby_countries_df,
#           fill="gray50", linewidth=0.5, colour="black")
# 


## ----ind-contig2, fig.width=12, fig.height=6, echo=FALSE, out.width="100%", eval=knitr::is_latex_output(), fig.cap = "(ref:my-caption2)"----
# with 'concavehull = TRUE' and 'nodes = "numeric"'

st_bridges(provinces_df, "province", link_islands_k = 2) |> 
  st_quickmap_nb(fillcol = "antiquewhite1", 
                 bordercol = "black", bordersize = 0.5, 
                 linkcol = "tomato", linksize = 0.5, 
                 nodes = "numeric", 
                 numericcol = "black", numericsize = 6, 
                 concavehull = TRUE, 
                 hullcol = "darkgreen", hullsize = 0.2) + 
  theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", 
                                        linewidth=1.5),
        axis.text = element_blank())



## ----ind-contig2html, fig.width=12, fig.height=6, echo=TRUE, out.width="100%", eval=knitr::is_html_output(), fig.cap = "Neighbourhood structure for Indonesian provinces. Viewed with st\\_quickmap_nb(), using the arguments nodes = 'numeric' and concavehull = TRUE. "----
# # with 'concavehull = TRUE' and 'nodes = "numeric"'
# 
# st_bridges(provinces_df, "province", link_islands_k = 2) |>
#   st_quickmap_nb(fillcol = "antiquewhite1",
#                  bordercol = "black", bordersize = 0.5,
#                  linkcol = "tomato", linksize = 0.5,
#                  nodes = "numeric",
#                  numericcol = "black", numericsize = 6,
#                  concavehull = TRUE,
#                  hullcol = "darkgreen", hullsize = 0.2) +
#   theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black",
#                                         linewidth=1.5),
#         axis.text = element_blank())
# 


## ----ind-contig3, fig.width=12, fig.height=6, echo=TRUE, out.width="100%", eval=knitr::is_latex_output(), fig.cap = "(ref:my-caption3)"----
# a series of forced joins and cuts by index number

joins_df <- tribble(
  ~x, ~y,
  1, 24,
  1, 30,
  3, 13,
  13, 17,
  14, 25,
  20, 29,
  19, 23,
  16, 27,
  22, 23,
  7, 19,
  7, 20,
  19, 28,
  4, 18,
  21, 26,
  22, 28
)

st_bridges(provinces_df, "province", link_islands_k = 2) |> 
  st_force_join_nb(xy_df = joins_df) |> 
  st_force_cut_nb(19,22) |> 
  st_quickmap_nb(fillcol = "antiquewhite1", 
                 bordercol = "black", bordersize = 0.5, 
                 linkcol = "darkblue", linksize = 0.8, 
                 pointcol = "red", pointsize = 2) + 
  theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", 
                                        linewidth=1.5),
        axis.text = element_blank()) +
  geom_sf(data=nearby_countries_df, 
          fill="gray50", linewidth=0.5, colour="black") + 
  annotation_scale()



## ----ind-contig3html, fig.width=12, fig.height=6, echo=FALSE, out.width="100%", eval=knitr::is_html_output(), fig.cap = "Neighbourhood structure for Indonesian provinces, after alterations using st\\_force_join() and st\\_force_cut().  As many connections are being enforced at once, we can feed these to the function as a data frame rather than using consecutive function calls as before. "----
# # a series of forced joins and cuts by index number
# 
# joins_df <- tribble(
#   ~x, ~y,
#   1, 24,
#   1, 30,
#   3, 13,
#   13, 17,
#   14, 25,
#   20, 29,
#   19, 23,
#   16, 27,
#   22, 23,
#   7, 19,
#   7, 20,
#   19, 28,
#   4, 18,
#   21, 26,
#   22, 28
# )
# 
# st_bridges(provinces_df, "province", link_islands_k = 2) |>
#   st_force_join_nb(xy_df = joins_df) |>
#   st_force_cut_nb(19,22) |>
#   st_quickmap_nb(fillcol = "antiquewhite1",
#                  bordercol = "black", bordersize = 0.5,
#                  linkcol = "darkblue", linksize = 0.8,
#                  pointcol = "red", pointsize = 2) +
#   theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black",
#                                         linewidth=1.5),
#         axis.text = element_blank()) +
#   geom_sf(data=nearby_countries_df,
#           fill="gray50", linewidth=0.5, colour="black") +
#   annotation_scale()
# 


## ----fig.width=12, fig.height=6-----------------------------------------------

provinces_df$province <- factor(provinces_df$province)

prep_data <- st_bridges(provinces_df, "province",link_islands_k = 2) |> 
  st_force_join_nb(xy_df = joins_df) |> 
  st_force_cut_nb(19,22)



## ----echo=TRUE----------------------------------------------------------------

mod_pois_mrf <- gam(damaging_quakes_total ~ 
                      fault_concentration +
                      s(province, bs='mrf', xt=list(nb=prep_data$nb), k=24) +
                      offset(log(area_province)),
                    data=prep_data, method="REML",family = "poisson")



## -----------------------------------------------------------------------------
summary(mod_pois_mrf)


## ----eval=FALSE---------------------------------------------------------------
# # these two are equivalent
# 
# AER::dispersiontest(mod_pois_mrf)
# # AER::dispersiontest(mod_pois_mrf,trafo = 1)


## ----echo=knitr::is_html_output(), eval=knitr::is_html_output()---------------
# # column names of augmented dataframe
# 
# mod_pois_mrf |>
#   st_augment(prep_data) |>
#   names()


## ----echo=knitr::is_latex_output(), eval=knitr::is_latex_output()-------------
# column names of augmented dataframe

mod_pois_mrf |>
  st_augment(prep_data) |>
  names() |>
  dput()


## ----ind-mrf1, fig.width=12, fig.height=6, echo=TRUE, out.width="100%", eval=knitr::is_latex_output(), fig.cap = "(ref:my-caption4)"----
# st_quickmap_preds() outputs a list of ggplots

plot_mrf <- mod_pois_mrf |> 
  st_augment(prep_data) |>
  st_quickmap_preds(scale_low = "darkgreen",
                    scale_mid = "ivory", 
                    scale_high = "darkred", 
                    scale_midpoint = 0)

# in this case, there is only one plot in the list
# so we call it by index
# it is then supplemented with additional ggplot functions

plot_mrf[[1]] +
  coord_sf(datum=NA, default = TRUE) +
  theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", 
                                        linewidth=1.5),
        axis.text = element_blank()) +
  geom_sf(data=provinces_df, fill=NA, colour="black", linewidth=0.5) + 
  geom_sf(data=nearby_countries_df, fill="gray50", colour="black", 
          linewidth=0.5) + 
  labs(fill="relative\nincidence") +
  annotation_scale() +
  coord_sf(datum=NA, default = TRUE) +
  theme(legend.position = "inside",
        legend.position.inside = c(0.92,0.77),
        legend.box.background = element_rect(colour = "black", linewidth = 1),
        legend.title = element_text())



## ----ind-mrf1html, fig.width=12, fig.height=6, echo=FALSE, out.width="100%", eval=knitr::is_html_output(), fig.cap = "Estimates of $\\gamma_i$ using st_quickmap_preds(). "----
# # st_quickmap_preds() outputs a list of ggplots
# 
# plot_mrf <- mod_pois_mrf |>
#   st_augment(prep_data) |>
#   st_quickmap_preds(scale_low = "darkgreen",
#                     scale_mid = "ivory",
#                     scale_high = "darkred",
#                     scale_midpoint = 0)
# 
# # in this case, there is only one plot in the list
# 
# plot_mrf[[1]] +
#   coord_sf(datum=NA, default = TRUE) +
#   theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black",
#                                         linewidth=1.5),
#         axis.text = element_blank()) +
#   geom_sf(data=provinces_df, fill=NA, colour="black", linewidth=0.5) +
#   geom_sf(data=nearby_countries_df, fill="gray50", colour="black",
#           linewidth=0.5) +
#   labs(fill="relative\nincidence") +
#   annotation_scale() +
#   coord_sf(datum=NA, default = TRUE) +
#   theme(legend.position = "inside",
#         legend.position.inside = c(0.92,0.77),
#         legend.box.background = element_rect(colour = "black", linewidth = 1),
#         legend.title = element_text())
# 


## ----ind-mrf2, fig.width=12, fig.height=6, out.width="100%", eval=knitr::is_latex_output(), fig.cap = "(ref:my-caption5)"----

qpois_mod_aug <- mod_pois_mrf |> 
  st_augment(prep_data)

largest <- qpois_mod_aug |> 
  arrange(desc(mrf.smooth.province)) |> 
  head(3)
smallest <- qpois_mod_aug |> 
  arrange(mrf.smooth.province) |> 
  head(2)

ggplot() + 
  geom_sf(data=nearby_countries_df, 
          fill="gray50", colour="black", linewidth=0.5) + 
  geom_sf(data=qpois_mod_aug, aes(fill=exp(mrf.smooth.province)), 
          colour="black", linewidth=0.5) + 
  geom_sf_label(data=largest,
                      aes(label=paste(province,":",
                                      round(exp(mrf.smooth.province),1))),
                      colour="darkred", size=2.5, fill="white", alpha=0.9, 
                nudge_y= 130000, nudge_x = 130000) +
  geom_sf_label(data=smallest |> mutate(geometry=st_centroid(geometry)),
               aes(label=paste(province,":",round(exp(mrf.smooth.province),3))),
               size=2.5, fill="white", alpha=0.9) +
  scale_fill_gradient2(low = "darkgreen", 
                       mid = "ivory", 
                       high = "darkred", 
                       midpoint = 1) +
  scale_colour_gradient2(low = "darkgreen", 
                         mid = "ivory", 
                         high = "darkred", 
                         midpoint = 1) +
  guides(colour="none") + 
  labs(fill="exp.\nrelative\nincidence") + 
  annotation_scale() +
  coord_sf(datum=NA) + 
  theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", linewidth=1.5), 
        axis.title = element_blank(),
        axis.ticks = element_blank(), 
        legend.position = "inside",
        legend.position.inside = c(0.92,0.76),
        legend.box.background = element_rect(colour = "black", linewidth = 1))



## ----ind-mrf2html, fig.width=12, fig.height=6, out.width="100%", eval=knitr::is_html_output(), fig.cap = "Map showing estimates of exp($\\gamma_i$). This is produced by adding an additional column to the dataframe produced by st_augment()."----
# 
# qpois_mod_aug <- mod_pois_mrf |>
#   st_augment(prep_data)
# 
# largest <- qpois_mod_aug |>
#   arrange(desc(mrf.smooth.province)) |>
#   head(3)
# smallest <- qpois_mod_aug |>
#   arrange(mrf.smooth.province) |>
#   head(2)
# 
# ggplot() +
#   geom_sf(data=nearby_countries_df,
#           fill="gray50", colour="black", linewidth=0.5) +
#   geom_sf(data=qpois_mod_aug, aes(fill=exp(mrf.smooth.province)),
#           colour="black", linewidth=0.5) +
#   geom_sf_label(data=largest,
#                       aes(label=paste(province,":",
#                                       round(exp(mrf.smooth.province),1))),
#                       colour="darkred", size=2.5, fill="white", alpha=0.9,
#                 nudge_y= 130000, nudge_x = 130000) +
#   geom_sf_label(data=smallest |> mutate(geometry=st_centroid(geometry)),
#                aes(label=paste(province,":",round(exp(mrf.smooth.province),3))),
#                size=2.5, fill="white", alpha=0.9) +
#   scale_fill_gradient2(low = "darkgreen",
#                        mid = "ivory",
#                        high = "darkred",
#                        midpoint = 1) +
#   scale_colour_gradient2(low = "darkgreen",
#                          mid = "ivory",
#                          high = "darkred",
#                          midpoint = 1) +
#   guides(colour="none") +
#   labs(fill="exp.\nrelative\nincidence") +
#   annotation_scale() +
#   coord_sf(datum=NA) +
#   theme(panel.background = element_rect(fill = "#ECF6F7", colour = "black", linewidth=1.5),
#         axis.title = element_blank(),
#         axis.ticks = element_blank(),
#         legend.position = "inside",
#         legend.position.inside = c(0.92,0.76),
#         legend.box.background = element_rect(colour = "black", linewidth = 1))
# 


## ----eval=FALSE, echo=TRUE----------------------------------------------------
# # workflow:
# 
# # 1. set up neighbourhood structure
# 
# prep_data <- st_bridges(provinces_df, "province")
# 
# # 2. define model
# 
# mod <- gam(quake_mlxl_total ~
#                   fault_concentration +
#                   s(province, bs='mrf', xt=list(nb=prep_data$nb), k=22) +
#                   offset(log(area_province)),
#         data=prep_data, method="REML",family = "poisson")
# 
# # 3. augment tidy estimates
# 
# tidy_ests <- st_augment(mod, prep_data)
# 
# # 4. visualise them
# 
# st_quickmap_preds(tidy_ests)


## ----message=TRUE, echo=TRUE--------------------------------------------------
st_bridges(london, "GSS_CODE") |> 
  st_check_islands()


## ----lon-contig1, fig.width=12, fig.height=8, echo=TRUE, out.width="100%", fig.cap = "Wards of Greater London. Queen contiguity. ", message=TRUE----
# same as sfdep:st_contiguity() as there are no islands
# an extra layer for the river Thames

st_bridges(london, "GSS_CODE") |> 
  st_quickmap_nb() + 
  geom_sf(data=thames, colour="blue", linewidth=1.5) + 
  theme(panel.background = element_rect(fill = "#F6F3E9", colour = "black", 
                                        linewidth=1.5))


## ----lon-contig2, fig.width=12, fig.height=6, echo=TRUE, out.width="100%", fig.cap = "Riverside wards of Greater London. Queen contiguity disregarding river. "----
# which wards are alongside the river

riverside <- thames |> st_intersects(london) |> unlist() |> unique()

# only map these wards

st_bridges(london[riverside,],"NAME") |> 
  st_quickmap_nb(linksize = 0.5) +
  geom_sf(data=thames, colour="blue", linewidth=1.5) + 
  annotation_scale(location="br") +
  coord_sf(datum=NA) + 
  theme(panel.background = element_rect(fill = "#F6F3E9", colour = "black", 
                                        linewidth=1.5))


## ----lon-crossings, fig.width=12, fig.height=6, out.width="100%", fig.cap = "Riverside wards of Greater London. Road and pedestrian crossing and tunnels surrounded by 1 kilometre buffer shaded green. "----

ggplot() + 
  geom_sf(data=london[riverside,], fill="gray90", colour="gray50", linewidth=0.5) + 
  geom_sf(data=crossings_roadped |> st_buffer(1000), fill="darkgreen", alpha=0.4) + 
  geom_sf(data=thames, colour="blue", linewidth=1.5) + 
  geom_sf(data=crossings_roadped, size=1, colour="yellow") + 
  geom_label_repel(data=crossings_roadped[1:11,], 
                   aes(label=crossing, x=st_coordinates(geometry)[,1], y=st_coordinates(geometry)[,2]), 
                   size=2.5, nudge_y=-10000, fill="white", fontface="bold") + 
  geom_label_repel(data=crossings_roadped[12:22,], 
                   aes(label=crossing, x=st_coordinates(geometry)[,1], y=st_coordinates(geometry)[,2]), 
                   size=2.5, nudge_y=10000, fill="white", fontface="bold") +
  annotation_scale(location="br") +
  coord_sf(datum=NA)



## -----------------------------------------------------------------------------
# which riverside units do not fall within any of the buffers...

crossing_buffer_summarised <- crossings_roadped |> 
  st_buffer(1000) |> 
  st_transform(st_crs(london)) |> 
  summarise()

touch_buffer <- st_intersects(london[riverside,],
                              crossing_buffer_summarised)
indices <- c()
for (i in seq_along(touch_buffer)) {
  if (length(touch_buffer[[i]]) == 0) {
    indices <- c(indices, i)
  }
}
indices <- which(sapply(touch_buffer, length) == 0)

no_touch_buffer <- london[riverside,][indices,]


## ----lon-contig3, fig.width=12, fig.height=6, echo=TRUE, out.width="100%", fig.cap = "Riverside wards of Greater London. Index number for each ward shown at centroid. Wards which are not within 1 kilometre of a crossing are shaded pink. "----
# with 'nodes = "numeric"'

st_bridges(london[riverside,],"NAME") |> 
  st_quickmap_nb(nodes = "numeric", numericsize = 4, linksize = 0.5) +
  geom_sf(data=no_touch_buffer, fill="pink", alpha=0.3) + 
  geom_sf(data=crossings_roadped |> st_buffer(1000), 
          fill="darkgreen", alpha=0.3) +
  geom_sf(data=thames, colour="blue", linewidth=1.5) + 
  geom_sf(data=crossings_roadped, size=1, colour="yellow") + 
  annotation_scale(location="br") +
  coord_sf(datum=NA) + 
  theme(panel.background = element_rect(fill = "#F6F3E9", colour = "black", 
                                        linewidth=1.5))


## ----lon-contig4, fig.width=12, fig.height=6, echo=TRUE, out.width="100%", fig.cap = "Riverside wards of Greater London. Contiguities across the river have been cut for the pink wards. "----
# enforce cuts for the links where there is no crossing

cut_df <- tribble(
  ~x, ~y,
  18, 17,
  19, 17,
  19, 20,
  20, 21,
  21, 22,
  47, 48,
  45, 46,
  45, 47,
  39, 65,
  1, 2
)
st_bridges(london[riverside,], "NAME") |> 
  st_force_cut_nb(xy_df = cut_df) |> 
  st_quickmap_nb(bordercol = "black", bordersize = 0.5, linksize = 0.5) +
  geom_sf(data=no_touch_buffer, fill = "pink", alpha = 0.3) + 
  geom_sf(data=crossings_roadped |> st_buffer(1000), 
          fill= "darkgreen", alpha = 0.3) +
  geom_sf(data=thames, colour = "blue", linewidth = 1.5) +
  annotation_scale(location = "br") +
  coord_sf(datum=NA) + 
  theme(panel.background = element_rect(fill = "#F6F3E9", colour = "black", 
                                        linewidth = 1.5))

