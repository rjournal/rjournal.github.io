<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

<style>
  div.csl-bib-body { }
  div.csl-entry {
    clear: both;
    }
  .hanging div.csl-entry {
    margin-left:2em;
    text-indent:-2em;
  }
  div.csl-left-margin {
    min-width:2em;
    float:left;
  }
  div.csl-right-inline {
    margin-left:2em;
    padding-left:1em;
  }
  div.csl-indent {
    margin-left: 2em;
  }
</style>

  <!--radix_placeholder_meta_tags-->
<title>Sparse Model Matrices for Multidimensional Hierarchical Aggregation</title>

<meta property="description" itemprop="description" content="Multidimensional hierarchical sum aggregations can be formulated as matrix multiplications involving dummy matrices which can be referred to as model matrices. In contrast to standard model matrices, all categories of all variables must be included. For this purpose, the R package SSBtools includes functionality to create model matrices in two alternative ways, by model formulas or by so-called hierarchies. The latter means a coding of hierarchical relationships, and this can be done in several ways. Tree-shaped hierarchies are not required. The internal standard in the package is a parent-child coding. Functionality to find hierarchies automatically from the data is also included. The model matrix functionality is applied in several R packages for statistical disclosure control. This enables general implementation of methods and a flexible user interface. This paper describes the model matrix and hierarchy functions in SSBtools, as well as the methods and functions behind it."/>

<link rel="canonical" href="https://doi.org/10.32614/RJ-2023-088/"/>
<link rel="license" href="https://creativecommons.org/licenses/by/4.0/"/>
<link rel="icon" type="image/vnd.microsoft.icon" href="../../resources/favicon.ico"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2024-04-11"/>
<meta property="article:created" itemprop="dateCreated" content="2024-04-11"/>
<meta name="article:author" content="Øyvind Langsrud"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="Sparse Model Matrices for Multidimensional Hierarchical Aggregation"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="Multidimensional hierarchical sum aggregations can be formulated as matrix multiplications involving dummy matrices which can be referred to as model matrices. In contrast to standard model matrices, all categories of all variables must be included. For this purpose, the R package SSBtools includes functionality to create model matrices in two alternative ways, by model formulas or by so-called hierarchies. The latter means a coding of hierarchical relationships, and this can be done in several ways. Tree-shaped hierarchies are not required. The internal standard in the package is a parent-child coding. Functionality to find hierarchies automatically from the data is also included. The model matrix functionality is applied in several R packages for statistical disclosure control. This enables general implementation of methods and a flexible user interface. This paper describes the model matrix and hierarchy functions in SSBtools, as well as the methods and functions behind it."/>
<meta property="og:url" content="https://doi.org/10.32614/RJ-2023-088/"/>
<meta property="og:image" content="https://journal.r-project.org/articles/RJ-2023-088/figures/young_old_EU_nonEU_Total.png"/>
<meta property="og:image:width" content="2360"/>
<meta property="og:image:height" content="1152"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="The R Journal"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="Sparse Model Matrices for Multidimensional Hierarchical Aggregation"/>
<meta property="twitter:description" content="Multidimensional hierarchical sum aggregations can be formulated as matrix multiplications involving dummy matrices which can be referred to as model matrices. In contrast to standard model matrices, all categories of all variables must be included. For this purpose, the R package SSBtools includes functionality to create model matrices in two alternative ways, by model formulas or by so-called hierarchies. The latter means a coding of hierarchical relationships, and this can be done in several ways. Tree-shaped hierarchies are not required. The internal standard in the package is a parent-child coding. Functionality to find hierarchies automatically from the data is also included. The model matrix functionality is applied in several R packages for statistical disclosure control. This enables general implementation of methods and a flexible user interface. This paper describes the model matrix and hierarchy functions in SSBtools, as well as the methods and functions behind it."/>
<meta property="twitter:url" content="https://doi.org/10.32614/RJ-2023-088/"/>
<meta property="twitter:image" content="https://journal.r-project.org/articles/RJ-2023-088/figures/young_old_EU_nonEU_Total.png"/>
<meta property="twitter:image:width" content="2360"/>
<meta property="twitter:image:height" content="1152"/>

<!--  https://scholar.google.com/intl/en/scholar/inclusion.html#indexing -->
<meta name="citation_title" content="Sparse Model Matrices for Multidimensional Hierarchical Aggregation"/>
<meta name="citation_fulltext_html_url" content="https://doi.org/10.32614/RJ-2023-088"/>
<meta name="citation_pdf_url" content="RJ-2023-088.pdf"/>
<meta name="citation_volume" content="15"/>
<meta name="citation_issue" content="4"/>
<meta name="citation_doi" content="10.32614/RJ-2023-088"/>
<meta name="citation_journal_title" content="The R Journal"/>
<meta name="citation_issn" content="2073-4859"/>
<meta name="citation_firstpage" content="150"/>
<meta name="citation_lastpage" content="166"/>
<meta name="citation_fulltext_world_readable" content=""/>
<meta name="citation_online_date" content="2024/04/11"/>
<meta name="citation_publication_date" content="2024/04/11"/>
<meta name="citation_author" content="Øyvind Langsrud"/>
<meta name="citation_author_institution" content="Statistics Norway"/>
<!--/radix_placeholder_meta_tags-->
  
  <meta name="citation_reference" content="citation_title=Statistical disclosure control;citation_publisher=John Wiley &amp; Sons, Ltd;citation_doi=10.1002/9781118348239.ch1;citation_author=Anco Hundepool;citation_author=Josep Domingo-Ferrer;citation_author=Luisa Franconi;citation_author=Sarah Giessing;citation_author=Eric Schulte Nordholt;citation_author=Keith Spicer;citation_author=Peter-Paul Wolf"/>
  <meta name="citation_reference" content="citation_title=Methodology for the automatic confidentialisation of statistical outputs from remote servers at the Australian Bureau of Statistics;citation_publisher=Joint UNECE/Eurostat Work Session on Statistical Data;citation_author=G. Thompson;citation_author=S. Broadfoot;citation_author=D. Elazar"/>
  <meta name="citation_reference" content="citation_title=An Algorithm for Small Count Rounding of Tabular Data;citation_publisher=Privacy in statistical databases, Valencia, Spain;citation_author=Øyvind Langsrud;citation_author=Johan Heldal"/>
  <meta name="citation_reference" content="citation_title=GaussSuppression: Tabular data suppression using gaussian elimination;citation_author=Øyvind Langsrud;citation_author=Daniel Lupp"/>
  <meta name="citation_reference" content="citation_title=SSBcellKey: Cell-key method for tabular data;citation_author=Daniel Lupp;citation_author=Øyvind Langsrud"/>
  <meta name="citation_reference" content="citation_title=Kostra: Functions for kostra;citation_author=Magnar Lillegård;citation_author=Anna-Karin Mevik;citation_author=Johan Heldal;citation_author=Øyvind Langsrud"/>
  <meta name="citation_reference" content="citation_title=SmallCountRounding: Small count rounding of tabular data;citation_author=Øyvind Langsrud;citation_author=Johan Heldal"/>
  <meta name="citation_reference" content="citation_title=easySdcTable: Easy interface to the statistical disclosure control package ’sdcTable’ extended with own implementation of ’GaussSuppression’;citation_author=Øyvind Langsrud"/>
  <meta name="citation_reference" content="citation_title=sdcTable: Methods for statistical disclosure control in tabular data;citation_author=Bernhard Meindl"/>
  <meta name="citation_reference" content="citation_title=peakRAM: Monitor the total and peak RAM used by an expression or function;citation_author=Thomas Quinn"/>
  <meta name="citation_reference" content="citation_title=The igraph software package for complex network research;citation_volume=Complex Systems;citation_author=Gabor Csardi;citation_author=Tamas Nepusz"/>
  <meta name="citation_reference" content="citation_title=tau-ARGUS user’s manual, version 4.1;citation_publisher=Statistics Netherlands;citation_author=Peter-Paul Wolf;citation_author=Anco Hundepool;citation_author=Sarah Giessing;citation_author=Juan-José Salazar;citation_author=Jordi Castro"/>
  <meta name="citation_reference" content="citation_title=Validation &amp; transformation language, part 2 library of operators, version 1.0;citation_author=Sami Airo;citation_author=Foteini Andrikopoulou;citation_author=David Barraclough;citation_author=Luigi Bellomarini;citation_author=Marc Bouffard;citation_author=Maurizio Capaccioli;citation_author=Vincenzo Vecchio;citation_author=Fabio Giovanni;citation_author=Jens Dossé;citation_author=Heinrich Ehrmann;citation_author=Bryan Fitzpatrick;citation_author=Arofan Gregory;citation_author=Edgardo Greising;citation_author=Angelo Linardi;citation_author=Chris Nelson;citation_author=Stratos Nikoloutsos;citation_author=Marco Pellegrino;citation_author=Michele Romanelli;citation_author=Juan Sanchez;citation_author=Nikolaos Zisimos"/>
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","type","header-includes","date","date_received","journal","volume","issue","slug","packages","draft","preview","bibliography","CTV","output","pdf_url","citation_url","doi","creative_commons","csl","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["Sparse Model Matrices for Multidimensional Hierarchical Aggregation"]},{"type":"character","attributes":{},"value":["Multidimensional hierarchical sum aggregations can be formulated as matrix multiplications involving dummy matrices which can be referred to as model matrices. In contrast to standard model matrices, all categories of all variables must be included. For this purpose, the R package SSBtools includes functionality to create model matrices in two alternative ways, by model formulas or by so-called hierarchies. The latter means a coding of hierarchical relationships, and this can be done in several ways. Tree-shaped hierarchies are not required. The internal standard in the package is a parent-child coding. Functionality to find hierarchies automatically from the data is also included. The model matrix functionality is applied in several R packages for statistical disclosure control. This enables general implementation of methods and a flexible user interface. This paper describes the model matrix and hierarchy functions in SSBtools, as well as the methods and functions behind it."]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation","address","url","orcid_id","email"]}},"value":[{"type":"character","attributes":{},"value":["Øyvind Langsrud"]},{"type":"character","attributes":{},"value":["Statistics Norway"]},{"type":"character","attributes":{},"value":["P.O. Box 8131 Dep.,","0033 Oslo, Norway"]},{"type":"character","attributes":{},"value":["https://github.com/olangsrud"]},{"type":"character","attributes":{},"value":["0000-0002-1380-4396"]},{"type":"character","attributes":{},"value":["Oyvind.Langsrud@ssb.no"]}]}]},{"type":"character","attributes":{},"value":["package"]},{"type":"character","attributes":{},"value":["\\usepackage{longtable}"]},{"type":"character","attributes":{},"value":["2024-04-11"]},{"type":"character","attributes":{},"value":["2023-01-17"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","issn","firstpage","lastpage"]}},"value":[{"type":"character","attributes":{},"value":["The R Journal"]},{"type":"character","attributes":{},"value":["2073-4859"]},{"type":"integer","attributes":{},"value":[150]},{"type":"integer","attributes":{},"value":[166]}]},{"type":"integer","attributes":{},"value":[15]},{"type":"integer","attributes":{},"value":[4]},{"type":"character","attributes":{},"value":["RJ-2023-088"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["cran","bioc"]}},"value":[{"type":"NULL"},{"type":"NULL"}]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["preview.png"]},{"type":"character","attributes":{},"value":["langsrud-sparse-model-matrices.bib"]},{"type":"list","attributes":{},"value":[]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","legacy_pdf"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]}]}]},{"type":"character","attributes":{},"value":["RJ-2023-088.pdf"]},{"type":"character","attributes":{},"value":["https://doi.org/10.32614/RJ-2023-088"]},{"type":"character","attributes":{},"value":["10.32614/RJ-2023-088"]},{"type":"character","attributes":{},"value":["CC BY"]},{"type":"character","attributes":{},"value":["/Library/Frameworks/R.framework/Versions/sitelib-4.4-arm64/rjtools/rjournal.csl"]},{"type":"character","attributes":{},"value":["https://doi.org/10.32614/RJ-2023-088/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["figures/Function_Art_hierarchy.png","figures/young_old_EU_nonEU_Total.png","langsrud-sparse-model-matrices.bib","langsrud-sparse-model-matrices.pdf","langsrud-sparse-model-matrices.tex","preamble.tex","RJ-2023-088.log","RJ-2023-088.pdf","RJ-2023-088.Rmd-rj","RJ-2023-088.tex","RJournal.sty","RJwrapper.aux","RJwrapper.log","RJwrapper.out","RJwrapper.tex","Rlogo-5.png"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
<meta name="distill:offset" content="../.."/>

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      tolerance: 5,
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #0F2E3D;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
  min-width: 150px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative; min-height: 500px; }
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

/* adjust viewport for navbar height */
/* helps vertically center bootstrap (non-distill) content */
.min-vh-100 {
  min-height: calc(100vh - 100px) !important;
}

</style>

<script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../site_libs/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

d-byline .byline {
  grid-template-columns: 2fr 2fr;
}

d-byline .byline h3 {
  margin-block-start: 1.5em;
}

d-byline .byline .authors-affiliations h3 {
  margin-block-start: 0.5em;
}

.authors-affiliations .orcid-id {
  width: 16px;
  height:16px;
  margin-left: 4px;
  margin-right: 4px;
  vertical-align: middle;
  padding-bottom: 2px;
}

d-title .dt-tags {
  margin-top: 1em;
  grid-column: text;
}

.dt-tags .dt-tag {
  text-decoration: none;
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0em 0.4em;
  margin-right: 0.5em;
  margin-bottom: 0.4em;
  font-size: 70%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

d-article table.gt_table td,
d-article table.gt_table th {
  border-bottom: none;
  font-size: 100%;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

hr.section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  margin: 0px;
}


d-byline {
  border-top: none;
}

d-article {
  padding-top: 2.5rem;
  padding-bottom: 30px;
  border-top: none;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article h2 {
  margin: 1rem 0 1.5rem 0;
}

d-article h3 {
  margin-top: 1.5rem;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

/* Tweak code blocks */

d-article div.sourceCode code,
d-article pre code {
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: auto;
}

d-article div.sourceCode {
  background-color: white;
}

d-article div.sourceCode pre {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

d-article pre a {
  border-bottom: none;
}

d-article pre a:hover {
  border-bottom: none;
  text-decoration: underline;
}

d-article details {
  grid-column: text;
  margin-bottom: 0.8em;
}

@media(min-width: 768px) {

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: visible !important;
}

d-article div.sourceCode pre {
  padding-left: 18px;
  font-size: 14px;
}

/* tweak for Pandoc numbered line within distill */
d-article pre.numberSource code > span {
    left: -2em;
}

d-article pre {
  font-size: 14px;
}

}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for d-contents */

.d-contents {
  grid-column: text;
  color: rgba(0,0,0,0.8);
  font-size: 0.9em;
  padding-bottom: 1em;
  margin-bottom: 1em;
  padding-bottom: 0.5em;
  margin-bottom: 1em;
  padding-left: 0.25em;
  justify-self: start;
}

@media(min-width: 1000px) {
  .d-contents.d-contents-float {
    height: 0;
    grid-column-start: 1;
    grid-column-end: 4;
    justify-self: center;
    padding-right: 3em;
    padding-left: 2em;
  }
}

.d-contents nav h3 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 1em;
}

.d-contents li {
  list-style-type: none
}

.d-contents nav > ul {
  padding-left: 0;
}

.d-contents ul {
  padding-left: 1em
}

.d-contents nav ul li {
  margin-top: 0.6em;
  margin-bottom: 0.2em;
}

.d-contents nav a {
  font-size: 13px;
  border-bottom: none;
  text-decoration: none
  color: rgba(0, 0, 0, 0.8);
}

.d-contents nav a:hover {
  text-decoration: underline solid rgba(0, 0, 0, 0.6)
}

.d-contents nav > ul > li > a {
  font-weight: 600;
}

.d-contents nav > ul > li > ul {
  font-weight: inherit;
}

.d-contents nav > ul > li > ul > li {
  margin-top: 0.2em;
}


.d-contents nav ul {
  margin-top: 0;
  margin-bottom: 0.25em;
}

.d-article-with-toc h2:nth-child(2) {
  margin-top: 0;
}


/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

/* Citations */

d-article .citation {
  color: inherit;
  cursor: inherit;
}

div.hanging-indent{
  margin-left: 1em; text-indent: -1em;
}

/* Citation hover box */

.tippy-box[data-theme~=light-border] {
  background-color: rgba(250, 250, 250, 0.95);
}

.tippy-content > p {
  margin-bottom: 0;
  padding: 2px;
}


/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Include appendix styles here so they can be overridden */

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

/* Include footnote styles here so they can be overridden */

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}



/* Anchor.js */

.anchorjs-link {
  /*transition: all .25s linear; */
  text-decoration: none;
  border-bottom: none;
}
*:hover > .anchorjs-link {
  margin-left: -1.125em !important;
  text-decoration: none;
  border-bottom: none;
}

/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


.sidebar-section.custom {
  font-size: 12px;
  line-height: 1.6em;
}

.custom p {
  margin-bottom: 0.5em;
}

/* Styles for listing layout (hide title) */
.layout-listing d-title, .layout-listing .d-title {
  display: none;
}

/* Styles for posts lists (not auto-injected) */


.posts-with-sidebar {
  padding-left: 45px;
  padding-right: 45px;
}

.posts-list .description h2,
.posts-list .description p {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

.posts-list .description h2 {
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
}

.posts-list h2.post-tag {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  padding-bottom: 12px;
}
.posts-list {
  margin-top: 60px;
  margin-bottom: 24px;
}

.posts-list .post-preview {
  text-decoration: none;
  overflow: hidden;
  display: block;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 24px 0;
}

.post-preview-last {
  border-bottom: none !important;
}

.posts-list .posts-list-caption {
  grid-column: screen;
  font-weight: 400;
}

.posts-list .post-preview h2 {
  margin: 0 0 6px 0;
  line-height: 1.2em;
  font-style: normal;
  font-size: 24px;
}

.posts-list .post-preview p {
  margin: 0 0 12px 0;
  line-height: 1.4em;
  font-size: 16px;
}

.posts-list .post-preview .thumbnail {
  box-sizing: border-box;
  margin-bottom: 24px;
  position: relative;
  max-width: 500px;
}
.posts-list .post-preview img {
  width: 100%;
  display: block;
}

.posts-list .metadata {
  font-size: 12px;
  line-height: 1.4em;
  margin-bottom: 18px;
}

.posts-list .metadata > * {
  display: inline-block;
}

.posts-list .metadata .publishedDate {
  margin-right: 2em;
}

.posts-list .metadata .dt-authors {
  display: block;
  margin-top: 0.3em;
  margin-right: 2em;
}

.posts-list .dt-tags {
  display: block;
  line-height: 1em;
}

.posts-list .dt-tags .dt-tag {
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0.3em 0.4em;
  margin-right: 0.2em;
  margin-bottom: 0.4em;
  font-size: 60%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

.posts-list img {
  opacity: 1;
}

.posts-list img[data-src] {
  opacity: 0;
}

.posts-more {
  clear: both;
}


.posts-sidebar {
  font-size: 16px;
}

.posts-sidebar h3 {
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0.5em;
  font-weight: 400;
  text-transform: uppercase;
}

.sidebar-section {
  margin-bottom: 30px;
}

.categories ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

.categories li {
  color: rgba(0, 0, 0, 0.8);
  margin-bottom: 0;
}

.categories li>a {
  border-bottom: none;
}

.categories li>a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
}

.categories .active {
  font-weight: 600;
}

.categories .category-count {
  color: rgba(0, 0, 0, 0.4);
}


@media(min-width: 768px) {
  .posts-list .post-preview h2 {
    font-size: 26px;
  }
  .posts-list .post-preview .thumbnail {
    float: right;
    width: 30%;
    margin-bottom: 0;
  }
  .posts-list .post-preview .description {
    float: left;
    width: 45%;
  }
  .posts-list .post-preview .metadata {
    float: left;
    width: 20%;
    margin-top: 8px;
  }
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.5em;
    font-size: 16px;
  }
  .posts-with-sidebar .posts-list {
    float: left;
    width: 75%;
  }
  .posts-with-sidebar .posts-sidebar {
    float: right;
    width: 20%;
    margin-top: 60px;
    padding-top: 24px;
    padding-bottom: 24px;
  }
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

.downlevel .posts-list .post-preview {
  color: inherit;
}



</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // add anchors
  if (window.anchors) {
    window.anchors.options.placement = 'left';
    window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
  }


  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // separator
  var separator = '<hr class="section-separator" style="clear: both"/>';
  // prepend separator above appendix
  $('.d-byline').before(separator);
  $('.d-article').before(separator);

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  // move refs into #references-listing
  $('#references-listing').replaceWith($('#refs'));

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-contents a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('details, div.sourceCode, pre, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // remove code block used to force  highlighting css
  $('.distill-force-highlighting-css').parent().remove();

  // remove empty line numbers inserted by pandoc when using a
  // custom syntax highlighting theme, except when numbering line
  // in code chunk
  $('pre:not(.numberLines) code.sourceCode a:empty').remove();

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // article with toc class
    $('.d-contents').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // add orcid ids
    $('.authors-affiliations').find('.author').each(function(i, el) {
      var orcid_id = front_matter.authors[i].orcidID;
      var author_name = front_matter.authors[i].author
      if (orcid_id) {
        var a = $('<a></a>');
        a.attr('href', 'https://orcid.org/' + orcid_id);
        var img = $('<img></img>');
        img.addClass('orcid-id');
        img.attr('alt', author_name ? 'ORCID ID for ' + author_name : 'ORCID ID');
        img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
        a.append(img);
        $(this).append(a);
      }
    });

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // remove d-appendix and d-footnote-list local styles
    $('d-appendix > style:first-child').remove();
    $('d-footnote-list > style:first-child').remove();

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // hoverable references
    $('span.citation[data-cites]').each(function() {
      const citeChild = $(this).children()[0]
      // Do not process if @xyz has been used without escaping and without bibliography activated
      // https://github.com/rstudio/distill/issues/466
      if (citeChild === undefined) return true

      if (citeChild.nodeName == "D-FOOTNOTE") {
        var fn = citeChild
        $(this).html(fn.shadowRoot.querySelector("sup"))
        $(this).id = fn.id
        fn.remove()
      }
      var refs = $(this).attr('data-cites').split(" ");
      var refHtml = refs.map(function(ref) {
        // Could use CSS.escape too here, we insure backward compatibility in navigator
        return "<p>" + $('div[id="ref-' + ref + '"]').html() + "</p>";
      }).join("\n");
      window.tippy(this, {
        allowHTML: true,
        content: refHtml,
        maxWidth: 500,
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start'
      });
    });

    // fix footnotes in tables (#411)
    // replacing broken distill.pub feature
    $('table d-footnote').each(function() {
      // we replace internal showAtNode methode which is triggered when hovering a footnote
      this.hoverBox.showAtNode = function(node) {
        // ported from https://github.com/distillpub/template/pull/105/files
        calcOffset = function(elem) {
            let x = elem.offsetLeft;
            let y = elem.offsetTop;
            // Traverse upwards until an `absolute` element is found or `elem`
            // becomes null.
            while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                x += elem.offsetLeft;
                y += elem.offsetTop;
            }

            return { left: x, top: y };
        }
        // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
        const bbox = node.getBoundingClientRect();
        const offset = calcOffset(node);
        this.show([offset.left + bbox.width, offset.top + bbox.height]);
      }
    })

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-contents').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    // ignore leaflet img layers (#106)
    figures = figures.filter(':not(img[class*="leaflet"])')
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<style type="text/css">
/* base variables */

/* Edit the CSS properties in this file to create a custom
   Distill theme. Only edit values in the right column
   for each row; values shown are the CSS defaults.
   To return any property to the default,
   you may set its value to: unset
   All rows must end with a semi-colon.                      */

/* Optional: embed custom fonts here with `@import`          */
/* This must remain at the top of this file.                 */



html {
  /*-- Main font sizes --*/
  --title-size:      50px;
  --body-size:       1.06rem;
  --code-size:       14px;
  --aside-size:      12px;
  --fig-cap-size:    13px;
  /*-- Main font colors --*/
  --title-color:     #000000;
  --header-color:    rgba(0, 0, 0, 0.8);
  --body-color:      rgba(0, 0, 0, 0.8);
  --aside-color:     rgba(0, 0, 0, 0.6);
  --fig-cap-color:   rgba(0, 0, 0, 0.6);
  /*-- Specify custom fonts ~~~ must be imported above   --*/
  --heading-font:    sans-serif;
  --mono-font:       monospace;
  --body-font:       sans-serif;
  --navbar-font:     sans-serif;  /* websites + blogs only */
}

/*-- ARTICLE METADATA --*/
d-byline {
  --heading-size:    0.6rem;
  --heading-color:   rgba(0, 0, 0, 0.5);
  --body-size:       0.8rem;
  --body-color:      rgba(0, 0, 0, 0.8);
}

/*-- ARTICLE TABLE OF CONTENTS --*/
.d-contents {
  --heading-size:    18px;
  --contents-size:   13px;
}

/*-- ARTICLE APPENDIX --*/
d-appendix {
  --heading-size:    15px;
  --heading-color:   rgba(0, 0, 0, 0.65);
  --text-size:       0.8em;
  --text-color:      rgba(0, 0, 0, 0.5);
}

/*-- WEBSITE HEADER + FOOTER --*/
/* These properties only apply to Distill sites and blogs  */

.distill-site-header {
  --title-size:       18px;
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #0F2E3D;
}

.distill-site-footer {
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #0F2E3D;
}

/*-- Additional custom styles --*/
/* Add any additional CSS rules below                      */
</style>
<style type="text/css">
/* base variables */

/* Edit the CSS properties in this file to create a custom
   Distill theme. Only edit values in the right column
   for each row; values shown are the CSS defaults.
   To return any property to the default,
   you may set its value to: unset
   All rows must end with a semi-colon.                      */

/* Optional: embed custom fonts here with `@import`          */
/* This must remain at the top of this file.                 */



html {
  /*-- Main font sizes --*/
  --title-size:      50px;
  --body-size:       1.06rem;
  --code-size:       14px;
  --aside-size:      12px;
  --fig-cap-size:    13px;
  /*-- Main font colors --*/
  --title-color:     #000000;
  --header-color:    rgba(0, 0, 0, 0.8);
  --body-color:      rgba(0, 0, 0, 0.8);
  --aside-color:     rgba(0, 0, 0, 0.6);
  --fig-cap-color:   rgba(0, 0, 0, 0.6);
  /*-- Specify custom fonts ~~~ must be imported above   --*/
  --heading-font:    sans-serif;
  --mono-font:       monospace;
  --body-font:       sans-serif;
  --navbar-font:     sans-serif;  /* websites + blogs only */
}

/*-- ARTICLE METADATA --*/
d-byline {
  --heading-size:    0.6rem;
  --heading-color:   rgba(0, 0, 0, 0.5);
  --body-size:       0.8rem;
  --body-color:      rgba(0, 0, 0, 0.8);
}

/*-- ARTICLE TABLE OF CONTENTS --*/
.d-contents {
  --heading-size:    18px;
  --contents-size:   13px;
}

/*-- ARTICLE APPENDIX --*/
d-appendix {
  --heading-size:    15px;
  --heading-color:   rgba(0, 0, 0, 0.65);
  --text-size:       0.8em;
  --text-color:      rgba(0, 0, 0, 0.7);
}

/*-- WEBSITE HEADER + FOOTER --*/
/* These properties only apply to Distill sites and blogs  */

.distill-site-header {
  --title-size:       18px;
  --text-color:       rgba(0, 0, 0, 0.8);
  --text-size:        15px;
  --hover-color:      black;
  --bkgd-color:       #ffffff;
}

.distill-site-footer {
  --text-color:       rgba(0, 0, 0, 0.8);
  --text-size:        15px;
  --hover-color:      black;
  --bkgd-color:       #fafafa;
}

/*-- Additional custom styles --*/
/* Add any additional CSS rules below                      */

.nav-right > a {
  text-transform: uppercase;
}

d-title h1, d-title p, d-title figure,
d-abstract p, d-abstract b {
  grid-column: page;
}

.rj-blue {
  color: #2467bb;
}

ul li {
  line-height: 1.6;
  margin-top: 0em;
  margin-bottom: 0em;
}</style>
<style type="text/css">
/* base style */

/* FONT FAMILIES */

:root {
  --heading-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  --mono-default: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  --body-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

body,
.posts-list .post-preview p,
.posts-list .description p {
  font-family: var(--body-font), var(--body-default);
}

h1, h2, h3, h4, h5, h6,
.posts-list .post-preview h2,
.posts-list .description h2 {
  font-family: var(--heading-font), var(--heading-default);
}

d-article div.sourceCode code,
d-article pre code {
  font-family: var(--mono-font), var(--mono-default);
}


/*-- TITLE --*/
d-title h1,
.posts-list > h1 {
  color: var(--title-color, black);
}

d-title h1 {
  font-size: var(--title-size, 50px);
}

/*-- HEADERS --*/
d-article h1,
d-article h2,
d-article h3,
d-article h4,
d-article h5,
d-article h6 {
  color: var(--header-color, rgba(0, 0, 0, 0.8));
}

/*-- BODY --*/
d-article > p,  /* only text inside of <p> tags */
d-article > ul, /* lists */
d-article > ol {
  color: var(--body-color, rgba(0, 0, 0, 0.8));
  font-size: var(--body-size, 1.06rem);
}


/*-- CODE --*/
d-article div.sourceCode code,
d-article pre code {
  font-size: var(--code-size, 14px);
}

/*-- ASIDE --*/
d-article aside {
  font-size: var(--aside-size, 12px);
  color: var(--aside-color, rgba(0, 0, 0, 0.6));
}

/*-- FIGURE CAPTIONS --*/
figure .caption,
figure figcaption,
.figure .caption {
  font-size: var(--fig-cap-size, 13px);
  color: var(--fig-cap-color, rgba(0, 0, 0, 0.6));
}

/*-- METADATA --*/
d-byline h3 {
  font-size: var(--heading-size, 0.6rem);
  color: var(--heading-color, rgba(0, 0, 0, 0.5));
}

d-byline {
  font-size: var(--body-size, 0.8rem);
  color: var(--body-color, rgba(0, 0, 0, 0.8));
}

d-byline a,
d-article d-byline a {
  color: var(--body-color, rgba(0, 0, 0, 0.8));
}

/*-- TABLE OF CONTENTS --*/
.d-contents nav h3 {
  font-size: var(--heading-size, 18px);
}

.d-contents nav a {
  font-size: var(--contents-size, 13px);
}

/*-- APPENDIX --*/
d-appendix h3 {
  font-size: var(--heading-size, 15px);
  color: var(--heading-color, rgba(0, 0, 0, 0.65));
}

d-appendix {
  font-size: var(--text-size, 0.8em);
  color: var(--text-color, rgba(0, 0, 0, 0.5));
}

d-appendix d-footnote-list a.footnote-backlink {
  color: var(--text-color, rgba(0, 0, 0, 0.5));
}

/*-- WEBSITE HEADER + FOOTER --*/
.distill-site-header .title {
  font-size: var(--title-size, 18px);
  font-family: var(--navbar-font), var(--heading-default);
}

.distill-site-header a,
.nav-dropdown .nav-dropbtn {
  font-family: var(--navbar-font), var(--heading-default);
}

.nav-dropdown .nav-dropbtn {
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  font-size: var(--text-size, 15px);
}

.distill-site-header a:hover,
.nav-dropdown:hover .nav-dropbtn {
  color: var(--hover-color, white);
}

.distill-site-header {
  font-size: var(--text-size, 15px);
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  background-color: var(--bkgd-color, #0F2E3D);
}

.distill-site-footer {
  font-size: var(--text-size, 15px);
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  background-color: var(--bkgd-color, #0F2E3D);
}

.distill-site-footer a:hover {
  color: var(--hover-color, white);
}</style>
<!--/radix_placeholder_distill-->
  <script src="../../site_libs/header-attrs-2.25/header-attrs.js"></script>
  <script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="../../site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="../../site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="../../site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="../../site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="../../site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<!--/radix_placeholder_site_in_header-->
  <script>
    $(function() {
      console.log("Starting...")

      // Always show Published - distill hides it if not set
      function show_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'visible');
      }

      show_byline_column('Published')

      // tweak function
      var rmd_meta = JSON.parse($("#radix-rmarkdown-metadata").html());
      function get_meta(name, meta) {
        var ind = meta.attributes.names.value.findIndex((e) => e == name)
        var val = meta.value[ind]
        if (val.type != 'list') {
          return val.value.toString()
        }
        return val
      }

      // tweak description
      // Add clickable tags
      const slug = get_meta('slug', rmd_meta)
      const cite_url = get_meta('citation_url', rmd_meta)

      var title = $("d-title").text

      const buttons = $('<div class="dt-tags" style="grid-column: page;">')
      buttons.append('<a href="#citation" class="dt-tag"><i class="fas fa-quote-left"></i> Cite</a>')
      buttons.append('<a href="' + slug + '.pdf" class="dt-tag"><i class="fas fa-file-pdf"></i> PDF</a>')
      buttons.append('<a href="' + slug + '.zip" class="dt-tag"><i class="fas fa-file-zipper"></i> Supplement</a>')

      // adds Abstract: in front of the first <p> in the title section --
      // unless it happens to be the subtitle (FIXME: this is a bad hack - can't distill do this?)
      var tpar = $("d-title p:not(:empty)").first();
      if (tpar && ! tpar.hasClass("subtitle")) {
        const abstract = $('<d-abstract>')
        abstract.append('<b>Abstract:</b><br>')
        abstract.append($("d-title p:not(:empty)").first()) // Move description to d-abstract
        $("d-title p:empty").remove() // Remove empty paragraphs after title
        abstract.append(buttons)
        abstract.insertAfter($('d-title')) // Add abstract section after title */
      }

      // tweak by-line
      var byline = $("d-byline div.byline")
      ind = rmd_meta.attributes.names.value.findIndex((e) => e == "journal")
      const journal = get_meta('journal', rmd_meta)
      const volume = get_meta('volume', rmd_meta)
      const issue = get_meta('issue', rmd_meta)
      const jrtitle = get_meta('title', journal)
      const year = ((jrtitle == "R News") ? 2000 : 2008) + parseInt(volume)
      const firstpage = get_meta('firstpage', journal)
      const lastpage = get_meta('lastpage', journal)
      byline.append('<div class="rjournal grid">')
      $('div.rjournal').append('<h3>Volume</h3>')
      $('div.rjournal').append('<h3>Pages</h3>')
      $('div.rjournal').append('<a class="volume" href="../../issues/'+year+'-'+issue+'">'+volume+'/'+issue+'</a>')
      $('div.rjournal').append('<p class="pages">'+firstpage+' - '+lastpage+'</p>')

      const received_date = new Date(get_meta('date_received', rmd_meta))
      byline.find('h3:contains("Published")').parent().append('<h3>Received</h3><p>'+received_date.toLocaleDateString('en-US', {month: 'short'})+' '+received_date.getDate()+', '+received_date.getFullYear()+'</p>')

    })
  </script>

  <style>
      /*
    .nav-dropdown-content .nav-dropdown-header {
      text-transform: lowercase;
    }
    */

    d-byline .byline {
      grid-template-columns: 2fr 2fr 2fr 2fr;
    }

    d-byline .rjournal {
      grid-column-end: span 2;
      grid-template-columns: 1fr 1fr;
      margin-bottom: 0;
    }

    d-title h1, d-title p, d-title figure,
    d-abstract p, d-abstract b {
      grid-column: page;
    }

    d-title .dt-tags {
      grid-column: page;
    }

    .dt-tags .dt-tag {
      text-transform: lowercase;
    }

    d-article h1 {
      line-height: 1.1em;
    }

    d-abstract p, d-article p {
      text-align: justify;
    }

    @media(min-width: 1000px) {
      .d-contents.d-contents-float {
        justify-self: end;
      }

      nav.toc {
        border-right: 1px solid rgba(0, 0, 0, 0.1);
        border-right-width: 1px;
        border-right-style: solid;
        border-right-color: rgba(0, 0, 0, 0.1);
      }
    }

    .posts-list .dt-tags .dt-tag {
      text-transform: lowercase;
    }

    @keyframes highlight-target {
      0% {
        background-color: #ffa;
      }
      66% {
        background-color: #ffa;
      }
      100% {
        background-color: none;
      }
    }

    d-article :target, d-appendix :target {
       animation: highlight-target 3s;
    }

    .header-section-number {
      margin-right: 0.5em;
    }
    
    d-appendix .citation-appendix,
    .d-appendix .citation-appendix {
      color: rgb(60, 60, 60);
    }

    d-article h2 {
      border-bottom: 0px solid rgba(0, 0, 0, 0.1);
      padding-bottom: 0rem;
    }
    d-article h3 {
      font-size: 20px;
    }
    d-article h4 {
      font-size: 18px;
      text-transform: none;
    }

    @media (min-width: 1024px) {
      d-article h2 {
        font-size: 32px;
      }
      d-article h3 {
        font-size: 24px;
      }
      d-article h4 {
        font-size: 20px;
      }
    }
  </style>


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Sparse Model Matrices for Multidimensional Hierarchical Aggregation","description":"Multidimensional hierarchical sum aggregations can be formulated as matrix multiplications involving dummy matrices which can be referred to as model matrices. In contrast to standard model matrices, all categories of all variables must be included. For this purpose, the R package SSBtools includes functionality to create model matrices in two alternative ways, by model formulas or by so-called hierarchies. The latter means a coding of hierarchical relationships, and this can be done in several ways. Tree-shaped hierarchies are not required. The internal standard in the package is a parent-child coding. Functionality to find hierarchies automatically from the data is also included. The model matrix functionality is applied in several R packages for statistical disclosure control. This enables general implementation of methods and a flexible user interface. This paper describes the model matrix and hierarchy functions in SSBtools, as well as the methods and functions behind it.","doi":"10.32614/RJ-2023-088","authors":[{"author":"Øyvind Langsrud","authorURL":"https://github.com/olangsrud","affiliation":"Statistics Norway","affiliationURL":"#","orcidID":"0000-0002-1380-4396"}],"publishedDate":"2024-04-11T00:00:00.000+00:00","citationText":"Langsrud, 2024"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a class="logo" href="../../index.html">
<img src="../../resources/rlogo.png" alt="Logo"/>
</a>
<a href="../../index.html" class="title">The R Journal</a>
</div>
<div class="nav-right">
<a href="../../index.html">Home</a>
<a href="../../issues/2024-3">Current</a>
<a href="../../issues.html">Issues</a>
<a href="../../news.html">News</a>
<a href="../../submissions.html">Submit</a>
<a href="../../editors.html">Editorial board</a>
<a href="../../articles.xml">
<i class="fa fa-rss" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Sparse Model Matrices for Multidimensional Hierarchical Aggregation</h1>

<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p><p>Multidimensional hierarchical sum aggregations can be formulated as matrix multiplications involving dummy matrices which can be referred to as model matrices. In contrast to standard model matrices, all categories of all variables must be included. For this purpose, the R package SSBtools includes functionality to create model matrices in two alternative ways, by model formulas or by so-called hierarchies. The latter means a coding of hierarchical relationships, and this can be done in several ways. Tree-shaped hierarchies are not required. The internal standard in the package is a parent-child coding. Functionality to find hierarchies automatically from the data is also included. The model matrix functionality is applied in several R packages for statistical disclosure control. This enables general implementation of methods and a flexible user interface. This paper describes the model matrix and hierarchy functions in SSBtools, as well as the methods and functions behind it.</p></p>
</div>

<div class="d-byline">
  Øyvind Langsrud <a href="https://github.com/olangsrud" class="uri">https://github.com/olangsrud</a> (Statistics Norway)
  
<br/>2024-04-11
</div>

<div class="d-article">
<h2 data-number="1" id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>In general, a vector of sum aggregates (<span class="math inline">\(z\)</span>) can be calculated from a data vector (<span class="math inline">\(y\)</span>) through a dummy matrix (<span class="math inline">\(x\)</span>) by</p>
<p><span class="math display" id="eq:eq1">\[\begin{equation}
z = x^{T}y
   \tag{1}
\end{equation}\]</span></p>
<p>The matrix <span class="math inline">\(x\)</span> can be referred to as a model matrix.
In package <a href="https://cran.r-project.org/package=SSBtools">SSBtools</a> <span class="citation" data-cites="SSBtools_2023">(<a href="#ref-SSBtools_2023" role="doc-biblioref">Langsrud and Lupp 2023b</a>)</span> there are several tools for creating such model matrices and for computing aggregates via such matrices.
This article focuses on these tools, while there are additional tools included in the package that are not addressed herein.
Note that the package gathers functions that are used by other packages for specific purposes.</p>
<p>For some applications it is important to have access to the model matrix.
In other applications, the interface or the computational efficiency is what is needed.
For efficiency, the aggregates may sometimes be computed by</p>
<p><span class="math display" id="eq:eq2">\[\begin{equation}
z = x_{1}^{T}y x_{2}
   \tag{2}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(y\)</span> is a matrix of input data that is appropriately reorganized into multiple columns and where <span class="math inline">\(x_{1}\)</span> and <span class="math inline">\(x_{2}\)</span> are two dummy matrices.</p>
<p>An important part of the model matrix framework within <a href="https://cran.r-project.org/package=SSBtools">SSBtools</a> is the handling of hierarchical relationships.
That is, the categorical variables in the input data are hierarchically related.
Or, alternatively, some codings of hierarchical relationships, such as parent-child, are supplied as separate input.
We refer to these codings as hierarchies and these are not limited to being tree-shaped.
Hierarchies are used both in the process of constructing the model matrix and also to organize the categorical variables in the aggregated output data.</p>
<p>Model matrices are usually associated with regression models which can be expressed by model formulas and fitted by the <code>lm</code> function or by other more advanced functions.
In this article, we will also use model formulas to specify model matrices.
For this purpose, only the right-hand side of a model formula is needed.
A formula consisting of the variables <code>a</code> and <code>b</code> including the interaction (<code>a:b</code>) can be written as <code>~a + b + a:b</code>, or equivalently as <code>~a * b</code>.
By using model formulas, we can take advantage of the asterisk sign and other possibilities to write comprehensive models in compact ways (see <code>?formula</code> in an interactive R console).
The intercept term, which is included by default, can be removed by subtracting a one (<code>~a * b - 1</code>).
In the model matrix, the intercept term is a column of ones.
In our context, we would rather refer to this model term as the overall total.</p>
<p>Most elements of the model matrices considered in this paper will be zero.
When using regular dense matrices, as created by the base-R function <code>matrix</code>, an unnecessary amount of memory is used to store all the zeros.
Instead, we use sparse matrices defined in the <a href="https://cran.r-project.org/package=Matrix">Matrix</a> package <span class="citation" data-cites="Matrix">(<a href="#ref-Matrix" role="doc-biblioref">Bates et al. 2023</a>)</span>.
Then the matrices are stored in a compressed format, while ordinary matrix operations can still be performed.
In many cases, the matrices will be so large that applications which do not utilize sparse matrices will be impossible in practice.
Please note that the functions discussed in this article do not create any new classes.
The primary outputs of these functions include sparse matrices according to <a href="https://cran.r-project.org/package=Matrix">Matrix</a>, data frames, or a combination of both in the form of lists.</p>
<p>The rest of this paper is structured as follows.
First, we describe the function, <code>ModelMatrix</code>, for generating model matrices.
The following section takes a closer look at some underlying computations.
Then, a section is devoted to a more advanced function for two-way computation. Within this function, equation <a href="#eq:eq2">(2)</a> is applied.
The next section looks at aggregation beyond summation, such as median calculation.
Then, there is a section where various alternatives for creating model matrices and aggregates are compared in terms of both time and memory usage.
In the penultimate section, we consider applications in other packages.
Finally, a short conclusion is given.</p>
<p>The theory in this paper is described using examples and R code.</p>
<h2 data-number="2" id="the-function-modelmatrix"><span class="header-section-number">2</span> The function <code>ModelMatrix</code></h2>
<p>The base-R function <code>model.matrix</code> is a workhorse function for constructing model or design matrices used in regression modeling.
To create sparse matrices, the corresponding function <code>sparse.model.matrix</code> in the <a href="https://cran.r-project.org/package=Matrix">Matrix</a> package <span class="citation" data-cites="Matrix">(<a href="#ref-Matrix" role="doc-biblioref">Bates et al. 2023</a>)</span> can be used.
When all variables involved are categorical, the model matrices are dummy matrices of zeroes and ones.
The function <code>ModelMatrix</code> in package <a href="https://cran.r-project.org/package=SSBtools">SSBtools</a> is an alternative function with a slightly different purpose.
The aim is to represent the transformation from input to output when producing various types of aggregated data.
As described below, the model matrix can be constructed with both a formula interface and a hierarchy interface.</p>
<h3 data-number="2.1" id="model-matrix-from-formula"><span class="header-section-number">2.1</span> Model matrix from formula</h3>
<p>In the examples below, <code>d</code> is a data frame.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>d</span></span></code></pre>
</div>
<pre><code>    age      geo    eu value
1 young    Spain    EU  66.9
2 young  Iceland nonEU   1.8
3 young Portugal    EU  11.6
4   old    Spain    EU 120.3
5   old  Iceland nonEU   1.5
6   old Portugal    EU  20.2</code></pre>
</div>
<p>A model matrix can be specified with a formula.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/ModelMatrix.html'>ModelMatrix</a></span><span class='op'>(</span><span class='va'>d</span>, formula <span class='op'>=</span> <span class='op'>~</span><span class='va'>age</span> <span class='op'>+</span> <span class='va'>geo</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>     Total-Total old-Total young-Total Total-Iceland Total-Portugal
[1,]           1         .           1             .              .
[2,]           1         .           1             1              .
[3,]           1         .           1             .              1
[4,]           1         1           .             .              .
[5,]           1         1           .             1              .
[6,]           1         1           .             .              1
     Total-Spain
[1,]           1
[2,]           .
[3,]           .
[4,]           1
[5,]           .
[6,]           .</code></pre>
</div>
<p>In contrast to standard model matrices, all categories are included.
All variables are considered categorical.
The column names correspond to rows in a data frame, called <code>crossTable</code>, which can be requested as output.
Such a model matrix can be used to compute aggregates according to <a href="#eq:eq1">(1)</a>, for example by:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/ModelMatrix.html'>ModelMatrix</a></span><span class='op'>(</span><span class='va'>d</span>, formula <span class='op'>=</span> <span class='op'>~</span><span class='va'>age</span> <span class='op'>+</span> <span class='va'>geo</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://rdrr.io/r/base/matmult.html'>%*%</a></span> <span class='va'>d</span><span class='op'>$</span><span class='va'>value</span></span></code></pre>
</div>
<pre><code>                [,1]
Total-Total    222.3
old-Total      142.0
young-Total     80.3
Total-Iceland    3.3
Total-Portugal  31.8
Total-Spain    187.2</code></pre>
</div>
<p>Exactly the same aggregates can be computed more directly using
a related <a href="https://cran.r-project.org/package=SSBtools">SSBtools</a> function: <code>FormulaSums(d, formula = value~age + geo)</code>.
With this function, the aggregates are computed somewhat faster when the data is large.
Internally, each model term triggers a call to the function <code>aggregate</code>.
Correspondingly, <code>ModelMatrix</code> calls the <code>Matrix</code> function <code>fac2sparse</code> repeatedly.
Note that the formula interface within <code>aggregate</code> is different from our approach.
The formula <code>~age + geo</code> interpreted by <code>aggregate</code> corresponds to <code>~age:geo - 1</code> interpreted by <code>ModelMatrix</code> or <code>FormulaSums</code>.
So the formula interface in <code>aggregate</code> is less flexible.
For example,
<code>aggregate(value ~age + geo, d, sum)</code> and
<code>aggregate(value ~age * geo, d, sum)</code> give the same results.</p>
<p>To illustrate hierarchical variables, we proceed with a more complicated formula:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/ModelMatrix.html'>ModelMatrix</a></span><span class='op'>(</span><span class='va'>d</span>, formula <span class='op'>=</span> <span class='op'>~</span><span class='va'>age</span><span class='op'>*</span><span class='va'>eu</span> <span class='op'>+</span> <span class='va'>geo</span>, crossTable <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>$modelMatrix
                            
[1,] 1 . 1 1 . . . 1 . . 1 .
[2,] 1 . 1 . 1 1 . . . . . 1
[3,] 1 . 1 1 . . 1 . . . 1 .
[4,] 1 1 . 1 . . . 1 1 . . .
[5,] 1 1 . . 1 1 . . . 1 . .
[6,] 1 1 . 1 . . 1 . 1 . . .

$crossTable
     age      geo
1  Total    Total
2    old    Total
3  young    Total
4  Total       EU
5  Total    nonEU
6  Total  Iceland
7  Total Portugal
8  Total    Spain
9    old       EU
10   old    nonEU
11 young       EU
12 young    nonEU</code></pre>
</div>
<p>The column names suppressed from the <code>$modelMatrix</code> output can be seen in <code>$crossTable</code>.
Here there are two variables in <code>crossTable</code> even though there are three in the formula. This is because it has automatically been discovered that <code>geo</code> and <code>eu</code> are hierarchically related. Combining hierarchical variables in this way is often useful and this is common within official statistics. Automatic detection and handling of hierarchical relationships can be turned off with the <code>avoidHierarchical</code> parameter. The calculations made in the background are related to the automatic generation of hierarchies discussed below.</p>
<p>Note that <code>ModelMatrix</code> does not define any new classes.
The dummy matrix will have a sparse matrix class according to <a href="https://cran.r-project.org/package=Matrix">Matrix</a>.
Though, an attribute called <code>startCol</code> has been added to make locating individual model terms easy
and a related function, <code>FormulaSelection</code>, is available in <a href="https://cran.r-project.org/package=SSBtools">SSBtools</a>.</p>
<h3 data-number="2.2" id="model-matrix-from-hierarchies"><span class="header-section-number">2.2</span> Model matrix from hierarchies</h3>
<p>From the data we can generate hierarchies coded as trees:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dimLists</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/FindDimLists.html'>FindDimLists</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"age"</span>, <span class='st'>"geo"</span>, <span class='st'>"eu"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span></span>
<span><span class='va'>dimLists</span> </span></code></pre>
</div>
<pre><code>$age
  levels codes
1      @ Total
2     @@   old
3     @@ young

$geo
  levels    codes
1      @    Total
2     @@       EU
3    @@@ Portugal
4    @@@    Spain
5     @@    nonEU
6    @@@  Iceland</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span style="display:block;" id="fig:fig1"></span>
<img src="figures/young_old_EU_nonEU_Total.png" alt="The hierarchies in the examples." width="100%" />
<p class="caption">
Figure 1: The hierarchies in the examples.
</p>
</div>
</div>
<p>The two hierarchies are illustrated in Figure <a href="#fig:fig1">1</a>.
This way of coding hierarchies follows the standard used in the R package <a href="https://cran.r-project.org/package=sdcTable">sdcTable</a> <span class="citation" data-cites="sdcTable">(<a href="#ref-sdcTable" role="doc-biblioref">Meindl 2023</a>)</span>,
which is a tool for statistical disclosure control (SDC) <span class="citation" data-cites="SDCbook_2012">(<a href="#ref-SDCbook_2012" role="doc-biblioref">Hundepool et al. 2012</a>)</span>.
A model matrix can be constructed from the data and the hierarchies.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/ModelMatrix.html'>ModelMatrix</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>[</span><span class='op'>-</span><span class='fl'>6</span>, <span class='op'>-</span><span class='fl'>3</span><span class='op'>]</span>, hierarchies <span class='op'>=</span> <span class='va'>dimLists</span>, inputInOutput <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='cn'>TRUE</span>, <span class='cn'>FALSE</span><span class='op'>)</span>, </span>
<span>            crossTable <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>$modelMatrix
                      
[1,] 1 1 . . . . 1 1 .
[2,] 1 . 1 . . . 1 . 1
[3,] 1 1 . . . . 1 1 .
[4,] 1 1 . 1 1 . . . .
[5,] 1 . 1 1 . 1 . . .

$crossTable
    age   geo
1 Total Total
2 Total    EU
3 Total nonEU
4   old Total
5   old    EU
6   old nonEU
7 young Total
8 young    EU
9 young nonEU</code></pre>
</div>
<p>By default, with hierarchy input, all possible combinations are made.
Here, parameter <code>inputInOutput</code> is used to prevent columns being constructed from input codes for <code>geo</code> (country names).
The <code>eu</code> column (3rd) was removed from the input data to illustrate that this column is not being used.
Instead, the information about <code>EU</code> and <code>nonEU</code> is now given in the hierarchy.
The last row (6th) was also removed to illustrate that complete data is not required.
Either way, the rows in the output correspond to the rows in the input.</p>
<p>An alternative coding of the above hierarchies follow the standard used in the SDC program called <span class="math inline">\(\tau\)</span>-Argus <span class="citation" data-cites="tauARGUS_2014">(<a href="#ref-tauARGUS_2014" role="doc-biblioref">Wolf et al. 2014</a>)</span>. Conversion to and from this standard is possible:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hrc</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/DimList2Hrc.html'>DimList2Hrc</a></span><span class='op'>(</span><span class='va'>dimLists</span><span class='op'>)</span></span>
<span><span class='va'>hrc</span></span></code></pre>
</div>
<pre><code>$age
[1] &quot;old&quot;   &quot;young&quot;

$geo
[1] &quot;EU&quot;        &quot;@Portugal&quot; &quot;@Spain&quot;    &quot;nonEU&quot;     &quot;@Iceland&quot; </code></pre>
</div>
<p>However, the standard we use within the framework of <code>ModelMatrix</code> is more general and tree-shaped hierarchies are not required.
By the function <code>AutoHierarchies</code>, hierarchies coded in several ways are converted to our internal standard.
As shown below, it is also possible to specify total codes.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hi</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/AutoHierarchies.html'>AutoHierarchies</a></span><span class='op'>(</span><span class='va'>hrc</span>, total <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"All"</span>, <span class='st'>"Europe"</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>hi</span></span></code></pre>
</div>
<pre><code>$age
  mapsFrom mapsTo sign level
1      old    All    1     1
2    young    All    1     1

$geo
  mapsFrom mapsTo sign level
1       EU Europe    1     2
2 Portugal     EU    1     1
3    Spain     EU    1     1
4    nonEU Europe    1     2
5  Iceland  nonEU    1     1</code></pre>
</div>
<p>The variable names <code>mapsFrom</code> and <code>mapsTo</code> were chosen because the starting point was to reprogram an application implemented in the
Validation and Transformation Language (VTL) described in <span class="citation" data-cites="VTL_2015">Airo et al. (<a href="#ref-VTL_2015" role="doc-biblioref">2015</a>)</span>.
The level variable indicates the order in which the codes must be calculated.
This variable can be computed automatically and is not needed in input.
Sign, as coded in the <code>sign</code> column, can also be negative (<code>-1</code>), which means subtraction instead of addition.
The hierarchies can be very general (but not circular) and it is possible that the final model matrix consists of values beyond zeros and ones. A dummy matrix can be ensured by <code>unionComplement = TRUE</code>.
Then, in accordance with VTL, <code>sign</code> is interpreted as union or complement instead of addition or subtraction.</p>
<p>Another possible coding that can be input to <code>AutoHierarchies</code> is formulas.
This should not be confused with model formulas in the section above.
Conversion to formulas from the internal standard is possible.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/Hierarchy2Formula.html'>Hierarchies2Formulas</a></span><span class='op'>(</span><span class='va'>hi</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>$age
[1] &quot;All = old + young&quot;

$geo
[1] &quot;Europe = EU + nonEU&quot;   &quot;EU = Portugal + Spain&quot;
[3] &quot;nonEU = Iceland&quot;      </code></pre>
</div>
<p>By using the parameter <code>select</code>, the columns in the model matrix, i.e. <code>crossTable</code>, can be specified in advance.
This can be much more efficient than making the selection afterwards.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/ModelMatrix.html'>ModelMatrix</a></span><span class='op'>(</span><span class='va'>d</span>, hierarchies <span class='op'>=</span> <span class='va'>hi</span>, select <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>            age <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"young"</span>, <span class='st'>"young"</span>, <span class='st'>"All"</span>, <span class='st'>"All"</span><span class='op'>)</span>, </span>
<span>            geo <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"EU"</span>, <span class='st'>"nonEU"</span>, <span class='st'>"nonEU"</span>, <span class='st'>"Europe"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>     young:EU young:nonEU All:nonEU All:Europe
[1,]        1           .         .          1
[2,]        .           1         1          1
[3,]        1           .         .          1
[4,]        .           .         .          1
[5,]        .           .         1          1
[6,]        .           .         .          1</code></pre>
</div>
<p>With few rows in input, many columns in the model matrix will only consist of zeros. As illustrated below, such columns can be omitted by the parameter, <code>removeEmpty</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/ModelMatrix.html'>ModelMatrix</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>4</span><span class='op'>)</span>, <span class='op'>]</span>, hierarchies <span class='op'>=</span> <span class='va'>hi</span>, removeEmpty <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>     All:Europe All:EU All:Spain old:Europe old:EU old:Spain
[1,]          1      1         1          .      .         .
[2,]          1      1         1          1      1         1
     young:Europe young:EU young:Spain
[1,]            1        1           1
[2,]            .        .           .</code></pre>
</div>
<p>Due to <code>removeEmpty</code>, nine columns were omitted (<code>"All"</code>, <code>"old"</code> and <code>"young"</code> crossed with <code>"nonEU"</code>, <code>"Iceland"</code> and <code>"Portugal"</code>).
In large real data sets, the effect of <code>removeEmpty</code> can be enormous.</p>
<p>Two special possibilities are that the hierarchies can be encoded as a string or as an empty string.
A string is considered a total code. An empty string means that the variable is considered a pure categorical variable without a hierarchy.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/ModelMatrix.html'>ModelMatrix</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>2</span>,<span class='fl'>4</span><span class='op'>)</span>, <span class='op'>]</span>, hierarchies <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>age <span class='op'>=</span> <span class='st'>""</span>, geo <span class='op'>=</span> <span class='st'>"Europe"</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>     old:Europe old:Iceland old:Spain young:Europe young:Iceland
[1,]          .           .         .            1             .
[2,]          .           .         .            1             1
[3,]          1           .         1            .             .
     young:Spain
[1,]           1
[2,]           .
[3,]           .</code></pre>
</div>
<p>In this case only two countries are present in the input data. If <code>removeEmpty</code> had been <code>TRUE</code>, the <code>old:Iceland</code> column would have been omitted.</p>
<p>Note that both <code>ModelMatrix</code> parameters, <code>hierarchies</code> and <code>formula</code>, can be used simultaneously.
How the hierarchies are to be crossed is then defined by the formula.</p>
<h2 data-number="3" id="underlying-computations"><span class="header-section-number">3</span> Underlying computations</h2>
<h3 data-number="3.1" id="hierarchies-automatically-from-the-data"><span class="header-section-number">3.1</span> Hierarchies automatically from the data</h3>
<p>To find hierarchies automatically from the data, a kind of correlation matrix is first computed by the function <code>FactorLevCorr</code>.
The function was named with factor variables and their levels in mind, but any variable type is possible.
To illustrate a little more complexity, we add <code>isSpain</code> as a logical variable.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>d</span><span class='op'>$</span><span class='va'>isSpain</span> <span class='op'>&lt;-</span> <span class='va'>d</span><span class='op'>$</span><span class='va'>geo</span> <span class='op'>==</span> <span class='st'>"Spain"</span></span>
<span><span class='va'>fCorr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/FactorLevCorr.html'>FactorLevCorr</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"age"</span>, <span class='st'>"geo"</span>, <span class='st'>"eu"</span>, <span class='st'>"isSpain"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span></span>
<span><span class='va'>fCorr</span></span></code></pre>
</div>
<pre><code>        age geo   eu isSpain
age       2   0  0.0     0.0
geo       0   3 -1.0    -1.0
eu        0   1  2.0     0.5
isSpain   0   1 -0.5     2.0</code></pre>
</div>
<p>The diagonal elements in this matrix are used to store the number of unique values of each variable (<span class="math inline">\(n_i\)</span>).
To calculate our correlations, we first find the number of unique combinations (<span class="math inline">\(m_{ij}\)</span>) of each pair of variables.
For this purpose, the function, <code>unique</code>, is repeatedly called with two-column data frames as input.
The absolute values of off-diagonal elements are
<span class="math inline">\(0\)</span> when <span class="math inline">\(m_{ij} = n_i*n_j\)</span>,
<span class="math inline">\(1\)</span> when <span class="math inline">\(m_{ij} = \max(n_i, n_j)\)</span> and otherwise computed as
<span class="math inline">\((n_i*n_j-m_{ij})/(n_i*n_j-\max(n_i, n_j))\)</span>.
So <span class="math inline">\(0\)</span> means that all possible level combinations exist in the data and <span class="math inline">\(1\)</span> means that the two variables are hierarchically related. In our example the correlation between <code>eu</code> and <code>isSpain</code> isn’t zero since the combination (<code>nonEU</code>, <code>TRUE</code>) is missing in the data.
The signs of off-diagonal elements are set to be positive when <span class="math inline">\(n_i&lt;n_j\)</span> and negative when <span class="math inline">\(n_i&gt;n_j\)</span>.
In cases where <span class="math inline">\(n_i=n_j\)</span>, elements will be positive above the diagonal and negative below.
Values other than <span class="math inline">\(0\)</span>, <span class="math inline">\(-1\)</span> and <span class="math inline">\(1\)</span> could be useful for detecting errors in the data. For example, values close to one may be suspicious.</p>
<p>In our application, to generate hierarchies, we only need to look for ones.
A one means that two hierarchically related variables are found.
More generally, one can find trees by connecting relations when the variables are ordered according to the diagonal elements.
The function, <code>HierarchicalGroups</code>, does this repeatedly using a recursive algorithm so that all possible trees are found.
Below we run this function with <code>eachName = TRUE</code> so that names are included instead of indices.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/HierarchicalGroups.html'>HierarchicalGroups</a></span><span class='op'>(</span>fCorr <span class='op'>=</span> <span class='va'>fCorr</span>, eachName <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>$age
[1] &quot;age&quot;

$geo
[1] &quot;geo&quot; &quot;eu&quot; 

$geo
[1] &quot;geo&quot;     &quot;isSpain&quot;</code></pre>
</div>
<p>Here two groups were named <code>geo</code>. This means also that <code>FindDimLists</code> will result in two hierarchies named <code>geo</code>.
Each hierarchy is achieved by looking at sorted unique rows.
For example, this hierarchy,</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/FindDimLists.html'>FindDimLists</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"age"</span>, <span class='st'>"geo"</span>, <span class='st'>"eu"</span>, <span class='st'>"isSpain"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>3</span><span class='op'>]</span><span class='op'>]</span></span></code></pre>
</div>
<pre><code>  levels    codes
1      @    Total
2     @@    FALSE
3    @@@  Iceland
4    @@@ Portugal
5     @@     TRUE
6    @@@    Spain</code></pre>
</div>
<p>was constructed from this data frame:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'>SSBtools</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/SortRows.html'>SortRows</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"isSpain"</span>, <span class='st'>"geo"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  isSpain      geo
2   FALSE  Iceland
3   FALSE Portugal
1    TRUE    Spain</code></pre>
</div>
<p>The top level (<code>@</code>) is always the total code. The remaining levels correspond to the columns in the data as defined by the hierarchical groups.
Here this means <code>"isSpain"</code> (<code>@@</code>) and <code>"geo"</code> (<code>@@@</code>).</p>
<p>Note that the corresponding function <code>FindHierarchies</code> produces only a single <code>geo</code> hierarchy.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/FindHierarchies.html'>FindHierarchies</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"age"</span>, <span class='st'>"geo"</span>, <span class='st'>"eu"</span>, <span class='st'>"isSpain"</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span><span class='op'>$</span><span class='va'>geo</span></span></code></pre>
</div>
<pre><code>  mapsFrom mapsTo sign level
1  Iceland  nonEU    1     1
2  Iceland  Total    1     1
3  Iceland  FALSE    1     1
4 Portugal     EU    1     1
5 Portugal  Total    1     1
6 Portugal  FALSE    1     1
7    Spain     EU    1     1
8    Spain  Total    1     1
9    Spain   TRUE    1     1</code></pre>
</div>
<p><code>FindHierarchies</code> wraps <code>FindDimLists</code> and <code>AutoHierarchies</code> into a single function.
By default, when multiple hierarchies exist for the same variable, <code>AutoHierarchies</code> combines them by generating a flattened hierarchy with a single level.
The output codes are the parents (<code>mapsTo</code>) and all childs (<code>mapsFrom</code>) are input codes.
Parent-child relationships corresponding to multilevel tree structures are not directly available,
but the information needed to create model matrices is available.
In fact, the hierarchies are combined via dummy matrices described below.</p>
<h3 data-number="3.2" id="from-hierarchies-to-dummy-matrices"><span class="header-section-number">3.2</span> From hierarchies to dummy matrices</h3>
<p>To produce model matrices, the hierarchies are converted to dummy matrices and the parameter <code>inputInOutput</code> is used.
Here we convert the hierarchies, <code>hi</code>, in the previous section:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hiM</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/DummyHierarchy.html'>DummyHierarchies</a></span><span class='op'>(</span><span class='va'>hi</span>, inputInOutput <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='cn'>TRUE</span>, <span class='cn'>FALSE</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>hiM</span></span></code></pre>
</div>
<pre><code>$age
      old young
old     1     .
young   .     1
All     1     1

$geo
       Iceland Portugal Spain
EU           .        1     1
nonEU        1        .     .
Europe       1        1     1</code></pre>
</div>
<p>The first two rows of <code>hiM$age</code> are a perturbed identity matrix since <code>inputInOutput = TRUE</code> for this variable.
The first two rows of <code>hiM$geo</code> can be found directly from the level 1 rows of the hierarchy, <code>hi$geo</code>.
The nonzero elements are taken from the <code>sign</code> variable and the corresponding rows and columns can be read from the variables <code>mapsFrom</code> and <code>mapsTo</code>, respectively.
A similar matrix can be constructed from level 2. In our example this matrix is:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>geo2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/Matrix/man/Matrix.html'>Matrix</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>1</span>, <span class='fl'>2</span>, dimnames <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='st'>"Europe"</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"EU"</span>, <span class='st'>"nonEU"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>geo2</span></span></code></pre>
</div>
<pre><code>       EU nonEU
Europe  1     1</code></pre>
</div>
<p>The last row of <code>hiM$geo</code> can now be found by the matrix multiplication:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>geo2</span> <span class='op'><a href='https://rdrr.io/r/base/matmult.html'>%*%</a></span> <span class='va'>hiM</span><span class='op'>$</span><span class='va'>geo</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span>, <span class='op'>]</span></span></code></pre>
</div>
<pre><code>       Iceland Portugal Spain
Europe       1        1     1</code></pre>
</div>
<p>In general, the dummy matrix is constructed successively by adding one level at a time. The new rows are found as a matrix constructed from the new level multiplied by the preliminary dummy matrix. The parameter <code>unionComplement</code> mentioned above is used within this process.</p>
<p>The next step is to extend these matrices to match the data and this can be achieved by the function <code>DataDummyHierarchies</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hiD</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/DataDummyHierarchy.html'>DataDummyHierarchies</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='va'>hiM</span>, colNamesFromData <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span>
<span><span class='va'>hiD</span></span></code></pre>
</div>
<pre><code>$age
      young young young old old old
old       .     .     .   1   1   1
young     1     1     1   .   .   .
All       1     1     1   1   1   1

$geo
       Spain Iceland Portugal Spain Iceland Portugal
EU         1       .        1     1       .        1
nonEU      .       1        .     .       1        .
Europe     1       1        1     1       1        1</code></pre>
</div>
<p>For readability <code>colNamesFromData</code> was here set to <code>TRUE</code>.
This also means that the relationship to <code>hiM</code> is direct.
Now a transposed model matrix can be achieved by the function <code>KhatriRao</code> (column-wise Kronecker product) within the Matrix package.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'>Matrix</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/Matrix/man/KhatriRao.html'>KhatriRao</a></span><span class='op'>(</span><span class='va'>hiD</span><span class='op'>$</span><span class='va'>geo</span>, <span class='va'>hiD</span><span class='op'>$</span><span class='va'>age</span>, make.dimnames <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>             Spain Iceland Portugal Spain Iceland Portugal
old:EU           .       .        .     1       .        1
young:EU         1       .        1     .       .        .
All:EU           1       .        1     1       .        1
old:nonEU        .       .        .     .       1        .
young:nonEU      .       1        .     .       .        .
All:nonEU        .       1        .     .       1        .
old:Europe       .       .        .     1       1        1
young:Europe     1       1        1     .       .        .
All:Europe       1       1        1     1       1        1</code></pre>
</div>
<p>Now the column names are misleading since only names from the first input matrix are used. However, the row names can be useful.
With more than two variables, <code>KhatriRao</code> is run several times by adding one variable at a time.</p>
<p>We now recall how a model matrix with pre-selected columns was created in the previous section using the <code>select</code> parameter to <code>ModelMatrix</code>.
When we look at dummy matrices here, this means pre-selected rows.
To produce such a matrix with pre-selected rows, one possibility is to first produce separate matrices for each variable.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hiD</span><span class='op'>$</span><span class='va'>age</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"young"</span>, <span class='st'>"young"</span>, <span class='st'>"All"</span>, <span class='st'>"All"</span><span class='op'>)</span>, <span class='op'>]</span></span></code></pre>
</div>
<pre><code>      young young young old old old
young     1     1     1   .   .   .
young     1     1     1   .   .   .
All       1     1     1   1   1   1
All       1     1     1   1   1   1</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hiD</span><span class='op'>$</span><span class='va'>geo</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"EU"</span>, <span class='st'>"nonEU"</span>, <span class='st'>"nonEU"</span>, <span class='st'>"Europe"</span><span class='op'>)</span>, <span class='op'>]</span></span></code></pre>
</div>
<pre><code>       Spain Iceland Portugal Spain Iceland Portugal
EU         1       .        1     1       .        1
nonEU      .       1        .     .       1        .
nonEU      .       1        .     .       1        .
Europe     1       1        1     1       1        1</code></pre>
</div>
<p>The transposed model matrix is then obtained by multiplying these matrices together.
This is a fast way to obtain the model matrix.
A possible problem is, however, that the matrices to be multiplied are not as sparse as the final matrix.
Therefore <code>KhatriRao</code> combined with reducing the matrices as much as possible first, can still be better.
The choice between the two methods is controlled by a parameter, called <code>selectionByMultiplicationLimit</code>.
The functionality of the parameter <code>removeEmpty</code> mentioned above, is implemented by <code>KhatriRao</code> combined with reducing the matrices.</p>
<h2 data-number="4" id="two-way-computation"><span class="header-section-number">4</span> Two-way computation</h2>
<h3 data-number="4.1" id="the-function-hierarchycompute"><span class="header-section-number">4.1</span> The function <code>HierarchyCompute</code></h3>
<p>We recall that sum aggregates of a data vector (<span class="math inline">\(y\)</span>) can be calculated by equation <a href="#eq:eq1">(1)</a> where the model matrix (<span class="math inline">\(x\)</span>) can be produced by the function <code>ModelMatrix</code>.
As mentioned above, with formula input an alternative function is <code>FormulaSums</code>. Then the aggregates are calculated without <span class="math inline">\(x\)</span> being created.
In the cases of hierarchies, a corresponding function is <code>HierarchyCompute</code>.
Although this function makes aggregates via one or two dummy matrices, a model matrix that matches the input data is not necessarily made.
A special case of <code>HierarchyCompute</code> is to make such a model matrix and this matrix can also be requested as output.
Actually, <code>ModelMatrix</code> with hierarchy input make use of <code>HierarchyCompute</code>.
The <code>HierarchyCompute</code> function does not take many hierarchy types as input, so <code>AutoHierarchies</code> may have to be run first.</p>
<p>In general, aggregates are computed by <code>HierarchyCompute</code> according to equation <a href="#eq:eq2">(2)</a>.
But the original version of the function, without the <code>colVar</code> parameter, is limited to equation <a href="#eq:eq1">(1)</a>.
However, <span class="math inline">\(y\)</span> may be a multi-column matrix containing a reorganized version of the input data vector.
Then the columns represent a single categorical variable with no hierarchy.
To tell <code>HierarchyCompute</code> to treat a categorical variable in this way,
this categorical variable is encoded as the string <code>"colFactor"</code> in the hierarchy input.
Other categorical variables are encoded as <code>"rowFactor"</code>.
The function <code>AutoHierarchies</code> re-encodes an empty string to <code>"rowFactor"</code>.</p>
<p>To illustrate this function, we add an extra variable, <code>year</code>, to the data. Although, it is only a single year.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/HierarchyCompute.html'>HierarchyCompute</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>d</span>, year <span class='op'>=</span> <span class='fl'>2022</span><span class='op'>)</span>, </span>
<span>     hierarchies <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>age <span class='op'>=</span> <span class='st'>"colFactor"</span>, geo <span class='op'>=</span> <span class='va'>hi</span><span class='op'>$</span><span class='va'>geo</span>, year <span class='op'>=</span> <span class='st'>"rowFactor"</span><span class='op'>)</span>, </span>
<span>     valueVar <span class='op'>=</span> <span class='st'>"value"</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>    age    geo year value
1   old     EU 2022 140.5
2   old  nonEU 2022   1.5
3   old Europe 2022 142.0
4 young     EU 2022  78.5
5 young  nonEU 2022   1.8
6 young Europe 2022  80.3</code></pre>
</div>
<p>Except for column and row order, the output will be the same if <code>"rowFactor"</code> and <code>"colFactor"</code> are swapped or if both <code>age</code> and <code>year</code> are set to <code>"rowFactor"</code>.
If <code>output = "matrixComponents"</code> is included in the function call, the internal differences can be seen. Then, in our example, output become:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hc</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/HierarchyCompute.html'>HierarchyCompute</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>d</span>, year <span class='op'>=</span> <span class='fl'>2022</span><span class='op'>)</span>, </span>
<span>           hierarchies <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>age <span class='op'>=</span> <span class='st'>"colFactor"</span>, geo <span class='op'>=</span> <span class='va'>hi</span><span class='op'>$</span><span class='va'>geo</span>, year <span class='op'>=</span> <span class='st'>"rowFactor"</span><span class='op'>)</span>, </span>
<span>           valueVar <span class='op'>=</span> <span class='st'>"value"</span>, output <span class='op'>=</span> <span class='st'>"matrixComponents"</span><span class='op'>)</span></span>
<span><span class='va'>hc</span></span></code></pre>
</div>
<pre><code>$dataDummyHierarchy
                 
EU:2022     . 1 1
nonEU:2022  1 . .
Europe:2022 1 1 1

$valueMatrix
       old young
[1,]   1.5   1.8
[2,]  20.2  11.6
[3,] 120.3  66.9

$fromCrossCode
       geo year
1  Iceland 2022
2 Portugal 2022
3    Spain 2022

$toCrossCode
     geo year
1     EU 2022
2  nonEU 2022
3 Europe 2022</code></pre>
</div>
<p>The matrix, <code>valueMatrix</code> is a reorganized version of the value variable in the input data.
If a variable is selected as <code>"colFactor"</code>, there is one column for each level of that variable.
Even without such a variable, there may be fewer rows in the <code>valueMatrix</code> than in the input data.
This is because rows where the values are zero can be removed and because duplicated code combinations in the input can be aggregated.
This is controlled by parameters <code>"reduceData"</code> and <code>"handleDuplicated"</code>.
The data frame <code>fromCrossCode</code> contains variables that characterize the rows of <code>valueMatrix</code>.
The matrix <code>dataDummyHierarchy</code> is a transposed model matrix that matches <code>valueMatrix</code>.
This means that the aggregate output values can be calculated as <code>dataDummyHierarchy %*% valueMatrix</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hc</span><span class='op'>$</span><span class='va'>dataDummyHierarchy</span> <span class='op'><a href='https://rdrr.io/r/base/matmult.html'>%*%</a></span> <span class='va'>hc</span><span class='op'>$</span><span class='va'>valueMatrix</span></span></code></pre>
</div>
<pre><code>              old young
EU:2022     140.5  78.5
nonEU:2022    1.5   1.8
Europe:2022 142.0  80.3</code></pre>
</div>
<p>The data frame <code>toCrossCode</code> contains variables that characterize the rows of this matrix.
Along with column names, this is the information needed to reorganize the aggregate result into a regular output data frame.</p>
<h3 data-number="4.2" id="hierarchycompute-with-colvar"><span class="header-section-number">4.2</span> <code>HierarchyCompute</code> with <code>colVar</code></h3>
<p>When the parameter <code>colVar</code> is applied, two (transposed) model matrices are made,
one for rows and one for columns.
Parameter <code>colVar</code> splits the hierarchy variables in two groups and this variable overrides the difference between <code>"rowFactor"</code> and <code>"colFactor"</code>.
Actually, there will be two runs of <code>HierarchyCompute</code>.
With <code>output = "matrixComponents"</code>, output from the two runs are returned as a list with elements <code>hcRow</code> and <code>hcCol</code>.
Below we illustrate this by including the age hierarchy with <code>inputInOutput = TRUE</code> (<code>FALSE</code> is default).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hc2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/HierarchyCompute.html'>HierarchyCompute</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>d</span>, year <span class='op'>=</span> <span class='fl'>2022</span><span class='op'>)</span>, </span>
<span>            hierarchies <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>age <span class='op'>=</span> <span class='va'>hi</span><span class='op'>$</span><span class='va'>age</span>, geo <span class='op'>=</span> <span class='va'>hi</span><span class='op'>$</span><span class='va'>geo</span>, year <span class='op'>=</span> <span class='st'>"rowFactor"</span><span class='op'>)</span>, </span>
<span>            colVar <span class='op'>=</span> <span class='st'>"age"</span>, inputInOutput <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='cn'>TRUE</span>, <span class='cn'>FALSE</span><span class='op'>)</span>,</span>
<span>            valueVar <span class='op'>=</span> <span class='st'>"value"</span>, output <span class='op'>=</span> <span class='st'>"matrixComponents"</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>For rows, we obtain the same matrices as earlier. The aggregates in the previous subsection can now be computed as:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hc2</span><span class='op'>$</span><span class='va'>hcRow</span><span class='op'>$</span><span class='va'>dataDummyHierarchy</span> <span class='op'><a href='https://rdrr.io/r/base/matmult.html'>%*%</a></span> <span class='va'>hc2</span><span class='op'>$</span><span class='va'>hcRow</span><span class='op'>$</span><span class='va'>valueMatrix</span></span></code></pre>
</div>
<pre><code>                1    2
EU:2022     140.5 78.5
nonEU:2022    1.5  1.8
Europe:2022 142.0 80.3</code></pre>
</div>
<p>The model matrix for columns can be seen as:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='va'>hc2</span><span class='op'>$</span><span class='va'>hcCol</span><span class='op'>$</span><span class='va'>dataDummyHierarchy</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>     old young All
[1,]   1     .   1
[2,]   .     1   1</code></pre>
</div>
<p>Finally, the aggregate output values can be calculated as:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hc2</span><span class='op'>$</span><span class='va'>hcRow</span><span class='op'>$</span><span class='va'>dataDummyHierarchy</span> <span class='op'><a href='https://rdrr.io/r/base/matmult.html'>%*%</a></span> <span class='va'>hc2</span><span class='op'>$</span><span class='va'>hcRow</span><span class='op'>$</span><span class='va'>valueMatrix</span> <span class='op'><a href='https://rdrr.io/r/base/matmult.html'>%*%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='va'>hc2</span><span class='op'>$</span><span class='va'>hcCol</span><span class='op'>$</span><span class='va'>dataDummyHierarchy</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>              old young   All
EU:2022     140.5  78.5 219.0
nonEU:2022    1.5   1.8   3.3
Europe:2022 142.0  80.3 222.3</code></pre>
</div>
<p>Taking into account that the dummy matrices are transposed model matrices, equation <a href="#eq:eq2">(2)</a> is applied.
With ordinary output, these values are organized into a data frame and we do not see what is going on internally.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/HierarchyCompute.html'>HierarchyCompute</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>d</span>, year <span class='op'>=</span> <span class='fl'>2022</span><span class='op'>)</span>, </span>
<span>     hierarchies <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>age <span class='op'>=</span> <span class='va'>hi</span><span class='op'>$</span><span class='va'>age</span>, geo <span class='op'>=</span> <span class='va'>hi</span><span class='op'>$</span><span class='va'>geo</span>, year <span class='op'>=</span> <span class='st'>"rowFactor"</span><span class='op'>)</span>, </span>
<span>     colVar <span class='op'>=</span> <span class='st'>"age"</span>, inputInOutput <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='cn'>TRUE</span>, <span class='cn'>FALSE</span><span class='op'>)</span>,</span>
<span>     valueVar <span class='op'>=</span> <span class='st'>"value"</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>    age    geo year value
1   old     EU 2022 140.5
2   old  nonEU 2022   1.5
3   old Europe 2022 142.0
4 young     EU 2022  78.5
5 young  nonEU 2022   1.8
6 young Europe 2022  80.3
7   All     EU 2022 219.0
8   All  nonEU 2022   3.3
9   All Europe 2022 222.3</code></pre>
</div>
<p>We obtain the same results without specifying <code>colVar</code>.
One reason to use <code>colVar</code> is to do the computations more efficiently.
Another reason may be that the internal matrices may be of interest.
Note that variable combinations for output can be specified by parameters
<code>rowSelect</code>, <code>colSelect</code> and <code>select</code>.
Then <code>colVar</code> also matters.</p>
<h2 data-number="5" id="aggregation-beyond-summation"><span class="header-section-number">5</span> Aggregation beyond summation</h2>
<p>The most recent functions in the <a href="https://cran.r-project.org/package=SSBtools">SSBtools</a> package are about general aggregation beyond summation.
With respect to future application packages, this is written in a different coding style (lower snake case).
The function <code>model_aggregate</code> combines the model specification capabilities of <code>ModelMatrix</code> with aggregation with general functions. Below is an example:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/model_aggregate.html'>model_aggregate</a></span><span class='op'>(</span><span class='va'>d</span>, formula <span class='op'>=</span> <span class='op'>~</span><span class='va'>age</span> <span class='op'>+</span> <span class='va'>eu</span>, </span>
<span>                fun_vars <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>max <span class='op'>=</span> <span class='st'>"value"</span>, median <span class='op'>=</span> <span class='st'>"value"</span>, length <span class='op'>=</span> <span class='st'>"geo"</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>    age    eu value_max value_median geo_length
1 Total Total     120.3        15.90          6
2   old Total     120.3        20.20          3
3 young Total      66.9        11.60          3
4 Total    EU     120.3        43.55          4
5 Total nonEU       1.8         1.65          2</code></pre>
</div>
<p>The underlying computations make use of a model matrix. By default (<code>pre_aggregate = TRUE</code>), the number of rows in the input data frame is reduced before <code>ModelMatrix</code> is called.
In practice, this pre-aggregation step is done by running <code>aggregate</code> with <code>FUN = function(x){x}</code> and <code>simplify = FALSE</code>.
The individual observations to be aggregated are then included as lists. In this example, the reduced input data is:</p>
<div class="layout-chunk" data-layout="l-body">
<pre><code>    age    eu       value             geo
1   old    EU 120.3, 20.2 Spain, Portugal
2 young    EU  66.9, 11.6 Spain, Portugal
3   old nonEU         1.5         Iceland
4 young nonEU         1.8         Iceland</code></pre>
</div>
<p>The corresponding model matrix is:</p>
<div class="layout-chunk" data-layout="l-body">
<pre><code>     Total-Total old-Total young-Total Total-EU Total-nonEU
[1,]           1         1           .        1           .
[2,]           1         .           1        1           .
[3,]           1         1           .        .           1
[4,]           1         .           1        .           1</code></pre>
</div>
<p>The function <code>model_aggregate</code> has many possibilities for specifying the aggregation.
Functions of several data variables are possible. Output variable names can be passed as input, even for functions with multiple outputs.
This is possible since <code>model_aggregate</code> calls <code>dummy_aggregate</code> (model matrix is input) which calls
<code>aggregate_multiple_fun</code> which is an advanced wrapper to <code>aggregate</code>.
The implementation uses indexes to rows, which made it possible to call <code>aggregate</code> only once.
Since matrix multiplication is a fast way to do sum aggregation, this is also included as a possibility in <code>model_aggregate</code> (parameter <code>sum_vars</code>).</p>
<h2 data-number="6" id="comparisons-with-comments"><span class="header-section-number">6</span> Comparisons with comments</h2>
<p>To facilitate comparisons, we utilize hierarchical example data with <span class="math inline">\(10^i\)</span> rows obtained by crossing <span class="math inline">\(i\)</span> dimensions.
For each dimension there is a child variable with 10 categories and a parent variable with 3 categories (2, 3 and 5 categories aggregated).
The child and parent variables are named alphabetically by small and capital letters, respectively.
Below is an illustration of a <code>HierarchyCompute</code> call when <span class="math inline">\(i = 4\)</span>, showing eight rows in both the input and output.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>d</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/SSBtoolsData.html'>SSBtoolsData</a></span><span class='op'>(</span><span class='st'>"power10to4"</span><span class='op'>)</span></span>
<span><span class='va'>d</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>4</span>, <span class='fl'>3715</span><span class='op'>:</span><span class='fl'>3716</span>, <span class='fl'>9999</span><span class='op'>:</span><span class='fl'>10000</span><span class='op'>)</span>, <span class='op'>]</span></span></code></pre>
</div>
<pre><code>        a    A   b    B   c    C   d    D
1      a1 A100  b1 B100  c1 C100  d1 D100
2      a2 A100  b1 B100  c1 C100  d1 D100
3      a3 A200  b1 B100  c1 C100  d1 D100
4      a4 A200  b1 B100  c1 C100  d1 D100
3715   a5 A200  b2 B100  c8 C300  d4 D200
3716   a6 A300  b2 B100  c8 C300  d4 D200
9999   a9 A300 b10 B300 c10 C300 d10 D300
10000 a10 A300 b10 B300 c10 C300 d10 D300</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>hi</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/FindHierarchies.html'>FindHierarchies</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>)</span></span>
<span><span class='va'>d</span><span class='op'>$</span><span class='va'>y</span> <span class='op'>&lt;-</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>)</span></span>
<span><span class='va'>output</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/SSBtools/man/HierarchyCompute.html'>HierarchyCompute</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='va'>hi</span>, <span class='st'>"y"</span>, inputInOutput <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span>
<span><span class='va'>output</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>5473</span><span class='op'>:</span><span class='fl'>5475</span>, <span class='fl'>37852</span><span class='op'>:</span><span class='fl'>37854</span>, <span class='fl'>38416</span><span class='op'>)</span>, <span class='op'>]</span></span></code></pre>
</div>
<pre><code>          a     b     c     d        y
1        a1    b1    c1    d1        1
5473   A300  B300 Total   d10  2382000
5474  Total  B300 Total   d10  4762750
5475     a1 Total Total   d10   949600
37852    a9   b10  C200 Total   146970
37853  A100   b10  C200 Total   293490
37854  A200   b10  C200 Total   440460
38416 Total Total Total Total 50005000</code></pre>
</div>
<p>Here an <code>integer</code> <span class="math inline">\(y\)</span> is added to the input data. Either way, the variable becomes <code>numeric</code> in the output.
In the comparisons below, the input class is also <code>numeric</code>.
We use <code>inputInOutput = TRUE</code>, which is the default in <code>ModelMatrix</code>.
With 10 child categories, 3 parent categories, and the inclusion of a total code, this results in <span class="math inline">\(14^i\)</span> rows in the output.</p>
<div class="layout-chunk" data-layout="l-body">
<table>
<caption>
<span id="tab:tab1-html">Table 1: </span>User CPU time in seconds based on hierarchical input data with <span class="math inline">\(10^i\)</span> rows, resulting in <span class="math inline">\(14^i\)</span> output aggregates. Thus, the size of the model matrix is <span class="math inline">\(10^i \times 14^i\)</span>. The source code is given in Table 3.
</caption>
<thead>
<tr>
<th style="text-align:right;">
function call
</th>
<th style="text-align:right;">
<span class="math inline">\(i = 2\)</span>
</th>
<th style="text-align:right;">
<span class="math inline">\(i = 3\)</span>
</th>
<th style="text-align:right;">
<span class="math inline">\(i = 4\)</span>
</th>
<th style="text-align:right;">
<span class="math inline">\(i = 5\)</span>
</th>
<th style="text-align:right;">
<span class="math inline">\(i = 6\)</span>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
FindHierarchies
</td>
<td style="text-align:right;">
0.010
</td>
<td style="text-align:right;">
0.032
</td>
<td style="text-align:right;">
0.392
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
131
</td>
</tr>
<tr>
<td style="text-align:right;">
HierarchyCompute
</td>
<td style="text-align:right;">
0.017
</td>
<td style="text-align:right;">
0.027
</td>
<td style="text-align:right;">
0.188
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
147
</td>
</tr>
<tr>
<td style="text-align:right;">
HierarchyCompute with colVar
</td>
<td style="text-align:right;">
0.018
</td>
<td style="text-align:right;">
0.028
</td>
<td style="text-align:right;">
0.086
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
22
</td>
</tr>
<tr>
<td style="text-align:right;">
ModelMatrix from hierarchies
</td>
<td style="text-align:right;">
0.014
</td>
<td style="text-align:right;">
0.026
</td>
<td style="text-align:right;">
0.229
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
218
</td>
</tr>
<tr>
<td style="text-align:right;">
ModelMatrix from formula
</td>
<td style="text-align:right;">
0.016
</td>
<td style="text-align:right;">
0.083
</td>
<td style="text-align:right;">
1.294
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:right;">
2922
</td>
</tr>
<tr>
<td style="text-align:right;">
sparse.model.matrix
</td>
<td style="text-align:right;">
0.026
</td>
<td style="text-align:right;">
0.173
</td>
<td style="text-align:right;">
11.703
</td>
<td style="text-align:right;">
1597
</td>
<td style="text-align:right;">
</td>
</tr>
<tr>
<td style="text-align:right;">
model.matrix
</td>
<td style="text-align:right;">
0.004
</td>
<td style="text-align:right;">
0.024
</td>
<td style="text-align:right;">
3.238
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
</tr>
<tr>
<td style="text-align:right;">
FormulaSums
</td>
<td style="text-align:right;">
0.021
</td>
<td style="text-align:right;">
0.110
</td>
<td style="text-align:right;">
1.417
</td>
<td style="text-align:right;">
43
</td>
<td style="text-align:right;">
1041
</td>
</tr>
<tr>
<td style="text-align:right;">
median by model_aggregate
</td>
<td style="text-align:right;">
0.030
</td>
<td style="text-align:right;">
0.208
</td>
<td style="text-align:right;">
3.353
</td>
<td style="text-align:right;">
74
</td>
<td style="text-align:right;">
1403
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-body">
<table>
<caption>
<span id="tab:tab2-html">Table 2: </span>Peak RAM in MiB for the calculations described in Tables 1 and 3. For <span class="math inline">\(i\geq 4\)</span>, the size of the output object is provided within parentheses, denoted in MiB as well.
</caption>
<thead>
<tr>
<th style="text-align:right;">
function call
</th>
<th style="text-align:right;">
<span class="math inline">\(i = 2\)</span>
</th>
<th style="text-align:right;">
<span class="math inline">\(i = 3\)</span>
</th>
<th style="text-align:left;">
     <span class="math inline">\(i = 4\)</span>
</th>
<th style="text-align:left;">
     <span class="math inline">\(i = 5\)</span>
</th>
<th style="text-align:left;">
     <span class="math inline">\(i = 6\)</span>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
FindHierarchies
</td>
<td style="text-align:right;">
0.9
</td>
<td style="text-align:right;">
1.9
</td>
<td style="text-align:left;">
        12 (0.010)
</td>
<td style="text-align:left;">
        57 (0.012)
</td>
<td style="text-align:left;">
      610 (0.015)
</td>
</tr>
<tr>
<td style="text-align:right;">
HierarchyCompute
</td>
<td style="text-align:right;">
3.0
</td>
<td style="text-align:right;">
3.8
</td>
<td style="text-align:left;">
        69 (1.5)
</td>
<td style="text-align:left;">
    1074 (25)
</td>
<td style="text-align:left;">
  30792 (402)
</td>
</tr>
<tr>
<td style="text-align:right;">
HierarchyCompute with colVar
</td>
<td style="text-align:right;">
1.2
</td>
<td style="text-align:right;">
2.1
</td>
<td style="text-align:left;">
        20 (1.5)
</td>
<td style="text-align:left;">
      201 (25)
</td>
<td style="text-align:left;">
    1273 (402)
</td>
</tr>
<tr>
<td style="text-align:right;">
ModelMatrix from hierarchies
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
4.3
</td>
<td style="text-align:left;">
        71 (12.2)
</td>
<td style="text-align:left;">
    1079 (324)
</td>
<td style="text-align:left;">
  32246 (9003)
</td>
</tr>
<tr>
<td style="text-align:right;">
ModelMatrix from formula
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
16.8
</td>
<td style="text-align:left;">
        71 (12.2)
</td>
<td style="text-align:left;">
      919 (324)
</td>
<td style="text-align:left;">
  27809 (9003)
</td>
</tr>
<tr>
<td style="text-align:right;">
sparse.model.matrix
</td>
<td style="text-align:right;">
2.4
</td>
<td style="text-align:right;">
40.0
</td>
<td style="text-align:left;">
      536 (13.1)
</td>
<td style="text-align:left;">
  61654 (333)
</td>
<td style="text-align:left;">
         
</td>
</tr>
<tr>
<td style="text-align:right;">
model.matrix
</td>
<td style="text-align:right;">
0.6
</td>
<td style="text-align:right;">
42.1
</td>
<td style="text-align:left;">
    5864 (2935)
</td>
<td style="text-align:left;">
         
</td>
<td style="text-align:left;">
         
</td>
</tr>
<tr>
<td style="text-align:right;">
FormulaSums
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
18.2
</td>
<td style="text-align:left;">
      431 (3.1)
</td>
<td style="text-align:left;">
    6884 (48)
</td>
<td style="text-align:left;">
    1252 (689)
</td>
</tr>
<tr>
<td style="text-align:right;">
median by model_aggregate
</td>
<td style="text-align:right;">
0.9
</td>
<td style="text-align:right;">
15.2
</td>
<td style="text-align:left;">
      230 (1.5)
</td>
<td style="text-align:left;">
    2257 (25)
</td>
<td style="text-align:left;">
  63435 (402)
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-body">
<table>
<caption><span id="tab:tab3-html">Table 3: </span>The source code for the calculations underlying Tables 1 and 2. With <span class="math inline">\(i\)</span> defined, the code can be run directly from top to bottom. Be careful not to run <code>FindHierarchies(d)</code> with <code>y</code> included in <code>d</code>.</caption>
<colgroup>
<col style="width: 22%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">function call, etc.</th>
<th style="text-align: left;">source code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">Input data</td>
<td style="text-align: left;"><code>d &lt;- SSBtoolsData(paste0("power10to", i))</code></td>
</tr>
<tr class="even">
<td style="text-align: right;">FindHierarchies</td>
<td style="text-align: left;"><code>hi &lt;- FindHierarchies(d)</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;">Adding numeric variable</td>
<td style="text-align: left;"><code>d$y &lt;- as.numeric(1:nrow(d))</code></td>
</tr>
<tr class="even">
<td style="text-align: right;">HierarchyCompute</td>
<td style="text-align: left;"><code>HierarchyCompute(d, hi, "y", inputInOutput = TRUE)</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;">HierarchyCompute with colVar</td>
<td style="text-align: left;"><code>HierarchyCompute(d, hi, "y", inputInOutput = TRUE,</code> <code>colVar = letters[1:(floor(i/2))])</code></td>
</tr>
<tr class="even">
<td style="text-align: right;">ModelMatrix from hierarchies</td>
<td style="text-align: left;"><code>ModelMatrix(d, hierarchies = hi)</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;">Formula</td>
<td style="text-align: left;"><code>f &lt;- as.formula(strtrim(</code> <code>"y ~ (a+A)*(b+B)*(c+C)*(d+D)*(e+E)*(f+F)", 3 + 6*i))</code></td>
</tr>
<tr class="even">
<td style="text-align: right;">ModelMatrix from formula</td>
<td style="text-align: left;"><code>ModelMatrix(d, formula = f)</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;">sparse.model.matrix</td>
<td style="text-align: left;"><code>ModelMatrix(d, formula = f, viaOrdinary = TRUE)</code></td>
</tr>
<tr class="even">
<td style="text-align: right;">model.matrix</td>
<td style="text-align: left;"><code>ModelMatrix(d, formula = f, viaOrdinary = TRUE,</code> <code>sparse = FALSE)</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;">FormulaSums</td>
<td style="text-align: left;"><code>FormulaSums(d, formula = f)</code></td>
</tr>
<tr class="even">
<td style="text-align: right;">median by model_aggregate</td>
<td style="text-align: left;"><code>model_aggregate(d, hierarchies = hi,</code> <code>fun_vars = c(median = "y"))</code></td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>Table <a href="#tab:tab1-html">1</a>
displays the CPU times for different function calls.
The measurements were made by <code>system.time</code> (first element). The median values from five runs are shown.
Table <a href="#tab:tab2-html">2</a>
displays the memory usage as peak RAM, measured using the <a href="https://cran.r-project.org/package=peakRAM">peakRAM</a> package <span class="citation" data-cites="peakRAM_2017">(<a href="#ref-peakRAM_2017" role="doc-biblioref">Quinn 2017</a>)</span>.
The median values from five runs are shown.
These runs were conducted separately from the CPU time measurements.
Table <a href="#tab:tab2-html">2</a>
also presents object sizes obtained using the <code>object.size</code> function.
The source code is shown in
Table <a href="#tab:tab3-html">3</a>.
These comparisons were made with R version 4.2.2 running on Linux.
The server had about 500 GiB of RAM, and it appeared that less than 10% of it were occupied by other users.</p>
<p>Since some functions are based on hierarchy input that may need to be generated from data, <code>FindHierarchies</code> are also included in the tables.
Some functions produce aggregate results (<code>HierarchyCompute</code>, <code>FormulaSums</code> and <code>model_aggregate</code>), while others produce a model matrix.
However, the time required for calculating sum aggregates through matrix multiplication is almost negligible.
When <span class="math inline">\(i=6\)</span>, <code>crossprod(x, d$y)</code> takes four seconds. Here <code>x</code> refers to the sparse model matrix.</p>
<p>Generation of the model matrix from hierarchies by <code>ModelMatrix</code> is done via <code>HierarchyCompute</code>.
The transposed model matrix is outputted before the ordinary results are produced.
The main reason why <code>ModelMatrix</code> still takes longer, when <span class="math inline">\(i \geq 4\)</span>, is a parameter setting that ensures that the column order is more similar to a usual model matrix (<code>reorder = TRUE</code>).
Some time is also spent on matrix transposition.
Even if <code>ModelMatrix</code> is run with <code>crossTable = FALSE</code>, which is the default, this information is still internally generated in order to create column names.</p>
<p>If the desired output is sum aggregates, there is no doubt that <code>HierarchyCompute</code> with <code>colVar</code> is the most efficient option.
In this case, equation <a href="#eq:eq2">(2)</a> is utilized, and instead of creating one large model matrix, two smaller matrices are generated.
For example, when <span class="math inline">\(i=5\)</span>, dimensions <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> are used for columns, while <span class="math inline">\(c\)</span>, <span class="math inline">\(d\)</span>, and <span class="math inline">\(e\)</span> are used for rows.</p>
<p>Even though the functions handle hierarchical relationships, the formula used in the input must be written appropriately in order to achieve the desired output.
To generate all combinations, the input formula to <code>ModelMatrix</code> at <span class="math inline">\(i=4\)</span> would be <code>~(a+A)*(b+B)*(c+C)*(d+D)</code>.
In Table <a href="#tab:tab3-html">3</a>,
a response term is included in the formula, but it is only necessary for the <code>FormulaSums</code> function.
The output from <code>FormulaSums</code> is a one-column matrix containing aggregates.
However, the object size is larger compared to the data frame output of <code>HierarchyCompute</code>.
This is because row names are a less efficient method of storing the information.
It is interesting to note that <code>FormulaSums</code> uses more memory at <span class="math inline">\(i=5\)</span> than <span class="math inline">\(i=6\)</span>.
This is probably because the <code>aggregate</code> function uses a different method for large data.</p>
<p>The initial implementation of <code>ModelMatrix</code> utilized the functions <code>sparse.model.matrix</code> and <code>model.matrix</code>.
This option still remains available by setting <code>viaOrdinary = TRUE</code>.
Since these functions omit a factor level, the input variables are encoded as factors and an empty factor level is added.
In this way, the desired matrix is achieved, here a <span class="math inline">\(10^i \times 14^i\)</span> matrix.
With small data sets (<span class="math inline">\(i \leq 3\)</span>), <code>model.matrix</code> is the fastest method, but with <span class="math inline">\(i \geq 5\)</span>, there was not enough available memory.
With <span class="math inline">\(i=5\)</span> and <span class="math inline">\(i=6\)</span>, the size of the output object would be approximately 400 GiB and 55 TiB, respectively.
The results show, perhaps surprisingly, that <code>sparse.model.matrix</code> consumes significant time and memory.
It was not feasible to run it at <span class="math inline">\(i=6\)</span>.
Profiling indicates that this is primarily due to interaction calculations.
In contrast, in <code>ModelMatrix</code>, which only handles categorical variables, this process is simplified by combining multiple variables from the input before calling <code>fac2sparse</code>.
The hierarchy interface to <code>ModelMatrix</code>, however, is significantly faster than the formula interface.
This is because a few calls to the <code>KhatriRao</code> function are much faster than building the matrix with <code>cbind</code> based on numerous <code>fac2sparse</code> calls.
The object size of the output matrix is slightly larger when using <code>sparse.model.matrix</code> compared to the regular <code>ModelMatrix</code>.
This is primarily because the output from <code>sparse.model.matrix</code> includes row names as well.</p>
<p>Here, <code>model_aggregate</code> is used to calculate median values instead of the sums calculated by <code>HierarchyCompute</code>.
Output is similar, but the rows are sorted differently.
Internally, <code>ModelMatrix</code> is called, and the formula interface is also possible.
Instead of matrix multiplication, the <code>median</code> function is now called <span class="math inline">\(14^i\)</span> times.
This is more resource-intensive, but still feasible when <span class="math inline">\(i=6\)</span>.</p>
<h2 data-number="7" id="applications-in-other-r-packages"><span class="header-section-number">7</span> Applications in other R packages</h2>
<p>The first of the functions demonstrated above to be used in a specific purpose package was <code>FindDimLists</code>.
Package <a href="https://cran.r-project.org/package=easySdcTable">easySdcTable</a> <span class="citation" data-cites="easySdcTable_2022">(<a href="#ref-easySdcTable_2022" role="doc-biblioref">Langsrud 2022</a>)</span> provides a simplifying interface to the
statistical disclosure control (SDC) package <a href="https://cran.r-project.org/package=sdcTable">sdcTable</a> <span class="citation" data-cites="sdcTable">(<a href="#ref-sdcTable" role="doc-biblioref">Meindl 2023</a>)</span>.
This is about protecting frequency tables by the suppression method.
Automatic hierarchies by <code>FindDimLists</code> is an important part of the simplification.</p>
<p>The function <code>HierarchyCompute</code> was originally made for Statistics Norway’s modernized calculations
of <a href="https://www.ssb.no/en/kommregnko/">municipal accounts</a>, which involve complicated hierarchies.
The original intention was to do the computations by an implementation of VTL <span class="citation" data-cites="VTL_2015">(<a href="#ref-VTL_2015" role="doc-biblioref">Airo et al. 2015</a>)</span>, but this approach proved to be too inefficient and R was chosen instead.
The calculations are implemented in the package <a href="#">Kostra</a> <span class="citation" data-cites="Kostra_2023">(<a href="#ref-Kostra_2023" role="doc-biblioref">Lillegård et al. 2023</a>)</span> that is made for internal use in Statistics Norway.
The two complicated hierarchies involved are illustrated on Figure <a href="#fig:fig2">2</a>.
This figure as well as Figure <a href="#fig:fig1">1</a> is made using package <a href="https://cran.r-project.org/package=igraph">igraph</a> <span class="citation" data-cites="igraph_2006">(<a href="#ref-igraph_2006" role="doc-biblioref">Csardi and Nepusz 2006</a>)</span>.
Plotting could be achieved by converting the hierarchies produced by <code>AutoHierarchies</code> into igraph objects using the <code>graph_from_data_frame</code> function.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span style="display:block;" id="fig:fig2"></span>
<img src="figures/Function_Art_hierarchy.png" alt="The function (left) and art (right) hierarchy involved in Statistics Norway’s municipal accounts calculations. Red arrow means negative sign." width="100%" />
<p class="caption">
Figure 2: The function (left) and art (right) hierarchy involved in Statistics Norway’s municipal accounts calculations. Red arrow means negative sign.
</p>
</div>
</div>
<p>The hierarchy interface part of <code>ModelMatrix</code> was created as a spin-off from <code>HierarchyCompute</code>.
The first application was in the SDC package <a href="https://cran.r-project.org/package=SmallCountRounding">SmallCountRounding</a> <span class="citation" data-cites="SmallCountRounding_2022">(<a href="#ref-SmallCountRounding_2022" role="doc-biblioref">Langsrud and Heldal 2022</a>)</span>,
which protects frequency tables data by the perturbation method described by <span class="citation" data-cites="Langsrud_Heldal_2018">Langsrud and Heldal (<a href="#ref-Langsrud_Heldal_2018" role="doc-biblioref">2018</a>)</span>.
The earliest versions of this package were limited to formula input and the package then contained the first version of <code>ModelMatrix</code>.
Two other SDC packages also use <code>ModelMatrix</code>.
The packages <a href="#">SSBcellKey</a> <span class="citation" data-cites="SSBcellKey">(<a href="#ref-SSBcellKey" role="doc-biblioref">Lupp and Langsrud 2023</a>)</span> and <a href="https://cran.r-project.org/package=GaussSuppression">GaussSuppression</a> <span class="citation" data-cites="GaussSuppression">(<a href="#ref-GaussSuppression" role="doc-biblioref">Langsrud and Lupp 2023a</a>)</span> can be used to protect both frequency and magnitude tables
by, respectively, perturbation <span class="citation" data-cites="CellKey">(<a href="#ref-CellKey" role="doc-biblioref">Thompson et al. 2013</a>)</span> and suppression <span class="citation" data-cites="SDCbook_2012">(<a href="#ref-SDCbook_2012" role="doc-biblioref">Hundepool et al. 2012</a>)</span>.</p>
<p>All the SDC packages mentioned above are about protection of tabular data.
When <code>ModelMatrix</code> is used, the model matrix itself is important to the algorithm.
The model matrix is therefore necessary for more than aggregating the data by a matrix multiplication.
In the package <a href="#">SSBcellKey</a>, however, use of the model matrix is limited to running the <a href="https://cran.r-project.org/package=SSBtools">SSBtools</a> function <code>DummyApply</code>
which is a precursor to the <code>dummy_aggregate</code> function mentioned above.</p>
<h2 data-number="8" id="conclusion"><span class="header-section-number">8</span> Conclusion</h2>
<p>The <a href="https://cran.r-project.org/package=SSBtools">SSBtools</a> package provides functionality to handle hierarchical relationships and to generate corresponding model matrices.
This is useful in contexts where multidimensional aggregation and related computations are to be done.
This is applied by several R packages for statistical disclosure control, a field that is important for official statistics.</p>
<h2 class="unnumbered" id="acknowledgements">Acknowledgements</h2>
<p>I would like to thank my colleagues Daniel Lupp and Johan Fosen at Statistics Norway, as well as an anonymous reviewer, for their valuable comments that led to improvements.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-VTL_2015" class="csl-entry" role="listitem">
S. Airo, F. Andrikopoulou, D. Barraclough, L. Bellomarini, M. Bouffard, M. Capaccioli, V. Vecchio, F. Giovanni, J. Dossé, H. Ehrmann, et al. <em>Validation &amp; transformation language, part 2 library of operators, version 1.0.</em> 2015. URL <a href="https://sdmx.org/wp-content/uploads/VTL1_2015_part2_operators_final.pdf">https://sdmx.org/wp-content/uploads/VTL1_2015_part2_operators_final.pdf</a>. SDMX Technical Working Group, VTL Task Force.
</div>
<div id="ref-Matrix" class="csl-entry" role="listitem">
D. Bates, M. Maechler and M. Jagan. <em><span>Matrix</span>: Sparse and dense matrix classes and methods.</em> 2023. URL <a href="https://CRAN.R-project.org/package=Matrix">https://CRAN.R-project.org/package=Matrix</a>. R package version 1.6-1.
</div>
<div id="ref-igraph_2006" class="csl-entry" role="listitem">
G. Csardi and T. Nepusz. The igraph software package for complex network research. <em>InterJournal</em>, Complex Systems: 1695, 2006. URL <a href="https://igraph.org">https://igraph.org</a>.
</div>
<div id="ref-SDCbook_2012" class="csl-entry" role="listitem">
A. Hundepool, J. Domingo-Ferrer, L. Franconi, S. Giessing, E. S. Nordholt, K. Spicer and P.-P. de Wolf. <em>Statistical disclosure control.</em> John Wiley &amp; Sons, Ltd, 2012. DOI <a href="https://doi.org/10.1002/9781118348239.ch1">10.1002/9781118348239.ch1</a>.
</div>
<div id="ref-easySdcTable_2022" class="csl-entry" role="listitem">
Ø. Langsrud. <em><span class="nocase">easySdcTable</span>: Easy interface to the statistical disclosure control package ’sdcTable’ extended with own implementation of ’GaussSuppression’.</em> 2022. URL <a href="https://CRAN.R-project.org/package=easySdcTable">https://CRAN.R-project.org/package=easySdcTable</a>. R package version 1.0.7.
</div>
<div id="ref-Langsrud_Heldal_2018" class="csl-entry" role="listitem">
Ø. Langsrud and J. Heldal. <span class="nocase">An Algorithm for Small Count Rounding of Tabular Data</span>. <span>Privacy in statistical databases, Valencia, Spain</span>. 2018.
</div>
<div id="ref-SmallCountRounding_2022" class="csl-entry" role="listitem">
Ø. Langsrud and J. Heldal. <em><span>SmallCountRounding</span>: Small count rounding of tabular data.</em> 2022. URL <a href="https://CRAN.R-project.org/package=SmallCountRounding">https://CRAN.R-project.org/package=SmallCountRounding</a>. R package version 1.0.3.
</div>
<div id="ref-GaussSuppression" class="csl-entry" role="listitem">
Ø. Langsrud and D. Lupp. <em><span>GaussSuppression</span>: Tabular data suppression using gaussian elimination.</em> 2023a. URL <a href="https://CRAN.R-project.org/package=GaussSuppression">https://CRAN.R-project.org/package=GaussSuppression</a>. R package version 0.7.0.
</div>
<div id="ref-SSBtools_2023" class="csl-entry" role="listitem">
Ø. Langsrud and D. Lupp. <em><span>SSBtools</span>: Statistics norway’s miscellaneous tools.</em> 2023b. URL <a href="https://CRAN.R-project.org/package=SSBtools">https://CRAN.R-project.org/package=SSBtools</a>. R package version 1.4.8.
</div>
<div id="ref-Kostra_2023" class="csl-entry" role="listitem">
M. Lillegård, A.-K. Mevik, J. Heldal and Ø. Langsrud. <em><span>Kostra</span>: Functions for kostra.</em> 2023. URL <a href="https://github.com/statisticsnorway/Kostra">https://github.com/statisticsnorway/Kostra</a>. R package version 1.3.3.
</div>
<div id="ref-SSBcellKey" class="csl-entry" role="listitem">
D. Lupp and Ø. Langsrud. <em><span>SSBcellKey</span>: Cell-key method for tabular data.</em> 2023. URL <a href="https://github.com/statisticsnorway/SSBcellKey">https://github.com/statisticsnorway/SSBcellKey</a>. R package version 0.0.4.
</div>
<div id="ref-sdcTable" class="csl-entry" role="listitem">
B. Meindl. <em><span class="nocase">sdcTable</span>: Methods for statistical disclosure control in tabular data.</em> 2023. URL <a href="https://CRAN.R-project.org/package=sdcTable">https://CRAN.R-project.org/package=sdcTable</a>. R package version 0.32.6.
</div>
<div id="ref-peakRAM_2017" class="csl-entry" role="listitem">
T. Quinn. <em><span class="nocase">peakRAM</span>: Monitor the total and peak RAM used by an expression or function.</em> 2017. URL <a href="https://CRAN.R-project.org/package=peakRAM">https://CRAN.R-project.org/package=peakRAM</a>. R package version 1.0.2.
</div>
<div id="ref-CellKey" class="csl-entry" role="listitem">
G. Thompson, S. Broadfoot and D. Elazar. <span class="nocase">Methodology for the automatic confidentialisation of statistical outputs from remote servers at the Australian Bureau of Statistics</span>. <span>Joint UNECE/Eurostat Work Session on Statistical Data</span>. 2013.
</div>
<div id="ref-tauARGUS_2014" class="csl-entry" role="listitem">
P.-P. de Wolf, A. Hundepool, S. Giessing, J.-J. Salazar and J. Castro. <span class="nocase">tau-ARGUS user’s manual, version 4.1</span>. Statistics Netherlands. 2014. URL <a href="https://github.com/sdcTools/tauargus">https://github.com/sdcTools/tauargus</a>.
</div>
</div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
  <h3 id="references">References</h3>
  <div id="references-listing"></div>
  <h3 id="reuse">Reuse</h3>
  <p>Text and figures are licensed under Creative Commons Attribution <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. The figures that have been reused from other sources don't fall under this license and can be recognized by a note in their caption: "Figure from ...".</p>
  <h3 id="citation">Citation</h3>
  <p>For attribution, please cite this work as</p>
  <pre class="citation-appendix short">Langsrud, "Sparse Model Matrices for Multidimensional Hierarchical Aggregation", The R Journal, 2024</pre>
  <p>BibTeX citation</p>
  <pre class="citation-appendix long">@article{RJ-2023-088,
  author = {Langsrud, Øyvind},
  title = {Sparse Model Matrices for Multidimensional Hierarchical Aggregation},
  journal = {The R Journal},
  year = {2024},
  note = {https://doi.org/10.32614/RJ-2023-088},
  doi = {10.32614/RJ-2023-088},
  volume = {15},
  issue = {4},
  issn = {2073-4859},
  pages = {150-166}
}</pre>
</div>
<!--/radix_placeholder_appendices-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<!--radix_placeholder_navigation_after_body--><html><body>
<div class="distill-site-nav distill-site-footer">
<p>© The R Foundation, <a href="mailto:r-journal@r-project.org">web page
contact</a>.</p>
</div>
<!--/radix_placeholder_navigation_after_body-->
</body></html>


</body>

</html>
