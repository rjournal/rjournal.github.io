# This script was automatically generated by the shinymgr R package's App Builder on 2022-08-03 13:45:22.
# For more information, visit: https://code.usgs.gov/vtcfwru/shinymgr
jscode <- "
shinyjs.disableTab = function(name) {
var tab = $('.nav li a[data-value=' + name + ']');
tab.bind('click.tab', function(e) {
e.preventDefault();
return false;
});
tab.addClass('disabled');
}

shinyjs.enableTab = function(name) {
var tab = $('.nav li a[data-value=' + name + ']');
tab.unbind('click.tab');
tab.removeClass('disabled');
}
"

css <- "
.nav li a.disabled {
background-color: #bbb !important;
border-color: #ccc !important;
cursor: not-allowed !important;
}"


iris_explorer_ui <- function(id) {
  ns <- NS(id)
  tagList(
    fluidPage(
      useShinyjs(),
      extendShinyjs(text = jscode, functions = c('disableTab','enableTab')),
      inlineCSS(css),
      actionButton(
        ns("start"),
        "Start New Analysis",
        onclick = "var $btn=$(this); setTimeout(function(){$btn.remove();},0);"
      ),
      uiOutput(ns('test'))
    )
  )
}
iris_explorer_server <- function(id, userID, shinyMgrPath) {
  moduleServer(id, function(input, output, session) {
    ns <- session$ns
    observeEvent(input$start, {

      disable('start')

      output$test <- renderUI({
        tagList(
          tabsetPanel(
            id = ns("mainTabSet"),
            tabPanel(
              "Intro", 
              value = "tab1",
              iris_intro_ui(ns("mod1")),
              fluidRow(
                actionButton(ns('next_tab_1'), label = "Next")
              )
            ),
            tabPanel(
              "Cluster Iris Data", 
              value = "tab2",
              tags$br(),
              wellPanel(
                style = "background: skyblue",
                "Cluster data from the iris dataset by specifying the attributes and number of clusters."
              ),
              iris_cluster_ui(ns("mod2")),
              fluidRow(
                actionButton(ns('previous_tab_2'), label = "Previous"),
                actionButton(ns('next_tab_2'), label = "Next")
              )
            ),
            tabPanel(
              "Subset Rows", 
              value = "tab3",
              tags$br(),
              wellPanel(
                style = "background: skyblue",
                "Specify the number of rows to randomly select from the clustered iris data."
              ),
              subset_rows_ui(ns("mod3")),
              fluidRow(
                actionButton(ns('previous_tab_3'), label = "Previous"),
                actionButton(ns('next_tab_3'), label = "Next")
              )
            ),
            tabPanel(
              "Plot Column", 
              value = "tab4",
              tags$br(),
              wellPanel(
                style = "background: skyblue",
                "Select a column to view its distribution."
              ),
              single_column_plot_ui(ns("mod4")),
              fluidRow(
                actionButton(ns('previous_tab_4'), label = "Previous"),
                actionButton(ns('next_tab_4'), label = "Next")
              )
            ),
            tabPanel(
              "Save",
              value = "tab5",
              save_analysis_ui(ns("mod5")),
              tags$br(),
              tags$br(),
              fluidRow(
                actionButton(ns("previous_tab_5"), label = "Previous")
              )
            )
          )
        )
      })
      delay(50, {
        js$disableTab("tab2")
        js$disableTab("tab3")
        js$disableTab("tab4")
        js$disableTab("tab5")
      })
    })

    iris_intro_server("mod1")
    data1 <- iris_cluster_server("mod2")
    data2 <- subset_rows_server("mod3", dataset = data1$returndf)
    data3 <- single_column_plot_server("mod4", dataset = data2$subset_data)
    save_analysis_server("mod5",
      appName = "iris_explorer",
      moduleInput = input,
      returns = list(
        data1 = list(
          returndf = data1$returndf()
        ),
        data2 = list(
          subset_data = data2$subset_data()
        ),
        data3 = list(
          selectedCol = data3$selectedCol(),
          g = data3$g()
        )
      ),
      metadata = list(
        appDescription = "Cluster iris data, randomly subset some rows, and plot the distribution of a column",
        mod1 = list(
          dataset = "no returns",
          modName = "iris_intro",
          modDisplayName = "Iris Explorer introduction Page",
          modDescription = "This module is simply a page of text with instructions for the iris explorer module.",
          modArguments = "This module has no additional arguments",
          modReturns = "This module has no returns",
          modPackages = "This module has no package dependencies"
        ),
        mod2 = list(
          dataset = "data1",
          modName = "iris_cluster",
          modDisplayName = "Iris K-Means Clustering",
          modDescription = "Clusters iris data based on 2 attributes",
          modArguments = "This module has no additional arguments",
          modReturns = data.frame(
            name = c("returndf"),
            class = c("data.frame"),
            description = c("selected attributes and their assigned clusters")
          ),
          modPackages = "This module has no package dependencies"
        ),
        mod3 = list(
          dataset = "data2",
          modName = "subset_rows",
          modDisplayName = "Subset Rows (random)",
          modDescription = "Randomly selects rows to create a subset of a dataframe",
          modArguments = data.frame(
            name = c("dataset"),
            class = c("data.frame"),
            description = c("dataframe to be subset")
          ),
          modReturns = data.frame(
            name = c("subset_data"),
            class = c("data.frame"),
            description = c("subset of original data")
          ),
          modPackages = data.frame(
            name = c("reactable"),
            version = c("0.3.0")
          )
        ),
        mod4 = list(
          dataset = "data3",
          modName = "single_column_plot",
          modDisplayName = "Plot Single Column",
          modDescription = "Uses qplot to plot a column in a dataset",
          modArguments = data.frame(
            name = c("dataset"),
            class = c("data.frame"),
            description = c("dataframe to be explored")
          ),
          modReturns = data.frame(
            name = c("selectedCol","g"),
            class = c("string","ggproto"),
            description = c("name of column selected","plot of column distribution")
          ),
          modPackages = data.frame(
            name = c("ggplot2"),
            version = c("3.3.5")
          )
        )
      )
    )
    observeEvent(input$next_tab_1, {
      js$enableTab('tab2')
      js$disableTab('tab1')
      updateTabsetPanel(
        session, 'mainTabSet',
        selected = 'tab2'
      )
    })
    observeEvent(input$next_tab_2, {
      js$enableTab('tab3')
      js$disableTab('tab2')
      updateTabsetPanel(
        session, 'mainTabSet',
        selected = 'tab3'
      )
    })
    observeEvent(input$previous_tab_2, {
      delay(50, {
        js$enableTab('tab1')
        js$disableTab('tab2')
      })
      removeTab('mainTabSet','tab2',session)
      insertTab(
        inputId = 'mainTabSet',
        tab = tabPanel(
          title = "Cluster Iris Data",
          value = "tab2",
          iris_cluster_ui(ns("mod2")),
          fluidRow(
            actionButton(ns('previous_tab_2'), label = "Previous"),
            actionButton(ns('next_tab_2'), label = "Next")
          )
        ),
        target = 'tab1',
        position = 'after'
      )
      updateTabsetPanel(
        session, 'mainTabSet',
                selected = 'tab1'
      )
    })
    observeEvent(input$next_tab_3, {
      js$enableTab('tab4')
      js$disableTab('tab3')
      updateTabsetPanel(
        session, 'mainTabSet',
        selected = 'tab4'
      )
    })
    observeEvent(input$previous_tab_3, {
      delay(50, {
        js$enableTab('tab2')
        js$disableTab('tab3')
      })
      removeTab('mainTabSet','tab3',session)
      insertTab(
        inputId = 'mainTabSet',
        tab = tabPanel(
          title = "Subset Rows",
          value = "tab3",
          subset_rows_ui(ns("mod3")),
          fluidRow(
            actionButton(ns('previous_tab_3'), label = "Previous"),
            actionButton(ns('next_tab_3'), label = "Next")
          )
        ),
        target = 'tab2',
        position = 'after'
      )
      updateTabsetPanel(
        session, 'mainTabSet',
                selected = 'tab2'
      )
    })
    observeEvent(input$next_tab_4, {
      js$enableTab('tab5')
      js$disableTab('tab4')
      updateTabsetPanel(
        session, 'mainTabSet',
        selected = 'tab5'
      )
    })
    observeEvent(input$previous_tab_4, {
      delay(50, {
        js$enableTab('tab3')
        js$disableTab('tab4')
      })
      removeTab('mainTabSet','tab4',session)
      insertTab(
        inputId = 'mainTabSet',
        tab = tabPanel(
          title = "Plot Column",
          value = "tab4",
          single_column_plot_ui(ns("mod4")),
          fluidRow(
            actionButton(ns('previous_tab_4'), label = "Previous"),
            actionButton(ns('next_tab_4'), label = "Next")
          )
        ),
        target = 'tab3',
        position = 'after'
      )
      updateTabsetPanel(
        session, 'mainTabSet',
                selected = 'tab3'
      )
    })
    observeEvent(input$previous_tab_5, {
      delay(50, {
        js$enableTab('tab4')
        js$disableTab('tab5')
      })
      updateTabsetPanel(
        session, 'mainTabSet',
                selected = 'tab4'
      )
    })
  })
}
